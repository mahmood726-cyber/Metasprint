<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>META-SPRINT UMBRELLA V1.0</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #F8FAFC;
            --surface: #FFFFFF;
            --border: #E2E8F0;
            --border-strong: #CBD5E1;
            --text: #0F172A;
            --text-secondary: #475569;
            --text-muted: #64748B;
            --accent: #6366F1;
            --accent-light: #EEF2FF;
            --success: #059669;
            --success-light: #D1FAE5;
            --warning: #D97706;
            --warning-light: #FEF3C7;
            --danger: #DC2626;
            --danger-light: #FEE2E2;
            --purple: #0284C7;
            --purple-light: #E0F2FE;
            --umbrella: #6366F1;
            --umbrella-light: #EEF2FF;
            --warning-bg: #FFFBEB;
            --warning-border: #F59E0B;
            --warning-title: #B45309;
            --warning-text: #92400E;
        }

        /* Dark Mode */
        .dark-mode {
            --bg: #0F172A;
            --surface: #1E293B;
            --border: #334155;
            --border-strong: #475569;
            --text: #F1F5F9;
            --text-secondary: #CBD5E1;
            --text-muted: #94A3B8;
            --accent: #22D3EE;
            --accent-light: #3730A3;
            --success: #10B981;
            --success-light: #032E23;
            --warning: #F59E0B;
            --warning-light: #4A2008;
            --danger: #EF4444;
            --danger-light: #451A1A;
            --purple: #38BDF8;
            --purple-light: #0C4A6E;
            --umbrella: #818CF8;
            --umbrella-light: #3730A3;
            --warning-bg: #422006;
            --warning-border: #92400E;
            --warning-title: #FBBF24;
            --warning-text: #FDE68A;
        }
        .dark-mode .form-input, .dark-mode .form-textarea, .dark-mode select { background: var(--surface); color: var(--text); }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; font-size: 14px; }
        .container { max-width: 900px; margin: 0 auto; padding: 16px; }

        /* Header */
        .header { background: linear-gradient(135deg, var(--umbrella) 0%, #0369A1 100%); border-bottom: 1px solid var(--border); padding: 12px 16px; position: sticky; top: 0; z-index: 100; }
        .header-inner { max-width: 900px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
        .logo { font-weight: 700; font-size: 18px; color: white; }
        .logo span { color: rgba(255,255,255,0.7); font-weight: 400; font-size: 12px; }
        .logo .nma-badge { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px; }
        .header-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .role-badge { background: rgba(255,255,255,0.2); color: white; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .day-control { display: flex; align-items: center; gap: 8px; }
        .day-btn { width: 44px; height: 44px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.1); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .day-btn:hover:not(:disabled) { background: rgba(255,255,255,0.2); }
        .day-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .day-display { font-weight: 700; font-size: 16px; min-width: 70px; text-align: center; color: white; cursor: pointer; padding: 4px 8px; border-radius: 6px; }
        .day-display:hover { background: rgba(255,255,255,0.1); }
        .day-hint { font-size: 12px; color: rgba(255,255,255,0.7); text-align: center; margin-top: 2px; }

        /* Toast notification */
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--success); color: white; padding: 12px 20px; border-radius: 8px; font-weight: 500; font-size: 13px; z-index: 1000; opacity: 0; transform: translateY(20px); transition: all 0.3s ease; pointer-events: none; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast.error { background: var(--danger); }

        /* Tabs */
        .tabs { display: flex; gap: 4px; background: var(--surface); padding: 8px 16px; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .tab { padding: 12px 16px; border: none; background: none; font-family: inherit; font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-radius: 6px; white-space: nowrap; }
        .tab:hover { background: var(--bg); }
        .tab.active { background: var(--umbrella-light); color: var(--umbrella); }

        /* Cards */
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
        .card-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .card-title { font-weight: 600; font-size: 15px; }
        .card-body { padding: 16px; }

        /* UMBRELLA-specific badges */
        .nma-indicator { background: var(--umbrella-light); color: var(--umbrella); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }

        /* Phase badges */
        .phase-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .phase-a { background: var(--purple-light); color: var(--purple); }
        .phase-b { background: var(--umbrella-light); color: var(--umbrella); }
        .phase-c { background: var(--warning-light); color: var(--warning); }
        .phase-d { background: var(--success-light); color: var(--success); }
        .phase-e { background: var(--danger-light); color: var(--danger); }

        /* Alerts */
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: flex-start; gap: 12px; }
        .alert-icon { font-size: 18px; flex-shrink: 0; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; margin-bottom: 2px; }
        .alert-text { font-size: 13px; }
        .alert-info { background: var(--umbrella-light); border: 1px solid var(--umbrella); }
        .alert-warning { background: var(--warning-light); border: 1px solid var(--warning); }
        .alert-danger { background: var(--danger-light); border: 1px solid var(--danger); }
        .alert-success { background: var(--success-light); border: 1px solid var(--success); }

        /* Checklist */
        .checklist-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s; }
        .checklist-item:hover { background: var(--bg); }
        .checklist-item.checked { background: var(--success-light); border-color: var(--success); }
        .check-box { width: 20px; height: 20px; border: 2px solid var(--border-strong); border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
        .checklist-item.checked .check-box { background: var(--success); border-color: var(--success); }
        .check-box svg { color: white; display: none; }
        .checklist-item.checked .check-box svg { display: block; }
        .checklist-content { flex: 1; }
        .checklist-title { font-weight: 500; }
        .checklist-hint { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

        /* Timeline */
        .timeline-bar { height: 8px; background: var(--border); border-radius: 4px; position: relative; margin: 16px 0; }
        .timeline-fill { height: 100%; background: var(--umbrella); border-radius: 4px; transition: width 0.3s; }
        .timeline-markers { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .timeline-marker { text-align: center; }
        .timeline-marker.active { color: var(--umbrella); font-weight: 600; }
        .timeline-marker.passed { color: var(--success); }

        /* Health Dashboard */
        .health-dashboard { background: linear-gradient(135deg, var(--surface) 0%, var(--bg) 100%); border: 2px solid var(--umbrella); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .health-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
        .health-title { font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .health-score { font-size: 24px; font-weight: 700; }
        .health-score.good { color: var(--success); }
        .health-score.warning { color: var(--warning); }
        .health-score.danger { color: var(--danger); }
        .health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
        .health-stat { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center; }
        .health-stat-value { font-size: 20px; font-weight: 700; color: var(--umbrella); }
        .health-stat-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .gate-dots { display: flex; gap: 6px; justify-content: center; margin-top: 12px; }
        .gate-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: var(--text-muted); }
        .gate-dot.passed { background: var(--success); border-color: var(--success); color: white; }
        .gate-dot.current { border-color: var(--warning); color: var(--warning); animation: pulse 1.5s infinite; }

        .risk-panel { margin-top: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
        .risk-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px; }
        .risk-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); letter-spacing: 0.02em; text-transform: uppercase; }
        .risk-badge { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 999px; }
        .risk-badge.low { background: var(--success-light); color: var(--success); }
        .risk-badge.medium { background: var(--warning-light); color: var(--warning); }
        .risk-badge.high { background: var(--danger-light); color: var(--danger); }
        .risk-list { list-style: none; margin: 0; padding: 0; display: grid; gap: 6px; }
        .risk-item { font-size: 12px; color: var(--text-secondary); padding: 6px 8px; border-radius: 6px; background: var(--bg); border: 1px solid var(--border); }
        .risk-item.medium { border-color: var(--warning); background: var(--warning-light); color: var(--warning); }
        .risk-item.high { border-color: var(--danger); background: var(--danger-light); color: var(--danger); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Accuracy visualization placeholder */
        .accuracy-preview { background: var(--bg); border: 2px dashed var(--border); border-radius: 12px; padding: 24px; text-align: center; margin-bottom: 16px; }
        .accuracy-preview-title { font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .accuracy-stats { display: flex; justify-content: center; gap: 24px; flex-wrap: wrap; }
        .accuracy-stat { text-align: center; }
        .accuracy-stat-value { font-size: 28px; font-weight: 700; color: var(--umbrella); }
        .accuracy-stat-label { font-size: 12px; color: var(--text-muted); }

        /* Forms */
        .form-row { margin-bottom: 12px; }
        .form-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; display: block; }
        .form-input, .form-textarea { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; }
        .form-textarea { resize: vertical; min-height: 60px; }
        .form-hint { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

        /* Buttons */
        .copy-btn { background: var(--umbrella); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-family: inherit; font-weight: 600; cursor: pointer; }
        .copy-btn:hover { background: #0E7490; }
        .download-btn { background: var(--surface); color: var(--text); border: 1px solid var(--border); padding: 10px 20px; border-radius: 6px; font-family: inherit; font-weight: 600; cursor: pointer; }
        .download-btn:hover { background: var(--bg); }
        .btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }

        /* Templates */
        .template-card { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; overflow: hidden; }
        .template-header { padding: 12px 16px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .template-header:hover { background: var(--border); }
        .template-name { font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .template-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .badge-essential { background: var(--danger-light); color: var(--danger); }
        .badge-nma { background: var(--umbrella-light); color: var(--umbrella); }
        .badge-reference { background: var(--purple-light); color: var(--purple); }
        .template-body { padding: 16px; display: none; }
        .template-body.open { display: block; }
        .template-output { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-top: 12px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; white-space: pre-wrap; display: none; }
        .template-output.visible { display: block; }

        /* Tables */
        .ref-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .ref-table th, .ref-table td { padding: 10px 12px; border: 1px solid var(--border); text-align: left; }
        .ref-table th { background: var(--bg); font-weight: 600; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
        .modal.visible { display: flex; }
        .modal-card { background: var(--surface); border-radius: 16px; width: 100%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font-weight: 700; font-size: 18px; }
        .modal-close { width: 44px; height: 44px; border: none; background: var(--bg); border-radius: 8px; cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; }
        .modal-body { padding: 24px; }

        /* Onboarding */
        .onboarding { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px; overflow-y: auto; }
        .onboarding.hidden { display: none; }
        .onboarding-card { background: var(--surface); border-radius: 16px; width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; }
        .onboarding-header { background: linear-gradient(135deg, var(--umbrella) 0%, #0E7490 100%); padding: 24px; border-radius: 16px 16px 0 0; color: white; text-align: center; }
        .onboarding-body { padding: 24px; }
        .role-grid { display: grid; gap: 8px; margin-bottom: 24px; }
        .role-btn { display: flex; align-items: center; gap: 12px; padding: 14px; border: 2px solid var(--border); border-radius: 10px; background: var(--surface); cursor: pointer; text-align: left; font-family: inherit; }
        .role-btn:hover { border-color: var(--umbrella); }
        .role-btn.selected { border-color: var(--umbrella); background: var(--umbrella-light); }
        .role-icon { width: 36px; height: 36px; background: var(--bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .role-info { flex: 1; }
        .role-name { font-weight: 600; font-size: 14px; }
        .role-desc { font-size: 11px; color: var(--text-secondary); }
        .start-btn { width: 100%; padding: 14px; background: var(--umbrella); color: white; border: none; border-radius: 8px; font-family: inherit; font-size: 15px; font-weight: 600; cursor: pointer; }
        .start-btn:disabled { background: var(--border-strong); cursor: not-allowed; }

        /* Eligibility checks */
        .elig-item { display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
        .elig-item:hover { background: var(--bg); }
        .elig-item.checked { background: var(--success-light); border-color: var(--success); }
        .elig-check { width: 22px; height: 22px; border: 2px solid var(--border-strong); border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .elig-item.checked .elig-check { background: var(--success); border-color: var(--success); }
        .elig-check svg { color: white; display: none; }
        .elig-item.checked .elig-check svg { display: block; }

        /* Pages */
        .page { display: none; }
        .page.active { display: block; }

        /* Freeze banner */
        .freeze-banner { background: var(--danger); color: white; padding: 12px 16px; text-align: center; font-weight: 600; }
        .freeze-banner.hidden { display: none; }

        /* DoD sections */
        .dod-section { margin-bottom: 24px; }
        .dod-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 12px; border-radius: 8px; }
        .dod-header.phase-a { background: var(--purple-light); }
        .dod-header.phase-b { background: var(--umbrella-light); }
        .dod-header.phase-c { background: var(--warning-light); }
        .dod-header.phase-d { background: var(--success-light); }
        .dod-header.phase-e { background: var(--danger-light); }
        .dod-title { font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .dod-gate-status { padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .gate-pending { background: var(--bg); color: var(--text-muted); }
        .gate-ready { background: var(--warning-light); color: var(--warning); }
        .gate-passed { background: var(--success-light); color: var(--success); }

        /* Confetti */
        .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
        .confetti { position: absolute; width: 10px; height: 10px; opacity: 0; animation: confetti-fall 3s ease-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-100px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }

        /* Day jump modal */
        .day-jump-modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: center; justify-content: center; z-index: 1001; }
        .day-jump-modal.visible { display: flex; }
        .day-jump-card { background: var(--surface); border-radius: 12px; padding: 24px; width: 280px; max-width: calc(100vw - 32px); text-align: center; }
        .day-jump-input { width: 100px; padding: 12px; font-size: 24px; font-weight: 700; text-align: center; border: 2px solid var(--umbrella); border-radius: 8px; }

        /* Bootcamp section */
        .bootcamp-card { background: linear-gradient(135deg, var(--umbrella-light) 0%, var(--bg) 100%); border: 2px solid var(--umbrella); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .bootcamp-title { font-weight: 700; color: var(--umbrella); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .bootcamp-modules { display: grid; gap: 8px; }
        .bootcamp-module { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; }
        .bootcamp-module.completed { background: var(--success-light); border-color: var(--success); }
        .bootcamp-module-check { width: 24px; height: 24px; border: 2px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .bootcamp-module.completed .bootcamp-module-check { background: var(--success); border-color: var(--success); color: white; }
        .bootcamp-module-info { flex: 1; }
        .bootcamp-module-name { font-weight: 600; font-size: 13px; }
        .bootcamp-module-time { font-size: 11px; color: var(--text-muted); }

        /* ROBINS-E domains */
        .cinema-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 16px; }
        .cinema-domain { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center; }
        .cinema-domain-name { font-weight: 600; font-size: 12px; margin-bottom: 4px; }
        .cinema-domain-rating { font-size: 11px; padding: 2px 8px; border-radius: 4px; }
        .cinema-high { background: var(--success-light); color: var(--success); }
        .cinema-moderate { background: var(--warning-light); color: var(--warning); }
        .cinema-low { background: var(--danger-light); color: var(--danger); }

        /* Tab progress indicators */
        .tab { position: relative; }
        .tab-badge { position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; border-radius: 50%; }
        .tab-badge.needs-attention { background: var(--warning); }
        .tab-badge.complete { background: var(--success); }

        /* Accuracy graph visualization */
        .accuracy-graph { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; min-height: 200px; position: relative; margin-bottom: 16px; }
        .accuracy-graph svg { width: 100%; height: 180px; }
        .accuracy-test { cursor: pointer; transition: all 0.2s; }
        .accuracy-test:hover { transform: scale(1.1); }
        .accuracy-edge { stroke: var(--border-strong); stroke-width: 2; }
        .accuracy-label { font-size: 11px; fill: var(--text); font-weight: 600; text-anchor: middle; }

        /* Handoff checklist */
        .handoff-card { background: linear-gradient(135deg, var(--purple-light) 0%, var(--bg) 100%); border: 1px solid var(--purple); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .handoff-title { font-weight: 700; color: var(--purple); font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .handoff-items { display: grid; gap: 4px; }
        .handoff-item { font-size: 12px; display: flex; align-items: center; gap: 6px; }
        .handoff-item input { margin: 0; }

        /* Worked example */
        .example-box { background: var(--umbrella-light); border: 1px solid var(--umbrella); border-radius: 8px; padding: 16px; margin: 12px 0; }
        .example-title { font-weight: 700; color: var(--umbrella); margin-bottom: 8px; }
        .example-step { background: var(--surface); border-radius: 6px; padding: 10px; margin-bottom: 8px; font-size: 13px; }
        .example-step-num { display: inline-block; width: 20px; height: 20px; background: var(--umbrella); color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 11px; font-weight: 700; margin-right: 8px; }

        /* Evidence Reversal Stories */
        .story-card { background: linear-gradient(135deg, var(--surface) 0%, var(--bg) 100%); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .story-header { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); color: white; padding: 20px; cursor: pointer; }
        .story-header:hover { background: linear-gradient(135deg, #234b78 0%, #1e293b 100%); }
        .story-number { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-bottom: 4px; }
        .story-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .story-hook { font-size: 14px; opacity: 0.9; font-style: italic; }
        .story-body { display: none; padding: 0; }
        .story-body.open { display: block; }
        .story-scene { padding: 20px; border-bottom: 1px solid var(--border); }
        .story-scene:last-child { border-bottom: none; }
        .scene-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; }
        .scene-content { font-size: 14px; line-height: 1.7; }
        .story-question { background: var(--umbrella-light); border-left: 4px solid var(--umbrella); padding: 16px; margin: 16px 0; font-size: 15px; font-weight: 600; font-style: italic; color: var(--umbrella); }
        .story-contrast { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0; }
        .contrast-box { padding: 16px; border-radius: 8px; }
        .contrast-wrong { background: var(--danger-light); border: 1px solid var(--danger); }
        .contrast-right { background: var(--success-light); border: 1px solid var(--success); }
        .contrast-label { font-size: 11px; text-transform: uppercase; font-weight: 700; margin-bottom: 8px; }
        .contrast-wrong .contrast-label { color: var(--danger); }
        .contrast-right .contrast-label { color: var(--success); }
        .story-moral { background: linear-gradient(135deg, var(--success-light) 0%, #d1fae5 100%); border: 2px solid var(--success); border-radius: 8px; padding: 20px; margin-top: 16px; }
        .moral-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--success); font-weight: 700; margin-bottom: 8px; }
        .moral-text { font-size: 15px; font-weight: 600; color: var(--success); }
        .story-reflection { background: var(--purple-light); border-radius: 8px; padding: 16px; margin-top: 16px; }
        .reflection-question { font-size: 14px; color: var(--purple); font-weight: 600; margin-bottom: 8px; }
        @media (max-width: 640px) { .story-contrast { grid-template-columns: 1fr; } }

        /* Achievements System */
        .achievements-panel { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid var(--warning); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .achievements-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .achievements-title { font-weight: 700; font-size: 15px; color: #92400e; display: flex; align-items: center; gap: 8px; }
        .achievements-count { background: var(--warning); color: white; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .achievement { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; text-align: center; opacity: 0.4; transition: all 0.3s; }
        .achievement.earned { opacity: 1; border-color: var(--warning); box-shadow: 0 2px 8px rgba(217, 119, 6, 0.2); }
        .achievement-icon { font-size: 24px; margin-bottom: 4px; }
        .achievement-name { font-size: 11px; font-weight: 600; color: var(--text); }
        .achievement-desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        .achievement.earned .achievement-icon { animation: achievePulse 0.5s ease; }
        @keyframes achievePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        /* Daily Standup Generator */
        .standup-btn { background: linear-gradient(135deg, var(--purple) 0%, #6d28d9 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
        .standup-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3); }
        .standup-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .standup-modal.open { display: flex; }
        .standup-card { background: var(--surface); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .standup-section { background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .standup-label { font-size: 11px; text-transform: uppercase; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; }
        .standup-items { font-size: 13px; }
        .standup-item { padding: 4px 0; display: flex; align-items: flex-start; gap: 6px; }
        .standup-copy { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 8px; }
        .standup-copy:hover { background: #047857; }

        /* Contextual Help Tooltips */
        .help-tip { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; background: var(--text-muted); color: white; border-radius: 50%; font-size: 11px; font-weight: 700; cursor: help; margin-left: 4px; position: relative; }
        .help-tip:hover { background: var(--umbrella); }
        .help-tip::after { content: attr(data-tip); position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--text); color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: 400; white-space: normal; width: 200px; text-align: left; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .help-tip:hover::after { opacity: 1; visibility: visible; }
        .help-tip::before { content: ''; position: absolute; bottom: calc(100% + 2px); left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: var(--text); opacity: 0; visibility: hidden; transition: all 0.2s; }
        .help-tip:hover::before { opacity: 1; visibility: visible; }

        /* PRISMA Validation */
        .prisma-warning { background: var(--danger-light); border: 1px solid var(--danger); border-radius: 6px; padding: 8px 12px; font-size: 12px; color: var(--danger); margin-top: 8px; display: none; }
        .prisma-warning.visible { display: block; }
        .prisma-valid { background: var(--success-light); border: 1px solid var(--success); color: var(--success); }
        .prisma-calc { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-style: italic; }

        /* Mobile */
        @media (max-width: 640px) {
            .header-inner { flex-direction: column; align-items: stretch; }
            .header-controls { justify-content: center; }
            .health-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* Focus visible */
        :focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

        /* Enhanced modal shadows */
        .modal-card, .onboarding-card { box-shadow: 0 20px 60px rgba(0,0,0,0.25); }

        /* Print styles */
        @media print { .header, .tabs, .toast, .modal, .onboarding, .day-jump-modal, .confetti-container { display: none !important; } body { background: white !important; color: black !important; } .card { break-inside: avoid; box-shadow: none; } .container { max-width: 100%; } }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; } }

        /* Tablet breakpoint */
        @media (min-width: 641px) and (max-width: 899px) { .health-grid { grid-template-columns: repeat(3, 1fr); } .role-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast" aria-live="polite" aria-atomic="true"><span id="toastIcon">✓</span><span id="toastText">Saved</span></div>

<!-- CONFETTI -->
<div class="confetti-container" id="confettiContainer" aria-hidden="true"></div>

<!-- DAY JUMP MODAL -->
<div class="day-jump-modal" id="dayJumpModal" role="dialog" aria-modal="true" onclick="closeDayJump(event)">
    <div class="day-jump-card" onclick="event.stopPropagation()">
        <div style="font-weight:700;margin-bottom:16px">Jump to Day</div>
        <input type="number" class="day-jump-input" id="dayJumpInput" inputmode="numeric" aria-label="Jump to day (1-40)" min="1" max="40" value="1" onkeydown="handleDayJumpKey(event)">
        <div class="btn-row" style="justify-content:center;margin-top:16px">
            <button class="download-btn" onclick="closeDayJump()">Cancel</button>
            <button class="copy-btn" onclick="jumpToDay()">Go</button>
        </div>
    </div>
</div>

<!-- BOOTCAMP MODAL -->
<div class="modal" id="bootcampModal" role="dialog" aria-modal="true">
    <div class="modal-card" style="max-width:700px">
        <div class="modal-header">
            <div class="modal-title">🎓 UMBRELLA Bootcamp</div>
            <button class="modal-close" aria-label="Close" onclick="closeModal('bootcampModal')">×</button>
        </div>
        <div class="modal-body" id="bootcampContent">
            <!-- Module 1: Umbrella Review Fundamentals -->
            <div class="bootcamp-lesson" id="lesson-tests">
                <h3 style="color:var(--umbrella);margin-bottom:12px">Module 1: Umbrella Review Fundamentals & Curve Shapes (10 min)</h3>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <p><strong>What is Umbrella Review Meta-Analysis?</strong></p>
                    <p style="margin:8px 0">Dose-response meta-analysis pools data from studies reporting outcomes at multiple dose levels to characterize the relationship between exposure dose and effect magnitude.</p>
                    <p style="margin-top:12px"><strong>Key Components:</strong></p>
                    <ul style="margin:8px 0 0 20px;font-size:13px">
                        <li><strong>Umbrella Review Curve:</strong> Graph showing how effect size changes across dose levels (linear, log-linear, sigmoidal, etc.)</li>
                        <li><strong>ED50/EC50:</strong> Dose producing 50% of maximum effect — key pharmacological parameter</li>
                        <li><strong>Emax:</strong> Maximum achievable effect at high doses (plateau level)</li>
                        <li><strong>Hill Coefficient:</strong> Slope parameter describing steepness of the curve</li>
                    </ul>
                </div>
                <div style="background:var(--warning-light);padding:12px;border-radius:8px;border:1px solid var(--warning);font-size:13px">
                    <strong>⚠️ Common Mistake:</strong> Assuming linear dose-response. Most biological relationships are non-linear. Always test model fit before pooling.
                </div>
                <div style="background:var(--success-light);padding:12px;border-radius:8px;border:1px solid var(--success);font-size:13px;margin-top:8px">
                    <strong>✅ Example Study Registry:</strong><br>
                    Study 1: RCT, n=450, doses: 10, 25, 50, 100 mg<br>
                    Study 2: Observational, n=1200, doses: 5, 10, 20, 40, 80 mg<br>
                    Study 3: RCT, n=180, doses: placebo, 25, 75 mg<br>
                    Primary outcome: Blood pressure reduction (mmHg)
                </div>
            </div>

            <!-- Module 2: Umbrella Review Models -->
            <div class="bootcamp-lesson" id="lesson-applicability" style="display:none">
                <h3 style="color:var(--umbrella);margin-bottom:12px">Module 2: Umbrella Review Model Selection (10 min)</h3>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <p><strong>Choosing the Right Model</strong></p>
                    <p style="margin:8px 0">Dose-response relationships can follow many shapes. Selecting the appropriate model is critical for valid conclusions.</p>
                    <p style="margin-top:12px"><strong>Model Selection Steps:</strong></p>
                    <ul style="margin:8px 0 0 20px;font-size:13px">
                        <li><strong>Visualize:</strong> Plot all study data to identify curve shape patterns</li>
                        <li><strong>Fit Candidates:</strong> Test linear, quadratic, spline, Emax, and log-linear models</li>
                        <li><strong>Compare:</strong> Use AIC/BIC and visual inspection of residuals</li>
                        <li><strong>Validate:</strong> Leave-one-out cross-validation for overfitting check</li>
                    </ul>
                </div>
                <table class="ref-table" style="font-size:12px">
                    <thead><tr><th>Model Type</th><th>When to Use</th></tr></thead>
                    <tbody>
                        <tr><td>Linear</td><td>Constant effect per dose unit, no plateau</td></tr>
                        <tr><td>Emax/Sigmoid</td><td>Pharmacological effects with saturation</td></tr>
                        <tr><td>Restricted Cubic Splines</td><td>Flexible, unknown shape</td></tr>
                        <tr><td>Log-linear</td><td>Proportional effects at low doses</td></tr>
                        <tr><td>Fractional Polynomial</td><td>Complex non-linear patterns</td></tr>
                    </tbody>
                </table>
                <div style="background:var(--danger-light);padding:12px;border-radius:8px;border:1px solid var(--danger);font-size:13px;margin-top:12px">
                    <strong>🚫 Common Pitfalls:</strong> Overfitting with complex models, extrapolating beyond observed dose range, ignoring heterogeneity in curve shapes across studies.
                </div>
            </div>

            <!-- Module 3: Pooling Umbrella Review Data -->
            <div class="bootcamp-lesson" id="lesson-proportional-hazards" style="display:none">
                <h3 style="color:var(--umbrella);margin-bottom:12px">Module 3: Pooling Umbrella Review Data Across Studies (10 min)</h3>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <p><strong>How to Pool Umbrella Review Data?</strong></p>
                    <p style="margin:8px 0">Two-stage approach: (1) Fit within-study dose-response curves, (2) Pool curve parameters across studies using multivariate meta-analysis.</p>
                    <p style="margin-top:8px"><strong>Key Methods:</strong> Greenland & Longnecker method for aggregated data; one-stage mixed-effects models for IPD.</p>
                </div>
                <table class="ref-table" style="font-size:12px">
                    <thead><tr><th>Heterogeneity Source</th><th>How to Detect</th><th>What to Do</th></tr></thead>
                    <tbody>
                        <tr><td><strong>Different curve shapes</strong></td><td>Visual inspection, model comparison</td><td>Stratify or use random slopes</td></tr>
                        <tr><td><strong>Population differences</strong></td><td>Age, baseline risk, disease severity</td><td>Meta-regression on ED50</td></tr>
                        <tr><td><strong>Dose range variation</strong></td><td>Studies with non-overlapping doses</td><td>Restrict to common range</td></tr>
                        <tr><td><strong>Outcome definition</strong></td><td>Different effect measures/scales</td><td>Standardize or sensitivity analysis</td></tr>
                    </tbody>
                </table>
                <div style="background:var(--umbrella-light);padding:12px;border-radius:8px;border:1px solid var(--umbrella);font-size:13px;margin-top:12px">
                    <strong>💡 Handling Non-Linearity:</strong><br>
                    1. Use restricted cubic splines with 3-4 knots<br>
                    2. Pool spline coefficients across studies<br>
                    3. Test for non-linearity using Wald test on non-linear terms<br>
                    4. Always visualize pooled curve with prediction intervals
                </div>
            </div>

            <!-- Module 4: Key Umbrella Review Parameters -->
            <div class="bootcamp-lesson" id="lesson-summary-measures" style="display:none">
                <h3 style="color:var(--umbrella);margin-bottom:12px">Module 4: Key Umbrella Review Parameters & Interpretation (5 min)</h3>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <p><strong>Key Umbrella Review Parameters:</strong></p>
                    <ul style="margin:8px 0 0 20px;font-size:13px">
                        <li><strong>ED50 (EC50):</strong> Dose producing 50% of maximum effect — primary potency measure</li>
                        <li><strong>Emax:</strong> Maximum achievable effect — efficacy plateau</li>
                        <li><strong>Slope/Hill Coefficient:</strong> Steepness of the curve — sensitivity to dose changes</li>
                        <li><strong>Threshold Dose:</strong> Minimum dose for detectable effect (if applicable)</li>
                    </ul>
                    <p style="margin-top:12px"><strong>What ED50 tells you:</strong></p>
                    <ul style="margin:8px 0 0 20px;font-size:13px">
                        <li>Relative potency between treatments</li>
                        <li>Dose needed for clinically meaningful effect</li>
                        <li>Starting dose for clinical practice</li>
                    </ul>
                    <p style="margin-top:12px"><strong>What ED50 doesn't tell you:</strong></p>
                    <ul style="margin:8px 0 0 20px;font-size:13px">
                        <li>Maximum possible effect (need Emax)</li>
                        <li>Dose-toxicity relationship (need safety data)</li>
                        <li>Optimal therapeutic dose (need benefit-risk)</li>
                    </ul>
                </div>
                <div style="background:var(--danger-light);padding:12px;border-radius:8px;border:1px solid var(--danger);font-size:13px">
                    <strong>🚫 CAUTION WITH POOLED UMBRELLA-RESPONSE IF:</strong><br>
                    • Studies use very different dose ranges<br>
                    • Curve shapes differ substantially across studies<br>
                    • Outcome definitions vary (different scales)<br>
                    • High heterogeneity in ED50 estimates (I² > 75%)
                </div>
            </div>

            <!-- Module 5: Risk of Bias -->
            <div class="bootcamp-lesson" id="lesson-cinema" style="display:none">
                <h3 style="color:var(--umbrella);margin-bottom:12px">Module 5: Risk of Bias in Umbrella Review Studies (10 min)</h3>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <p><strong>ROBINS-E for Observational Umbrella Review Studies</strong></p>
                    <p style="margin:8px 0;font-size:13px">For observational dose-response studies, use ROBINS-E. For RCTs with multiple dose arms, use RoB 2. Key focus: confounding by indication at different doses.</p>
                </div>
                <table class="ref-table" style="font-size:11px">
                    <thead><tr><th>Domain</th><th>Umbrella Review Concern</th><th>Example: "Some concerns"</th></tr></thead>
                    <tbody>
                        <tr><td><strong>Confounding</strong></td><td>Higher doses given to sicker patients?</td><td>Some confounders adjusted, not all</td></tr>
                        <tr><td><strong>Selection</strong></td><td>Selection based on expected response?</td><td>Unclear why some got higher doses</td></tr>
                        <tr><td><strong>Exposure measurement</strong></td><td>Dose accurately measured/recorded?</td><td>Self-reported adherence, some validation</td></tr>
                        <tr><td><strong>Post-exposure interventions</strong></td><td>Dose modifications during study?</td><td>Some dose titration allowed</td></tr>
                        <tr><td><strong>Missing data</strong></td><td>Dropout related to dose or effect?</td><td>10-20% missing, pattern unclear</td></tr>
                        <tr><td><strong>Outcome measurement</strong></td><td>Outcome measurement dose-blind?</td><td>Assessors knew approximate dose</td></tr>
                        <tr><td><strong>Selective reporting</strong></td><td>All doses/outcomes reported?</td><td>Some intermediate doses omitted</td></tr>
                    </tbody>
                </table>
                <div style="background:var(--success-light);padding:12px;border-radius:8px;border:1px solid var(--success);font-size:13px;margin-top:12px">
                    <strong>✅ Overall RoB:</strong> Rate as Low / Some concerns / High / Very high. Consider GRADE downgrading for studies with high RoB. Confounding by indication is the primary threat in dose-response observational studies.
                </div>
            </div>

            <div class="btn-row" style="justify-content:space-between;margin-top:20px">
                <button class="download-btn" id="prevLessonBtn" onclick="prevLesson()" disabled>← Previous</button>
                <span id="lessonCounter" style="font-weight:600;color:var(--text-secondary)">1 / 5</span>
                <button class="copy-btn" id="nextLessonBtn" onclick="nextLesson()">Next →</button>
            </div>
        </div>
    </div>
</div>

<!-- ONBOARDING -->
<div class="onboarding" id="onboarding">
    <div class="onboarding-card">
        <div class="onboarding-header">
            <div style="font-size:32px;margin-bottom:8px">📈</div>
            <h2 style="font-size:22px;margin-bottom:4px">META-SPRINT UMBRELLA</h2>
            <p style="opacity:0.9;font-size:14px">Umbrella Review Meta-Analysis in 40 Days</p>
        </div>
        <div class="onboarding-body" id="step1">
            <div style="text-align:center;margin-bottom:20px">
                <div style="font-size:18px;font-weight:700;margin-bottom:8px">Eligibility Check</div>
                <p style="color:var(--text-secondary);font-size:13px">All criteria must be met for UMBRELLA workflow</p>
            </div>
            <div class="eligibility-list">
                <div class="elig-item" onclick="toggleElig(this)">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <div><strong>≤60 studies</strong> anticipated included</div>
                </div>
                <div class="elig-item" onclick="toggleElig(this)">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <div><strong>≥3 dose levels</strong> per study (including placebo/control)</div>
                </div>
                <div class="elig-item" onclick="toggleElig(this)">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <div><strong>Quantitative dose information</strong> extractable (mg, μg, units)</div>
                </div>
                <div class="elig-item" onclick="toggleElig(this)">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <div><strong>Continuous or dichotomous outcome</strong> at each dose level</div>
                </div>
                <div class="elig-item" onclick="toggleElig(this)">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <div><strong>Dose-response model feasible</strong> (overlapping dose ranges)</div>
                </div>
                <div class="elig-item" onclick="toggleElig(this)">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <div><strong>12-person team</strong> available (≤2h/day each)</div>
                </div>
            </div>
            <button class="start-btn" id="nextBtn1" disabled onclick="goToStep2()">Continue →</button>
        </div>
        <div id="step2" style="display:none">
            <div class="onboarding-body">
                <div style="text-align:center;margin-bottom:20px">
                    <div style="font-size:18px;font-weight:700;margin-bottom:8px">Select Your Role</div>
                    <p style="color:var(--text-secondary);font-size:13px">UMBRELLA requires specialized roles</p>
                </div>
                <div class="role-grid">
                    <button class="role-btn" onclick="selectRole(this, 'integrator')">
                        <div class="role-icon">🎯</div>
                        <div class="role-info"><div class="role-name">Integrator</div><div class="role-desc">Owns gates, timeline, audit pack, submission</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'deputy')">
                        <div class="role-icon">📋</div>
                        <div class="role-info"><div class="role-name">Deputy Integrator</div><div class="role-desc">Decision queue, backup analysis lead</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'search')">
                        <div class="role-icon">🔍</div>
                        <div class="role-info"><div class="role-name">Search & Screen Pod</div><div class="role-desc">2 people. Search, dedup, screen</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'fulltext')">
                        <div class="role-icon">📄</div>
                        <div class="role-info"><div class="role-name">Full-Text Pod</div><div class="role-desc">2 people. Retrieval, inclusion decisions</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'extraction')">
                        <div class="role-icon">📊</div>
                        <div class="role-info"><div class="role-name">Extraction & Quality Risk (RoB) Pod</div><div class="role-desc">4 people. dose-response data digitization, RoB</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'analysis')">
                        <div class="role-icon">🔗</div>
                        <div class="role-info"><div class="role-name">Umbrella Review Analysis Pod</div><div class="role-desc">1 person. Study registry, KM digitization, viability</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'modeling')">
                        <div class="role-icon">📈</div>
                        <div class="role-info"><div class="role-name">Modeling & Write Pod</div><div class="role-desc">1 person. Analysis, ROBINS-E, manuscript</div></div>
                    </button>
                </div>
                <button class="start-btn" id="startBtn" disabled onclick="startApp()">Start META-SPRINT UMBRELLA →</button>
            </div>
        </div>
    </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none">
    <div class="freeze-banner hidden" id="freezeBanner">🔒 FREEZE DAY 34 — No new studies, interventions, modifiers, or models</div>

    <header class="header">
        <div class="header-inner">
            <div class="logo">META-SPRINT <span class="nma-badge">UMBRELLA</span> <span>V1.0</span></div>
            <div class="header-controls">
                <div class="role-badge" id="roleBadge" tabindex="0" role="button" onclick="showRoleChange()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">Integrator</div>
                <div class="day-control">
                    <button class="day-btn" id="prevDayBtn" onclick="changeDay(-1)">←</button>
                    <div>
                        <div class="day-display" tabindex="0" role="button" onclick="showDayJump()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">Day <span id="dayNum">1</span>/40</div>
                        <div class="day-hint">click to jump</div>
                    </div>
                    <button class="day-btn" id="nextDayBtn" onclick="changeDay(1)">→</button>
                </div>
                <button class="day-btn" onclick="toggleDarkMode()" id="darkModeBtn">🌙</button>
                <button class="day-btn" onclick="openModal('settingsModal')">⚙️</button>
            </div>
        </div>
    </header>

    <div class="tabs" role="tablist">
        <button class="tab active" role="tab" aria-selected="true" onclick="showPage('today', this)">📋 Today</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('timeline', this)">📅 Timeline</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('accuracy', this)">📊 Umbrella Review</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('dod', this)">✅ Checkpoints (DoD)</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('rob', this)">⭐ ROBINS-E</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('stories', this)">📖 Stories</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('templates', this)">📝 Templates</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('reference', this)">📚 Reference</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('help', this)">❓ Help</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('glossary', this)">💡 Glossary</button>
    </div>

    <div class="container">
        <!-- TODAY PAGE -->
        <div class="page  role="tabpanel"active" id="page-today">
            <!-- Health Dashboard -->
            <div class="health-dashboard" id="healthDashboard">
                <div class="health-header">
                    <div class="health-title">🔗 UMBRELLA Project Health</div>
                    <div class="health-score" id="healthScore">--</div>
                </div>
                <div class="health-grid">
                    <div class="health-stat">
                        <div class="health-stat-value" id="daysRemaining">40</div>
                        <div class="health-stat-label">Days Left</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-stat-value" id="testCount">0</div>
                        <div class="health-stat-label">Studies</div>
                    </div>
                    <div class="health-stat" onclick="promptStudyCount()" style="cursor:pointer" title="Click to update">
                        <div class="health-stat-value" id="studyCount">0</div>
                        <div class="health-stat-label">Studies ✏️</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-stat-value" id="gatesPassed">0/5</div>
                        <div class="health-stat-label">Gates</div>
                    </div>
                </div>
                <div class="gate-dots">
                    <div class="gate-dot" id="gateA" title="DoD-A-UMBRELLA">A</div>
                    <div class="gate-dot" id="gateB" title="DoD-B-UMBRELLA">B</div>
                    <div class="gate-dot" id="gateC" title="DoD-C-UMBRELLA">C</div>
                    <div class="gate-dot" id="gateD" title="DoD-D-UMBRELLA">D</div>
                    <div class="gate-dot" id="gateE" title="DoD-E-UMBRELLA">E</div>
                </div>
            </div>

            <!-- Deadline Alerts -->
            
            <div class="risk-panel" id="riskPanel">
                <div class="risk-header">
                    <div class="risk-title">Project Risk</div>
                    <div class="risk-badge low" id="riskStatusBadge" aria-live="polite">LOW</div>
                </div>
                <ul class="risk-list" id="riskList" aria-live="polite">
                    <li class="risk-item">No active risks. Keep daily outputs on schedule.</li>
                </ul>
            </div>
            <div id="deadlineAlerts"></div>

            <!-- Achievements Panel -->
            <div class="achievements-panel" id="achievementsPanel">
                <div class="achievements-header">
                    <div class="achievements-title">🏆 Achievements <span class="achievements-count" id="achieveCount">0/10</span></div>
                    <button class="standup-btn" onclick="openStandupModal()">📋 Generate Standup</button>
                </div>
                <div class="achievements-grid" id="achievementsGrid">
                    <div class="achievement" id="ach-bootcamp" data-check="bootcamp">
                        <div class="achievement-icon">🎓</div>
                        <div class="achievement-name">Scholar</div>
                        <div class="achievement-desc">Complete UMBRELLA Bootcamp</div>
                    </div>
                    <div class="achievement" id="ach-protocol" data-check="dodA">
                        <div class="achievement-icon">🔒</div>
                        <div class="achievement-name">Protocol Locked</div>
                        <div class="achievement-desc">Pass DoD-A-UMBRELLA</div>
                    </div>
                    <div class="achievement" id="ach-accuracy" data-check="tests">
                        <div class="achievement-icon">🔬</div>
                        <div class="achievement-name">Study Registrar</div>
                        <div class="achievement-desc">Register 2+ studies</div>
                    </div>
                    <div class="achievement" id="ach-search" data-check="dodB">
                        <div class="achievement-icon">🔍</div>
                        <div class="achievement-name">Search Master</div>
                        <div class="achievement-desc">Pass DoD-B-UMBRELLA</div>
                    </div>
                    <div class="achievement" id="ach-prisma" data-check="prisma">
                        <div class="achievement-icon">📊</div>
                        <div class="achievement-name">PRISMA Complete</div>
                        <div class="achievement-desc">Fill all PRISMA counts</div>
                    </div>
                    <div class="achievement" id="ach-extraction" data-check="dodC">
                        <div class="achievement-icon">📋</div>
                        <div class="achievement-name">Data Extractor</div>
                        <div class="achievement-desc">Pass DoD-C-UMBRELLA</div>
                    </div>
                    <div class="achievement" id="ach-cinema" data-check="cinema">
                        <div class="achievement-icon">⭐</div>
                        <div class="achievement-name">Confidence Rated</div>
                        <div class="achievement-desc">Complete ROBINS-E</div>
                    </div>
                    <div class="achievement" id="ach-analysis" data-check="dodD">
                        <div class="achievement-icon">📈</div>
                        <div class="achievement-name">Analysis Complete</div>
                        <div class="achievement-desc">Pass DoD-D-UMBRELLA</div>
                    </div>
                    <div class="achievement" id="ach-stories" data-check="stories">
                        <div class="achievement-icon">📖</div>
                        <div class="achievement-name">Storyteller</div>
                        <div class="achievement-desc">Read all 4 stories</div>
                    </div>
                    <div class="achievement" id="ach-submission" data-check="dodE">
                        <div class="achievement-icon">🏁</div>
                        <div class="achievement-name">Submission Ready</div>
                        <div class="achievement-desc">Pass DoD-E-UMBRELLA</div>
                    </div>
                </div>
            </div>

            <!-- Standup Modal -->
            <div class="standup-modal" id="standupModal" role="dialog" aria-modal="true" onclick="closeStandupModal(event)">
                <div class="standup-card" onclick="event.stopPropagation()">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                        <div style="font-weight:700;font-size:16px">📋 Daily Standup</div>
                        <button onclick="closeStandupModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-muted)">×</button>
                    </div>
                    <div class="standup-section">
                        <div class="standup-label">✅ Yesterday (Completed)</div>
                        <div class="standup-items" id="standupYesterday">Loading...</div>
                    </div>
                    <div class="standup-section">
                        <div class="standup-label">📌 Today (Planned)</div>
                        <div class="standup-items" id="standupToday">Loading...</div>
                    </div>
                    <div class="standup-section">
                        <div class="standup-label">🚧 Blockers</div>
                        <div class="standup-items" id="standupBlockers">Loading...</div>
                    </div>
                    <div class="standup-section" style="background:var(--umbrella-light)">
                        <div class="standup-label" style="color:var(--umbrella)">📊 Status</div>
                        <div class="standup-items" id="standupStatus">Loading...</div>
                    </div>
                    <button class="standup-copy" onclick="copyStandup()">📋 Copy to Clipboard</button>
                </div>
            </div>

            <!-- Bootcamp (Day 1) -->
            <div class="bootcamp-card" id="bootcampCard">
                <div class="bootcamp-title">🎓 UMBRELLA Bootcamp (Day 1 — 45 min total)</div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Complete all modules before starting work</p>
                <div class="bootcamp-modules">
                    <div class="bootcamp-module" tabindex="0" onclick="toggleBootcamp(this, \'tests\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();this.click()}">
                        <div class="bootcamp-module-check">✓</div>
                        <div class="bootcamp-module-info">
                            <div class="bootcamp-module-name">1. Umbrella Review Fundamentals</div>
                            <div class="bootcamp-module-time">10 min</div>
                        </div>
                    </div>
                    <div class="bootcamp-module" tabindex="0" onclick="toggleBootcamp(this, \'applicability\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();this.click()}">
                        <div class="bootcamp-module-check">✓</div>
                        <div class="bootcamp-module-info">
                            <div class="bootcamp-module-name">2. Model Selection (Emax, Splines)</div>
                            <div class="bootcamp-module-time">10 min</div>
                        </div>
                    </div>
                    <div class="bootcamp-module" tabindex="0" onclick="toggleBootcamp(this, \'proportional-hazards\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();this.click()}">
                        <div class="bootcamp-module-check">✓</div>
                        <div class="bootcamp-module-info">
                            <div class="bootcamp-module-name">3. Pooling Umbrella Review Data</div>
                            <div class="bootcamp-module-time">10 min</div>
                        </div>
                    </div>
                    <div class="bootcamp-module" tabindex="0" onclick="toggleBootcamp(this, \'summary-measures\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();this.click()}">
                        <div class="bootcamp-module-check">✓</div>
                        <div class="bootcamp-module-info">
                            <div class="bootcamp-module-name">4. ED50, Emax & Clinical Interpretation</div>
                            <div class="bootcamp-module-time">5 min</div>
                        </div>
                    </div>
                    <div class="bootcamp-module" tabindex="0" onclick="toggleBootcamp(this, \'cinema\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();this.click()}">
                        <div class="bootcamp-module-check">✓</div>
                        <div class="bootcamp-module-info">
                            <div class="bootcamp-module-name">5. Risk of Bias (ROBINS-E / RoB 2)</div>
                            <div class="bootcamp-module-time">10 min</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Goal -->
            <div class="alert alert-info" id="todayGoal">
                <div class="alert-icon">🎯</div>
                <div class="alert-content">
                    <div class="alert-title">Today's Goal</div>
                    <div class="alert-text" id="goalText">Complete Bootcamp + Draft Study Registry v1</div>
                </div>
            </div>

            <!-- Tasks -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Your Tasks</div>
                    <div class="phase-badge phase-a" id="phaseBadge">Protocol</div>
                </div>
                <div class="card-body" id="tasksContainer">
                    <!-- Tasks rendered by JS -->
                </div>
            </div>
        </div>

        <!-- NETWORK PAGE -->
        <div class="page" role="tabpanel" id="page-accuracy">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">🔗 Umbrella Review Overview</div>
                    <span class="nma-indicator">UMBRELLA-SPECIFIC</span>
                </div>
                <div class="card-body">
                    <!-- Accuracy Graph Visualization -->
                    <div class="accuracy-graph" id="accuracyGraph">
                        <svg id="accuracySvg" viewBox="0 0 400 180">
                            <!-- Example accuracy - updates based on test count -->
                            <g id="accuracyEdges"></g>
                            <g id="accuracyTests"></g>
                        </svg>
                        <div style="text-align:center;font-size:11px;color:var(--text-muted);margin-top:8px">
                            Interactive preview • Updates when you save Study Registry
                        </div>
                    </div>

                    <div class="accuracy-preview">
                        <div class="accuracy-preview-title">Study Statistics</div>
                        <div class="accuracy-stats">
                            <div class="accuracy-stat">
                                <div class="accuracy-stat-value" id="netTests">0</div>
                                <div class="accuracy-stat-label">Studies</div>
                            </div>
                            <div class="accuracy-stat">
                                <div class="accuracy-stat-value" id="netEdges">0</div>
                                <div class="accuracy-stat-label">Pairwise Comparisons</div>
                            </div>
                            <div class="accuracy-stat">
                                <div class="accuracy-stat-value" id="netStudies">0</div>
                                <div class="accuracy-stat-label">Studies</div>
                            </div>
                        </div>
                    </div>

                    <h4 style="margin:16px 0 12px">Study Registry <span class="help-tip" data-tip="A Study Registry maps each treatment to a unique test ID. Lock at DoD-A. Max 12 tests for feasibility. Changes require CondGO.">?</span></h4>
                    <div class="form-row">
                        <textarea class="form-textarea" id="testDictionary" style="min-height:120px;font-family:'IBM Plex Mono',monospace;font-size:12px" placeholder="Node 1: Placebo&#10;Node 2: Drug A (all doses)&#10;Node 3: Drug B 10mg&#10;Node 4: Drug B 20mg&#10;..."></textarea>
                        <div class="form-hint">Lock at DoD-A-UMBRELLA. Max 12 tests.</div>
                    </div>
                    <button class="copy-btn" onclick="saveNodeDictionary()">Save Study Registry</button>

                    <h4 style="margin:24px 0 12px">Viability Status</h4>
                    <div id="viabilityStatus">
                        <div class="checklist-item">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Accuracy is connected</div></div>
                        </div>
                        <div class="checklist-item">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">≤12 interventions after mapping</div></div>
                        </div>
                        <div class="checklist-item">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Each test has ≥2 studies</div></div>
                        </div>
                        <div class="checklist-item">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Effect modifier missingness ≤40%</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PRISMA Flow Tracker -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📊 PRISMA Flow Tracker <span class="help-tip" data-tip="Track record counts through screening stages. Auto-validates that numbers are logically consistent.">?</span></div>
                    <span class="nma-indicator">Auto-Validated</span>
                </div>
                <div class="card-body">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
                        <div class="form-row" style="margin:0">
                            <label class="form-label" for="prismaIdentified" style="font-size:11px">Records Identified</label>
                            <input type="number" class="form-input" id="prismaIdentified" min="0" placeholder="0" onchange="validatePrisma();savePrismaFlow()">
                        </div>
                        <div class="form-row" style="margin:0">
                            <label class="form-label" for="prismaDuplicates" style="font-size:11px">Duplicates Removed</label>
                            <input type="number" class="form-input" id="prismaDuplicates" min="0" placeholder="0" onchange="validatePrisma();savePrismaFlow()">
                        </div>
                        <div class="form-row" style="margin:0">
                            <label class="form-label" for="prismaScreened" style="font-size:11px">Records Screened</label>
                            <input type="number" class="form-input" id="prismaScreened" min="0" placeholder="0" onchange="validatePrisma();savePrismaFlow()">
                            <div class="prisma-calc" id="calcScreened"></div>
                        </div>
                        <div class="form-row" style="margin:0">
                            <label class="form-label" for="prismaExcluded" style="font-size:11px">Excluded at T/A</label>
                            <input type="number" class="form-input" id="prismaExcluded" min="0" placeholder="0" onchange="validatePrisma();savePrismaFlow()">
                        </div>
                        <div class="form-row" style="margin:0">
                            <label class="form-label" for="prismaFullText" style="font-size:11px">Full-text Assessed</label>
                            <input type="number" class="form-input" id="prismaFullText" min="0" placeholder="0" onchange="validatePrisma();savePrismaFlow()">
                            <div class="prisma-calc" id="calcFullText"></div>
                        </div>
                        <div class="form-row" style="margin:0">
                            <label class="form-label" for="prismaIncluded" style="font-size:11px;color:var(--success);font-weight:700">✓ Studies Included</label>
                            <input type="number" class="form-input" id="prismaIncluded" min="0" placeholder="0" style="border-color:var(--success)" onchange="validatePrisma();savePrismaFlow();updateStudyCount()">
                        </div>
                    </div>
                    <div class="prisma-warning" id="prismaWarning" role="status" aria-live="polite"></div>
                    <div style="margin-top:12px;padding:10px;background:var(--bg);border-radius:6px;font-size:12px">
                        <strong>META-SPRINT target:</strong> 40-60 studies included. Current: <span id="prismaTarget" style="font-weight:700">0</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Statistical Model <span class="help-tip" data-tip="Dose-response meta-analysis pools effect estimates across dose levels. Choose model type (linear, Emax, spline) and pooling method.">?</span></div>
                    <span class="badge-essential" style="padding:4px 8px;border-radius:4px">Lock at DoD-A</span>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <label class="form-label">Umbrella Review Model Type</label>
                        <select class="form-input" id="modelMethod">
                            <option value="">Select...</option>
                            <option value="linear">Linear dose-response (constant slope)</option>
                            <option value="spline">Restricted cubic splines (flexible shape)</option>
                            <option value="emax">Emax / Sigmoid model (pharmacological)</option>
                            <option value="frac-poly">Fractional polynomial (complex patterns)</option>
                        </select>
                        <div class="form-hint">Linear = simple | Splines = flexible | Emax = plateau expected | Frac-poly = complex</div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Software & Package</label>
                        <select class="form-input" id="modelSoftware">
                            <option value="">Select...</option>
                            <option value="dosresmeta">R: dosresmeta package</option>
                            <option value="metafor">R: metafor (multivariate)</option>
                            <option value="stata">Stata: drmeta / glst</option>
                            <option value="bayesian">R: brms / rstanarm (Bayesian)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Handling Non-Linearity</label>
                        <input type="text" class="form-input" id="modelZeroCells" placeholder="e.g., Test Wald p-value for non-linear terms / Compare AIC across models">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Minimum Studies for Meta-analysis</label>
                        <input type="text" class="form-input" id="modelMinStudies" placeholder="e.g., ≥3 studies with ≥3 dose levels each">
                    </div>
                    <button class="copy-btn" onclick="saveModelContract()">Save Statistical Model</button>
                </div>
            </div>

            <!-- Effect Modifiers -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Effect Modifiers (for Applicability) <span class="help-tip" data-tip="Variables that could change treatment effects (age, dose, severity, duration). Track distribution across comparisons to assess applicability.">?</span></div>
                    <span class="nma-indicator">CRITICAL</span>
                </div>
                <div class="card-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">List variables that could modify treatment effects. These must be balanced across comparisons for applicability to hold.</p>
                    <div class="form-row">
                        <textarea class="form-textarea" id="effectModifiers" style="min-height:100px" placeholder="1. Disease severity (mild/moderate/severe)&#10;2. Prior treatment (naive/experienced)&#10;3. Age distribution&#10;4. Baseline risk&#10;5. Outcome definition&#10;6. Study era (pre/post 2010)"></textarea>
                        <div class="form-hint">Limit to ≤6 key modifiers. Lock at DoD-A.</div>
                    </div>
                    <button class="copy-btn" onclick="saveEffectModifiers()">Save Effect Modifiers</button>
                </div>
            </div>

            <!-- Applicability Assessment -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Applicability Assessment <span class="help-tip" data-tip="Applicability means studies are similar enough to combine. Effect modifiers (age, severity, dose) should be balanced across comparisons.">?</span></div>
                    <span class="badge-essential" style="padding:4px 8px;border-radius:4px">Required</span>
                </div>
                <div class="card-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Check each item if the condition is met. More checks = higher confidence in applicability.</p>
                    <div class="checklist-item" onclick="toggleApplicability(this, 'similar')">
                        <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="checklist-content">
                            <div class="checklist-title">Study populations are clinically similar across comparisons</div>
                            <div class="checklist-hint">Age, severity, comorbidities roughly comparable</div>
                        </div>
                    </div>
                    <div class="checklist-item" onclick="toggleApplicability(this, 'modifiers')">
                        <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="checklist-content">
                            <div class="checklist-title">Effect modifiers are balanced across comparisons</div>
                            <div class="checklist-hint">No systematic differences in key variables</div>
                        </div>
                    </div>
                    <div class="checklist-item" onclick="toggleApplicability(this, 'outcome')">
                        <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="checklist-content">
                            <div class="checklist-title">Outcome definitions are consistent</div>
                            <div class="checklist-hint">Same measure, same timepoint, same direction</div>
                        </div>
                    </div>
                    <div class="checklist-item" onclick="toggleApplicability(this, 'era')">
                        <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="checklist-content">
                            <div class="checklist-title">Study eras are comparable</div>
                            <div class="checklist-hint">No major practice changes between study periods</div>
                        </div>
                    </div>
                    <div class="checklist-item" onclick="toggleApplicability(this, 'dose')">
                        <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="checklist-content">
                            <div class="checklist-title">Dose/intensity groupings are clinically appropriate</div>
                            <div class="checklist-hint">Node definitions reflect meaningful clinical distinctions</div>
                        </div>
                    </div>
                    <div class="alert" id="applicabilityResult" style="margin-top:12px;display:none"></div>
                </div>
            </div>
        </div>

        <!-- DOD GATES PAGE -->
        <div class="page" role="tabpanel" id="page-dod">
            <div class="alert alert-info">
                <div class="alert-icon">🔗</div>
                <div class="alert-content">
                    <div class="alert-title">UMBRELLA-Specific Checkpoints (DoD)</div>
                    <div class="alert-text">All gates include UMBRELLA requirements: dose extraction, unit standardization, covariance structure, Emax/ED50 modeling, RoB</div>
                </div>
            </div>
            <div id="dodContainer">
                <!-- Rendered by JS -->
            </div>
        </div>

        <!-- ROBINS-E PAGE -->
        <div class="page" role="tabpanel" id="page-rob">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">⭐ ROBINS-E Risk of Bias Assessment <span class="help-tip" data-tip="ROBINS-E assesses 7 domains of bias in non-randomized studies of exposures. For RCTs, use RoB 2 instead.">?</span></div>
                    <span class="nma-indicator">UMBRELLA-SPECIFIC</span>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning" style="margin-bottom:16px">
                        <div class="alert-icon">⚠️</div>
                        <div class="alert-content">
                            <div class="alert-title">Required for DoD-D-UMBRELLA</div>
                            <div class="alert-text">Complete ROBINS-E for observational studies or RoB 2 for RCTs. High risk of bias should be reflected in GRADE assessment.</div>
                        </div>
                    </div>

                    <h4 style="margin-bottom:12px">ROBINS-E Domains <span style="font-size:11px;color:var(--text-muted)">(7 domains for observational studies)</span></h4>

                    <!-- Domain 1: Confounding -->
                    <div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:12px">
                        <div style="font-weight:600;color:var(--umbrella);margin-bottom:8px">1. Confounding</div>
                        <div style="display:grid;grid-template-columns:1fr;gap:12px">
                            <div>
                                <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Risk of Bias</div>
                                <select class="form-input" id="robins-confound" style="font-size:11px" title="Were baseline confounders measured and appropriately controlled?">
                                    <option value="">Rate...</option>
                                    <option value="low">Low risk</option>
                                    <option value="some">Some concerns</option>
                                    <option value="high">High risk</option>
                                    <option value="veryhigh">Very high risk</option>
                                </select>
                            </div>
                        </div>
                        <div style="font-size:10px;color:var(--text-muted);margin-top:6px">Key signals: Unmeasured confounders | No adjustment | Immortal time bias</div>
                    </div>

                    <!-- Domain 2: Selection -->
                    <div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:12px">
                        <div style="font-weight:600;color:var(--umbrella);margin-bottom:8px">2. Selection of Participants</div>
                        <div style="display:grid;grid-template-columns:1fr;gap:12px">
                            <div>
                                <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Risk of Bias</div>
                                <select class="form-input" id="robins-selection" style="font-size:11px" title="Was selection into the study related to exposure and outcome?">
                                    <option value="">Rate...</option>
                                    <option value="low">Low risk</option>
                                    <option value="some">Some concerns</option>
                                    <option value="high">High risk</option>
                                    <option value="veryhigh">Very high risk</option>
                                </select>
                            </div>
                        </div>
                        <div style="font-size:10px;color:var(--text-muted);margin-top:6px">Key signals: Selection based on response | Prevalent user bias | Selection on mediators</div>
                    </div>

                    <!-- Domain 3: Exposure Classification -->
                    <div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:12px">
                        <div style="font-weight:600;color:var(--umbrella);margin-bottom:8px">3. Classification of Exposure</div>
                        <div style="display:grid;grid-template-columns:1fr;gap:12px">
                            <div>
                                <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Risk of Bias</div>
                                <select class="form-input" id="robins-exposure" style="font-size:11px" title="Was exposure status accurately measured?">
                                    <option value="">Rate...</option>
                                    <option value="low">Low risk</option>
                                    <option value="some">Some concerns</option>
                                    <option value="high">High risk</option>
                                    <option value="veryhigh">Very high risk</option>
                                </select>
                            </div>
                        </div>
                        <div style="font-size:10px;color:var(--text-muted);margin-top:6px">Key signals: Misclassification of treatment | Time-varying exposure not captured</div>
                    </div>

                    <!-- Domain 4: Post-exposure Interventions -->
                    <div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:12px">
                        <div style="font-weight:600;color:var(--umbrella);margin-bottom:8px">4. Post-exposure Interventions</div>
                        <div style="display:grid;grid-template-columns:1fr;gap:12px">
                            <div>
                                <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Risk of Bias</div>
                                <select class="form-input" id="robins-postexp" style="font-size:11px" title="Were co-interventions balanced? Could they affect the outcome?">
                                    <option value="">Rate...</option>
                                    <option value="low">Low risk</option>
                                    <option value="some">Some concerns</option>
                                    <option value="high">High risk</option>
                                    <option value="veryhigh">Very high risk</option>
                                </select>
                            </div>
                        </div>
                        <div style="font-size:10px;color:var(--text-muted);margin-top:6px">Key signals: Unbalanced supportive care | Treatment switching | Rescue therapies</div>
                    </div>

                    <!-- Domain 5: Missing Data -->
                    <div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:12px">
                        <div style="font-weight:600;color:var(--umbrella);margin-bottom:8px">5. Missing Data</div>
                        <div style="display:grid;grid-template-columns:1fr;gap:12px">
                            <div>
                                <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Risk of Bias</div>
                                <select class="form-input" id="robins-missing" style="font-size:11px" title="Could missing data affect the results?">
                                    <option value="">Rate...</option>
                                    <option value="low">Low risk</option>
                                    <option value="some">Some concerns</option>
                                    <option value="high">High risk</option>
                                    <option value="veryhigh">Very high risk</option>
                                </select>
                            </div>
                        </div>
                        <div style="font-size:10px;color:var(--text-muted);margin-top:6px">Key signals: High loss to follow-up | Differential censoring | Missing covariate data</div>
                    </div>

                    <!-- Domain 6: Outcome Measurement -->
                    <div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:12px">
                        <div style="font-weight:600;color:var(--umbrella);margin-bottom:8px">6. Measurement of Outcomes</div>
                        <div style="display:grid;grid-template-columns:1fr;gap:12px">
                            <div>
                                <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Risk of Bias</div>
                                <select class="form-input" id="robins-outcome" style="font-size:11px" title="Was outcome measurement valid and unbiased?">
                                    <option value="">Rate...</option>
                                    <option value="low">Low risk</option>
                                    <option value="some">Some concerns</option>
                                    <option value="high">High risk</option>
                                    <option value="veryhigh">Very high risk</option>
                                </select>
                            </div>
                        </div>
                        <div style="font-size:10px;color:var(--text-muted);margin-top:6px">Key signals: Outcome assessors not blinded | Different follow-up by group | Competing risks</div>
                    </div>

                    <!-- Domain 7: Selective Reporting -->
                    <div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:12px">
                        <div style="font-weight:600;color:var(--umbrella);margin-bottom:8px">7. Selection of Reported Result</div>
                        <div style="display:grid;grid-template-columns:1fr;gap:12px">
                            <div>
                                <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Risk of Bias</div>
                                <select class="form-input" id="robins-reporting" style="font-size:11px" title="Could multiple analyses have been conducted with only favorable ones reported?">
                                    <option value="">Rate...</option>
                                    <option value="low">Low risk</option>
                                    <option value="some">Some concerns</option>
                                    <option value="high">High risk</option>
                                    <option value="veryhigh">Very high risk</option>
                                </select>
                            </div>
                        </div>
                        <div style="font-size:10px;color:var(--text-muted);margin-top:6px">Key signals: No protocol | Multiple timepoints analyzed | Selected subgroups reported</div>
                    </div>

                    <!-- ROBINS-E Summary -->
                    <div style="background:var(--umbrella-light);padding:12px;border-radius:8px;margin-bottom:16px;font-size:12px;border:1px solid var(--umbrella)">
                        <strong>ROBINS-E Quick Reference:</strong>
                        <ul style="margin:8px 0 0 16px;line-height:1.8">
                            <li><strong>Confounding:</strong> Were key prognostic factors balanced or adjusted?</li>
                            <li><strong>Selection:</strong> Was study entry related to both exposure and outcome?</li>
                            <li><strong>Exposure:</strong> Was treatment/exposure accurately classified?</li>
                            <li><strong>Post-exposure:</strong> Were co-interventions balanced across groups?</li>
                            <li><strong>Missing data:</strong> Was follow-up complete? Differential censoring?</li>
                            <li><strong>Outcome:</strong> Was outcome measurement valid and blinded?</li>
                            <li><strong>Reporting:</strong> Was the analysis pre-specified?</li>
                        </ul>
                    </div>

                    <div class="form-row">
                        <label class="form-label">Overall Risk of Bias</label>
                        <select class="form-input" id="robins-overall">
                            <option value="">Calculate from domains...</option>
                            <option value="high">High</option>
                            <option value="moderate">Moderate</option>
                            <option value="low">Low</option>
                            <option value="verylow">Very Low</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label class="form-label">Justification</label>
                        <textarea class="form-textarea" id="robins-justification" placeholder="Explain overall rating and key concerns..."></textarea>
                    </div>

                    <div class="btn-row">
                        <button class="copy-btn" onclick="saveRobinsE()">Save ROBINS-E Assessment</button>
                        <button class="download-btn" onclick="generateRobinsEReport()">Generate Report</button>
                    </div>
                    <div class="template-output" id="robins-output"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Ranking Suppression Check</div>
                </div>
                <div class="card-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Summary dose-response curve is reported <strong>only if ALL conditions pass</strong>:</p>
                    <div id="rankingChecks">
                        <div class="checklist-item" onclick="toggleRankCheck(this, 'confidence')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content">
                                <div class="checklist-title">ROBINS-E confidence NOT "Low" for key contrasts</div>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="toggleRankCheck(this, 'incoherence')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content">
                                <div class="checklist-title">No severe incoherence (global/local) affecting key contrasts</div>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="toggleRankCheck(this, 'applicability')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content">
                                <div class="checklist-title">Applicability concerns NOT "High"</div>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="toggleRankCheck(this, 'clinical')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content">
                                <div class="checklist-title">Effect sizes are clinically meaningful</div>
                            </div>
                        </div>
                    </div>
                    <div class="alert" id="rankingResult" style="margin-top:12px;display:none">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- TIMELINE PAGE -->
        <div class="page" role="tabpanel" id="page-timeline">
            <div class="card">
                <div class="card-header"><div class="card-title">40-Day UMBRELLA Timeline</div></div>
                <div class="card-body">
                    <div class="timeline-bar" role="progressbar" aria-valuemin="0" aria-valuemax="40" aria-valuenow="1" aria-label="Sprint progress"><div class="timeline-fill" id="timelineFill" style="width:0%"></div></div>
                    <div class="timeline-markers">
                        <div class="timeline-marker">D4<br>DoD-A</div>
                        <div class="timeline-marker">D12<br>DoD-B</div>
                        <div class="timeline-marker">D20<br>Audit1</div>
                        <div class="timeline-marker">D28<br>DoD-C</div>
                        <div class="timeline-marker">D34<br>DoD-D</div>
                        <div class="timeline-marker">D34<br>Freeze</div>
                        <div class="timeline-marker">D40<br>Submit</div>
                    </div>
                    <table class="ref-table" style="margin-top:24px">
                        <thead><tr><th>Phase</th><th>Days</th><th>Key Deliverables</th></tr></thead>
                        <tbody>
                            <tr><td><strong>DoD-A-UMBRELLA</strong></td><td>1-4</td><td>Protocol + Statistical Model + Study Registry locked</td></tr>
                            <tr><td><strong>DoD-B-UMBRELLA</strong></td><td>6-12</td><td>Search complete + Meta-analysis feasibility confirmed</td></tr>
                            <tr><td><strong>DoD-C-UMBRELLA</strong></td><td>12-28</td><td>dose-response data digitization + Mapping locked</td></tr>
                            <tr><td><strong>DoD-D-UMBRELLA</strong></td><td>24-34</td><td>Model + ROBINS-E + Consistency + Summary Umbrella Review</td></tr>
                            <tr><td><strong>DoD-E-UMBRELLA</strong></td><td>34-40</td><td>PRISMA + Reruns + Submission</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Workload Summary -->
            <div class="card">
                <div class="card-header"><div class="card-title">Weekly Workload Summary (12 people × ≤2h/day)</div></div>
                <div class="card-body">
                    <table class="ref-table" style="font-size:12px">
                        <thead>
                            <tr><th>Week</th><th>Days</th><th>Primary Focus</th><th>Pods Active</th><th>Est. Hours/Person</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>Week 1</strong></td><td>1-7</td><td>Bootcamp → Protocol → Search</td><td>All → Search Pod</td><td>~1.5h</td></tr>
                            <tr><td><strong>Week 2</strong></td><td>8-14</td><td>Screen → Viability → DoD-B</td><td>Search + Accuracy</td><td>~2h</td></tr>
                            <tr><td><strong>Week 3</strong></td><td>15-21</td><td>Full-text → Extract → Audit 1</td><td>Full-text + Extraction</td><td>~2h</td></tr>
                            <tr><td><strong>Week 4</strong></td><td>22-28</td><td>Extraction → Mapping → DoD-C</td><td>Extraction + Accuracy</td><td>~2h</td></tr>
                            <tr><td><strong>Week 5</strong></td><td>29-35</td><td>Analysis → ROBINS-E → Audit 2 → FREEZE</td><td>Modeling + All QA</td><td>~2h</td></tr>
                            <tr><td><strong>Week 6</strong></td><td>36-40</td><td>Write → Rerun → Submit</td><td>Modeling + Integrator</td><td>~1.5h</td></tr>
                        </tbody>
                    </table>
                    <div class="alert alert-info" style="margin-top:16px">
                        <div class="alert-icon">💡</div>
                        <div class="alert-content">
                            <div class="alert-title">Total: ~240 person-hours over 40 days</div>
                            <div class="alert-text">12 people × 2h/day × 40 days = 960h capacity. UMBRELLA uses ~25% for buffer/meetings.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PRISMA Checklist -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">PRISMA Checklist</div>
                    <span class="nma-indicator">Required for DoD-E</span>
                </div>
                <div class="card-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Complete all PRISMA items before submission.</p>
                    <div id="prismaNmaChecklist">
                        <div class="checklist-item" onclick="togglePrisma(this, 'title')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Title identifies as dose-response meta-analysis</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'geometry')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Accuracy geometry described (tests, edges, direct comparisons)</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'methods')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Statistical methods for dose-response modeling described (model type, software, pooling method)</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'applicability')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Applicability assumption assessment reported</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'consistency')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Consistency/coherence evaluation reported (global + local)</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'league')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Summary accuracy table or forest plot of all comparisons included</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'ranking')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Ranking probabilities reported with uncertainty (or suppression justified)</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'cinema')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">ROBINS-E confidence assessment for key comparisons</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'heterogeneity')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Heterogeneity quantified (τ², I², prediction intervals)</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'sensitivity')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Sensitivity analyses results reported</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STORIES PAGE: Evidence Reversal Stories -->
        <div class="page" role="tabpanel" id="page-stories">
            <div class="alert alert-info" style="margin-bottom:20px">
                <div class="alert-icon">📖</div>
                <div class="alert-content">
                    <div class="alert-title">Evidence Reversal Stories</div>
                    <div class="alert-text">Learn from cases where proper dose-response meta-analysis methodology revealed the truth — or where ignoring it led to harm. Click each story to expand.</div>
                </div>
            </div>

            <!-- STORY 1: The Linear Assumption -->
            <div class="story-card">
                <div class="story-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleStory(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="story-number">Story One</div>
                    <div class="story-title">The Line That Wasn't Straight</div>
                    <div class="story-hook">"Higher dose = better effect! Let's double it..." But what happens at high doses?</div>
                </div>
                <div class="story-body">
                    <div class="story-scene">
                        <div class="scene-label">🌅 The Beginning</div>
                        <div class="scene-content">
                            <p>A meta-analysis of 12 trials modeled the dose-response relationship as linear. Slope: <strong>2.5 mmHg reduction per 10mg</strong>. Guidelines recommended: "Higher doses for resistant hypertension."</p>
                            <p style="margin-top:12px">Manufacturers pushed 80mg tablets. Clinicians prescribed aggressively. Patients took more.</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">❓ The Question You Must Ask</div>
                        <div class="story-question">
                            Did anyone test whether the relationship was actually linear? What happens at the high end of the dose range?
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">🔍 The Hidden Truth</div>
                        <div class="scene-content">
                            <p>A re-analysis using restricted cubic splines revealed:</p>
                            <ul style="margin:12px 0 0 20px">
                                <li><strong>0-40mg:</strong> Strong dose-response (as expected)</li>
                                <li><strong>40-60mg:</strong> Effect plateaued — Emax reached</li>
                                <li><strong>Above 60mg:</strong> No additional benefit, but toxicity increased</li>
                                <li><strong>Non-linearity test:</strong> p < 0.001 — linear model rejected</li>
                            </ul>
                            <p style="margin-top:12px">The linear extrapolation was <strong>dangerous fiction</strong>. Patients on 80mg got no extra benefit but double the side effects.</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">⚖️ Two Paths</div>
                        <div class="story-contrast">
                            <div class="contrast-box contrast-wrong">
                                <div class="contrast-label">❌ What They Did</div>
                                <p style="font-size:13px">Assumed linearity without testing. Extrapolated beyond observed range. Ignored plateau.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Patients overtreated. Unnecessary toxicity. Wasted resources.</p>
                            </div>
                            <div class="contrast-box contrast-right">
                                <div class="contrast-label">✅ What META-SPRINT Would Do</div>
                                <p style="font-size:13px">Test multiple models (linear, Emax, splines). Report non-linearity test. Identify optimal dose range. Flag plateau.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Appropriate dosing. Minimal toxicity. Better outcomes.</p>
                            </div>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="story-moral">
                            <div class="moral-label">📜 The Lesson</div>
                            <div class="moral-text">Linear models are convenient but often wrong. Most biological dose-response curves plateau. Always test for non-linearity. Never extrapolate beyond observed dose ranges.</div>
                        </div>
                        <div class="story-reflection">
                            <div class="reflection-question">🤔 Reflect: Have you tested whether your dose-response curve is truly linear? Have you identified the plateau?</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STORY 2: Confounding by Indication -->
            <div class="story-card">
                <div class="story-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleStory(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="story-number">Story Two</div>
                    <div class="story-title">The Dose That Killed (Or Did It?)</div>
                    <div class="story-hook">"High-dose patients have 3x mortality! The drug is dangerous at high doses..." But is it the dose?</div>
                </div>
                <div class="story-body">
                    <div class="story-scene">
                        <div class="scene-label">🌅 The Beginning</div>
                        <div class="scene-content">
                            <p>An observational dose-response meta-analysis found: <strong>Mortality increased 15% per 10mg dose increase</strong>. Regulators panicked. Black box warning added.</p>
                            <p style="margin-top:12px">Physicians stopped prescribing high doses. Patients with severe disease were undertreated.</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">❓ The Question You Must Ask</div>
                        <div class="story-question">
                            Why did some patients get higher doses? Were they sicker to begin with? Is this confounding by indication?
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">🔍 The Hidden Truth</div>
                        <div class="scene-content">
                            <p>A careful re-analysis accounting for disease severity revealed:</p>
                            <ul style="margin:12px 0 0 20px">
                                <li><strong>High-dose patients:</strong> Had 2x worse baseline disease severity</li>
                                <li><strong>Confounding:</strong> Sicker patients → higher doses → worse outcomes (NOT due to dose)</li>
                                <li><strong>After adjustment:</strong> No significant dose-mortality relationship</li>
                                <li><strong>Actually:</strong> Higher doses HELPED sicker patients (reduced mortality by 10%)</li>
                            </ul>
                            <p style="margin-top:12px">The apparent danger was <strong>confounding by indication</strong>. The dose wasn't killing patients — the disease was.</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">⚖️ Two Paths</div>
                        <div class="story-contrast">
                            <div class="contrast-box contrast-wrong">
                                <div class="contrast-label">❌ What They Did</div>
                                <p style="font-size:13px">Pooled unadjusted observational data. Ignored confounding by indication. Concluded dose is harmful.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Patients with severe disease denied effective treatment. Excess deaths from undertreating.</p>
                            </div>
                            <div class="contrast-box contrast-right">
                                <div class="contrast-label">✅ What META-SPRINT Would Do</div>
                                <p style="font-size:13px">Use ROBINS-E. Require confounder adjustment. Sensitivity analysis for unmeasured confounding. Triangulate with RCT data.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Appropriate caution with observational data. Better treatment for sick patients.</p>
                            </div>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="story-moral">
                            <div class="moral-label">📜 The Lesson</div>
                            <div class="moral-text">In observational dose-response studies, confounding by indication is the primary threat. Sicker patients get higher doses. Always assess ROBINS-E. Always adjust for disease severity. Never trust unadjusted observational dose-response.</div>
                        </div>
                        <div class="story-reflection">
                            <div class="reflection-question">🤔 Reflect: Why did patients in your studies receive different doses? Have you adjusted for baseline severity?</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STORY 3: The Missing Doses -->
            <div class="story-card">
                <div class="story-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleStory(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="story-number">Story Three</div>
                    <div class="story-title">The Doses That Disappeared</div>
                    <div class="story-hook">"Clear dose-response! The evidence is compelling..." But where did some doses go?</div>
                </div>
                <div class="story-body">
                    <div class="story-scene">
                        <div class="scene-label">🌅 The Beginning</div>
                        <div class="scene-content">
                            <p>A meta-analysis pooled 8 trials testing doses of 10, 25, 50, and 100mg. Clear monotonic dose-response: <strong>each doubling of dose = 3 mmHg additional reduction</strong>.</p>
                            <p style="margin-top:12px">Regulators approved 100mg. Marketing pushed "maximum efficacy at maximum dose."</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">❓ The Question You Must Ask</div>
                        <div class="story-question">
                            Were all tested doses reported? Did any trials test intermediate doses (e.g., 75mg)? What happened to negative results?
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">🔍 The Hidden Truth</div>
                        <div class="scene-content">
                            <p>Freedom of Information requests revealed hidden trial arms:</p>
                            <ul style="margin:12px 0 0 20px">
                                <li><strong>Study A:</strong> 75mg arm dropped for "operational reasons" — actually showed toxicity</li>
                                <li><strong>Study B:</strong> 200mg arm not reported — caused severe adverse events</li>
                                <li><strong>Study C:</strong> Original protocol had 150mg — removed before publication</li>
                                <li><strong>Study D:</strong> Placebo response unusually low — inflated apparent effect</li>
                            </ul>
                            <p style="margin-top:12px">The "clear dose-response" was <strong>selective reporting</strong>. The true curve showed plateau at 50mg and harm above 100mg.</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">⚖️ Two Paths</div>
                        <div class="story-contrast">
                            <div class="contrast-box contrast-wrong">
                                <div class="contrast-label">❌ What They Did</div>
                                <p style="font-size:13px">Used only published doses. Didn't check trial registrations for all planned arms. Assumed monotonicity.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Incomplete dose-response curve. Hidden toxicity. Patients harmed by high doses.</p>
                            </div>
                            <div class="contrast-box contrast-right">
                                <div class="contrast-label">✅ What META-SPRINT Would Do</div>
                                <p style="font-size:13px">Check trial registrations for all planned doses. Request unpublished arms. Assess for selective dose reporting. Funnel plot by dose.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Complete dose-response picture. Identified toxic threshold. Safer recommendations.</p>
                            </div>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="story-moral">
                            <div class="moral-label">📜 The Lesson</div>
                            <div class="moral-text">Selective dose reporting is common. Negative dose arms often disappear. Always check registrations for planned doses. Always ask: "Were all tested doses published?"</div>
                        </div>
                        <div class="story-reflection">
                            <div class="reflection-question">🤔 Reflect: Have you checked trial registrations for all originally planned dose arms? Have you contacted authors about unpublished doses?</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STORY 4: The U-Shape No One Expected -->
            <div class="story-card">
                <div class="story-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleStory(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="story-number">Story Four</div>
                    <div class="story-title">The U-Shape No One Expected</div>
                    <div class="story-hook">"More is better! Increase the dose for maximum effect..." But what if the curve bends back?</div>
                </div>
                <div class="story-body">
                    <div class="story-scene">
                        <div class="scene-label">🌅 The Beginning</div>
                        <div class="scene-content">
                            <p>A meta-analysis of vitamin D supplementation showed: <strong>higher doses = better bone density</strong>. Linear dose-response up to 4000 IU/day. "The more the better!"</p>
                            <p style="margin-top:12px">Supplement manufacturers marketed mega-doses. Patients took 10,000+ IU daily. Sales exploded.</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">❓ The Question You Must Ask</div>
                        <div class="story-question">
                            Did the studies test very high doses? Is the relationship truly monotonic? Can there be harm at high doses?
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">🔍 The Hidden Truth</div>
                        <div class="scene-content">
                            <p>A new meta-analysis including high-dose studies revealed:</p>
                            <ul style="margin:12px 0 0 20px">
                                <li><strong>0-2000 IU:</strong> Clear benefit, as expected</li>
                                <li><strong>2000-4000 IU:</strong> Plateau — no additional benefit</li>
                                <li><strong>Above 4000 IU:</strong> Effect reversed — INCREASED fracture risk</li>
                                <li><strong>Above 10,000 IU:</strong> Hypercalcemia, kidney stones, harm</li>
                            </ul>
                            <p style="margin-top:12px">The dose-response was <strong>U-shaped or inverted-U</strong>. The original linear model was dangerous extrapolation.</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">⚖️ Two Paths</div>
                        <div class="story-contrast">
                            <div class="contrast-box contrast-wrong">
                                <div class="contrast-label">❌ What They Did</div>
                                <p style="font-size:13px">Assumed monotonicity. Extrapolated linear model. Ignored sparse high-dose data.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Patients harmed by mega-doses. Fractures increased. Hypercalcemia hospitalizations.</p>
                            </div>
                            <div class="contrast-box contrast-right">
                                <div class="contrast-label">✅ What META-SPRINT Would Do</div>
                                <p style="font-size:13px">Test for non-monotonicity. Use flexible splines. Identify optimal dose RANGE. Flag potential harm at extremes.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Clear optimal range. Avoid toxic doses. Better patient outcomes.</p>
                            </div>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="story-moral">
                            <div class="moral-label">📜 The Lesson</div>
                            <div class="moral-text">"More is better" is often wrong. Many dose-response relationships are U-shaped or plateau. Test for non-monotonicity. Use flexible models. Never extrapolate beyond observed data.</div>
                        </div>
                        <div class="story-reflection">
                            <div class="reflection-question">🤔 Reflect: Have you tested whether your dose-response is monotonic? Have you looked for harm at high doses?</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📜 The Four Lessons</div>
                </div>
                <div class="card-body">
                    <div style="display:grid;gap:12px">
                        <div style="padding:12px;background:var(--bg);border-radius:8px;border-left:4px solid var(--umbrella)">
                            <strong>1. Linear models are convenient but often wrong.</strong><br>
                            <span style="font-size:13px;color:var(--text-secondary)">Always test for non-linearity. Use flexible models. Never blindly extrapolate.</span>
                        </div>
                        <div style="padding:12px;background:var(--bg);border-radius:8px;border-left:4px solid var(--success)">
                            <strong>2. Confounding by indication corrupts observational data.</strong><br>
                            <span style="font-size:13px;color:var(--text-secondary)">Sicker patients get higher doses. Always adjust for baseline severity. Use ROBINS-E.</span>
                        </div>
                        <div style="padding:12px;background:var(--bg);border-radius:8px;border-left:4px solid var(--warning)">
                            <strong>3. Selective dose reporting hides the truth.</strong><br>
                            <span style="font-size:13px;color:var(--text-secondary)">Check registrations for all planned doses. Ask about unpublished arms. Complete the picture.</span>
                        </div>
                        <div style="padding:12px;background:var(--bg);border-radius:8px;border-left:4px solid var(--purple)">
                            <strong>4. "More is better" is often wrong.</strong><br>
                            <span style="font-size:13px;color:var(--text-secondary)">Test for U-shapes. Identify optimal range. Look for harm at high doses.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TEMPLATES PAGE -->
        <div class="page" role="tabpanel" id="page-templates">
            <div class="alert alert-info">
                <div class="alert-icon">📝</div>
                <div class="alert-content">
                    <div class="alert-title">UMBRELLA Templates</div>
                    <div class="alert-text">Templates marked with 🔗 are UMBRELLA-specific additions to the standard META-SPRINT pack</div>
                </div>
            </div>

            <!-- Statistical Model Template -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔗 Appendix B: Statistical Model <span class="template-badge badge-nma">UMBRELLA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Lock at DoD-A-UMBRELLA. No changing priors/estimators mid-stream except via CondGO.</p>
                    <div class="form-row">
                        <label class="form-label">Method Choice</label>
                        <select class="form-input" id="mc-method">
                            <option value="freq">Frequentist random-effects dose-response modeling</option>
                            <option value="bayes">Bayesian random-effects dose-response modeling</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Estimator (Freq) / Prior Policy (Bayes)</label>
                        <input type="text" class="form-input" id="mc-estimator" placeholder="e.g., REML / Half-normal(0,0.5)">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Multi-threshold Handling</label>
                        <input type="text" class="form-input" id="mc-multiarm" placeholder="e.g., Correlation adjustment for shared arms">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Global Non-Linearity Test</label>
                        <input type="text" class="form-input" id="mc-global" placeholder="e.g., Design-by-treatment interaction">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Study-Level Model Fit</label>
                        <input type="text" class="form-input" id="mc-local" placeholder="e.g., Node-splitting">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Convergence Criteria (Bayes only)</label>
                        <input type="text" class="form-input" id="mc-convergence" placeholder="e.g., R-hat < 1.05, ESS > 400">
                    </div>
                    <div class="btn-row">
                        <button class="copy-btn" onclick="generateModelContract()">Generate & Copy</button>
                    </div>
                    <div class="template-output" id="mc-output"></div>
                </div>
            </div>

            <!-- Ranking Policy Template -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔗 Appendix C: Ranking Policy <span class="template-badge badge-nma">UMBRELLA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Summary Umbrella Review are optional and never the primary claim. Lock suppression rule at DoD-A.</p>
                    <div class="alert alert-warning">
                        <div class="alert-icon">⚠️</div>
                        <div class="alert-content">
                            <div class="alert-title">Suppression Rule</div>
                            <div class="alert-text">If ANY condition fails: suppress summary accuracy and report only effect estimates with uncertainty + confidence grading.</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Ranking Metric</label>
                        <select class="form-input" id="rp-metric">
                            <option value="">Select...</option>
                            <option value="sucra">Sensitivity</option>
                            <option value="pscore">P-score</option>
                            <option value="posterior">Posterior rank probabilities</option>
                            <option value="none">Not reporting summary accuracy</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Suppression Decision</label>
                        <select class="form-input" id="rp-suppress">
                            <option value="">Select...</option>
                            <option value="report">Report summary accuracy (all conditions pass)</option>
                            <option value="suppress">Suppress summary accuracy (conditions failed)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Justification</label>
                        <textarea class="form-textarea" id="rp-justify" placeholder="Why summary accuracy are/aren't reported..."></textarea>
                    </div>
                    <button class="copy-btn" onclick="generateRankingPolicy()">Generate & Copy</button>
                    <div class="template-output" id="rp-output"></div>
                </div>
            </div>

            <!-- Umbrella Review Viability Report -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔗 Appendix D: Umbrella Review Viability Report <span class="template-badge badge-nma">UMBRELLA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Complete at DoD-B-UMBRELLA. Required to proceed as UMBRELLA.</p>
                    <div class="form-row">
                        <label class="form-label">Intervention Count</label>
                        <input type="number" class="form-input" id="nv-tests" placeholder="e.g., 8">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Study Count</label>
                        <input type="number" class="form-input" id="nv-studies" placeholder="e.g., 45">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Data Availability</label>
                        <select class="form-input" id="nv-connected">
                            <option value="">Select...</option>
                            <option value="connected">All studies have HR or dose-response datas</option>
                            <option value="components">Some studies require figure digitization</option>
                            <option value="disconnected">Insufficient data for meta-analysis</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Sparsity Flags</label>
                        <textarea class="form-textarea" id="nv-sparse" placeholder="List any tests with minimal evidence..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Effect Modifier Missingness</label>
                        <input type="text" class="form-input" id="nv-missing" placeholder="e.g., Age: 15%, Baseline severity: 22%">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Viability Decision</label>
                        <select class="form-input" id="nv-decision">
                            <option value="">Select...</option>
                            <option value="proceed">PROCEED as UMBRELLA</option>
                            <option value="restrict">RESTRICT (document limitations)</option>
                            <option value="route">ROUTE OUT (not viable for UMBRELLA)</option>
                        </select>
                    </div>
                    <button class="copy-btn" onclick="generateViabilityReport()">Generate & Copy</button>
                    <div class="template-output" id="nv-output"></div>
                </div>
            </div>

            <!-- Dose Extraction Quality Checklist -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔗 Appendix E: Dose Extraction Quality Checklist <span class="template-badge badge-nma">UMBRELLA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Complete for each study requiring dose data extraction from figures or tables. Required for DoD-C-UMBRELLA.</p>
                    <div class="form-row">
                        <label class="form-label">Study ID</label>
                        <input type="text" class="form-input" id="ipd-study" placeholder="e.g., Smith 2020">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Data Source Quality</label>
                        <select class="form-input" id="ipd-quality">
                            <option value="">Select...</option>
                            <option value="high">High (tabulated data, clear dose units)</option>
                            <option value="medium">Medium (figure with clear axes)</option>
                            <option value="low">Low (figure digitization needed)</option>
                            <option value="unacceptable">Unacceptable (cannot reliably extract)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Number of Dose Levels Reported</label>
                        <select class="form-input" id="ipd-nar">
                            <option value="">Select...</option>
                            <option value="yes-complete">≥4 dose levels (excellent)</option>
                            <option value="yes-partial">3 dose levels (adequate)</option>
                            <option value="no">2 dose levels only (limited)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Dose Unit Standardization</label>
                        <select class="form-input" id="ipd-tool">
                            <option value="">Select...</option>
                            <option value="webplot">Direct extraction (same units)</option>
                            <option value="engauge">Conversion required (documented)</option>
                            <option value="digitizeit">Unclear units (contacted authors)</option>
                            <option value="other">Other (specify in notes)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Validation Against Reported Summary (if available)</label>
                        <input type="text" class="form-input" id="ipd-validation" placeholder="e.g., Reported slope=2.5, Extracted slope=2.4 (within 5%)">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Extraction Notes</label>
                        <textarea class="form-textarea" id="ipd-notes" placeholder="Document any issues: dose range limitations, missing n per dose, unit conversion assumptions..."></textarea>
                    </div>
                    <button class="copy-btn" onclick="generateIPDReport()">Generate & Copy</button>
                    <div class="template-output" id="ipd-output"></div>
                </div>
            </div>

            <!-- Clinical Summary UMBRELLA -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔗 Appendix J-UMBRELLA: Clinical Summary Panel <span class="template-badge badge-nma">UMBRELLA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Mandatory interpretation layer for UMBRELLA submissions.</p>
                    <div class="form-row">
                        <label class="form-label">1. PICOS + Outcome/Timepoint</label>
                        <textarea class="form-textarea" id="cs-picos" placeholder="Population, interventions, comparators, outcomes, study designs..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label">2. Main Contrasts of Interest (NOT "best treatment")</label>
                        <textarea class="form-textarea" id="cs-contrasts" placeholder="Key comparisons and their estimates..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label">3. Absolute Effects</label>
                        <textarea class="form-textarea" id="cs-absolute" placeholder="Absolute risk/benefit with baseline risk source..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label">4. Non-Linearity/Applicability Summary (Plain Language)</label>
                        <textarea class="form-textarea" id="cs-consistency" placeholder="Was there evidence of non-linearity? Optimal dose range? Any applicability concerns?"></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label">5. ROBINS-E Confidence Summary</label>
                        <textarea class="form-textarea" id="cs-cinema" placeholder="Overall confidence level and key reasons..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label">6. Summary Umbrella Review Statement</label>
                        <select class="form-input" id="cs-summary accuracy">
                            <option value="">Select...</option>
                            <option value="suppressed">Summary Umbrella Review SUPPRESSED (explain why)</option>
                            <option value="caution">Summary Umbrella Review included WITH CAUTION</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">7. Applicability + Key Uncertainties</label>
                        <textarea class="form-textarea" id="cs-applicability" placeholder="Who does this apply to? What are the key limitations?"></textarea>
                    </div>
                    <button class="copy-btn" onclick="generateClinicalSummary()">Generate & Copy</button>
                    <div class="template-output" id="cs-output"></div>
                </div>
            </div>

            <!-- CondGO UMBRELLA -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">⚠️ Appendix K: Emergency Fix Mode (CondGO) <span class="template-badge badge-essential">EMERGENCY</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">CondGO is ≤72 hours, no thrash. UMBRELLA-specific triggers included.</p>
                    <div class="form-row">
                        <label class="form-label">Trigger</label>
                        <select class="form-input" id="cg-trigger">
                            <option value="">Select trigger...</option>
                            <option value="disconnect">Disconnected accuracy discovered late</option>
                            <option value="threshold effects">Severe threshold effects without resolution path</option>
                            <option value="convergence">Bayesian convergence failure</option>
                            <option value="frequentist">Frequentist non-identifiability</option>
                            <option value="applicability">Applicability violation</option>
                            <option value="rerun">Rerun mismatch</option>
                            <option value="other">Other (specify)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Allowed Actions (check all that apply)</label>
                        <div style="display:grid;gap:8px">
                            <label><input type="checkbox" id="cg-a1"> Rule-based test remap + rerun</label>
                            <label><input type="checkbox" id="cg-a2"> Prespecified sensitivity analysis</label>
                            <label><input type="checkbox" id="cg-a3"> Restrict to connected component</label>
                            <label><input type="checkbox" id="cg-a4"> Suppress summary accuracy</label>
                            <label><input type="checkbox" id="cg-a5"> Downgrade ROBINS-E confidence</label>
                            <label><input type="checkbox" id="cg-a6"> Repair source-citation/extraction errors</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Exit Decision</label>
                        <select class="form-input" id="cg-exit">
                            <option value="">Select...</option>
                            <option value="pass">PASS — Issue resolved</option>
                            <option value="minimal">MINIMAL — Submit prespecified version</option>
                            <option value="terminate">TERMINATE — Archive with failure log</option>
                        </select>
                    </div>
                    <button class="copy-btn" onclick="generateCondGO()">Generate & Copy</button>
                    <div class="template-output" id="cg-output"></div>
                </div>
            </div>

            <!-- Audit 1 Template -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">📋 Appendix D1: Audit 1 (Days 18-20) <span class="template-badge badge-essential">QA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">10% trace audit + test mapping verification. Non-integrator auditor required.</p>
                    <div class="form-row">
                        <label class="form-label">Auditor Name (non-integrator)</label>
                        <input type="text" class="form-input" id="a1-auditor" placeholder="Name of auditor">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Date Range</label>
                        <input type="text" class="form-input" id="a1-dates" placeholder="e.g., Days 18-20">
                    </div>
                    <h4 style="margin:16px 0 8px;font-size:13px">10% Sample Trace (check each)</h4>
                    <div style="display:grid;gap:8px;margin-bottom:16px">
                        <label style="font-size:13px"><input type="checkbox" id="a1-c1"> Sample matches source PDF (n events, N total)</label>
                        <label style="font-size:13px"><input type="checkbox" id="a1-c2"> Effect size calculation correct</label>
                        <label style="font-size:13px"><input type="checkbox" id="a1-c3"> Study→Test mapping consistent with dictionary</label>
                        <label style="font-size:13px"><input type="checkbox" id="a1-c4"> Multi-threshold handling correct</label>
                        <label style="font-size:13px"><input type="checkbox" id="a1-c5"> RoB judgment supported by data</label>
                    </div>
                    <h4 style="margin:16px 0 8px;font-size:13px">Node Mapping Verification</h4>
                    <div style="display:grid;gap:8px;margin-bottom:16px">
                        <label style="font-size:13px"><input type="checkbox" id="a1-n1"> All studies mapped to correct tests</label>
                        <label style="font-size:13px"><input type="checkbox" id="a1-n2"> Grouping rules applied consistently</label>
                        <label style="font-size:13px"><input type="checkbox" id="a1-n3"> No orphan treatments</label>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Discrepancies Found</label>
                        <textarea class="form-textarea" id="a1-discrepancies" placeholder="List any errors or inconsistencies..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Audit 1 Result</label>
                        <select class="form-input" id="a1-result">
                            <option value="">Select...</option>
                            <option value="pass">PASS - No critical errors</option>
                            <option value="minor">PASS with minor corrections</option>
                            <option value="fail">FAIL - Major errors requiring re-extraction</option>
                        </select>
                    </div>
                    <button class="copy-btn" onclick="generateAudit1()">Generate & Copy</button>
                    <div class="template-output" id="a1-output"></div>
                </div>
            </div>

            <!-- Audit 2 Template -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔬 Appendix D2: Audit 2 (Days 30-32) <span class="template-badge badge-essential">QA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Rerun verification + influential study check. Must pass before FREEZE.</p>
                    <div class="form-row">
                        <label class="form-label">Auditor Name</label>
                        <input type="text" class="form-input" id="a2-auditor" placeholder="Name of auditor">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Date Range</label>
                        <input type="text" class="form-input" id="a2-dates" placeholder="e.g., Days 30-32">
                    </div>
                    <h4 style="margin:16px 0 8px;font-size:13px">Rerun Verification</h4>
                    <div style="display:grid;gap:8px;margin-bottom:16px">
                        <label style="font-size:13px"><input type="checkbox" id="a2-c1"> Independent rerun matches primary results</label>
                        <label style="font-size:13px"><input type="checkbox" id="a2-c2"> All effect estimates within equivalence bounds</label>
                        <label style="font-size:13px"><input type="checkbox" id="a2-c3"> Summary Umbrella Review (if reported) identical</label>
                        <label style="font-size:13px"><input type="checkbox" id="a2-c4"> ROBINS-E ratings consistent</label>
                    </div>
                    <h4 style="margin:16px 0 8px;font-size:13px">Influential Study Check (top 20% by weight)</h4>
                    <div style="display:grid;gap:8px;margin-bottom:16px">
                        <label style="font-size:13px"><input type="checkbox" id="a2-i1"> Identified influential studies listed</label>
                        <label style="font-size:13px"><input type="checkbox" id="a2-i2"> Leave-one-out sensitivity performed</label>
                        <label style="font-size:13px"><input type="checkbox" id="a2-i3"> No single study changes conclusions</label>
                        <label style="font-size:13px"><input type="checkbox" id="a2-i4"> Data extraction double-checked for influential studies</label>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Rerun Match Summary</label>
                        <textarea class="form-textarea" id="a2-equivalence" placeholder="Primary: OR 0.75 [0.62-0.91], Rerun: OR 0.75 [0.62-0.91] → MATCH"></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Issues Identified</label>
                        <textarea class="form-textarea" id="a2-issues" placeholder="List any discrepancies or concerns..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Audit 2 Result</label>
                        <select class="form-input" id="a2-result">
                            <option value="">Select...</option>
                            <option value="pass">PASS - Ready for FREEZE</option>
                            <option value="minor">PASS with minor corrections</option>
                            <option value="fail">FAIL - Rerun mismatch (trigger CondGO)</option>
                        </select>
                    </div>
                    <button class="copy-btn" onclick="generateAudit2()">Generate & Copy</button>
                    <div class="template-output" id="a2-output"></div>
                </div>
            </div>

            <!-- Pod Handoff Checklists -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🤝 Pod Handoff Checklists <span class="template-badge badge-reference">COORDINATION</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Use these checklists when transitioning work between pods. Both giving and receiving pod must confirm.</p>

                    <div class="handoff-card">
                        <div class="handoff-title">📋 Search → Full-Text Handoff (Day ~10)</div>
                        <div class="handoff-items">
                            <label class="handoff-item"><input type="checkbox"> All search results exported and deduplicated</label>
                            <label class="handoff-item"><input type="checkbox"> PRISMA "Records identified" count confirmed</label>
                            <label class="handoff-item"><input type="checkbox"> Screening decisions documented</label>
                            <label class="handoff-item"><input type="checkbox"> Full-text retrieval list provided</label>
                            <label class="handoff-item"><input type="checkbox"> Known difficult-to-obtain papers flagged</label>
                        </div>
                    </div>

                    <div class="handoff-card">
                        <div class="handoff-title">📄 Full-Text → Extraction Handoff (Day ~14)</div>
                        <div class="handoff-items">
                            <label class="handoff-item"><input type="checkbox"> All PDFs organized and accessible</label>
                            <label class="handoff-item"><input type="checkbox"> Exclusion reasons documented for each excluded study</label>
                            <label class="handoff-item"><input type="checkbox"> Final included studies list confirmed</label>
                            <label class="handoff-item"><input type="checkbox"> Multi-threshold studies flagged</label>
                            <label class="handoff-item"><input type="checkbox"> Study Registry shared with extraction team</label>
                        </div>
                    </div>

                    <div class="handoff-card">
                        <div class="handoff-title">📊 Extraction → Modeling Handoff (Day ~28)</div>
                        <div class="handoff-items">
                            <label class="handoff-item"><input type="checkbox"> All arm-level data extracted and verified</label>
                            <label class="handoff-item"><input type="checkbox"> Study→Test mapping complete with source citation</label>
                            <label class="handoff-item"><input type="checkbox"> RoB assessments complete</label>
                            <label class="handoff-item"><input type="checkbox"> Effect modifier data extracted</label>
                            <label class="handoff-item"><input type="checkbox"> Data file format matches Statistical Model specs</label>
                            <label class="handoff-item"><input type="checkbox"> Audit 1 passed</label>
                        </div>
                    </div>

                    <div class="handoff-card">
                        <div class="handoff-title">📈 Modeling → Write Handoff (Day ~34)</div>
                        <div class="handoff-items">
                            <label class="handoff-item"><input type="checkbox"> All analyses complete and reproducible</label>
                            <label class="handoff-item"><input type="checkbox"> Summary accuracy table finalized</label>
                            <label class="handoff-item"><input type="checkbox"> ROBINS-E assessment complete</label>
                            <label class="handoff-item"><input type="checkbox"> Ranking decision (report/suppress) documented</label>
                            <label class="handoff-item"><input type="checkbox"> Figures exported in publication format</label>
                            <label class="handoff-item"><input type="checkbox"> Audit 2 passed</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- REFERENCE PAGE -->
        <div class="page" role="tabpanel" id="page-reference">
            <div class="card">
                <div class="card-header"><div class="card-title">UMBRELLA-Specific Concepts</div></div>
                <div class="card-body">
                    <h4 style="margin-bottom:12px">Applicability Assumption</h4>
                    <div style="background:var(--bg);padding:12px;border-radius:8px;font-size:13px;margin-bottom:16px">
                        The assumption that indirect comparisons are valid because studies are sufficiently similar in effect modifiers. If populations differ systematically, indirect evidence may be biased.
                    </div>

                    <h4 style="margin-bottom:12px">Model Comparison & Non-Linearity</h4>
                    <table class="ref-table">
                        <thead><tr><th>Type</th><th>Description</th><th>Test</th></tr></thead>
                        <tbody>
                            <tr><td><strong>Global</strong></td><td>Overall accuracy coherence</td><td>Design-by-treatment interaction</td></tr>
                            <tr><td><strong>Local</strong></td><td>Specific comparison coherence</td><td>Node-splitting, loop-specific</td></tr>
                        </tbody>
                    </table>

                    <h4 style="margin:16px 0 12px">ROBINS-E Domains</h4>
                    <table class="ref-table">
                        <thead><tr><th>Domain</th><th>Question</th></tr></thead>
                        <tbody>
                            <tr><td>Within-study bias</td><td>Risk of bias in included studies?</td></tr>
                            <tr><td>Reporting bias</td><td>Missing studies/outcomes?</td></tr>
                            <tr><td>Indirectness</td><td>Applicability to PICO?</td></tr>
                            <tr><td>Imprecision</td><td>Confidence interval width?</td></tr>
                            <tr><td>Heterogeneity</td><td>Between-study variability?</td></tr>
                            <tr><td>Incoherence</td><td>Direct vs indirect agreement?</td></tr>
                        </tbody>
                    </table>

                    <h4 style="margin:16px 0 12px">When to Suppress Summary Umbrella Review</h4>
                    <div style="background:var(--danger-light);padding:12px;border-radius:8px;font-size:13px;border:1px solid var(--danger)">
                        <strong>Suppress if ANY:</strong><br>
                        • ROBINS-E confidence "Low" for key contrasts<br>
                        • Severe incoherence affecting key contrasts<br>
                        • Applicability concerns "High"<br>
                        • Effect sizes not clinically meaningful
                    </div>
                </div>
            </div>
        </div>

        <!-- HELP PAGE -->
        <div class="page" role="tabpanel" id="page-help">
            <div class="card">
                <div class="card-header"><div class="card-title">UMBRELLA Quick Reference</div></div>
                <div class="card-body">
                    <h4 style="margin-bottom:12px">Key Differences from Standard Pairwise</h4>
                    <table class="ref-table">
                        <thead><tr><th>Aspect</th><th>Standard Pairwise</th><th>Umbrella Review</th></tr></thead>
                        <tbody>
                            <tr><td>Effect measure</td><td>Single OR/RR/HR</td><td>Dose-response curve (ED50, Emax)</td></tr>
                            <tr><td>Data structure</td><td>2-arm comparisons</td><td>Multiple doses within studies</td></tr>
                            <tr><td>Covariance</td><td>Independent studies</td><td>Correlated dose-level estimates (Greenland-Longnecker)</td></tr>
                            <tr><td>Key output</td><td>Pooled effect</td><td>Dose-response function + optimal dose range</td></tr>
                            <tr><td>Dose mapping</td><td>N/A</td><td>Critical — standardize units at DoD-A</td></tr>
                        </tbody>
                    </table>

                    <h4 style="margin:16px 0 12px">Decision Trees</h4>
                    <div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:8px">
                        <strong>Accuracy disconnected?</strong><br>
                        → If prespecified component plan exists: analyze separately with limitations<br>
                        → If not: trigger CondGO; may need to route out
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:8px">
                        <strong>Non-linearity detected?</strong><br>
                        → Run local tests to identify problematic loops<br>
                        → Check applicability (effect modifier imbalance)<br>
                        → Consider sensitivity excluding outlier studies<br>
                        → Downgrade ROBINS-E; consider ranking suppression
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:8px">
                        <strong>Bayesian model won't converge?</strong><br>
                        → Check priors (too informative/vague?)<br>
                        → Increase iterations/chains<br>
                        → If still fails after 72h: CondGO → switch to frequentist or terminate
                    </div>
                </div>
            </div>

            <!-- Worked UMBRELLA Example -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📖 Worked Example: Oncology UMBRELLA</div>
                    <span class="nma-indicator">LEARNING</span>
                </div>
                <div class="card-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Walk through a mini-UMBRELLA example: dose-response for blood pressure reduction across 4 antihypertensive dose levels.</p>

                    <div class="example-box">
                        <div class="example-title">Scenario</div>
                        <p style="font-size:13px">Compare efficacy of 4 treatments for major depression: Placebo, Drug A, Drug B, Drug C. We have 12 RCTs with the following direct comparisons:</p>
                        <ul style="font-size:12px;margin:8px 0 0 20px">
                            <li>5 trials: Placebo vs Drug A</li>
                            <li>3 trials: Placebo vs Drug B</li>
                            <li>2 trials: Drug A vs Drug B</li>
                            <li>2 trials: Drug A vs Drug C</li>
                        </ul>
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">1</span>
                        <strong>Study Registry</strong><br>
                        <code style="font-size:11px;background:var(--bg);padding:2px 6px;border-radius:4px">
                        Node 1: Placebo | Node 2: Drug A | Node 3: Drug B | Node 4: Drug C
                        </code>
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">2</span>
                        <strong>Check Connectivity</strong><br>
                        ✅ Accuracy is connected (all tests reachable)<br>
                        ⚠️ Note: No direct Placebo vs Drug C trials — this comparison is <em>indirect only</em>
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">3</span>
                        <strong>Assess Applicability</strong><br>
                        Check effect modifiers across comparisons:<br>
                        • Severity: All trials in moderate-severe depression ✅<br>
                        • Age: Mean age 35-45 across all trials ✅<br>
                        • Duration: 8-12 weeks ✅<br>
                        → <strong>Applicability: Low concern</strong>
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">4</span>
                        <strong>Pool Umbrella Review Curves</strong><br>
                        Using frequentist random-effects (netmeta in R):<br>
                        <code style="font-size:11px;background:var(--bg);padding:2px 6px;border-radius:4px;display:block;margin-top:4px">
                        Drug A vs Placebo: OR 1.45 [1.20, 1.75]<br>
                        Drug B vs Placebo: OR 1.38 [1.10, 1.73]<br>
                        Drug C vs Placebo: OR 1.52 [1.15, 2.01] ← indirect!
                        </code>
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">5</span>
                        <strong>Check Consistency</strong><br>
                        Global test (design-by-treatment): p = 0.42 → No evidence of threshold effects ✅<br>
                        Node-splitting for A vs B: Direct OR 1.05, Indirect OR 1.08, p = 0.85 ✅
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">6</span>
                        <strong>ROBINS-E Assessment (Drug C vs Placebo)</strong><br>
                        • Within-study bias: Some concerns (3/4 trials high RoB)<br>
                        • Indirectness: Low concern<br>
                        • Imprecision: Some concerns (CI crosses 1.5 threshold)<br>
                        • Heterogeneity: Low concern (I² = 28%)<br>
                        • Incoherence: Low concern<br>
                        → <strong>Overall: Moderate confidence</strong>
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">7</span>
                        <strong>Summary Umbrella Review Decision</strong><br>
                        P-scores: Drug C (72%), Drug A (68%), Drug B (45%), Placebo (15%)<br>
                        ✅ ROBINS-E not "Low" for key contrasts<br>
                        ✅ No severe incoherence<br>
                        ✅ Applicability OK<br>
                        → <strong>Summary Umbrella Review CAN be reported</strong> (with caution language)
                    </div>

                    <div style="background:var(--success-light);padding:12px;border-radius:8px;border:1px solid var(--success);margin-top:12px;font-size:13px">
                        <strong>✅ Conclusion:</strong> All 4 drugs show benefit vs placebo. Drug C ranks highest but evidence is indirect only. Recommend Drug A or B as first-line (more direct evidence). Drug C may be considered with acknowledgment of indirect evidence.
                    </div>
                </div>
            </div>
        </div>

        <!-- GLOSSARY PAGE -->
        <div class="page" role="tabpanel" id="page-glossary">
            <div class="card">
                <div class="card-header"><div class="card-title">UMBRELLA Glossary</div></div>
                <div class="card-body" id="glossaryContent">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settingsModal" role="dialog" aria-modal="true">
    <div class="modal-card">
        <div class="modal-header">
            <div class="modal-title">⚙️ Settings</div>
            <button class="modal-close" aria-label="Close" onclick="closeModal('settingsModal')">×</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <label class="form-label">Project Name</label>
                <input type="text" class="form-input" id="projectNameInput" placeholder="My UMBRELLA Project">
            </div>
            <div class="btn-row" style="margin-top:16px">
                <button class="copy-btn" onclick="exportData()">⬇️ Export Data</button>
                <button class="download-btn" onclick="resetData()">🗑️ Reset All</button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== STATE =====
let state = {
    day: 1,
    role: '',
    bootcamp: {},
    testDictionary: '',
    modelContract: {},
    cinema: {},
    rankingChecks: {},
    applicabilityChecks: {},
    prismaChecks: {},
    tasks: {},
    taskAssignees: {},
    dodChecked: {},
    dodGates: { A: false, B: false, C: false, D: false, E: false },
    testCount: 0,
    studyCount: 0,
    effectModifiers: ''
};

// ===== CONSTANTS =====
const ROLE_NAMES = {
    integrator: 'Integrator',
    deputy: 'Deputy',
    search: 'Search & Screen',
    fulltext: 'Full-Text',
    extraction: 'Extraction & Quality Risk (RoB)',
    analysis: 'Analysis Lead',
    modeling: 'Modeling & Write'
};

const PHASES = [
    { id: 'A', name: 'Protocol + Statistical Model', days: [1, 4], cls: 'phase-a' },
    { id: 'B', name: 'Search + Viability', days: [6, 12], cls: 'phase-b' },
    { id: 'C', name: 'Extraction + Mapping', days: [12, 28], cls: 'phase-c' },
    { id: 'D', name: 'Model + ROBINS-E', days: [24, 34], cls: 'phase-d' },
    { id: 'E', name: 'Submission', days: [34, 40], cls: 'phase-e' }
];

const DOD_CHECKLISTS = {
    A: [
        { id: 'a1', text: 'PICOS + primary outcome + dose range + effect measure defined' },
        { id: 'a2', text: 'Dose-response model candidates specified (linear, Emax, splines)' },
        { id: 'a3', text: 'Dose unit standardization rules documented' },
        { id: 'a4', text: 'Reference dose defined (placebo or lowest dose)' },
        { id: 'a5', text: 'Applicability effect modifiers listed (≤6)' },
        { id: 'a6', text: 'Model selection criteria pre-specified (AIC, non-linearity test)' },
        { id: 'a7', text: 'Minimum dose levels per study defined (≥3)' },
        { id: 'a8', text: 'CondGO triggers included' },
        { id: 'a9', text: 'Study plan registered (PROSPERO/protocols.io)' },
        { id: 'a10', text: 'Signed by Integrator + non-integrator' }
    ],
    B: [
        { id: 'b1', text: 'Search strings saved verbatim' },
        { id: 'b2', text: 'Search dates + limits recorded' },
        { id: 'b3', text: 'Dedup method recorded' },
        { id: 'b4', text: 'Screening alignment check completed' },
        { id: 'b5', text: 'Study-flow (PRISMA) counts live' },
        { id: 'b6', text: 'Dose-response feasibility confirmed (≥3 studies with ≥3 doses each)' },
        { id: 'b7', text: 'Dose range overlap assessed across studies' }
    ],
    C: [
        { id: 'c1', text: 'Dose extraction template frozen (dose, n, effect, SE, reference dose)' },
        { id: 'c2', text: 'Dose unit conversion table complete with standardization rules' },
        { id: 'c3', text: 'Within-study covariance structure documented (correlated dose-level estimates)' },
        { id: 'c4', text: 'Greenland-Longnecker covariance method applied or justified alternative' },
        { id: 'c5', text: 'Key fields verified (Appendix F)' },
        { id: 'c6', text: 'Discrepancy arbitration functioning' },
        { id: 'c7', text: 'Audit 1 (10% trace + dose extraction) passed' }
    ],
    D: [
        { id: 'd1', text: 'Capsule runs from clean, versioned inputs' },
        { id: 'd2', text: 'Dose-response models fitted (linear, Emax, spline)' },
        { id: 'd3', text: 'Non-linearity test performed (Wald test on spline coefficients)' },
        { id: 'd4', text: 'Best-fitting model selected by pre-specified criteria' },
        { id: 'd5', text: 'Dose-response curve plotted with prediction intervals' },
        { id: 'd6', text: 'ED50/Emax estimated with 95% CI (if Emax model)' },
        { id: 'd7', text: 'ROBINS-E/RoB 2 completed for all included studies' },
        { id: 'd8', text: 'Red-team Audit 2 passed' }
    ],
    E: [
        { id: 'e1', text: 'Study-flow (PRISMA) checklist complete' },
        { id: 'e2', text: 'Two independent capsule reruns equivalent' },
        { id: 'e3', text: 'Clinical summary includes optimal dose range interpretation' },
        { id: 'e4', text: 'Deviations log complete' },
        { id: 'e5', text: 'Audit pack complete' },
        { id: 'e6', text: 'Submission pack ready' }
    ]
};

const GLOSSARY = [
    { term: 'ED50 (EC50)', plain: 'The dose that produces 50% of the maximum effect. Lower ED50 = more potent drug. Used to compare drug potencies.', technical: 'ED50 is the inflection point of sigmoidal Emax curve. Estimated via non-linear regression.' },
    { term: 'Emax', plain: 'The maximum achievable effect at high doses. The plateau of the dose-response curve. Represents full efficacy.', technical: 'Upper asymptote of dose-response function. E = Emax × Dⁿ / (ED50ⁿ + Dⁿ).' },
    { term: 'Hill Coefficient', plain: 'Describes the steepness of the dose-response curve. Higher values = sharper transition from no effect to full effect.', technical: 'n in Hill equation. n=1 is hyperbolic; n>1 is sigmoidal; n<1 is shallow curve.' },
    { term: 'Umbrella Review Curve', plain: 'Graph showing how effect size changes with dose. Can be linear, log-linear, sigmoidal, or more complex shapes.', technical: 'Function E(D) relating dose D to effect E. Common forms: linear, Emax, spline, fractional polynomial.' },
    { term: 'Restricted Cubic Splines', plain: 'Flexible curve-fitting method that joins polynomial segments smoothly. Good when true shape is unknown.', technical: 'Piecewise cubic polynomials joined at knots with continuous 2nd derivatives. Linear beyond outer knots.' },
    { term: 'Greenland-Longnecker Method', plain: 'Standard approach for dose-response meta-analysis. Uses correlation between doses within studies.', technical: 'Generalized least squares accounting for within-study covariance of log RRs at different doses.' },
    { term: 'Threshold Dose', plain: 'The minimum dose at which an effect first becomes detectable. Below this, no meaningful effect occurs.', technical: 'Estimated by hockey-stick models or by testing whether low-dose slope differs from zero.' },
    { term: 'Monotonicity', plain: 'The assumption that effect always increases (or decreases) with dose. Violated if U-shaped or inverted-U patterns exist.', technical: 'dE/dD ≥ 0 (or ≤ 0) for all D. Test by including quadratic terms or using shape-constrained models.' },
    { term: 'Reference Dose', plain: 'The dose level used as the comparison point (usually placebo or lowest dose). All other doses compared to this.', technical: 'Typically D=0 or lowest observed dose. Log RR at reference dose is 0 by definition.' },
    { term: 'Fractional Polynomials', plain: 'Flexible models using power transformations of dose. Can capture complex non-linear patterns.', technical: 'Uses powers from set {-2,-1,-0.5,0,0.5,1,2,3} where 0 = log. Select by AIC/BIC.' },
    { term: 'One-Stage Model', plain: 'Analyzes all data simultaneously. Better for small studies or IPD. Accounts for within-study correlation directly.', technical: 'Mixed-effects model with study random effects. Pools data while respecting study structure.' },
    { term: 'Two-Stage Model', plain: 'First fits curves within each study, then pools curve parameters across studies. More transparent.', technical: 'Stage 1: study-specific regression. Stage 2: multivariate meta-analysis of coefficients.' },
    { term: 'ROBINS-E', plain: 'Risk of Bias in Non-randomized Studies of Exposures. Essential for observational dose-response studies.', technical: '7-domain tool: confounding, selection, exposure measurement, post-exposure, missing data, outcome, reporting.' },
    { term: 'Confounding by Indication', plain: 'When sicker patients get higher doses, biasing the dose-response relationship. Major threat in observational studies.', technical: 'Exposure (dose) associated with outcome through confounders, not just causal path.' },
    { term: 'Forest Plot', plain: 'Visual display of pooled results. Each study shown as a square (size = weight) with confidence interval line.', technical: 'Point estimates with 95% CI for each study plus pooled diamond.' },
    { term: 'Funnel Plot', plain: 'Scatter plot of study effects vs precision. Asymmetry suggests publication bias or small-study effects.', technical: 'Effect vs SE. Should be symmetric around pooled estimate if no bias.' },
    { term: 'Heterogeneity (I²)', plain: 'Percentage of variation across studies due to true differences rather than chance. I² > 50% is substantial.', technical: 'I² = (Q - df)/Q × 100%. Describes inconsistency across study results.' },
    { term: 'Non-Linearity Test', plain: 'Statistical test for whether the dose-response relationship is truly non-linear vs linear.', technical: 'Wald test on non-linear spline coefficients or comparison of linear vs non-linear model AIC.' }
];

const DAILY_GOALS = {
    1: 'Complete Bootcamp + Draft Study Registry v1',
    2: 'Finalize PICOS + Begin Statistical Model',
    3: 'Lock Statistical Model + Ranking Policy',
    4: 'Sign off DoD-A-UMBRELLA',
    6: 'Execute searches',
    10: 'Complete screening + Meta-analysis feasibility check',
    12: 'Sign off DoD-B-UMBRELLA',
    18: 'Audit 1 begins',
    20: 'Audit 1 complete',
    28: 'Sign off DoD-C-UMBRELLA',
    30: 'Run full analysis + Begin ROBINS-E',
    32: 'Audit 2 begins',
    33: 'Audit 2 complete',
    34: 'Sign off DoD-D-UMBRELLA + FREEZE',
    40: 'Submit! DoD-E-UMBRELLA complete'
};

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    if (state.role) {
        document.getElementById('onboarding').classList.add('hidden');
        document.getElementById('app').style.display = 'block';
        render();
    }
    loadDarkMode();
});

function loadState() {
    const saved = localStorage.getItem('metasprint-umbrella');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            delete data.__proto__; delete data.constructor; delete data.prototype;
            state = { ...state, ...data };
        } catch(e) {}
    }
}

function save() {
    try { localStorage.setItem('metasprint-umbrella', JSON.stringify(state)); }
    catch(e) { if (e.name === 'QuotaExceededError') showToast('Storage full — export your data to free space', 'error'); }
}

// ===== ONBOARDING =====
function toggleElig(el) {
    el.classList.toggle('checked');
    const allChecked = document.querySelectorAll('.elig-item.checked').length === document.querySelectorAll('.elig-item').length;
    document.getElementById('nextBtn1').disabled = !allChecked;
}

function goToStep2() {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
}

function selectRole(el, role) {
    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    state.role = role;
    document.getElementById('startBtn').disabled = false;
}

function startApp() {
    save();
    document.getElementById('onboarding').classList.add('hidden');
    document.getElementById('app').style.display = 'block';
    render();
}

function showRoleChange() {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('onboarding').classList.remove('hidden');
}

// ===== RENDER =====
function buildRiskState() {
    var d = state.day;
    var gates = state.dodGates || {};
    var studyCount = state.studyCount ?? 0;
    var daysToFreeze = Math.max(0, 34 - d);
    var risks = [];
    var points = 0;
    var gateDeadlines = { A: 4, B: 12, C: 28, D: 34, E: 40 };

    ['A', 'B', 'C', 'D', 'E'].forEach(function(gate) {
        var deadline = gateDeadlines[gate];
        if (d > deadline && !gates[gate]) {
            var overdue = d - deadline;
            risks.push({ level: 'high', text: 'DoD-' + gate + ' overdue by ' + overdue + ' day(s).' });
            points += 3;
        }
    });

    if (d < 34 && daysToFreeze <= 3 && !gates.D) {
        risks.push({ level: 'medium', text: 'Freeze in ' + daysToFreeze + ' day(s), but DoD-D is not signed off.' });
        points += 2;
    }

    if (studyCount > 0 && (studyCount < 40 || studyCount > 60)) {
        risks.push({ level: 'medium', text: 'Study count ' + studyCount + ' is outside target range (40-60).' });
        points += 1;
    } else if (d > 12 && studyCount === 0) {
        risks.push({ level: 'medium', text: 'Study count is still zero after Day 12. Verify PRISMA and extraction logs.' });
        points += 1;
    }

    var level = 'low';
    if (points >= 4) level = 'high';
    else if (points >= 2) level = 'medium';

    if (risks.length === 0) {
        risks.push({ level: 'low', text: 'No active risks. Keep daily outputs on schedule.' });
    }

    return { level: level, items: risks };
}

function renderRiskPanel() {
    var badge = document.getElementById('riskStatusBadge');
    var list = document.getElementById('riskList');
    if (!badge || !list) return;

    var risk = buildRiskState();
    badge.className = 'risk-badge ' + risk.level;
    badge.textContent = risk.level.toUpperCase();

    var html = '';
    risk.items.forEach(function(item) {
        var cls = 'risk-item';
        if (item.level === 'high') cls += ' high';
        else if (item.level === 'medium') cls += ' medium';
        html += '<li class="' + cls + '">' + escapeHtml(item.text) + '</li>';
    });
    list.innerHTML = html;
}

function render() {
    const d = state.day;
    document.getElementById('dayNum').textContent = d;
    document.getElementById('prevDayBtn').disabled = d <= 1;
    document.getElementById('nextDayBtn').disabled = d >= 40;
    document.getElementById('roleBadge').textContent = ROLE_NAMES[state.role] || state.role;
    document.getElementById('freezeBanner').classList.toggle('hidden', d < 34);

    // Timeline
    document.getElementById('timelineFill').style.width = ((d / 40) * 100) + '%';
    const timelineBar = document.querySelector('.timeline-bar');
    if (timelineBar) timelineBar.setAttribute('aria-valuenow', d);

    // Phase badge
    const phase = PHASES.find(p => d >= p.days[0] && d <= p.days[1]) || PHASES[0];
    const badge = document.getElementById('phaseBadge');
    badge.textContent = phase.name;
    badge.className = 'phase-badge ' + phase.cls;

    // Health dashboard
    document.getElementById('daysRemaining').textContent = 40 - d;
    document.getElementById('testCount').textContent = state.testCount ?? 0;
    document.getElementById('studyCount').textContent = state.studyCount ?? 0;
    const gatesPassed = ['A','B','C','D','E'].filter(g => state.dodGates[g]).length;
    document.getElementById('gatesPassed').textContent = gatesPassed + '/5';

    // Gate dots
    ['A','B','C','D','E'].forEach(g => {
        const dot = document.getElementById('gate' + g);
        dot.classList.remove('passed', 'current');
        if (state.dodGates[g]) dot.classList.add('passed');
    });

    // Health score
    let score = 100;
    if (d > 4 && !state.dodGates.A) score -= 20;
    if (d > 12 && !state.dodGates.B) score -= 20;
    if (d > 28 && !state.dodGates.C) score -= 20;
    if (d > 34 && !state.dodGates.D) score -= 20;
    const scoreEl = document.getElementById('healthScore');
    scoreEl.textContent = score + '%';
    scoreEl.className = 'health-score ' + (score >= 80 ? 'good' : score >= 50 ? 'warning' : 'danger');

    renderRiskPanel();

    // Bootcamp visibility
    document.getElementById('bootcampCard').style.display = d <= 2 ? 'block' : 'none';

    // Goal
    const goal = DAILY_GOALS[d] || 'Continue current phase tasks';
    document.getElementById('goalText').textContent = goal;

    // Tasks
    renderTasks();

    // DoD page
    renderDoD();

    // Accuracy stats
    document.getElementById('netTests').textContent = state.testCount ?? 0;
    document.getElementById('netStudies').textContent = state.studyCount ?? 0;

    // Glossary
    renderGlossary();
}

function renderTasks() {
    const d = state.day;
    const role = state.role;
    let tasks = [];

    // Tasks with suggested owners
    if (d === 1) {
        tasks = [
            { text: 'Complete UMBRELLA Bootcamp (45 min)', owner: 'All' },
            { text: 'Draft Study Registry v1', owner: 'Accuracy' },
            { text: 'Review PICOS', owner: 'Integrator' }
        ];
    } else if (d <= 4) {
        tasks = [
            { text: 'Finalize Study Registry', owner: 'Accuracy' },
            { text: 'Complete Statistical Model', owner: 'Modeling' },
            { text: 'Lock ranking policy', owner: 'Integrator' }
        ];
    } else if (d <= 12) {
        if (role === 'search') tasks = [
            { text: 'Execute database searches', owner: 'Search' },
            { text: 'Document search strings', owner: 'Search' }
        ];
        else if (role === 'analysis') tasks = [
            { text: 'Prepare viability assessment', owner: 'Accuracy' },
            { text: 'Validate test mapping rules', owner: 'Accuracy' }
        ];
        else tasks = [
            { text: 'Support search/screen phase', owner: role },
            { text: 'Review test assignments', owner: role }
        ];
    } else if (d <= 28) {
        if (role === 'extraction') tasks = [
            { text: 'Continue arm-level extraction', owner: 'Extraction' },
            { text: 'Verify key fields', owner: 'Extraction' }
        ];
        else if (role === 'analysis') tasks = [
            { text: 'Monitor test mapping consistency', owner: 'Accuracy' },
            { text: 'Flag multi-threshold issues', owner: 'Accuracy' }
        ];
        else tasks = [
            { text: 'Support extraction', owner: role },
            { text: 'Prepare for Audit 1', owner: 'Deputy' }
        ];
    } else if (d <= 34) {
        if (role === 'modeling') tasks = [
            { text: 'Run UMBRELLA model', owner: 'Modeling' },
            { text: 'Complete ROBINS-E', owner: 'Modeling' },
            { text: 'Produce summary accuracy table', owner: 'Modeling' }
        ];
        else tasks = [
            { text: 'Support analysis', owner: role },
            { text: 'Review outputs', owner: role }
        ];
    } else {
        tasks = [
            { text: 'Final manuscript review', owner: 'Integrator' },
            { text: 'Complete PRISMA checklist', owner: 'Integrator' },
            { text: 'Verify rerun equivalence', owner: 'Deputy' }
        ];
    }

    let html = '';
    tasks.forEach((task, i) => {
        const key = `${d}-${i}`;
        const checked = state.tasks[key];
        const assignee = state.taskAssignees?.[key] || task.owner || '';
        const safeAssignee = escapeHtml(assignee);
        html += `<div class="checklist-item ${checked ? 'checked' : ''}" tabindex="0" style="position:relative">
            <div class="check-box" onclick="toggleTask('${key}')"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
            <div class="checklist-content" onclick="toggleTask('${key}')" style="flex:1">
                <div class="checklist-title">${task.text}</div>
            </div>
            <input type="text" value="${safeAssignee}" placeholder="Owner" onclick="event.stopPropagation()" onchange="setTaskAssignee('${key}', this.value)" style="width:70px;padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:11px;text-align:center;background:var(--bg)">
        </div>`;
    });
    document.getElementById('tasksContainer').innerHTML = html;
}

function setTaskAssignee(key, value) {
    if (!state.taskAssignees) state.taskAssignees = {};
    state.taskAssignees[key] = value;
    save();
    showToast('Assignee updated');
}

function toggleTask(key) {
    state.tasks[key] = !state.tasks[key];
    save();
    renderTasks();
    showToast('Saved');
}

function renderDoD() {
    let html = '';
    PHASES.forEach(phase => {
        const items = DOD_CHECKLISTS[phase.id] || [];
        const checkedCount = items.filter(item => state.dodChecked[item.id]).length;
        const allChecked = checkedCount === items.length;
        const passed = state.dodGates[phase.id];

        let statusText = passed ? '✓ PASSED' : allChecked ? '◉ Ready' : `${checkedCount}/${items.length}`;
        let statusClass = passed ? 'gate-passed' : allChecked ? 'gate-ready' : 'gate-pending';

        html += `<div class="dod-section">
            <div class="dod-header ${phase.cls}">
                <div class="dod-title">DoD-${phase.id}-UMBRELLA: ${phase.name}</div>
                <div class="dod-gate-status ${statusClass}">${statusText}</div>
            </div>`;

        items.forEach(item => {
            const checked = state.dodChecked[item.id];
            html += `<div class="checklist-item ${checked ? 'checked' : ''}" tabindex="0" onclick="toggleDoD('${item.id}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                <div class="checklist-content"><div class="checklist-title">${escapeHtml(item.text)}</div></div>
            </div>`;
        });

        if (allChecked && !passed) {
            html += `<button class="copy-btn" style="width:100%;margin-top:12px" onclick="signOffGate('${phase.id}')">✍️ Sign Off DoD-${phase.id}-UMBRELLA</button>`;
        }
        html += '</div>';
    });
    document.getElementById('dodContainer').innerHTML = html;
}

function toggleDoD(id) {
    state.dodChecked[id] = !state.dodChecked[id];
    save();
    renderDoD();
    showToast('Saved');
}

function signOffGate(gateId) {
    if (!confirm(`Sign off DoD-${gateId}-UMBRELLA? This confirms all checklist items are complete.`)) return;
    state.dodGates[gateId] = true;
    save();
    render();
    showToast(`🎉 DoD-${gateId}-UMBRELLA PASSED!`);
    launchConfetti();
}

function renderGlossary() {
    let html = '';
    GLOSSARY.forEach(item => {
        html += `<div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border)">
            <div style="font-weight:700;color:var(--umbrella)">${escapeHtml(item.term)}</div>
            <div style="margin-top:4px">${escapeHtml(item.plain)}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px;font-style:italic">${escapeHtml(item.technical)}</div>
        </div>`;
    });
    document.getElementById('glossaryContent').innerHTML = html;
}

// ===== NAVIGATION =====
function changeDay(delta) {
    state.day = Math.max(1, Math.min(40, state.day + delta));
    save();
    render();
}

function showPage(pageId, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
    document.getElementById('page-' + pageId).classList.add('active');
    if (btn) { btn.classList.add('active'); btn.setAttribute('aria-selected', 'true'); }
}

function showDayJump() {
    document.getElementById('dayJumpModal').classList.add('visible');
    const input = document.getElementById('dayJumpInput');
    input.value = state.day;
    input.select();
}

function closeDayJump(e) {
    if (e && e.target !== e.currentTarget) return;
    document.getElementById('dayJumpModal').classList.remove('visible');
}

function jumpToDay() {
    const val = parseInt(document.getElementById('dayJumpInput').value, 10) ?? 1;
    state.day = Math.max(1, Math.min(40, val));
    save();
    render();
    closeDayJump();
    showToast(`Jumped to Day ${state.day}`);
}

function handleDayJumpKey(e) {
    if (e.key === 'Enter') jumpToDay();
    else if (e.key === 'Escape') closeDayJump();
}

// ===== DARK MODE =====
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    try { localStorage.setItem('metasprint_umbrella_dark', isDark ? 'true' : 'false'); } catch(e) {}
    document.getElementById('darkModeBtn').textContent = isDark ? '☀️' : '🌙';
}

function loadDarkMode() {
    if (localStorage.getItem('metasprint_umbrella_dark') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeBtn').textContent = '☀️';
    }
}

// ===== MODALS =====
let _modalTrigger = null;
function openModal(id) {
    _modalTrigger = document.activeElement;
    document.getElementById(id).classList.add('visible');
    const firstFocusable = document.getElementById(id).querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (firstFocusable) setTimeout(() => firstFocusable.focus(), 50);
}
function closeModal(id) {
    document.getElementById(id).classList.remove('visible');
    if (_modalTrigger) { _modalTrigger.focus(); _modalTrigger = null; }
}

// ===== TEMPLATES =====
function toggleTemplate(el) {
    const body = el.nextElementSibling;
    body.classList.toggle('open');
    el.setAttribute('aria-expanded', body.classList.contains('open') ? 'true' : 'false');
}

function showOutput(id, text) {
    const el = document.getElementById(id);
    el.textContent = text;
    el.classList.add('visible');
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard');
    }).catch(() => {
        showToast('Output ready (clipboard unavailable)');
    });
}

function generateModelContract() {
    const text = `MODEL CONTRACT (UMBRELLA)
=====================================
Method: ${document.getElementById('mc-method').value === 'freq' ? 'Frequentist' : 'Bayesian'} random-effects dose-response modeling
Estimator/Prior: ${document.getElementById('mc-estimator').value}
Multi-threshold: ${document.getElementById('mc-multiarm').value}
Global threshold effects: ${document.getElementById('mc-global').value}
Local threshold effects: ${document.getElementById('mc-local').value}
Convergence: ${document.getElementById('mc-convergence').value}

LOCKED at DoD-A-UMBRELLA. No changes except via CondGO.`;
    showOutput('mc-output', text);
}

function generateRankingPolicy() {
    const text = `RANKING POLICY
=====================================
Metric: ${document.getElementById('rp-metric').value}
Decision: ${document.getElementById('rp-suppress').value}
Justification: ${document.getElementById('rp-justify').value}

LOCKED at DoD-A-UMBRELLA.`;
    showOutput('rp-output', text);
}

function generateViabilityReport() {
    const text = `UMBRELLAIVAL META-ANALYSIS VIABILITY REPORT
=====================================
Interventions: ${document.getElementById('nv-tests').value}
Studies: ${document.getElementById('nv-studies').value}
Data Availability: ${document.getElementById('nv-connected').value}
Sparsity flags: ${document.getElementById('nv-sparse').value}
Modifier missingness: ${document.getElementById('nv-missing').value}
DECISION: ${document.getElementById('nv-decision').value}`;
    showOutput('nv-output', text);
}

function generateIPDReport() {
    const text = `UMBRELLA EXTRACTION QUALITY CHECKLIST
=====================================
Study: ${document.getElementById('ipd-study').value}
Data Source Quality: ${document.getElementById('ipd-quality').value}
Number of Dose Levels: ${document.getElementById('ipd-nar').value}
Dose Unit Handling: ${document.getElementById('ipd-tool').value}
Validation: ${document.getElementById('ipd-validation').value}
Notes: ${document.getElementById('ipd-notes').value}

Quality Assessment: ${document.getElementById('ipd-quality').value === 'high' || document.getElementById('ipd-quality').value === 'medium' ? 'ACCEPTABLE' : 'REQUIRES REVIEW'}`;
    showOutput('ipd-output', text);
}

function generateClinicalSummary() {
    const text = `CLINICAL SUMMARY PANEL (UMBRELLA)
=====================================
1. PICOS: ${document.getElementById('cs-picos').value}
2. Main contrasts: ${document.getElementById('cs-contrasts').value}
3. Absolute effects: ${document.getElementById('cs-absolute').value}
4. Consistency: ${document.getElementById('cs-consistency').value}
5. ROBINS-E: ${document.getElementById('cs-cinema').value}
6. Summary Umbrella Review: ${document.getElementById('cs-summary accuracy').value}
7. Applicability: ${document.getElementById('cs-applicability').value}`;
    showOutput('cs-output', text);
}

function generateCondGO() {
    const actions = [];
    if (document.getElementById('cg-a1').checked) actions.push('Node remap');
    if (document.getElementById('cg-a2').checked) actions.push('Sensitivity analysis');
    if (document.getElementById('cg-a3').checked) actions.push('Restrict to component');
    if (document.getElementById('cg-a4').checked) actions.push('Suppress summary accuracy');
    if (document.getElementById('cg-a5').checked) actions.push('Downgrade ROBINS-E');
    if (document.getElementById('cg-a6').checked) actions.push('Repair errors');
    const text = `CONDGO DECISION (UMBRELLA)
=====================================
Trigger: ${document.getElementById('cg-trigger').value}
Actions: ${actions.join(', ')}
Exit: ${document.getElementById('cg-exit').value}

≤72 hours. No new outcomes/priors/tests.`;
    showOutput('cg-output', text);
}

// ===== ROBINS-E =====
function saveRobinsE() {
    state.cinema = {
        confound: document.getElementById('robins-confound').value,
        selection: document.getElementById('robins-selection').value,
        exposure: document.getElementById('robins-exposure').value,
        postexp: document.getElementById('robins-postexp').value,
        missing: document.getElementById('robins-missing').value,
        outcome: document.getElementById('robins-outcome').value,
        reporting: document.getElementById('robins-reporting').value,
        overall: document.getElementById('robins-overall').value,
        justification: document.getElementById('robins-justification').value
    };
    save();
    showToast('ROBINS-E saved');
}

function generateRobinsEReport() {
    const text = `ROBINS-E RISK OF BIAS ASSESSMENT
=====================================
1. Confounding: ${document.getElementById('robins-confound').value || 'Not rated'}
2. Selection: ${document.getElementById('robins-selection').value || 'Not rated'}
3. Exposure classification: ${document.getElementById('robins-exposure').value || 'Not rated'}
4. Post-exposure interventions: ${document.getElementById('robins-postexp').value || 'Not rated'}
5. Missing data: ${document.getElementById('robins-missing').value || 'Not rated'}
6. Outcome measurement: ${document.getElementById('robins-outcome').value || 'Not rated'}
7. Selection of reported result: ${document.getElementById('robins-reporting').value || 'Not rated'}

OVERALL: ${document.getElementById('robins-overall').value || 'Not rated'}
Justification: ${document.getElementById('robins-justification').value || 'None provided'}`;
    showOutput('robins-output', text);
}

function toggleRankCheck(el, check) {
    el.classList.toggle('checked');
    state.rankingChecks[check] = el.classList.contains('checked');
    save();
    updateRankingResult();
}

function updateRankingResult() {
    const checks = state.rankingChecks || {};
    const allPass = checks.confidence && checks.incoherence && checks.applicability && checks.clinical;
    const result = document.getElementById('rankingResult');
    result.style.display = 'block';
    if (allPass) {
        result.className = 'alert alert-success';
        result.innerHTML = '<div class="alert-icon">✅</div><div class="alert-content"><div class="alert-title">Summary Umbrella Review CAN be reported</div><div class="alert-text">All conditions pass. Include with appropriate caution language.</div></div>';
    } else {
        result.className = 'alert alert-danger';
        result.innerHTML = '<div class="alert-icon">🚫</div><div class="alert-content"><div class="alert-title">Summary Umbrella Review must be SUPPRESSED</div><div class="alert-text">Report only effect estimates with uncertainty + confidence grading.</div></div>';
    }
}

// ===== NETWORK =====
function saveNodeDictionary() {
    state.testDictionary = document.getElementById('testDictionary').value;
    const lines = state.testDictionary.split('\n').filter(l => l.trim());
    state.testCount = lines.length;
    save();
    render();
    showToast('Node dictionary saved');
}

function saveModelContract() {
    const getValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : '';
    };

    state.modelContract = {
        method: getValue('modelMethod'),
        software: getValue('modelSoftware'),
        zeroCells: getValue('modelZeroCells'),
        minStudies: getValue('modelMinStudies'),
        prior: getValue('modelPrior'),
        convergence: getValue('modelConvergence')
    };
    save();
    showToast('Model contract saved');
}

// ===== UTILITIES =====
function showToast(msg) {
    const toast = document.getElementById('toast');
    document.getElementById('toastText').textContent = msg;
    toast.classList.add('visible');
    setTimeout(() => toast.classList.remove('visible'), 2500);
}

function launchConfetti() {
    const container = document.getElementById('confettiContainer');
    const colors = ['#0891B2', '#059669', '#D97706', '#DC2626', '#7C3AED'];
    for (let i = 0; i < 80; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + '%';
        c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        c.style.animationDelay = Math.random() * 0.5 + 's';
        container.appendChild(c);
    }
    setTimeout(() => container.innerHTML = '', 4000);
}

function exportData() {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = 'metasprint-umbrella-backup.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function escapeHtml(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function resetData() {
    if (!confirm('Reset all data? This cannot be undone.')) return;
    localStorage.removeItem('metasprint-umbrella');
    location.reload();
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    // Escape closes any open modal/overlay
    if (e.key === 'Escape') {
        const visibleModal = document.querySelector('.modal.visible');
        if (visibleModal) { closeModal(visibleModal.id); e.preventDefault(); return; }
        const dayJump = document.querySelector('.day-jump-modal.visible');
        if (dayJump) { closeDayJump(); e.preventDefault(); return; }
        const standup = document.querySelector('.standup-modal.open');
        if (standup) { closeStandupModal(); e.preventDefault(); return; }
    }
    if (document.getElementById('app').style.display === 'none') return;
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
    if (document.querySelector('.modal.visible, .day-jump-modal.visible, .standup-modal.open')) return;
    if (e.key === 'ArrowLeft') { changeDay(-1); e.preventDefault(); }
    else if (e.key === 'ArrowRight') { changeDay(1); e.preventDefault(); }
});

// ===== BOOTCAMP LESSONS =====
let currentLesson = 0;
const lessons = ['tests', 'applicability', 'threshold effects', 'summary accuracy', 'cinema'];

function openBootcampLesson(module) {
    const idx = lessons.indexOf(module);
    if (idx >= 0) currentLesson = idx;
    showLesson();
    openModal('bootcampModal');
}

function showLesson() {
    lessons.forEach((l, i) => {
        document.getElementById('lesson-' + l).style.display = i === currentLesson ? 'block' : 'none';
    });
    document.getElementById('lessonCounter').textContent = (currentLesson + 1) + ' / ' + lessons.length;
    document.getElementById('prevLessonBtn').disabled = currentLesson === 0;
    document.getElementById('nextLessonBtn').textContent = currentLesson === lessons.length - 1 ? 'Finish ✓' : 'Next →';
}

function nextLesson() {
    if (currentLesson < lessons.length - 1) {
        currentLesson++;
        showLesson();
    } else {
        closeModal('bootcampModal');
        showToast('Bootcamp complete!');
    }
}

function prevLesson() {
    if (currentLesson > 0) {
        currentLesson--;
        showLesson();
    }
}

// ===== DEADLINE ALERTS =====
function renderDeadlineAlerts() {
    const d = state.day;
    let alerts = [];

    // DoD-A alert (due Day 4)
    if (d <= 4 && !state.dodGates.A) {
        const daysLeft = 4 - d;
        if (daysLeft <= 2) {
            alerts.push({ type: daysLeft === 0 ? 'danger' : 'warning', icon: '⚠️', title: `DoD-A-UMBRELLA due ${daysLeft === 0 ? 'TODAY' : 'in ' + daysLeft + ' day(s)'}`, text: 'Protocol + Statistical Model + Study Registry must be locked' });
        }
    }

    // DoD-B alert (due Day 12)
    if (d > 4 && d <= 12 && !state.dodGates.B) {
        const daysLeft = 12 - d;
        if (daysLeft <= 3) {
            alerts.push({ type: daysLeft === 0 ? 'danger' : 'warning', icon: '🔍', title: `DoD-B-UMBRELLA due ${daysLeft === 0 ? 'TODAY' : 'in ' + daysLeft + ' day(s)'}`, text: 'Search complete + Meta-analysis feasibility confirmed' });
        }
    }

    // Audit 1 alert (Days 18-20)
    if (d >= 16 && d <= 20) {
        if (d < 18) alerts.push({ type: 'info', icon: '📋', title: `Audit 1 starts in ${18 - d} day(s)`, text: '10% trace audit + test mapping check' });
        else if (d <= 20) alerts.push({ type: 'warning', icon: '📋', title: 'Audit 1 in progress', text: 'Complete by Day 20' });
    }

    // DoD-C alert (due Day 28)
    if (d > 12 && d <= 28 && !state.dodGates.C) {
        const daysLeft = 28 - d;
        if (daysLeft <= 3) {
            alerts.push({ type: daysLeft === 0 ? 'danger' : 'warning', icon: '📊', title: `DoD-C-UMBRELLA due ${daysLeft === 0 ? 'TODAY' : 'in ' + daysLeft + ' day(s)'}`, text: 'Extraction + Study→Test mapping complete' });
        }
    }

    // Audit 2 alert (Days 30-32)
    if (d >= 28 && d <= 32) {
        if (d < 30) alerts.push({ type: 'info', icon: '🔬', title: `Audit 2 starts in ${30 - d} day(s)`, text: 'Rerun verification + influential study check' });
        else if (d <= 32) alerts.push({ type: 'warning', icon: '🔬', title: 'Audit 2 in progress', text: 'Complete by Day 32' });
    }

    // DoD-D + Freeze alert (Day 34)
    if (d > 28 && d <= 34 && !state.dodGates.D) {
        const daysLeft = 34 - d;
        if (daysLeft <= 3) {
            alerts.push({ type: daysLeft === 0 ? 'danger' : 'warning', icon: '🔒', title: `FREEZE ${daysLeft === 0 ? 'TODAY' : 'in ' + daysLeft + ' day(s)'}`, text: 'DoD-D-UMBRELLA + No new studies/tests/models after Day 34' });
        }
    }

    // Submission alert (Day 40)
    if (d > 34 && d <= 40) {
        const daysLeft = 40 - d;
        alerts.push({ type: daysLeft <= 2 ? 'danger' : 'info', icon: '🚀', title: `Submission ${daysLeft === 0 ? 'TODAY' : 'in ' + daysLeft + ' day(s)'}`, text: 'Complete PRISMA + Final manuscript' });
    }

    // On track message
    if (alerts.length === 0 && d <= 40) {
        const nextGate = !state.dodGates.A ? 'A' : !state.dodGates.B ? 'B' : !state.dodGates.C ? 'C' : !state.dodGates.D ? 'D' : 'E';
        alerts.push({ type: 'success', icon: '✅', title: 'On track', text: `Next milestone: DoD-${nextGate}-UMBRELLA` });
    }

    let html = '';
    alerts.forEach(a => {
        html += `<div class="alert alert-${a.type}" style="margin-bottom:8px">
            <div class="alert-icon">${a.icon}</div>
            <div class="alert-content">
                <div class="alert-title">${a.title}</div>
                <div class="alert-text">${a.text}</div>
            </div>
        </div>`;
    });
    document.getElementById('deadlineAlerts').innerHTML = html;
}

// ===== STUDY COUNT =====
function promptStudyCount() {
    const current = state.studyCount ?? 0;
    const input = prompt('Enter number of included studies:', current);
    if (input !== null && !isNaN(parseInt(input))) {
        state.studyCount = parseInt(input);
        save();
        render();
        // Warn if outside range
        if (state.studyCount > 60) {
            showToast('⚠️ Warning: >60 studies may exceed capacity');
        } else if (state.studyCount < 10 && state.studyCount > 0) {
            showToast('⚠️ Warning: <10 studies may limit accuracy');
        } else {
            showToast('Study count updated');
        }
    }
}

// ===== EFFECT MODIFIERS =====
function saveEffectModifiers() {
    state.effectModifiers = document.getElementById('effectModifiers').value;
    save();
    showToast('Effect modifiers saved');
}

// ===== TRANSITIVITY ASSESSMENT =====
function toggleApplicability(el, item) {
    el.classList.toggle('checked');
    if (!state.applicabilityChecks) state.applicabilityChecks = {};
    state.applicabilityChecks[item] = el.classList.contains('checked');
    save();
    updateApplicabilityResult();
}

function updateApplicabilityResult() {
    const checks = state.applicabilityChecks || {};
    const total = Object.keys(checks).filter(k => checks[k]).length;
    const result = document.getElementById('applicabilityResult');
    if (!result) return;
    result.style.display = 'block';
    if (total >= 4) {
        result.className = 'alert alert-success';
        result.innerHTML = '<div class="alert-icon">✅</div><div class="alert-content"><div class="alert-title">Applicability: Low concern</div><div class="alert-text">Effect modifiers appear balanced across comparisons.</div></div>';
    } else if (total >= 2) {
        result.className = 'alert alert-warning';
        result.innerHTML = '<div class="alert-icon">⚠️</div><div class="alert-content"><div class="alert-title">Applicability: Some concerns</div><div class="alert-text">Some imbalance in effect modifiers. Document in limitations.</div></div>';
    } else {
        result.className = 'alert alert-danger';
        result.innerHTML = '<div class="alert-icon">🚫</div><div class="alert-content"><div class="alert-title">Applicability: Major concerns</div><div class="alert-text">Significant imbalance. Consider suppressing summary accuracy.</div></div>';
    }
}

// Update render to include deadline alerts
const originalRender = render;
render = function() {
    originalRender();
    renderDeadlineAlerts();
};

// ===== PRISMA =====
function togglePrisma(el, item) {
    el.classList.toggle('checked');
    if (!state.prismaChecks) state.prismaChecks = {};
    state.prismaChecks[item] = el.classList.contains('checked');
    save();
}

// ===== AUDIT GENERATORS =====
function generateAudit1() {
    const checks = [];
    if (document.getElementById('a1-c1').checked) checks.push('Sample matches source');
    if (document.getElementById('a1-c2').checked) checks.push('Effect size correct');
    if (document.getElementById('a1-c3').checked) checks.push('Node mapping consistent');
    if (document.getElementById('a1-c4').checked) checks.push('Multi-threshold correct');
    if (document.getElementById('a1-c5').checked) checks.push('RoB supported');
    const testChecks = [];
    if (document.getElementById('a1-n1').checked) testChecks.push('All mapped');
    if (document.getElementById('a1-n2').checked) testChecks.push('Rules consistent');
    if (document.getElementById('a1-n3').checked) testChecks.push('No orphans');

    const text = `AUDIT 1 REPORT (Days 18-20)
=====================================
Auditor: ${document.getElementById('a1-auditor').value}
Dates: ${document.getElementById('a1-dates').value}

10% TRACE CHECKS:
${checks.map(c => '✓ ' + c).join('\n')}

NODE MAPPING VERIFICATION:
${testChecks.map(c => '✓ ' + c).join('\n')}

Discrepancies: ${document.getElementById('a1-discrepancies').value || 'None'}

RESULT: ${document.getElementById('a1-result').value?.toUpperCase() || 'PENDING'}`;
    showOutput('a1-output', text);
}

function generateAudit2() {
    const rerunChecks = [];
    if (document.getElementById('a2-c1').checked) rerunChecks.push('Rerun matches');
    if (document.getElementById('a2-c2').checked) rerunChecks.push('Within equivalence');
    if (document.getElementById('a2-c3').checked) rerunChecks.push('Summary Umbrella Review identical');
    if (document.getElementById('a2-c4').checked) rerunChecks.push('ROBINS-E consistent');
    const influentialChecks = [];
    if (document.getElementById('a2-i1').checked) influentialChecks.push('Influential listed');
    if (document.getElementById('a2-i2').checked) influentialChecks.push('Leave-one-out done');
    if (document.getElementById('a2-i3').checked) influentialChecks.push('No single study changes');
    if (document.getElementById('a2-i4').checked) influentialChecks.push('Data double-checked');

    const text = `AUDIT 2 REPORT (Days 30-32)
=====================================
Auditor: ${document.getElementById('a2-auditor').value}
Dates: ${document.getElementById('a2-dates').value}

RERUN VERIFICATION:
${rerunChecks.map(c => '✓ ' + c).join('\n')}

INFLUENTIAL STUDY CHECK:
${influentialChecks.map(c => '✓ ' + c).join('\n')}

Equivalence Summary:
${document.getElementById('a2-equivalence').value || 'Not documented'}

Issues: ${document.getElementById('a2-issues').value || 'None'}

RESULT: ${document.getElementById('a2-result').value?.toUpperCase() || 'PENDING'}`;
    showOutput('a2-output', text);
}

// ===== BOOTCAMP MODULE CLICK =====
function toggleBootcamp(el, module) {
    el.classList.toggle('completed');
    state.bootcamp[module] = el.classList.contains('completed');
    save();
    // Also open the lesson content
    openBootcampLesson(module);
}

// ===== TAB PROGRESS INDICATORS =====
function updateTabBadges() {
    const d = state.day;
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        // Remove existing badges
        const existing = tab.querySelector('.tab-badge');
        if (existing) existing.remove();
    });

    // Accuracy tab - needs attention if no tests defined
    if (!state.testDictionary && d >= 1) {
        addTabBadge('accuracy', 'needs-attention');
    } else if (state.testCount > 0) {
        addTabBadge('accuracy', 'complete');
    }

    // DoD tab - needs attention if gates due
    const nextGate = !state.dodGates.A ? 'A' : !state.dodGates.B ? 'B' : !state.dodGates.C ? 'C' : !state.dodGates.D ? 'D' : 'E';
    const gateDays = { A: 4, B: 12, C: 28, D: 34, E: 40 };
    if (d >= gateDays[nextGate] - 2 && !state.dodGates[nextGate]) {
        addTabBadge('dod', 'needs-attention');
    }

    // ROBINS-E tab - needs attention after Day 28
    if (d >= 28 && !state.cinema.overall) {
        addTabBadge('rob', 'needs-attention');
    } else if (state.cinema.overall) {
        addTabBadge('rob', 'complete');
    }

    // Timeline tab - complete indicator for PRISMA
    const prismaComplete = state.prismaChecks && Object.keys(state.prismaChecks).filter(k => state.prismaChecks[k]).length >= 8;
    if (prismaComplete) {
        addTabBadge('timeline', 'complete');
    }
}

function addTabBadge(tabName, type) {
    const tabMap = {
        'accuracy': 2,
        'dod': 3,
        'rob': 4,
        'timeline': 1
    };
    const tabs = document.querySelectorAll('.tab');
    const tabIndex = tabMap[tabName];
    if (tabs[tabIndex]) {
        const badge = document.createElement('span');
        badge.className = 'tab-badge ' + type;
        tabs[tabIndex].appendChild(badge);
    }
}

// ===== NETWORK GRAPH VISUALIZATION =====
function renderAccuracyGraph() {
    const testCount = state.testCount ?? 0;
    if (testCount < 2) {
        document.getElementById('accuracySvg').innerHTML = `
            <text x="200" y="90" text-anchor="middle" fill="var(--text-muted)" font-size="13">
                Add tests to Study Registry to see accuracy preview
            </text>`;
        return;
    }

    const svg = document.getElementById('accuracySvg');
    const cx = 200, cy = 90, radius = 70;
    const tests = [];
    const labels = state.testDictionary.split('\n').filter(l => l.trim()).slice(0, 12);

    // Calculate test positions in a circle
    for (let i = 0; i < Math.min(testCount, 12); i++) {
        const angle = (i / testCount) * 2 * Math.PI - Math.PI/2;
        tests.push({
            x: cx + radius * Math.cos(angle),
            y: cy + radius * Math.sin(angle),
            label: labels[i] ? labels[i].replace(/^Node \d+:\s*/i, '').substring(0, 8) : `N${i+1}`
        });
    }

    // Create edges (connect adjacent + some cross edges for connected accuracy)
    let edgesHtml = '';
    for (let i = 0; i < tests.length; i++) {
        // Connect to next test
        const j = (i + 1) % tests.length;
        edgesHtml += `<line class="accuracy-edge" x1="${tests[i].x}" y1="${tests[i].y}" x2="${tests[j].x}" y2="${tests[j].y}"/>`;

        // Add a cross-edge for larger accuracys
        if (tests.length > 4 && i < tests.length / 2) {
            const k = (i + Math.floor(tests.length / 2)) % tests.length;
            edgesHtml += `<line class="accuracy-edge" x1="${tests[i].x}" y1="${tests[i].y}" x2="${tests[k].x}" y2="${tests[k].y}" stroke-dasharray="4,2" opacity="0.5"/>`;
        }
    }

    // Create tests
    let testsHtml = '';
    const colors = ['#0891B2', '#059669', '#D97706', '#DC2626', '#7C3AED', '#0D9488', '#4F46E5', '#DB2777'];
    tests.forEach((test, i) => {
        const color = colors[i % colors.length];
        testsHtml += `
            <g class="accuracy-test" transform="translate(${test.x}, ${test.y})">
                <circle r="18" fill="${color}" stroke="white" stroke-width="2"/>
                <text class="accuracy-label" y="4" fill="white" font-size="9">${escapeHtml(test.label.substring(0, 3))}</text>
            </g>`;
    });

    svg.innerHTML = `<g id="accuracyEdges">${edgesHtml}</g><g id="accuracyTests">${testsHtml}</g>`;

    // Update edge count estimate
    document.getElementById('netEdges').textContent = Math.min(testCount + Math.floor(testCount/2), testCount * (testCount-1) / 2);
}

// Override saveNodeDictionary to also render graph
const originalSaveNodeDictionary = saveNodeDictionary;
saveNodeDictionary = function() {
    state.testDictionary = document.getElementById('testDictionary').value;
    const lines = state.testDictionary.split('\n').filter(l => l.trim());
    state.testCount = lines.length;
    save();
    render();
    renderAccuracyGraph();
    updateTabBadges();
    showToast('Node dictionary saved');
};

// Update render to include tab badges and accuracy graph
const originalRender2 = render;
render = function() {
    originalRender2();
    updateTabBadges();
    renderAccuracyGraph();
};

// ===== EVIDENCE REVERSAL STORIES =====
function toggleStory(header) {
    const body = header.nextElementSibling;
    body.classList.toggle('open');
    header.setAttribute('aria-expanded', body.classList.contains('open') ? 'true' : 'false');
    // Track which stories have been read
    const storyNum = header.querySelector('.story-number').textContent;
    if (!state.storiesRead) state.storiesRead = {};
    state.storiesRead[storyNum] = true;
    save();
    updateAchievements();
}

// ===== ACHIEVEMENTS SYSTEM =====
function updateAchievements() {
    const achievements = {
        bootcamp: checkBootcampComplete(),
        dodA: state.dodA && Object.values(state.dodA).filter(v => v).length >= 8,
        tests: (state.testCount ?? 0) >= 4,
        dodB: state.dodB && Object.values(state.dodB).filter(v => v).length >= 7,
        prisma: checkPrismaComplete(),
        dodC: state.dodC && Object.values(state.dodC).filter(v => v).length >= 7,
        cinema: checkCinemaComplete(),
        dodD: state.dodD && Object.values(state.dodD).filter(v => v).length >= 8,
        stories: state.storiesRead && Object.keys(state.storiesRead).length >= 4,
        dodE: state.dodE && Object.values(state.dodE).filter(v => v).length >= 8
    };

    let earned = 0;
    Object.entries(achievements).forEach(([key, unlocked]) => {
        const el = document.querySelector(`[data-check="${key}"]`);
        if (el) {
            if (unlocked) {
                if (!el.classList.contains('earned')) {
                    el.classList.add('earned');
                    // Show celebration toast on new unlock
                    const name = el.querySelector('.achievement-name').textContent;
                    showToast(`🏆 Achievement Unlocked: ${name}!`);
                }
                earned++;
            } else {
                el.classList.remove('earned');
            }
        }
    });

    const countEl = document.getElementById('achieveCount');
    if (countEl) countEl.textContent = `${earned}/10`;
}

function checkBootcampComplete() {
    const modules = document.querySelectorAll('.bootcamp-module.completed');
    return modules.length >= 5;
}

function checkPrismaComplete() {
    // Check if PRISMA checklist is mostly complete
    return state.prismaNma && Object.values(state.prismaNma).filter(v => v).length >= 6;
}

function checkCinemaComplete() {
    // Check if all 7 ROBINS-E domain ratings + overall are completed
    return state.cinema && Object.values(state.cinema).filter(v => v !== '' && v !== undefined).length >= 8;
}

// ===== DAILY STANDUP GENERATOR =====
function openStandupModal() {
    generateStandup();
    document.getElementById('standupModal').classList.add('open');
}

function closeStandupModal(e) {
    if (!e || e.target === e.currentTarget) {
        document.getElementById('standupModal').classList.remove('open');
    }
}

function generateStandup() {
    const day = state.day ?? 1;
    const yesterday = [];
    const today = [];
    const blockers = [];

    // Yesterday's completed tasks (from previous day)
    if (day > 1) {
        const prevTasks = getPhaseTasks(day - 1);
        const completed = prevTasks.filter(t => state.tasks && state.tasks[t.id]);
        yesterday.push(...completed.slice(0, 3).map(t => t.text));
        if (completed.length === 0) yesterday.push('(No tasks logged)');
    } else {
        yesterday.push('Day 1 - Project kickoff');
    }

    // Today's planned tasks
    const todayTasks = getPhaseTasks(day);
    const incomplete = todayTasks.filter(t => !state.tasks || !state.tasks[t.id]);
    today.push(...incomplete.slice(0, 4).map(t => t.text));
    if (today.length === 0) today.push('All tasks complete!');

    // Blockers (incomplete DoD items for current gate)
    const gate = getActiveGate(day);
    if (gate && state[gate]) {
        const dodItems = Object.entries(state[gate]).filter(([k, v]) => !v);
        if (dodItems.length > 0) {
            blockers.push(`${dodItems.length} DoD items remaining for ${gate.toUpperCase()}`);
        }
    }
    if (blockers.length === 0) blockers.push('No blockers');

    // Render
    document.getElementById('standupYesterday').innerHTML = yesterday.map(t => `<div class="standup-item">• ${escapeHtml(t)}</div>`).join('');
    document.getElementById('standupToday').innerHTML = today.map(t => `<div class="standup-item">• ${escapeHtml(t)}</div>`).join('');
    document.getElementById('standupBlockers').innerHTML = blockers.map(t => `<div class="standup-item">⚠️ ${escapeHtml(t)}</div>`).join('');

    // Status
    const gatesPassed = ['dodA', 'dodB', 'dodC', 'dodD', 'dodE'].filter(g => state[g] && Object.values(state[g]).filter(v => v).length >= 7).length;
    const daysLeft = 40 - day;
    const studies = state.studyCount ?? 0;
    document.getElementById('standupStatus').innerHTML = `
        <div class="standup-item">📅 Day ${day}/40 (${daysLeft} days remaining)</div>
        <div class="standup-item">🔗 ${state.testCount ?? 0} tests | ${studies} studies</div>
        <div class="standup-item">🚪 ${gatesPassed}/5 gates passed</div>
    `;
}

function getPhaseTasks(day) {
    // Return sample tasks based on day/phase
    if (day <= 3) return [
        { id: 'task1', text: 'Finalize Study Registry' },
        { id: 'task2', text: 'Lock protocol assumptions' },
        { id: 'task3', text: 'Complete DoD-A checklist' }
    ];
    if (day <= 10) return [
        { id: 'task4', text: 'Run database searches' },
        { id: 'task5', text: 'De-duplicate records' },
        { id: 'task6', text: 'Complete title/abstract screening' }
    ];
    if (day <= 28) return [
        { id: 'task7', text: 'Full-text screening' },
        { id: 'task8', text: 'Data extraction' },
        { id: 'task9', text: 'RoB assessment' }
    ];
    if (day <= 33) return [
        { id: 'task10', text: 'Run UMBRELLA models' },
        { id: 'task11', text: 'Check threshold effects' },
        { id: 'task12', text: 'Generate summary accuracy' }
    ];
    return [
        { id: 'task13', text: 'Complete ROBINS-E' },
        { id: 'task14', text: 'Write manuscript' },
        { id: 'task15', text: 'Final submission' }
    ];
}

function getActiveGate(day) {
    if (day <= 3) return 'dodA';
    if (day <= 10) return 'dodB';
    if (day <= 28) return 'dodC';
    if (day <= 33) return 'dodD';
    return 'dodE';
}

function copyStandup() {
    const day = state.day ?? 1;
    const yesterdayEl = document.getElementById('standupYesterday');
    const todayEl = document.getElementById('standupToday');
    const blockersEl = document.getElementById('standupBlockers');
    const statusEl = document.getElementById('standupStatus');

    const text = `📋 META-SPRINT UMBRELLA Standup - Day ${day}

✅ YESTERDAY:
${yesterdayEl.innerText}

📌 TODAY:
${todayEl.innerText}

🚧 BLOCKERS:
${blockersEl.innerText}

📊 STATUS:
${statusEl.innerText}
`;

    navigator.clipboard.writeText(text).then(() => {
        showToast('📋 Standup copied to clipboard!');
        closeStandupModal();
    }).catch(() => {
        showToast('Standup generated (clipboard unavailable)');
        closeStandupModal();
    });
}

// ===== PRISMA FLOW TRACKER =====
function savePrismaFlow() {
    state.prismaFlow = {
        identified: parseInt(document.getElementById('prismaIdentified')?.value, 10) ?? 0,
        duplicates: parseInt(document.getElementById('prismaDuplicates')?.value, 10) ?? 0,
        screened: parseInt(document.getElementById('prismaScreened')?.value, 10) ?? 0,
        excluded: parseInt(document.getElementById('prismaExcluded')?.value, 10) ?? 0,
        fullText: parseInt(document.getElementById('prismaFullText')?.value, 10) ?? 0,
        included: parseInt(document.getElementById('prismaIncluded')?.value, 10) ?? 0
    };
    state.studyCount = state.prismaFlow.included ?? 0;
    var studyEl = document.getElementById('studyCount');
    if (studyEl) studyEl.textContent = state.studyCount;
    save();

    // Update target display
    const targetEl = document.getElementById('prismaTarget');
    if (targetEl) {
        const included = state.prismaFlow.included;
        targetEl.textContent = included;
        targetEl.style.color = (included >= 40 && included <= 60) ? 'var(--success)' :
                               (included > 0) ? 'var(--warning)' : 'var(--text)';
    }

    // Show calculated suggestions
    const p = state.prismaFlow;
    const calcScreened = document.getElementById('calcScreened');
    const calcFullText = document.getElementById('calcFullText');
    if (calcScreened && p.identified > 0) {
        calcScreened.textContent = `Expected: ≤${p.identified - p.duplicates}`;
    }
    if (calcFullText && p.screened > 0) {
        calcFullText.textContent = `Expected: ≤${p.screened - p.excluded}`;
    }

    updateAchievements();
}

function loadPrismaFlow() {
    if (state.prismaFlow) {
        const fields = ['identified', 'duplicates', 'screened', 'excluded', 'fullText', 'included'];
        fields.forEach(f => {
            const el = document.getElementById('prisma' + f.charAt(0).toUpperCase() + f.slice(1));
            if (el) el.value = state.prismaFlow[f] || '';
        });
        validatePrisma();
        savePrismaFlow(); // Update displays
    }
}

function updateStudyCount() {
    const included = parseInt(document.getElementById('prismaIncluded')?.value, 10) ?? 0;
    if (included > 0) {
        state.studyCount = included;
        save();
        const el = document.getElementById('studyCount');
        if (el) el.textContent = included;
    }
}

// ===== PRISMA VALIDATION =====
function validatePrisma() {
    // Called when PRISMA numbers change
    const identified = parseInt(document.getElementById('prismaIdentified')?.value, 10) ?? 0;
    const duplicates = parseInt(document.getElementById('prismaDuplicates')?.value, 10) ?? 0;
    const screened = parseInt(document.getElementById('prismaScreened')?.value, 10) ?? 0;
    const excluded = parseInt(document.getElementById('prismaExcluded')?.value, 10) ?? 0;
    const fullText = parseInt(document.getElementById('prismaFullText')?.value, 10) ?? 0;
    const included = parseInt(document.getElementById('prismaIncluded')?.value, 10) ?? 0;

    const warningEl = document.getElementById('prismaWarning');
    if (!warningEl) return;

    const warnings = [];

    // Validation rules
    if (identified > 0 && screened > identified - duplicates) {
        warnings.push(`Screened (${screened}) should be ≤ Identified - Duplicates (${identified - duplicates})`);
    }
    if (screened > 0 && fullText > screened - excluded) {
        warnings.push(`Full-text (${fullText}) should be ≤ Screened - Excluded (${screened - excluded})`);
    }
    if (included > fullText) {
        warnings.push(`Included (${included}) cannot exceed Full-text (${fullText})`);
    }
    if (included > 0 && (included < 40 || included > 60)) {
        warnings.push(`Studies included (${included}) outside META-SPRINT range (40-60)`);
    }

    if (warnings.length > 0) {
        warningEl.innerHTML = '&#9888; ' + warnings.map(w => escapeHtml(w)).join('<br>&#9888; ');
        warningEl.classList.add('visible');
        warningEl.classList.remove('prisma-valid');
    } else if (included > 0) {
        warningEl.innerHTML = '✓ PRISMA numbers validated successfully';
        warningEl.classList.add('visible', 'prisma-valid');
    } else {
        warningEl.classList.remove('visible');
    }
}

// Hook into render to update achievements and PRISMA
const originalRender3 = render;
render = function() {
    originalRender3();
    setTimeout(() => {
        updateAchievements();
        loadPrismaFlow();
    }, 100);
};

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        updateAchievements();
        loadPrismaFlow();
    }, 500);
});
</script>

</body>
</html>
