<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>META-SPRINT NMA V3.4</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #F8FAFC;
            --surface: #FFFFFF;
            --border: #E2E8F0;
            --border-strong: #CBD5E1;
            --text: #0F172A;
            --text-secondary: #475569;
            --text-muted: #64748B;
            --accent: #0891B2;
            --accent-light: #CFFAFE;
            --success: #059669;
            --success-light: #D1FAE5;
            --warning: #D97706;
            --warning-light: #FEF3C7;
            --danger: #DC2626;
            --danger-light: #FEE2E2;
            --purple: #7C3AED;
            --purple-light: #EDE9FE;
            --nma: #0891B2;
            --nma-light: #CFFAFE;
            --warning-bg: #FFFBEB;
            --warning-border: #F59E0B;
            --warning-title: #B45309;
            --warning-text: #92400E;
        }

        /* Dark Mode */
        .dark-mode {
            --bg: #0F172A;
            --surface: #1E293B;
            --border: #334155;
            --border-strong: #475569;
            --text: #F1F5F9;
            --text-secondary: #CBD5E1;
            --text-muted: #94A3B8;
            --accent: #22D3EE;
            --accent-light: #164E63;
            --success: #10B981;
            --success-light: #032E23;
            --warning: #F59E0B;
            --warning-light: #4A2008;
            --danger: #EF4444;
            --danger-light: #451A1A;
            --purple: #A78BFA;
            --purple-light: #2E1065;
            --nma: #22D3EE;
            --nma-light: #164E63;
            --warning-bg: #422006;
            --warning-border: #92400E;
            --warning-title: #FBBF24;
            --warning-text: #FDE68A;
        }
        .dark-mode .form-input, .dark-mode .form-textarea, .dark-mode select { background: var(--surface); color: var(--text); }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; font-size: 14px; }
        .container { max-width: 900px; margin: 0 auto; padding: 16px; }

        /* Header */
        .header { background: linear-gradient(135deg, var(--nma) 0%, #0E7490 100%); border-bottom: 1px solid var(--border); padding: 12px 16px; position: sticky; top: 0; z-index: 100; }
        .header-inner { max-width: 900px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
        .logo { font-weight: 700; font-size: 18px; color: white; }
        .logo span { color: rgba(255,255,255,0.7); font-weight: 400; font-size: 12px; }
        .logo .nma-badge { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px; }
        .header-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .role-badge { background: rgba(255,255,255,0.2); color: white; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .day-control { display: flex; align-items: center; gap: 8px; }
        .day-btn { width: 44px; height: 44px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.1); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .day-btn:hover:not(:disabled) { background: rgba(255,255,255,0.2); }
        .day-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .day-display { font-weight: 700; font-size: 16px; min-width: 70px; text-align: center; color: white; cursor: pointer; padding: 4px 8px; border-radius: 6px; }
        .day-display:hover { background: rgba(255,255,255,0.1); }
        .day-hint { font-size: 12px; color: rgba(255,255,255,0.7); text-align: center; margin-top: 2px; }

        /* Toast notification */
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--success); color: white; padding: 12px 20px; border-radius: 8px; font-weight: 500; font-size: 13px; z-index: 1000; opacity: 0; transform: translateY(20px); transition: all 0.3s ease; pointer-events: none; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast.error { background: var(--danger); }

        /* Tabs */
        .tabs { display: flex; gap: 4px; background: var(--surface); padding: 8px 16px; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .tab { padding: 12px 16px; border: none; background: none; font-family: inherit; font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-radius: 6px; white-space: nowrap; }
        .tab:hover { background: var(--bg); }
        .tab.active { background: var(--nma-light); color: var(--nma); }

        /* Cards */
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
        .card-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .card-title { font-weight: 600; font-size: 15px; }
        .card-body { padding: 16px; }

        /* NMA-specific badges */
        .nma-indicator { background: var(--nma-light); color: var(--nma); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }

        /* Phase badges */
        .phase-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .phase-a { background: var(--purple-light); color: var(--purple); }
        .phase-b { background: var(--nma-light); color: var(--nma); }
        .phase-c { background: var(--warning-light); color: var(--warning); }
        .phase-d { background: var(--success-light); color: var(--success); }
        .phase-e { background: var(--danger-light); color: var(--danger); }

        /* Alerts */
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: flex-start; gap: 12px; }
        .alert-icon { font-size: 18px; flex-shrink: 0; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; margin-bottom: 2px; }
        .alert-text { font-size: 13px; }
        .alert-info { background: var(--nma-light); border: 1px solid var(--nma); }
        .alert-warning { background: var(--warning-light); border: 1px solid var(--warning); }
        .alert-danger { background: var(--danger-light); border: 1px solid var(--danger); }
        .alert-success { background: var(--success-light); border: 1px solid var(--success); }

        /* Checklist */
        .checklist-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s; }
        .checklist-item:hover { background: var(--bg); }
        .checklist-item.checked { background: var(--success-light); border-color: var(--success); }
        .check-box { width: 20px; height: 20px; border: 2px solid var(--border-strong); border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
        .checklist-item.checked .check-box { background: var(--success); border-color: var(--success); }
        .check-box svg { color: white; display: none; }
        .checklist-item.checked .check-box svg { display: block; }
        .checklist-content { flex: 1; }
        .checklist-title { font-weight: 500; }
        .checklist-hint { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

        /* Timeline */
        .timeline-bar { height: 8px; background: var(--border); border-radius: 4px; position: relative; margin: 16px 0; }
        .timeline-fill { height: 100%; background: var(--nma); border-radius: 4px; transition: width 0.3s; }
        .timeline-markers { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .timeline-marker { text-align: center; }
        .timeline-marker.active { color: var(--nma); font-weight: 600; }
        .timeline-marker.passed { color: var(--success); }

        /* Health Dashboard */
        .health-dashboard { background: linear-gradient(135deg, var(--surface) 0%, var(--bg) 100%); border: 2px solid var(--nma); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .health-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
        .health-title { font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .health-score { font-size: 24px; font-weight: 700; }
        .health-score.good { color: var(--success); }
        .health-score.warning { color: var(--warning); }
        .health-score.danger { color: var(--danger); }
        .health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
        .health-stat { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center; }
        .health-stat-value { font-size: 20px; font-weight: 700; color: var(--nma); }
        .health-stat-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .gate-dots { display: flex; gap: 6px; justify-content: center; margin-top: 12px; }
        .gate-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: var(--text-muted); }
        .gate-dot.passed { background: var(--success); border-color: var(--success); color: white; }
        .gate-dot.current { border-color: var(--warning); color: var(--warning); animation: pulse 1.5s infinite; }

        .risk-panel { margin-top: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
        .risk-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px; }
        .risk-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); letter-spacing: 0.02em; text-transform: uppercase; }
        .risk-badge { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 999px; }
        .risk-badge.low { background: var(--success-light); color: var(--success); }
        .risk-badge.medium { background: var(--warning-light); color: var(--warning); }
        .risk-badge.high { background: var(--danger-light); color: var(--danger); }
        .risk-list { list-style: none; margin: 0; padding: 0; display: grid; gap: 6px; }
        .risk-item { font-size: 12px; color: var(--text-secondary); padding: 6px 8px; border-radius: 6px; background: var(--bg); border: 1px solid var(--border); }
        .risk-item.medium { border-color: var(--warning); background: var(--warning-light); color: var(--warning); }
        .risk-item.high { border-color: var(--danger); background: var(--danger-light); color: var(--danger); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Network visualization placeholder */
        .network-preview { background: var(--bg); border: 2px dashed var(--border); border-radius: 12px; padding: 24px; text-align: center; margin-bottom: 16px; }
        .network-preview-title { font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .network-stats { display: flex; justify-content: center; gap: 24px; flex-wrap: wrap; }
        .network-stat { text-align: center; }
        .network-stat-value { font-size: 28px; font-weight: 700; color: var(--nma); }
        .network-stat-label { font-size: 12px; color: var(--text-muted); }

        /* Forms */
        .form-row { margin-bottom: 12px; }
        .form-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; display: block; }
        .form-input, .form-textarea { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; }
        .form-textarea { resize: vertical; min-height: 60px; }
        .form-hint { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

        /* Buttons */
        .copy-btn { background: var(--nma); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-family: inherit; font-weight: 600; cursor: pointer; }
        .copy-btn:hover { background: #0E7490; }
        .download-btn { background: var(--surface); color: var(--text); border: 1px solid var(--border); padding: 10px 20px; border-radius: 6px; font-family: inherit; font-weight: 600; cursor: pointer; }
        .download-btn:hover { background: var(--bg); }
        .btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }

        /* Templates */
        .template-card { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; overflow: hidden; }
        .template-header { padding: 12px 16px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .template-header:hover { background: var(--border); }
        .template-name { font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .template-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .badge-essential { background: var(--danger-light); color: var(--danger); }
        .badge-nma { background: var(--nma-light); color: var(--nma); }
        .badge-reference { background: var(--purple-light); color: var(--purple); }
        .template-body { padding: 16px; display: none; }
        .template-body.open { display: block; }
        .template-output { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-top: 12px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; white-space: pre-wrap; display: none; }
        .template-output.visible { display: block; }

        /* Tables */
        .ref-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .ref-table th, .ref-table td { padding: 10px 12px; border: 1px solid var(--border); text-align: left; }
        .ref-table th { background: var(--bg); font-weight: 600; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
        .modal.visible { display: flex; }
        .modal-card { background: var(--surface); border-radius: 16px; width: 100%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font-weight: 700; font-size: 18px; }
        .modal-close { width: 44px; height: 44px; border: none; background: var(--bg); border-radius: 8px; cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; }
        .modal-body { padding: 24px; }

        /* Onboarding */
        .onboarding { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px; overflow-y: auto; }
        .onboarding.hidden { display: none; }
        .onboarding-card { background: var(--surface); border-radius: 16px; width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; }
        .onboarding-header { background: linear-gradient(135deg, var(--nma) 0%, #0E7490 100%); padding: 24px; border-radius: 16px 16px 0 0; color: white; text-align: center; }
        .onboarding-body { padding: 24px; }
        .role-grid { display: grid; gap: 8px; margin-bottom: 24px; }
        .role-btn { display: flex; align-items: center; gap: 12px; padding: 14px; border: 2px solid var(--border); border-radius: 10px; background: var(--surface); cursor: pointer; text-align: left; font-family: inherit; }
        .role-btn:hover { border-color: var(--nma); }
        .role-btn.selected { border-color: var(--nma); background: var(--nma-light); }
        .role-icon { width: 36px; height: 36px; background: var(--bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .role-info { flex: 1; }
        .role-name { font-weight: 600; font-size: 14px; }
        .role-desc { font-size: 11px; color: var(--text-secondary); }
        .start-btn { width: 100%; padding: 14px; background: var(--nma); color: white; border: none; border-radius: 8px; font-family: inherit; font-size: 15px; font-weight: 600; cursor: pointer; }
        .start-btn:disabled { background: var(--border-strong); cursor: not-allowed; }

        /* Eligibility checks */
        .elig-item { display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
        .elig-item:hover { background: var(--bg); }
        .elig-item.checked { background: var(--success-light); border-color: var(--success); }
        .elig-check { width: 22px; height: 22px; border: 2px solid var(--border-strong); border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .elig-item.checked .elig-check { background: var(--success); border-color: var(--success); }
        .elig-check svg { color: white; display: none; }
        .elig-item.checked .elig-check svg { display: block; }

        /* Pages */
        .page { display: none; }
        .page.active { display: block; }

        /* Freeze banner */
        .freeze-banner { background: var(--danger); color: white; padding: 12px 16px; text-align: center; font-weight: 600; }
        .freeze-banner.hidden { display: none; }

        /* DoD sections */
        .dod-section { margin-bottom: 24px; }
        .dod-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 12px; border-radius: 8px; }
        .dod-header.phase-a { background: var(--purple-light); }
        .dod-header.phase-b { background: var(--nma-light); }
        .dod-header.phase-c { background: var(--warning-light); }
        .dod-header.phase-d { background: var(--success-light); }
        .dod-header.phase-e { background: var(--danger-light); }
        .dod-title { font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .dod-gate-status { padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .gate-pending { background: var(--bg); color: var(--text-muted); }
        .gate-ready { background: var(--warning-light); color: var(--warning); }
        .gate-passed { background: var(--success-light); color: var(--success); }

        /* Confetti */
        .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
        .confetti { position: absolute; width: 10px; height: 10px; opacity: 0; animation: confetti-fall 3s ease-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-100px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }

        /* Day jump modal */
        .day-jump-modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: center; justify-content: center; z-index: 1001; }
        .day-jump-modal.visible { display: flex; }
        .day-jump-card { background: var(--surface); border-radius: 12px; padding: 24px; width: 280px; max-width: calc(100vw - 32px); text-align: center; }
        .day-jump-input { width: 100px; padding: 12px; font-size: 24px; font-weight: 700; text-align: center; border: 2px solid var(--nma); border-radius: 8px; }

        /* Bootcamp section */
        .bootcamp-card { background: linear-gradient(135deg, var(--nma-light) 0%, var(--bg) 100%); border: 2px solid var(--nma); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .bootcamp-title { font-weight: 700; color: var(--nma); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .bootcamp-modules { display: grid; gap: 8px; }
        .bootcamp-module { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; }
        .bootcamp-module.completed { background: var(--success-light); border-color: var(--success); }
        .bootcamp-module-check { width: 24px; height: 24px; border: 2px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .bootcamp-module.completed .bootcamp-module-check { background: var(--success); border-color: var(--success); color: white; }
        .bootcamp-module-info { flex: 1; }
        .bootcamp-module-name { font-weight: 600; font-size: 13px; }
        .bootcamp-module-time { font-size: 11px; color: var(--text-muted); }

        /* CINeMA domains */
        .cinema-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 16px; }
        .cinema-domain { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center; }
        .cinema-domain-name { font-weight: 600; font-size: 12px; margin-bottom: 4px; }
        .cinema-domain-rating { font-size: 11px; padding: 2px 8px; border-radius: 4px; }
        .cinema-high { background: var(--success-light); color: var(--success); }
        .cinema-moderate { background: var(--warning-light); color: var(--warning); }
        .cinema-low { background: var(--danger-light); color: var(--danger); }

        /* Tab progress indicators */
        .tab { position: relative; }
        .tab-badge { position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; border-radius: 50%; }
        .tab-badge.needs-attention { background: var(--warning); }
        .tab-badge.complete { background: var(--success); }

        /* Network graph visualization */
        .network-graph { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; min-height: 200px; position: relative; margin-bottom: 16px; }
        .network-graph svg { width: 100%; height: 180px; }
        .network-node { cursor: pointer; transition: all 0.2s; }
        .network-node:hover { transform: scale(1.1); }
        .network-edge { stroke: var(--border-strong); stroke-width: 2; }
        .network-label { font-size: 11px; fill: var(--text); font-weight: 600; text-anchor: middle; }

        /* Handoff checklist */
        .handoff-card { background: linear-gradient(135deg, var(--purple-light) 0%, var(--bg) 100%); border: 1px solid var(--purple); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .handoff-title { font-weight: 700; color: var(--purple); font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .handoff-items { display: grid; gap: 4px; }
        .handoff-item { font-size: 12px; display: flex; align-items: center; gap: 6px; }
        .handoff-item input { margin: 0; }

        /* Worked example */
        .example-box { background: var(--nma-light); border: 1px solid var(--nma); border-radius: 8px; padding: 16px; margin: 12px 0; }
        .example-title { font-weight: 700; color: var(--nma); margin-bottom: 8px; }
        .example-step { background: var(--surface); border-radius: 6px; padding: 10px; margin-bottom: 8px; font-size: 13px; }
        .example-step-num { display: inline-block; width: 20px; height: 20px; background: var(--nma); color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 11px; font-weight: 700; margin-right: 8px; }

        /* Evidence Reversal Stories */
        .story-card { background: linear-gradient(135deg, var(--surface) 0%, var(--bg) 100%); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .story-header { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); color: white; padding: 20px; cursor: pointer; }
        .story-header:hover { background: linear-gradient(135deg, #234b78 0%, #1e293b 100%); }
        .story-number { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-bottom: 4px; }
        .story-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .story-hook { font-size: 14px; opacity: 0.9; font-style: italic; }
        .story-body { display: none; padding: 0; }
        .story-body.open { display: block; }
        .story-scene { padding: 20px; border-bottom: 1px solid var(--border); }
        .story-scene:last-child { border-bottom: none; }
        .scene-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; }
        .scene-content { font-size: 14px; line-height: 1.7; }
        .story-question { background: var(--nma-light); border-left: 4px solid var(--nma); padding: 16px; margin: 16px 0; font-size: 15px; font-weight: 600; font-style: italic; color: var(--nma); }
        .story-contrast { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0; }
        .contrast-box { padding: 16px; border-radius: 8px; }
        .contrast-wrong { background: var(--danger-light); border: 1px solid var(--danger); }
        .contrast-right { background: var(--success-light); border: 1px solid var(--success); }
        .contrast-label { font-size: 11px; text-transform: uppercase; font-weight: 700; margin-bottom: 8px; }
        .contrast-wrong .contrast-label { color: var(--danger); }
        .contrast-right .contrast-label { color: var(--success); }
        .story-moral { background: linear-gradient(135deg, var(--success-light) 0%, #d1fae5 100%); border: 2px solid var(--success); border-radius: 8px; padding: 20px; margin-top: 16px; }
        .moral-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--success); font-weight: 700; margin-bottom: 8px; }
        .moral-text { font-size: 15px; font-weight: 600; color: var(--success); }
        .story-reflection { background: var(--purple-light); border-radius: 8px; padding: 16px; margin-top: 16px; }
        .reflection-question { font-size: 14px; color: var(--purple); font-weight: 600; margin-bottom: 8px; }
        @media (max-width: 640px) { .story-contrast { grid-template-columns: 1fr; } }

        /* Achievements System */
        .achievements-panel { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid var(--warning); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .achievements-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .achievements-title { font-weight: 700; font-size: 15px; color: #92400e; display: flex; align-items: center; gap: 8px; }
        .achievements-count { background: var(--warning); color: white; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .achievement { background: var(--surface); border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; text-align: center; opacity: 0.4; transition: all 0.3s; }
        .achievement.earned { opacity: 1; border-color: var(--warning); box-shadow: 0 2px 8px rgba(217, 119, 6, 0.2); }
        .achievement-icon { font-size: 24px; margin-bottom: 4px; }
        .achievement-name { font-size: 11px; font-weight: 600; color: var(--text); }
        .achievement-desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        .achievement.earned .achievement-icon { animation: achievePulse 0.5s ease; }
        @keyframes achievePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        /* Daily Standup Generator */
        .standup-btn { background: linear-gradient(135deg, var(--purple) 0%, #6d28d9 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
        .standup-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3); }
        .standup-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .standup-modal.open { display: flex; }
        .standup-card { background: var(--surface); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .standup-section { background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .standup-label { font-size: 11px; text-transform: uppercase; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; }
        .standup-items { font-size: 13px; }
        .standup-item { padding: 4px 0; display: flex; align-items: flex-start; gap: 6px; }
        .standup-copy { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 8px; }
        .standup-copy:hover { background: #047857; }

        /* Contextual Help Tooltips */
        .help-tip { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; line-height: 20px; background: var(--text-muted); color: white; border-radius: 50%; font-size: 11px; font-weight: 700; cursor: help; margin-left: 4px; position: relative; }
        .help-tip:hover { background: var(--nma); }
        .help-tip::after { content: attr(data-tip); position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--text); color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: 400; white-space: normal; width: 200px; text-align: left; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .help-tip:hover::after { opacity: 1; visibility: visible; }
        .help-tip::before { content: ''; position: absolute; bottom: calc(100% + 2px); left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: var(--text); opacity: 0; visibility: hidden; transition: all 0.2s; }
        .help-tip:hover::before { opacity: 1; visibility: visible; }

        /* PRISMA Validation */
        .prisma-warning { background: var(--danger-light); border: 1px solid var(--danger); border-radius: 6px; padding: 8px 12px; font-size: 12px; color: var(--danger); margin-top: 8px; display: none; }
        .prisma-warning.visible { display: block; }
        .prisma-valid { background: var(--success-light); border: 1px solid var(--success); color: var(--success); }
        .prisma-calc { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-style: italic; }

        /* Mobile */
        @media (max-width: 640px) {
            .header-inner { flex-direction: column; align-items: stretch; }
            .header-controls { justify-content: center; }
            .health-grid { grid-template-columns: repeat(2, 1fr); }
            .form-input, .form-textarea, select { font-size: 16px; }
        }

        /* Focus visible */
        :focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

        /* Modal shadows */
        .modal-card, .onboarding-card { box-shadow: 0 20px 60px rgba(0,0,0,0.25); }

        /* Print styles */
        @media print { .header, .tabs, .toast, .modal, .onboarding, .standup-modal, .day-jump-modal, .confetti-container { display: none !important; } body { background: white !important; color: black !important; } .card { break-inside: avoid; box-shadow: none; } .container { max-width: 100%; } }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; } }

        /* Tablet breakpoint */
        @media (min-width: 641px) and (max-width: 899px) { .health-grid { grid-template-columns: repeat(3, 1fr); } .role-grid { grid-template-columns: repeat(2, 1fr); } }
        /* 2-Tier Tab System */
        .tab-more-wrapper { position: relative; display: inline-flex; }
        .tab-more-btn { padding: 12px 16px; border: none; background: none; font-family: inherit; font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-radius: 6px; white-space: nowrap; display: flex; align-items: center; gap: 4px; }
        .tab-more-btn:hover { background: var(--bg); }
        .tab-more-btn.has-active { color: var(--nma); }
        .tab-more-dropdown { display: none; position: absolute; top: 100%; right: 0; min-width: 220px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 200; padding: 4px; }
        .tab-more-dropdown.visible { display: block; }
        .tab-more-item { display: block; width: 100%; padding: 10px 14px; border: none; background: none; font-family: inherit; font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-radius: 6px; text-align: left; white-space: nowrap; }
        .tab-more-item:hover { background: var(--bg); }
        .tab-more-item:focus-visible { outline: 2px solid var(--nma); outline-offset: -2px; }
        .tab-more-item.active { background: var(--nma-light); color: var(--nma); }
        .dark-mode .tab-more-dropdown { box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
    </style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast" aria-live="polite" aria-atomic="true"><span id="toastIcon">✓</span><span id="toastText">Saved</span></div>

<!-- CONFETTI -->
<div class="confetti-container" id="confettiContainer" aria-hidden="true"></div>

<!-- DAY JUMP MODAL -->
<div class="day-jump-modal" id="dayJumpModal" role="dialog" aria-modal="true" onclick="closeDayJump(event)">
    <div class="day-jump-card" onclick="event.stopPropagation()">
        <div style="font-weight:700;margin-bottom:16px">Jump to Day</div>
        <input type="number" class="day-jump-input" id="dayJumpInput" inputmode="numeric" aria-label="Jump to day (1-40)" min="1" max="40" value="1" onkeydown="handleDayJumpKey(event)">
        <div class="btn-row" style="justify-content:center;margin-top:16px">
            <button class="download-btn" onclick="closeDayJump()">Cancel</button>
            <button class="copy-btn" onclick="jumpToDay()">Go</button>
        </div>
    </div>
</div>

<!-- BOOTCAMP MODAL -->
<div class="modal" id="bootcampModal" role="dialog" aria-modal="true">
    <div class="modal-card" style="max-width:700px">
        <div class="modal-header">
            <div class="modal-title">🎓 NMA Bootcamp</div>
            <button class="modal-close" aria-label="Close" onclick="closeModal('bootcampModal')">×</button>
        </div>
        <div class="modal-body" id="bootcampContent">
            <!-- Module 1: Node Dictionary -->
            <div class="bootcamp-lesson" id="lesson-nodes">
                <h3 style="color:var(--nma);margin-bottom:12px">Module 1: Node Dictionary & Mapping (10 min)</h3>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <p><strong>What is a Node?</strong></p>
                    <p style="margin:8px 0">A node is a treatment option in your network. Each unique intervention becomes a node. For example: Placebo, Drug A 10mg, Drug A 20mg, Drug B.</p>
                    <p style="margin-top:12px"><strong>Why Node Dictionary Matters:</strong></p>
                    <ul style="margin:8px 0 0 20px;font-size:13px">
                        <li>Defines how treatments are grouped or split</li>
                        <li>Locked at DoD-A — changes require CondGO</li>
                        <li>Max 12 nodes for META-SPRINT feasibility</li>
                        <li>Each node needs ≥2 studies for stable estimates</li>
                    </ul>
                </div>
                <div style="background:var(--warning-light);padding:12px;border-radius:8px;border:1px solid var(--warning);font-size:13px">
                    <strong>⚠️ Common Mistake:</strong> Splitting doses too finely (Drug A 5mg vs 10mg vs 15mg vs 20mg) creates sparse nodes. Consider clinically meaningful groupings.
                </div>
                <div style="background:var(--success-light);padding:12px;border-radius:8px;border:1px solid var(--success);font-size:13px;margin-top:8px">
                    <strong>✅ Example Node Dictionary:</strong><br>
                    Node 1: Placebo<br>
                    Node 2: Drug A (all doses pooled)<br>
                    Node 3: Drug B low dose (≤10mg)<br>
                    Node 4: Drug B high dose (>10mg)<br>
                    Node 5: Drug C
                </div>
            </div>

            <!-- Module 2: Transitivity -->
            <div class="bootcamp-lesson" id="lesson-transitivity" style="display:none">
                <h3 style="color:var(--nma);margin-bottom:12px">Module 2: Transitivity & Effect Modifiers (10 min)</h3>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <p><strong>What is Transitivity?</strong></p>
                    <p style="margin:8px 0">The assumption that if A vs B studies and B vs C studies are similar enough, we can validly estimate A vs C indirectly. It's the foundation of NMA.</p>
                    <p style="margin-top:12px"><strong>Effect Modifiers:</strong></p>
                    <p style="margin:8px 0;font-size:13px">Variables that change the treatment effect. If effect modifiers are distributed unevenly across comparisons, transitivity fails.</p>
                </div>
                <div class="table-wrapper" style="overflow-x:auto"><table class="ref-table" style="font-size:12px">
                    <thead><tr><th>Common Effect Modifiers</th><th>Why It Matters</th></tr></thead>
                    <tbody>
                        <tr><td>Disease severity</td><td>Severe patients may respond differently</td></tr>
                        <tr><td>Prior treatment</td><td>Treatment-naive vs experienced</td></tr>
                        <tr><td>Age distribution</td><td>Elderly may metabolize drugs differently</td></tr>
                        <tr><td>Comorbidities</td><td>May alter treatment response</td></tr>
                        <tr><td>Outcome definition</td><td>Different scales/timepoints</td></tr>
                        <tr><td>Study era</td><td>Standard of care changes over time</td></tr>
                    </tbody>
                </table></div>
                <div style="background:var(--danger-light);padding:12px;border-radius:8px;border:1px solid var(--danger);font-size:13px;margin-top:12px">
                    <strong>🚫 Transitivity Violation Example:</strong> All A vs B studies are in mild disease, all B vs C studies are in severe disease. The indirect A vs C estimate would be biased.
                </div>
            </div>

            <!-- Module 3: Inconsistency -->
            <div class="bootcamp-lesson" id="lesson-inconsistency" style="display:none">
                <h3 style="color:var(--nma);margin-bottom:12px">Module 3: Inconsistency — Global vs Local (10 min)</h3>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <p><strong>What is Inconsistency?</strong></p>
                    <p style="margin:8px 0">When direct evidence (A vs B from head-to-head trials) disagrees with indirect evidence (A vs B estimated via A-C and B-C). This signals a problem.</p>
                </div>
                <div class="table-wrapper" style="overflow-x:auto"><table class="ref-table" style="font-size:12px">
                    <thead><tr><th>Test Type</th><th>What It Tests</th><th>Interpretation</th></tr></thead>
                    <tbody>
                        <tr><td><strong>Global</strong><br>(Design-by-treatment)</td><td>Overall network coherence</td><td>p < 0.10 suggests inconsistency somewhere in network</td></tr>
                        <tr><td><strong>Local</strong><br>(Node-splitting)</td><td>Specific comparison</td><td>Identifies which comparisons have direct vs indirect disagreement</td></tr>
                        <tr><td><strong>Loop-specific</strong></td><td>Individual loops</td><td>Finds problematic triangular loops</td></tr>
                    </tbody>
                </table></div>
                <div style="background:var(--nma-light);padding:12px;border-radius:8px;border:1px solid var(--nma);font-size:13px;margin-top:12px">
                    <strong>💡 What to do if inconsistency detected:</strong><br>
                    1. Check for transitivity violations (effect modifier imbalance)<br>
                    2. Look for outlier studies driving the inconsistency<br>
                    3. Consider sensitivity analysis excluding outliers<br>
                    4. Downgrade CINeMA confidence for affected comparisons<br>
                    5. If severe: suppress rankings
                </div>
            </div>

            <!-- Module 4: Rankings -->
            <div class="bootcamp-lesson" id="lesson-rankings" style="display:none">
                <h3 style="color:var(--nma);margin-bottom:12px">Module 4: Rankings — What They Mean & Don't (5 min)</h3>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <p><strong>SUCRA / P-scores:</strong></p>
                    <p style="margin:8px 0;font-size:13px">Surface Under Cumulative Ranking curve (Bayesian) or P-scores (Frequentist). Range 0-100%. Higher = more likely to be best.</p>
                    <p style="margin-top:12px"><strong>What rankings DO tell you:</strong></p>
                    <ul style="margin:8px 0 0 20px;font-size:13px">
                        <li>Relative probability of being best among included treatments</li>
                        <li>Useful for hypothesis generation</li>
                    </ul>
                    <p style="margin-top:12px"><strong>What rankings DON'T tell you:</strong></p>
                    <ul style="margin:8px 0 0 20px;font-size:13px">
                        <li>Clinical significance of differences</li>
                        <li>Whether the "best" treatment is actually good</li>
                        <li>Confidence in the ranking (need CINeMA for that)</li>
                    </ul>
                </div>
                <div style="background:var(--danger-light);padding:12px;border-radius:8px;border:1px solid var(--danger);font-size:13px">
                    <strong>🚫 SUPPRESS RANKINGS IF ANY:</strong><br>
                    • CINeMA confidence "Low" for key contrasts<br>
                    • Severe incoherence affecting key contrasts<br>
                    • Transitivity concerns "High"<br>
                    • Effect sizes not clinically meaningful
                </div>
            </div>

            <!-- Module 5: CINeMA -->
            <div class="bootcamp-lesson" id="lesson-cinema" style="display:none">
                <h3 style="color:var(--nma);margin-bottom:12px">Module 5: CINeMA Domains (10 min)</h3>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <p><strong>CINeMA = Confidence in Network Meta-Analysis</strong></p>
                    <p style="margin:8px 0;font-size:13px">Like GRADE for pairwise, but with NMA-specific domains. Rates confidence for each pairwise comparison in the network.</p>
                </div>
                <div class="table-wrapper" style="overflow-x:auto"><table class="ref-table" style="font-size:11px">
                    <thead><tr><th>Domain</th><th>Question</th><th>Example: "Some concerns"</th></tr></thead>
                    <tbody>
                        <tr><td><strong>Within-study bias</strong></td><td>RoB in contributing studies?</td><td>Mix of low and high RoB studies</td></tr>
                        <tr><td><strong>Reporting bias</strong></td><td>Missing studies/outcomes?</td><td>Some asymmetry in comparison-adjusted funnel</td></tr>
                        <tr><td><strong>Indirectness</strong></td><td>Applicable to your PICO?</td><td>Populations somewhat different from target</td></tr>
                        <tr><td><strong>Imprecision</strong></td><td>CI width acceptable?</td><td>CI crosses one decision threshold</td></tr>
                        <tr><td><strong>Heterogeneity</strong></td><td>Between-study variability?</td><td>I² 50-75%, τ² moderate</td></tr>
                        <tr><td><strong>Incoherence</strong></td><td>Direct vs indirect agree?</td><td>Some disagreement but not severe</td></tr>
                    </tbody>
                </table></div>
                <div style="background:var(--success-light);padding:12px;border-radius:8px;border:1px solid var(--success);font-size:13px;margin-top:12px">
                    <strong>✅ Overall Confidence:</strong> Start at "High", downgrade one level for each domain with "Some concerns", two levels for "Major concerns"
                </div>
            </div>

            <div class="btn-row" style="justify-content:space-between;margin-top:20px">
                <button class="download-btn" id="prevLessonBtn" onclick="prevLesson()" disabled>← Previous</button>
                <span id="lessonCounter" style="font-weight:600;color:var(--text-secondary)">1 / 5</span>
                <button class="copy-btn" id="nextLessonBtn" onclick="nextLesson()">Next →</button>
            </div>
        </div>
    </div>
</div>

<!-- ONBOARDING -->
<div class="onboarding" id="onboarding">
    <div class="onboarding-card">
        <div class="onboarding-header">
            <div style="font-size:32px;margin-bottom:8px">🔗</div>
            <h2 style="font-size:22px;margin-bottom:4px">META-SPRINT NMA</h2>
            <p style="opacity:0.9;font-size:14px">Network Meta-Analysis in 40 Days</p>
        </div>
        <div class="onboarding-body" id="step1">
            <div style="text-align:center;margin-bottom:20px">
                <div style="font-size:18px;font-weight:700;margin-bottom:8px">Eligibility Check</div>
                <p style="color:var(--text-secondary);font-size:13px">All criteria must be met for NMA workflow</p>
            </div>
            <div class="eligibility-list">
                <div class="elig-item" onclick="toggleElig(this)">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <div><strong>≤60 studies</strong> anticipated included</div>
                </div>
                <div class="elig-item" onclick="toggleElig(this)">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <div><strong>≤12 treatment nodes</strong> after mapping</div>
                </div>
                <div class="elig-item" onclick="toggleElig(this)">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <div><strong>Arm-level data</strong> extractable from publications</div>
                </div>
                <div class="elig-item" onclick="toggleElig(this)">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <div><strong>Single primary outcome</strong> + single timepoint</div>
                </div>
                <div class="elig-item" onclick="toggleElig(this)">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <div><strong>No IPD required</strong></div>
                </div>
                <div class="elig-item" onclick="toggleElig(this)">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <div><strong>12-person team</strong> available (≤2h/day each)</div>
                </div>
            </div>
            <button class="start-btn" id="nextBtn1" disabled onclick="goToStep2()">Continue →</button>
        </div>
        <div id="step2" style="display:none">
            <div class="onboarding-body">
                <div style="text-align:center;margin-bottom:20px">
                    <div style="font-size:18px;font-weight:700;margin-bottom:8px">Select Your Role</div>
                    <p style="color:var(--text-secondary);font-size:13px">NMA requires specialized roles</p>
                </div>
                <div class="role-grid">
                    <button class="role-btn" onclick="selectRole(this, 'integrator')">
                        <div class="role-icon">🎯</div>
                        <div class="role-info"><div class="role-name">Integrator</div><div class="role-desc">Owns gates, timeline, audit pack, submission</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'deputy')">
                        <div class="role-icon">📋</div>
                        <div class="role-info"><div class="role-name">Deputy Integrator</div><div class="role-desc">Decision queue, backup network architect</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'search')">
                        <div class="role-icon">🔍</div>
                        <div class="role-info"><div class="role-name">Search & Screen Pod</div><div class="role-desc">2 people. Search, dedup, screen</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'fulltext')">
                        <div class="role-icon">📄</div>
                        <div class="role-info"><div class="role-name">Full-Text Pod</div><div class="role-desc">2 people. Retrieval, inclusion decisions</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'extraction')">
                        <div class="role-icon">📊</div>
                        <div class="role-info"><div class="role-name">Extraction & Quality Risk (RoB) Pod</div><div class="role-desc">4 people. Arm-level extraction, RoB</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'network')">
                        <div class="role-icon">🔗</div>
                        <div class="role-info"><div class="role-name">Network Architecture Pod</div><div class="role-desc">1 person. Node dictionary, mapping, viability</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'modeling')">
                        <div class="role-icon">📈</div>
                        <div class="role-info"><div class="role-name">Modeling & Write Pod</div><div class="role-desc">1 person. Analysis, CINeMA, manuscript</div></div>
                    </button>
                </div>
                <button class="start-btn" id="startBtn" disabled onclick="startApp()">Start META-SPRINT NMA →</button>
            </div>
        </div>
    </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none">
    <div class="freeze-banner hidden" id="freezeBanner">🔒 FREEZE DAY 34 — No new studies, nodes, modifiers, or models</div>

    <header class="header">
        <div class="header-inner">
            <div class="logo">META-SPRINT <span class="nma-badge">NMA</span> <span>V3.4</span></div>
            <div class="header-controls">
                <div class="role-badge" id="roleBadge" tabindex="0" role="button" onclick="showRoleChange()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">Integrator</div>
                <div class="day-control">
                    <button class="day-btn" id="prevDayBtn" onclick="changeDay(-1)">←</button>
                    <div>
                        <div class="day-display" tabindex="0" role="button" onclick="showDayJump()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">Day <span id="dayNum">1</span>/40</div>
                        <div class="day-hint">click to jump</div>
                    </div>
                    <button class="day-btn" id="nextDayBtn" onclick="changeDay(1)">→</button>
                </div>
                <button class="day-btn" onclick="toggleDarkMode()" id="darkModeBtn">🌙</button>
                <button class="day-btn" onclick="openModal('settingsModal')">⚙️</button>
            </div>
        </div>
    </header>

    <div class="tabs" role="tablist">
        <button class="tab active" role="tab" aria-selected="true" onclick="showPage('today', this)">📋 Today</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('timeline', this)">📅 Timeline</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('network', this)">🔗 Network</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('dod', this)">✅ Checkpoints (DoD)</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('cinema', this)">⭐ CINeMA</button>
        <button class="tab" role="tab" aria-selected="false" onclick="showPage('templates', this)">📝 Templates</button>
        <div class="tab-more-wrapper">
            <button class="tab-more-btn" onclick="toggleMoreTabs(event)" aria-expanded="false" aria-haspopup="true" title="More pages">More ▾</button>
            <div class="tab-more-dropdown" id="moreTabsDropdown" role="menu">
                <button class="tab-more-item" data-page="stories" onclick="showPageFromMore('stories', this)" role="menuitem">📖 Stories</button>
                <button class="tab-more-item" data-page="reference" onclick="showPageFromMore('reference', this)" role="menuitem">📚 Reference</button>
                <button class="tab-more-item" data-page="help" onclick="showPageFromMore('help', this)" role="menuitem">❓ Help</button>
                <button class="tab-more-item" data-page="glossary" onclick="showPageFromMore('glossary', this)" role="menuitem">💡 Glossary</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- TODAY PAGE -->
        <div class="page active" id="page-today" role="tabpanel">
            <!-- Health Dashboard -->
            <div class="health-dashboard" id="healthDashboard">
                <div class="health-header">
                    <div class="health-title">🔗 NMA Project Health</div>
                    <div class="health-score" id="healthScore">--</div>
                </div>
                <div class="health-grid">
                    <div class="health-stat">
                        <div class="health-stat-value" id="daysRemaining">40</div>
                        <div class="health-stat-label">Days Left</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-stat-value" id="nodeCount">0</div>
                        <div class="health-stat-label">Nodes</div>
                    </div>
                    <div class="health-stat" onclick="promptStudyCount()" style="cursor:pointer" title="Click to update" tabindex="0" role="button" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                        <div class="health-stat-value" id="studyCount">0</div>
                        <div class="health-stat-label">Studies ✏️</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-stat-value" id="gatesPassed">0/5</div>
                        <div class="health-stat-label">Gates</div>
                    </div>
                </div>
                <div class="gate-dots">
                    <div class="gate-dot" id="gateA" title="DoD-A-NMA">A</div>
                    <div class="gate-dot" id="gateB" title="DoD-B-NMA">B</div>
                    <div class="gate-dot" id="gateC" title="DoD-C-NMA">C</div>
                    <div class="gate-dot" id="gateD" title="DoD-D-NMA">D</div>
                    <div class="gate-dot" id="gateE" title="DoD-E-NMA">E</div>
                </div>
            </div>

            <!-- Deadline Alerts -->
            
            <div class="risk-panel" id="riskPanel">
                <div class="risk-header">
                    <div class="risk-title">Project Risk</div>
                    <div class="risk-badge low" id="riskStatusBadge" aria-live="polite">LOW</div>
                </div>
                <ul class="risk-list" id="riskList" aria-live="polite">
                    <li class="risk-item">No active risks. Keep daily outputs on schedule.</li>
                </ul>
            </div>
            <div id="deadlineAlerts"></div>

            <!-- Achievements Panel -->
            <div class="achievements-panel" id="achievementsPanel">
                <div class="achievements-header">
                    <div class="achievements-title">🏆 Achievements <span class="achievements-count" id="achieveCount">0/10</span></div>
                    <button class="standup-btn" onclick="openStandupModal()">📋 Generate Standup</button>
                </div>
                <div class="achievements-grid" id="achievementsGrid">
                    <div class="achievement" id="ach-bootcamp" data-check="bootcamp">
                        <div class="achievement-icon">🎓</div>
                        <div class="achievement-name">Scholar</div>
                        <div class="achievement-desc">Complete NMA Bootcamp</div>
                    </div>
                    <div class="achievement" id="ach-protocol" data-check="dodA">
                        <div class="achievement-icon">🔒</div>
                        <div class="achievement-name">Protocol Locked</div>
                        <div class="achievement-desc">Pass DoD-A-NMA</div>
                    </div>
                    <div class="achievement" id="ach-network" data-check="nodes">
                        <div class="achievement-icon">🔗</div>
                        <div class="achievement-name">Network Architect</div>
                        <div class="achievement-desc">Define 4+ nodes</div>
                    </div>
                    <div class="achievement" id="ach-search" data-check="dodB">
                        <div class="achievement-icon">🔍</div>
                        <div class="achievement-name">Search Master</div>
                        <div class="achievement-desc">Pass DoD-B-NMA</div>
                    </div>
                    <div class="achievement" id="ach-prisma" data-check="prisma">
                        <div class="achievement-icon">📊</div>
                        <div class="achievement-name">PRISMA Complete</div>
                        <div class="achievement-desc">Fill all PRISMA counts</div>
                    </div>
                    <div class="achievement" id="ach-extraction" data-check="dodC">
                        <div class="achievement-icon">📋</div>
                        <div class="achievement-name">Data Extractor</div>
                        <div class="achievement-desc">Pass DoD-C-NMA</div>
                    </div>
                    <div class="achievement" id="ach-cinema" data-check="cinema">
                        <div class="achievement-icon">⭐</div>
                        <div class="achievement-name">Confidence Rated</div>
                        <div class="achievement-desc">Complete CINeMA</div>
                    </div>
                    <div class="achievement" id="ach-analysis" data-check="dodD">
                        <div class="achievement-icon">📈</div>
                        <div class="achievement-name">Analysis Complete</div>
                        <div class="achievement-desc">Pass DoD-D-NMA</div>
                    </div>
                    <div class="achievement" id="ach-stories" data-check="stories">
                        <div class="achievement-icon">📖</div>
                        <div class="achievement-name">Storyteller</div>
                        <div class="achievement-desc">Read all 4 stories</div>
                    </div>
                    <div class="achievement" id="ach-submission" data-check="dodE">
                        <div class="achievement-icon">🏁</div>
                        <div class="achievement-name">Submission Ready</div>
                        <div class="achievement-desc">Pass DoD-E-NMA</div>
                    </div>
                </div>
            </div>

            <!-- Standup Modal -->
            <div class="standup-modal" id="standupModal" role="dialog" aria-modal="true" onclick="closeStandupModal(event)">
                <div class="standup-card" onclick="event.stopPropagation()">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                        <div style="font-weight:700;font-size:16px">📋 Daily Standup</div>
                        <button onclick="closeStandupModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-muted)" aria-label="Close">×</button>
                    </div>
                    <div class="standup-section">
                        <div class="standup-label">✅ Yesterday (Completed)</div>
                        <div class="standup-items" id="standupYesterday">Loading...</div>
                    </div>
                    <div class="standup-section">
                        <div class="standup-label">📌 Today (Planned)</div>
                        <div class="standup-items" id="standupToday">Loading...</div>
                    </div>
                    <div class="standup-section">
                        <div class="standup-label">🚧 Blockers</div>
                        <div class="standup-items" id="standupBlockers">Loading...</div>
                    </div>
                    <div class="standup-section" style="background:var(--nma-light)">
                        <div class="standup-label" style="color:var(--nma)">📊 Status</div>
                        <div class="standup-items" id="standupStatus">Loading...</div>
                    </div>
                    <button class="standup-copy" onclick="copyStandup()">📋 Copy to Clipboard</button>
                </div>
            </div>

            <!-- Bootcamp (Day 1) -->
            <div class="bootcamp-card" id="bootcampCard">
                <div class="bootcamp-title">🎓 NMA Bootcamp (Day 1 — 45 min total)</div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Complete all modules before starting work</p>
                <div class="bootcamp-modules">
                    <div class="bootcamp-module" tabindex="0" onclick="toggleBootcamp(this, 'nodes')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                        <div class="bootcamp-module-check">✓</div>
                        <div class="bootcamp-module-info">
                            <div class="bootcamp-module-name">1. Node Dictionary + Mapping</div>
                            <div class="bootcamp-module-time">10 min</div>
                        </div>
                    </div>
                    <div class="bootcamp-module" tabindex="0" onclick="toggleBootcamp(this, 'transitivity')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                        <div class="bootcamp-module-check">✓</div>
                        <div class="bootcamp-module-info">
                            <div class="bootcamp-module-name">2. Transitivity + Effect Modifiers</div>
                            <div class="bootcamp-module-time">10 min</div>
                        </div>
                    </div>
                    <div class="bootcamp-module" tabindex="0" onclick="toggleBootcamp(this, 'inconsistency')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                        <div class="bootcamp-module-check">✓</div>
                        <div class="bootcamp-module-info">
                            <div class="bootcamp-module-name">3. Inconsistency (Global vs Local)</div>
                            <div class="bootcamp-module-time">10 min</div>
                        </div>
                    </div>
                    <div class="bootcamp-module" tabindex="0" onclick="toggleBootcamp(this, 'rankings')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                        <div class="bootcamp-module-check">✓</div>
                        <div class="bootcamp-module-info">
                            <div class="bootcamp-module-name">4. Rankings: What They Mean/Don't</div>
                            <div class="bootcamp-module-time">5 min</div>
                        </div>
                    </div>
                    <div class="bootcamp-module" tabindex="0" onclick="toggleBootcamp(this, 'cinema')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                        <div class="bootcamp-module-check">✓</div>
                        <div class="bootcamp-module-info">
                            <div class="bootcamp-module-name">5. CINeMA Domains</div>
                            <div class="bootcamp-module-time">10 min</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Goal -->
            <div class="alert alert-info" id="todayGoal">
                <div class="alert-icon">🎯</div>
                <div class="alert-content">
                    <div class="alert-title">Today's Goal</div>
                    <div class="alert-text" id="goalText">Complete Bootcamp + Draft Node Dictionary v1</div>
                </div>
            </div>

            <!-- Tasks -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Your Tasks</div>
                    <div class="phase-badge phase-a" id="phaseBadge">Protocol</div>
                </div>
                <div class="card-body" id="tasksContainer">
                    <!-- Tasks rendered by JS -->
                </div>
            </div>
        </div>

        <!-- NETWORK PAGE -->
        <div class="page" id="page-network" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">🔗 Network Overview</div>
                    <span class="nma-indicator">NMA-SPECIFIC</span>
                </div>
                <div class="card-body">
                    <!-- Network Graph Visualization -->
                    <div class="network-graph" id="networkGraph">
                        <svg id="networkSvg" viewBox="0 0 400 180">
                            <!-- Example network - updates based on node count -->
                            <g id="networkEdges"></g>
                            <g id="networkNodes"></g>
                        </svg>
                        <div style="text-align:center;font-size:11px;color:var(--text-muted);margin-top:8px">
                            Interactive preview • Updates when you save Node Dictionary
                        </div>
                    </div>

                    <div class="network-preview">
                        <div class="network-preview-title">Network Statistics</div>
                        <div class="network-stats">
                            <div class="network-stat">
                                <div class="network-stat-value" id="netNodes">0</div>
                                <div class="network-stat-label">Nodes</div>
                            </div>
                            <div class="network-stat">
                                <div class="network-stat-value" id="netEdges">0</div>
                                <div class="network-stat-label">Direct Comparisons</div>
                            </div>
                            <div class="network-stat">
                                <div class="network-stat-value" id="netStudies">0</div>
                                <div class="network-stat-label">Studies</div>
                            </div>
                            <div class="network-stat">
                                <div class="network-stat-value" id="netMultiarm">0</div>
                                <div class="network-stat-label">Multi-arm</div>
                            </div>
                        </div>
                    </div>

                    <h4 style="margin:16px 0 12px">Node Dictionary <span class="help-tip" data-tip="A Node Dictionary maps each treatment to a unique node ID. Lock at DoD-A. Max 12 nodes for feasibility. Changes require CondGO.">?</span></h4>
                    <div class="form-row">
                        <textarea class="form-textarea" id="nodeDictionary" style="min-height:120px;font-family:'IBM Plex Mono',monospace;font-size:12px" placeholder="Node 1: Placebo&#10;Node 2: Drug A (all doses)&#10;Node 3: Drug B 10mg&#10;Node 4: Drug B 20mg&#10;..."></textarea>
                        <div class="form-hint">Lock at DoD-A-NMA. Max 12 nodes.</div>
                    </div>
                    <button class="copy-btn" onclick="saveNodeDictionary()">Save Node Dictionary</button>

                    <h4 style="margin:24px 0 12px">Viability Status</h4>
                    <div id="viabilityStatus">
                        <div class="checklist-item">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Network is connected</div></div>
                        </div>
                        <div class="checklist-item">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">≤12 nodes after mapping</div></div>
                        </div>
                        <div class="checklist-item">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Each node has ≥2 studies</div></div>
                        </div>
                        <div class="checklist-item">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Effect modifier missingness ≤40%</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PRISMA Flow Tracker -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📊 PRISMA Flow Tracker <span class="help-tip" data-tip="Track record counts through screening stages. Auto-validates that numbers are logically consistent.">?</span></div>
                    <span class="nma-indicator">Auto-Validated</span>
                </div>
                <div class="card-body">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
                        <div class="form-row" style="margin:0">
                            <label class="form-label" style="font-size:11px" for="prismaIdentified">Records Identified</label>
                            <input type="number" class="form-input" id="prismaIdentified" min="0" placeholder="0" onchange="validatePrisma();savePrismaFlow()">
                        </div>
                        <div class="form-row" style="margin:0">
                            <label class="form-label" style="font-size:11px" for="prismaDuplicates">Duplicates Removed</label>
                            <input type="number" class="form-input" id="prismaDuplicates" min="0" placeholder="0" onchange="validatePrisma();savePrismaFlow()">
                        </div>
                        <div class="form-row" style="margin:0">
                            <label class="form-label" style="font-size:11px" for="prismaScreened">Records Screened</label>
                            <input type="number" class="form-input" id="prismaScreened" min="0" placeholder="0" onchange="validatePrisma();savePrismaFlow()">
                            <div class="prisma-calc" id="calcScreened"></div>
                        </div>
                        <div class="form-row" style="margin:0">
                            <label class="form-label" style="font-size:11px" for="prismaExcluded">Excluded at T/A</label>
                            <input type="number" class="form-input" id="prismaExcluded" min="0" placeholder="0" onchange="validatePrisma();savePrismaFlow()">
                        </div>
                        <div class="form-row" style="margin:0">
                            <label class="form-label" style="font-size:11px" for="prismaFullText">Full-text Assessed</label>
                            <input type="number" class="form-input" id="prismaFullText" min="0" placeholder="0" onchange="validatePrisma();savePrismaFlow()">
                            <div class="prisma-calc" id="calcFullText"></div>
                        </div>
                        <div class="form-row" style="margin:0">
                            <label class="form-label" style="font-size:11px;color:var(--success);font-weight:700" for="prismaIncluded">✓ Studies Included</label>
                            <input type="number" class="form-input" id="prismaIncluded" min="0" placeholder="0" style="border-color:var(--success)" onchange="validatePrisma();savePrismaFlow();updateStudyCount()">
                        </div>
                    </div>
                    <div class="prisma-warning" id="prismaWarning" role="status" aria-live="polite"></div>
                    <div style="margin-top:12px;padding:10px;background:var(--bg);border-radius:6px;font-size:12px">
                        <strong>META-SPRINT target:</strong> 40-60 studies included. Current: <span id="prismaTarget" style="font-weight:700">0</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Model Contract <span class="help-tip" data-tip="Pre-specifies analysis approach: Frequentist vs Bayesian, heterogeneity estimator/prior, convergence criteria. Lock before running any analyses.">?</span></div>
                    <span class="badge-essential" style="padding:4px 8px;border-radius:4px">Lock at DoD-A</span>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <label class="form-label" for="modelMethod">Analysis Method</label>
                        <select class="form-input" id="modelMethod">
                            <option value="">Select...</option>
                            <option value="freq">Frequentist random-effects NMA (default)</option>
                            <option value="bayes">Bayesian random-effects NMA</option>
                        </select>
                        <div class="form-hint">Choose Bayesian if: sparse network, complex multi-arm, need posterior ranks, frequentist fails pilot</div>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="modelPrior">Heterogeneity Prior (Bayesian) / Estimator (Frequentist)</label>
                        <input type="text" class="form-input" id="modelPrior" placeholder="e.g., Half-normal(0.5) / REML">
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="modelConvergence">Convergence Criteria (Bayesian)</label>
                        <input type="text" class="form-input" id="modelConvergence" placeholder="e.g., R-hat < 1.05, ESS > 400">
                    </div>
                    <button class="copy-btn" onclick="saveModelContract()">Save Model Contract</button>
                </div>
            </div>

            <!-- Effect Modifiers -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Effect Modifiers (for Transitivity) <span class="help-tip" data-tip="Variables that could change treatment effects (age, dose, severity, duration). Track distribution across comparisons to assess transitivity.">?</span></div>
                    <span class="nma-indicator">CRITICAL</span>
                </div>
                <div class="card-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">List variables that could modify treatment effects. These must be balanced across comparisons for transitivity to hold.</p>
                    <div class="form-row">
                        <textarea class="form-textarea" id="effectModifiers" style="min-height:100px" placeholder="1. Disease severity (mild/moderate/severe)&#10;2. Prior treatment (naive/experienced)&#10;3. Age distribution&#10;4. Baseline risk&#10;5. Outcome definition&#10;6. Study era (pre/post 2010)"></textarea>
                        <div class="form-hint">Limit to ≤6 key modifiers. Lock at DoD-A.</div>
                    </div>
                    <button class="copy-btn" onclick="saveEffectModifiers()">Save Effect Modifiers</button>
                </div>
            </div>

            <!-- Transitivity Assessment -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Transitivity Assessment <span class="help-tip" data-tip="Transitivity means studies are similar enough to combine. Effect modifiers (age, severity, dose) should be balanced across comparisons.">?</span></div>
                    <span class="badge-essential" style="padding:4px 8px;border-radius:4px">Required</span>
                </div>
                <div class="card-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Check each item if the condition is met. More checks = higher confidence in transitivity.</p>
                    <div class="checklist-item" onclick="toggleTransitivity(this, 'similar')">
                        <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="checklist-content">
                            <div class="checklist-title">Study populations are clinically similar across comparisons</div>
                            <div class="checklist-hint">Age, severity, comorbidities roughly comparable</div>
                        </div>
                    </div>
                    <div class="checklist-item" onclick="toggleTransitivity(this, 'modifiers')">
                        <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="checklist-content">
                            <div class="checklist-title">Effect modifiers are balanced across comparisons</div>
                            <div class="checklist-hint">No systematic differences in key variables</div>
                        </div>
                    </div>
                    <div class="checklist-item" onclick="toggleTransitivity(this, 'outcome')">
                        <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="checklist-content">
                            <div class="checklist-title">Outcome definitions are consistent</div>
                            <div class="checklist-hint">Same measure, same timepoint, same direction</div>
                        </div>
                    </div>
                    <div class="checklist-item" onclick="toggleTransitivity(this, 'era')">
                        <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="checklist-content">
                            <div class="checklist-title">Study eras are comparable</div>
                            <div class="checklist-hint">No major practice changes between study periods</div>
                        </div>
                    </div>
                    <div class="checklist-item" onclick="toggleTransitivity(this, 'dose')">
                        <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="checklist-content">
                            <div class="checklist-title">Dose/intensity groupings are clinically appropriate</div>
                            <div class="checklist-hint">Node definitions reflect meaningful clinical distinctions</div>
                        </div>
                    </div>
                    <div class="alert" id="transitivityResult" style="margin-top:12px;display:none"></div>
                </div>
            </div>
        </div>

        <!-- DOD GATES PAGE -->
        <div class="page" id="page-dod" role="tabpanel">
            <div class="alert alert-info">
                <div class="alert-icon">🔗</div>
                <div class="alert-content">
                    <div class="alert-title">NMA-Specific Checkpoints (DoD)</div>
                    <div class="alert-text">All gates include NMA requirements: node dictionary, model contract, viability, consistency, CINeMA</div>
                </div>
            </div>
            <div id="dodContainer">
                <!-- Rendered by JS -->
            </div>
        </div>

        <!-- CINeMA PAGE -->
        <div class="page" id="page-cinema" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">⭐ CINeMA Confidence Assessment <span class="help-tip" data-tip="CINeMA rates confidence across 6 domains: within-study bias, reporting bias, indirectness, imprecision, heterogeneity, incoherence. Rate each Very Low to High.">?</span></div>
                    <span class="nma-indicator">NMA-SPECIFIC</span>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning" style="margin-bottom:16px">
                        <div class="alert-icon">⚠️</div>
                        <div class="alert-content">
                            <div class="alert-title">Required for DoD-D-NMA</div>
                            <div class="alert-text">Complete CINeMA for primary outcome at minimum. If CINeMA confidence is "Low" for key contrasts, rankings must be suppressed.</div>
                        </div>
                    </div>

                    <h4 style="margin-bottom:12px">CINeMA Domains <span style="font-size:11px;color:var(--text-muted)">(hover for examples)</span></h4>
                    <div class="cinema-grid">
                        <div class="cinema-domain" title="Low: Mostly low RoB studies&#10;Some: Mix of low/high RoB&#10;Major: Mostly high RoB">
                            <div class="cinema-domain-name">Within-study bias</div>
                            <div style="font-size:11px;color:var(--text-muted);margin:4px 0">RoB in contributing studies</div>
                            <select class="form-input" id="cinema-wsb" aria-label="Within-study bias" style="font-size:11px">
                                <option value="">Rate...</option>
                                <option value="low">Low concern</option>
                                <option value="moderate">Some concerns</option>
                                <option value="high">Major concerns</option>
                            </select>
                        </div>
                        <div class="cinema-domain" title="Low: No evidence of missing studies&#10;Some: Asymmetric funnel plot&#10;Major: Known missing studies">
                            <div class="cinema-domain-name">Reporting bias</div>
                            <div style="font-size:11px;color:var(--text-muted);margin:4px 0">Missing studies/outcomes</div>
                            <select class="form-input" id="cinema-rb" aria-label="Reporting bias" style="font-size:11px">
                                <option value="">Rate...</option>
                                <option value="low">Low concern</option>
                                <option value="moderate">Some concerns</option>
                                <option value="high">Major concerns</option>
                            </select>
                        </div>
                        <div class="cinema-domain" title="Low: Matches target PICO&#10;Some: Minor population differences&#10;Major: Different population/setting">
                            <div class="cinema-domain-name">Indirectness</div>
                            <div style="font-size:11px;color:var(--text-muted);margin:4px 0">Applicability to your PICO</div>
                            <select class="form-input" id="cinema-ind" aria-label="Indirectness" style="font-size:11px">
                                <option value="">Rate...</option>
                                <option value="low">Low concern</option>
                                <option value="moderate">Some concerns</option>
                                <option value="high">Major concerns</option>
                            </select>
                        </div>
                        <div class="cinema-domain" title="Low: CI excludes no effect + decision threshold&#10;Some: CI crosses one threshold&#10;Major: CI crosses both thresholds">
                            <div class="cinema-domain-name">Imprecision</div>
                            <div style="font-size:11px;color:var(--text-muted);margin:4px 0">CI width vs decision thresholds</div>
                            <select class="form-input" id="cinema-imp" aria-label="Imprecision" style="font-size:11px">
                                <option value="">Rate...</option>
                                <option value="low">Low concern</option>
                                <option value="moderate">Some concerns</option>
                                <option value="high">Major concerns</option>
                            </select>
                        </div>
                        <div class="cinema-domain" title="Low: I²<40%, τ² small&#10;Some: I² 40-75%, τ² moderate&#10;Major: I²>75%, τ² large">
                            <div class="cinema-domain-name">Heterogeneity</div>
                            <div style="font-size:11px;color:var(--text-muted);margin:4px 0">Between-study variability</div>
                            <select class="form-input" id="cinema-het" aria-label="Heterogeneity" style="font-size:11px">
                                <option value="">Rate...</option>
                                <option value="low">Low concern</option>
                                <option value="moderate">Some concerns</option>
                                <option value="high">Major concerns</option>
                            </select>
                        </div>
                        <div class="cinema-domain" title="Low: No inconsistency detected&#10;Some: Minor disagreement, not severe&#10;Major: Severe disagreement in direct vs indirect">
                            <div class="cinema-domain-name">Incoherence</div>
                            <div style="font-size:11px;color:var(--text-muted);margin:4px 0">Direct vs indirect agreement</div>
                            <select class="form-input" id="cinema-inc" aria-label="Incoherence" style="font-size:11px">
                                <option value="">Rate...</option>
                                <option value="low">Low concern</option>
                                <option value="moderate">Some concerns</option>
                                <option value="high">Major concerns</option>
                            </select>
                        </div>
                    </div>

                    <!-- CINeMA Examples Card -->
                    <div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:16px;font-size:12px">
                        <strong>Quick Reference - When to rate "Some concerns":</strong>
                        <ul style="margin:8px 0 0 16px;line-height:1.8">
                            <li><strong>Within-study bias:</strong> Mix of low and high RoB studies contributing to estimate</li>
                            <li><strong>Reporting bias:</strong> Some asymmetry in comparison-adjusted funnel plot</li>
                            <li><strong>Indirectness:</strong> Study populations somewhat different from target (e.g., slightly different severity)</li>
                            <li><strong>Imprecision:</strong> CI crosses one clinical decision threshold but not both</li>
                            <li><strong>Heterogeneity:</strong> I² between 40-75%, moderate τ² that doesn't fully explain variability</li>
                            <li><strong>Incoherence:</strong> Node-splitting shows some disagreement but not statistically significant</li>
                        </ul>
                    </div>

                    <div class="form-row">
                        <label class="form-label" for="cinema-overall">Overall Confidence</label>
                        <select class="form-input" id="cinema-overall">
                            <option value="">Calculate from domains...</option>
                            <option value="high">High</option>
                            <option value="moderate">Moderate</option>
                            <option value="low">Low</option>
                            <option value="verylow">Very Low</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label class="form-label" for="cinema-justification">Justification</label>
                        <textarea class="form-textarea" id="cinema-justification" placeholder="Explain overall rating and key concerns..."></textarea>
                    </div>

                    <div class="btn-row">
                        <button class="copy-btn" onclick="saveCINeMA()">Save CINeMA Assessment</button>
                        <button class="download-btn" onclick="generateCINeMAReport()">Generate Report</button>
                    </div>
                    <div class="template-output" id="cinema-output"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Ranking Suppression Check</div>
                </div>
                <div class="card-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Rankings (SUCRA/P-scores) are reported <strong>only if ALL conditions pass</strong>:</p>
                    <div id="rankingChecks">
                        <div class="checklist-item" onclick="toggleRankCheck(this, 'confidence')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content">
                                <div class="checklist-title">CINeMA confidence NOT "Low" for key contrasts</div>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="toggleRankCheck(this, 'incoherence')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content">
                                <div class="checklist-title">No severe incoherence (global/local) affecting key contrasts</div>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="toggleRankCheck(this, 'transitivity')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content">
                                <div class="checklist-title">Transitivity concerns NOT "High"</div>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="toggleRankCheck(this, 'clinical')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content">
                                <div class="checklist-title">Effect sizes are clinically meaningful</div>
                            </div>
                        </div>
                    </div>
                    <div class="alert" id="rankingResult" style="margin-top:12px;display:none">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- TIMELINE PAGE -->
        <div class="page" id="page-timeline" role="tabpanel">
            <div class="card">
                <div class="card-header"><div class="card-title">40-Day NMA Timeline</div></div>
                <div class="card-body">
                    <div class="timeline-bar" role="progressbar" aria-valuemin="0" aria-valuemax="40" aria-valuenow="1" aria-label="Sprint progress" id="timelineBar"><div class="timeline-fill" id="timelineFill" style="width:0%"></div></div>
                    <div class="timeline-markers">
                        <div class="timeline-marker">D4<br>DoD-A</div>
                        <div class="timeline-marker">D12<br>DoD-B</div>
                        <div class="timeline-marker">D20<br>Audit1</div>
                        <div class="timeline-marker">D28<br>DoD-C</div>
                        <div class="timeline-marker">D34<br>DoD-D</div>
                        <div class="timeline-marker">D34<br>Freeze</div>
                        <div class="timeline-marker">D40<br>Submit</div>
                    </div>
                    <table class="ref-table" style="margin-top:24px">
                        <thead><tr><th>Phase</th><th>Days</th><th>Key Deliverables</th></tr></thead>
                        <tbody>
                            <tr><td><strong>DoD-A-NMA</strong></td><td>1-4</td><td>Protocol + Model Contract + Node Dictionary locked</td></tr>
                            <tr><td><strong>DoD-B-NMA</strong></td><td>6-12</td><td>Search complete + Network viability confirmed</td></tr>
                            <tr><td><strong>DoD-C-NMA</strong></td><td>12-28</td><td>Arm-level extraction + Mapping locked</td></tr>
                            <tr><td><strong>DoD-D-NMA</strong></td><td>24-34</td><td>Model + CINeMA + Consistency + Rankings</td></tr>
                            <tr><td><strong>DoD-E-NMA</strong></td><td>34-40</td><td>PRISMA-NMA + Reruns + Submission</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Workload Summary -->
            <div class="card">
                <div class="card-header"><div class="card-title">Weekly Workload Summary (12 people × ≤2h/day)</div></div>
                <div class="card-body">
                    <table class="ref-table" style="font-size:12px">
                        <thead>
                            <tr><th>Week</th><th>Days</th><th>Primary Focus</th><th>Pods Active</th><th>Est. Hours/Person</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>Week 1</strong></td><td>1-7</td><td>Bootcamp → Protocol → Search</td><td>All → Search Pod</td><td>~1.5h</td></tr>
                            <tr><td><strong>Week 2</strong></td><td>8-14</td><td>Screen → Viability → DoD-B</td><td>Search + Network</td><td>~2h</td></tr>
                            <tr><td><strong>Week 3</strong></td><td>15-21</td><td>Full-text → Extract → Audit 1</td><td>Full-text + Extraction</td><td>~2h</td></tr>
                            <tr><td><strong>Week 4</strong></td><td>22-28</td><td>Extraction → Mapping → DoD-C</td><td>Extraction + Network</td><td>~2h</td></tr>
                            <tr><td><strong>Week 5</strong></td><td>29-35</td><td>Analysis → CINeMA → Audit 2 → FREEZE</td><td>Modeling + All QA</td><td>~2h</td></tr>
                            <tr><td><strong>Week 6</strong></td><td>36-40</td><td>Write → Rerun → Submit</td><td>Modeling + Integrator</td><td>~1.5h</td></tr>
                        </tbody>
                    </table>
                    <div class="alert alert-info" style="margin-top:16px">
                        <div class="alert-icon">💡</div>
                        <div class="alert-content">
                            <div class="alert-title">Total: ~240 person-hours over 40 days</div>
                            <div class="alert-text">12 people × 2h/day × 40 days = 960h capacity. NMA uses ~25% for buffer/meetings.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PRISMA-NMA Checklist -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">PRISMA-NMA Checklist</div>
                    <span class="nma-indicator">Required for DoD-E</span>
                </div>
                <div class="card-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Complete all PRISMA-NMA items before submission.</p>
                    <div id="prismaNmaChecklist">
                        <div class="checklist-item" onclick="togglePrisma(this, 'title')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Title identifies as NMA/multiple treatments comparison</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'geometry')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Network geometry described (nodes, edges, direct comparisons)</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'methods')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Statistical methods for NMA described (model, software, priors)</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'transitivity')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Transitivity assumption assessment reported</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'consistency')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Consistency/coherence evaluation reported (global + local)</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'league')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">League table or forest plot of all comparisons included</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'ranking')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Ranking probabilities reported with uncertainty (or suppression justified)</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'cinema')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">CINeMA confidence assessment for key comparisons</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'heterogeneity')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Heterogeneity quantified (τ², I², prediction intervals)</div></div>
                        </div>
                        <div class="checklist-item" onclick="togglePrisma(this, 'sensitivity')">
                            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                            <div class="checklist-content"><div class="checklist-title">Sensitivity analyses results reported</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STORIES PAGE: Evidence Reversal Stories -->
        <div class="page" id="page-stories" role="tabpanel">
            <div class="alert alert-info" style="margin-bottom:20px">
                <div class="alert-icon">📖</div>
                <div class="alert-content">
                    <div class="alert-title">Evidence Reversal Stories</div>
                    <div class="alert-text">Learn from cases where proper NMA methodology revealed the truth — or where ignoring it led to harm. Click each story to expand.</div>
                </div>
            </div>

            <!-- STORY 1: The Ranking Reversal -->
            <div class="story-card">
                <div class="story-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleStory(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="story-number">Story One</div>
                    <div class="story-title">The Ranking That Deceived a Nation</div>
                    <div class="story-hook">"Drug X ranked #1 in efficacy. Two years later, it was withdrawn for harm..."</div>
                </div>
                <div class="story-body">
                    <div class="story-scene">
                        <div class="scene-label">🌅 The Beginning</div>
                        <div class="scene-content">
                            <p>In a network of 8 treatments for chronic pain, researchers published an NMA. <strong>Drug X ranked first</strong> with SUCRA of 92%. Headlines celebrated: "New Champion for Pain Relief Found!"</p>
                            <p style="margin-top:12px">Patients demanded it. Doctors prescribed it. Sales soared.</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">❓ The Question You Must Ask</div>
                        <div class="story-question">
                            But tell me — did anyone check WHY Drug X ranked so high? Did anyone look beneath the numbers?
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">🔍 The Hidden Truth</div>
                        <div class="scene-content">
                            <p>A methodologist examined the network. She found:</p>
                            <ul style="margin:12px 0 0 20px">
                                <li><strong>Drug X had only 2 small trials</strong> — both funded by its manufacturer</li>
                                <li><strong>No direct comparison</strong> to the standard treatment — all evidence was indirect</li>
                                <li><strong>CINeMA confidence was "Very Low"</strong> for the key comparison</li>
                                <li><strong>Transitivity was violated</strong> — Drug X trials enrolled milder patients</li>
                            </ul>
                            <p style="margin-top:12px">The high ranking came from <em>imprecision</em>, not superiority. With wide confidence intervals, Drug X could have been anywhere from 1st to 6th place.</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">⚖️ Two Paths</div>
                        <div class="story-contrast">
                            <div class="contrast-box contrast-wrong">
                                <div class="contrast-label">❌ What They Did</div>
                                <p style="font-size:13px">Published rankings without CINeMA. Ignored transitivity. Let SUCRA drive clinical decisions.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Drug withdrawn 2 years later for cardiovascular harm not detected in small trials.</p>
                            </div>
                            <div class="contrast-box contrast-right">
                                <div class="contrast-label">✅ What META-SPRINT Would Do</div>
                                <p style="font-size:13px">Suppress rankings (CINeMA "Low"). Report effect estimates with uncertainty. Flag indirect evidence. Require more data.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> No false champion. Patients protected.</p>
                            </div>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="story-moral">
                            <div class="moral-label">📜 The Lesson</div>
                            <div class="moral-text">Rankings without confidence are mirages in the desert — they appear real but vanish when you approach. Always ask: "How certain are we?" before "Who is best?"</div>
                        </div>
                        <div class="story-reflection">
                            <div class="reflection-question">🤔 Reflect: In your NMA, have you checked CINeMA before looking at rankings?</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STORY 2: The Transitivity Trap -->
            <div class="story-card">
                <div class="story-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleStory(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="story-number">Story Two</div>
                    <div class="story-title">The Invisible Wall Between Studies</div>
                    <div class="story-hook">"They combined apples and oranges, then wondered why the juice tasted wrong..."</div>
                </div>
                <div class="story-body">
                    <div class="story-scene">
                        <div class="scene-label">🌅 The Beginning</div>
                        <div class="scene-content">
                            <p>A team conducted an NMA comparing 5 antibiotics for pneumonia. The network looked perfect — fully connected, many trials, precise estimates.</p>
                            <p style="margin-top:12px">Their conclusion: <strong>"Antibiotic C is clearly inferior and should not be used."</strong></p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">❓ The Question You Must Ask</div>
                        <div class="story-question">
                            Were the patients in all these trials truly comparable? Or was there an invisible wall the researchers did not see?
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">🔍 The Hidden Truth</div>
                        <div class="scene-content">
                            <p>A critic noticed something strange:</p>
                            <ul style="margin:12px 0 0 20px">
                                <li>All <strong>Antibiotic C trials</strong> were conducted in <strong>severe, hospitalized patients</strong></li>
                                <li>All <strong>other antibiotic trials</strong> were in <strong>mild, outpatient cases</strong></li>
                                <li>The "common comparator" (Antibiotic A) was tested in <strong>completely different populations</strong></li>
                            </ul>
                            <p style="margin-top:12px">Antibiotic C wasn't inferior — it was being tested in sicker patients who were harder to treat. <strong>Transitivity was violated.</strong></p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">⚖️ Two Paths</div>
                        <div class="story-contrast">
                            <div class="contrast-box contrast-wrong">
                                <div class="contrast-label">❌ What They Did</div>
                                <p style="font-size:13px">Ignored effect modifiers. Combined incompatible populations. Published damaging conclusion.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Effective antibiotic abandoned. Resistant bacteria flourished from overuse of alternatives.</p>
                            </div>
                            <div class="contrast-box contrast-right">
                                <div class="contrast-label">✅ What META-SPRINT Would Do</div>
                                <p style="font-size:13px">Map effect modifiers at DoD-A. Detect severity imbalance. Rate transitivity "High concern". Stratify analysis or exclude comparison.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Honest uncertainty. No false condemnation.</p>
                            </div>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="story-moral">
                            <div class="moral-label">📜 The Lesson</div>
                            <div class="moral-text">A network may appear connected, but if the patients are not comparable, the indirect evidence is like a bridge built on sand. Check transitivity BEFORE you trust any indirect comparison.</div>
                        </div>
                        <div class="story-reflection">
                            <div class="reflection-question">🤔 Reflect: Have you listed your effect modifiers? Do they balance across comparisons?</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STORY 3: The Inconsistency Warning -->
            <div class="story-card">
                <div class="story-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleStory(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="story-number">Story Three</div>
                    <div class="story-title">When Direct and Indirect Evidence Quarreled</div>
                    <div class="story-hook">"The numbers disagreed. One was lying — but which one?"</div>
                </div>
                <div class="story-body">
                    <div class="story-scene">
                        <div class="scene-label">🌅 The Beginning</div>
                        <div class="scene-content">
                            <p>A cardiovascular NMA compared 6 blood pressure medications. Everything seemed fine — until a reviewer ran the inconsistency tests.</p>
                            <p style="margin-top:12px"><strong>Global test: p = 0.03.</strong> Something was wrong in the network.</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">❓ The Question You Must Ask</div>
                        <div class="story-question">
                            When direct evidence says one thing and indirect evidence says another, which do you believe? And more importantly — WHY do they disagree?
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">🔍 The Hidden Truth</div>
                        <div class="scene-content">
                            <p>Node-splitting revealed the problem:</p>
                            <ul style="margin:12px 0 0 20px">
                                <li><strong>Direct evidence (A vs B):</strong> OR = 0.72 [0.58, 0.89] — Drug A better</li>
                                <li><strong>Indirect evidence (A vs B via C):</strong> OR = 1.15 [0.95, 1.39] — No difference or B better</li>
                                <li><strong>p-value for disagreement: 0.008</strong></li>
                            </ul>
                            <p style="margin-top:12px">Investigation found: The direct A vs B trial was <strong>30 years old</strong> with different dose regimens. Standard of care had changed. The indirect path reflected modern practice.</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">⚖️ Two Paths</div>
                        <div class="story-contrast">
                            <div class="contrast-box contrast-wrong">
                                <div class="contrast-label">❌ The Temptation</div>
                                <p style="font-size:13px">Ignore the inconsistency. Average the estimates. Publish the combined result.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Misleading effect estimate. Neither direct nor indirect truth preserved.</p>
                            </div>
                            <div class="contrast-box contrast-right">
                                <div class="contrast-label">✅ What META-SPRINT Would Do</div>
                                <p style="font-size:13px">Report inconsistency transparently. Investigate cause (era effect). Sensitivity analysis excluding old trial. Downgrade CINeMA for affected comparisons.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Readers understand the uncertainty. Modern evidence prioritized.</p>
                            </div>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="story-moral">
                            <div class="moral-label">📜 The Lesson</div>
                            <div class="moral-text">Inconsistency is not a flaw to hide — it is a signal to investigate. When direct and indirect evidence disagree, the truth is trying to tell you something. Listen.</div>
                        </div>
                        <div class="story-reflection">
                            <div class="reflection-question">🤔 Reflect: Have you run both global AND local consistency tests? What will you do if they fail?</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STORY 4: The Node Dictionary Disaster -->
            <div class="story-card">
                <div class="story-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleStory(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="story-number">Story Four</div>
                    <div class="story-title">The Dictionary That Changed Everything</div>
                    <div class="story-hook">"Same drug, different names. Different doses, same node. Chaos followed..."</div>
                </div>
                <div class="story-body">
                    <div class="story-scene">
                        <div class="scene-label">🌅 The Beginning</div>
                        <div class="scene-content">
                            <p>An NMA on diabetes medications was conducted by three different teams using the same trials. Their conclusions were <strong>completely contradictory</strong>:</p>
                            <ul style="margin:12px 0 0 20px">
                                <li>Team 1: "Drug class A is best"</li>
                                <li>Team 2: "Drug class B is best"</li>
                                <li>Team 3: "No meaningful differences exist"</li>
                            </ul>
                            <p style="margin-top:12px">Same data. Same trials. Three different truths. How?</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">❓ The Question You Must Ask</div>
                        <div class="story-question">
                            If three honest researchers analyze the same evidence and reach opposite conclusions, where did the divergence begin?
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">🔍 The Hidden Truth</div>
                        <div class="scene-content">
                            <p>The answer lay in their <strong>Node Dictionaries</strong>:</p>
                            <ul style="margin:12px 0 0 20px">
                                <li><strong>Team 1:</strong> Lumped all doses together → Created artificial precision for Drug A</li>
                                <li><strong>Team 2:</strong> Split by exact dose → Created sparse nodes, unstable estimates, Drug B got lucky</li>
                                <li><strong>Team 3:</strong> Mixed approach → Inconsistent mapping led to washed-out effects</li>
                            </ul>
                            <p style="margin-top:12px">None were "wrong" — but none had <strong>locked their dictionary before extraction</strong>. Each team made ad-hoc decisions that favored different conclusions.</p>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="scene-label">⚖️ Two Paths</div>
                        <div class="story-contrast">
                            <div class="contrast-box contrast-wrong">
                                <div class="contrast-label">❌ What They Did</div>
                                <p style="font-size:13px">Defined nodes during analysis. Changed groupings when results looked "off". No source citation trail.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Contradictory literature. Clinicians confused. Patients harmed by inconsistent guidelines.</p>
                            </div>
                            <div class="contrast-box contrast-right">
                                <div class="contrast-label">✅ What META-SPRINT Would Do</div>
                                <p style="font-size:13px">Lock Node Dictionary at DoD-A. Document grouping rationale. All mapping with source citation. Changes only via CondGO with audit trail.</p>
                                <p style="font-size:13px;margin-top:8px"><strong>Result:</strong> Reproducible. Transparent. One truth, clearly stated with uncertainty.</p>
                            </div>
                        </div>
                    </div>

                    <div class="story-scene">
                        <div class="story-moral">
                            <div class="moral-label">📜 The Lesson</div>
                            <div class="moral-text">The Node Dictionary is the foundation of your NMA. Build it carelessly, and the whole structure may collapse. Build it thoughtfully, lock it early, and document every brick.</div>
                        </div>
                        <div class="story-reflection">
                            <div class="reflection-question">🤔 Reflect: Is your Node Dictionary locked? Could another team reproduce your exact mapping?</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📜 The Four Lessons</div>
                </div>
                <div class="card-body">
                    <div style="display:grid;gap:12px">
                        <div style="padding:12px;background:var(--bg);border-radius:8px;border-left:4px solid var(--nma)">
                            <strong>1. Rankings without confidence are mirages.</strong><br>
                            <span style="font-size:13px;color:var(--text-secondary)">Always check CINeMA before celebrating any "best" treatment.</span>
                        </div>
                        <div style="padding:12px;background:var(--bg);border-radius:8px;border-left:4px solid var(--success)">
                            <strong>2. Transitivity is the invisible assumption.</strong><br>
                            <span style="font-size:13px;color:var(--text-secondary)">Map effect modifiers early. If populations differ, indirect evidence fails.</span>
                        </div>
                        <div style="padding:12px;background:var(--bg);border-radius:8px;border-left:4px solid var(--warning)">
                            <strong>3. Inconsistency is a signal, not a flaw.</strong><br>
                            <span style="font-size:13px;color:var(--text-secondary)">When evidence disagrees, investigate why. The truth is trying to speak.</span>
                        </div>
                        <div style="padding:12px;background:var(--bg);border-radius:8px;border-left:4px solid var(--purple)">
                            <strong>4. The Node Dictionary is your foundation.</strong><br>
                            <span style="font-size:13px;color:var(--text-secondary)">Lock it early, document it fully, change it only with ceremony.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TEMPLATES PAGE -->
        <div class="page" id="page-templates" role="tabpanel">
            <div class="alert alert-info">
                <div class="alert-icon">📝</div>
                <div class="alert-content">
                    <div class="alert-title">NMA Templates</div>
                    <div class="alert-text">Templates marked with 🔗 are NMA-specific additions to the standard META-SPRINT pack</div>
                </div>
            </div>

            <!-- Model Contract Template -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔗 Appendix B: Model Contract <span class="template-badge badge-nma">NMA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Lock at DoD-A-NMA. No changing priors/estimators mid-stream except via CondGO.</p>
                    <div class="form-row">
                        <label class="form-label" for="mc-method">Method Choice</label>
                        <select class="form-input" id="mc-method">
                            <option value="freq">Frequentist random-effects NMA</option>
                            <option value="bayes">Bayesian random-effects NMA</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="mc-estimator">Estimator (Freq) / Prior Policy (Bayes)</label>
                        <input type="text" class="form-input" id="mc-estimator" placeholder="e.g., REML / Half-normal(0,0.5)">
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="mc-multiarm">Multi-arm Handling</label>
                        <input type="text" class="form-input" id="mc-multiarm" placeholder="e.g., Correlation adjustment for shared arms">
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="mc-global">Global Inconsistency Test</label>
                        <input type="text" class="form-input" id="mc-global" placeholder="e.g., Design-by-treatment interaction">
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="mc-local">Local Inconsistency Test</label>
                        <input type="text" class="form-input" id="mc-local" placeholder="e.g., Node-splitting">
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="mc-convergence">Convergence Criteria (Bayes only)</label>
                        <input type="text" class="form-input" id="mc-convergence" placeholder="e.g., R-hat < 1.05, ESS > 400">
                    </div>
                    <div class="btn-row">
                        <button class="copy-btn" onclick="generateModelContract()">Generate & Copy</button>
                    </div>
                    <div class="template-output" id="mc-output"></div>
                </div>
            </div>

            <!-- Ranking Policy Template -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔗 Appendix C: Ranking Policy <span class="template-badge badge-nma">NMA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Rankings are optional and never the primary claim. Lock suppression rule at DoD-A.</p>
                    <div class="alert alert-warning">
                        <div class="alert-icon">⚠️</div>
                        <div class="alert-content">
                            <div class="alert-title">Suppression Rule</div>
                            <div class="alert-text">If ANY condition fails: suppress rankings and report only effect estimates with uncertainty + confidence grading.</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="rp-metric">Ranking Metric</label>
                        <select class="form-input" id="rp-metric">
                            <option value="">Select...</option>
                            <option value="sucra">SUCRA</option>
                            <option value="pscore">P-score</option>
                            <option value="posterior">Posterior rank probabilities</option>
                            <option value="none">Not reporting rankings</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="rp-suppress">Suppression Decision</label>
                        <select class="form-input" id="rp-suppress">
                            <option value="">Select...</option>
                            <option value="report">Report rankings (all conditions pass)</option>
                            <option value="suppress">Suppress rankings (conditions failed)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="rp-justify">Justification</label>
                        <textarea class="form-textarea" id="rp-justify" placeholder="Why rankings are/aren't reported..."></textarea>
                    </div>
                    <button class="copy-btn" onclick="generateRankingPolicy()">Generate & Copy</button>
                    <div class="template-output" id="rp-output"></div>
                </div>
            </div>

            <!-- Network Viability Report -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔗 Appendix D: Network Viability Report <span class="template-badge badge-nma">NMA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Complete at DoD-B-NMA. Required to proceed as NMA.</p>
                    <div class="form-row">
                        <label class="form-label" for="nv-nodes">Node Count</label>
                        <input type="number" class="form-input" id="nv-nodes" placeholder="e.g., 8">
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="nv-studies">Study Count</label>
                        <input type="number" class="form-input" id="nv-studies" placeholder="e.g., 45">
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="nv-connected">Network Connectedness</label>
                        <select class="form-input" id="nv-connected">
                            <option value="">Select...</option>
                            <option value="connected">Fully connected</option>
                            <option value="components">Multiple components (plan documented)</option>
                            <option value="disconnected">Disconnected (cannot proceed)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="nv-sparse">Sparsity Flags</label>
                        <textarea class="form-textarea" id="nv-sparse" placeholder="List any nodes with minimal evidence..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="nv-missing">Effect Modifier Missingness</label>
                        <input type="text" class="form-input" id="nv-missing" placeholder="e.g., Age: 15%, Baseline severity: 22%">
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="nv-decision">Viability Decision</label>
                        <select class="form-input" id="nv-decision">
                            <option value="">Select...</option>
                            <option value="proceed">PROCEED as NMA</option>
                            <option value="restrict">RESTRICT (document limitations)</option>
                            <option value="route">ROUTE OUT (not viable for NMA)</option>
                        </select>
                    </div>
                    <button class="copy-btn" onclick="generateViabilityReport()">Generate & Copy</button>
                    <div class="template-output" id="nv-output"></div>
                </div>
            </div>

            <!-- Clinical Summary NMA -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔗 Appendix J-NMA: Clinical Summary Panel <span class="template-badge badge-nma">NMA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Mandatory interpretation layer for NMA submissions.</p>
                    <div class="form-row">
                        <label class="form-label" for="cs-picos">1. PICOS + Outcome/Timepoint</label>
                        <textarea class="form-textarea" id="cs-picos" placeholder="Population, interventions, comparators, outcomes, study designs..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="cs-contrasts">2. Main Contrasts of Interest (NOT "best treatment")</label>
                        <textarea class="form-textarea" id="cs-contrasts" placeholder="Key comparisons and their estimates..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="cs-absolute">3. Absolute Effects</label>
                        <textarea class="form-textarea" id="cs-absolute" placeholder="Absolute risk/benefit with baseline risk source..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="cs-consistency">4. Inconsistency/Transitivity Summary (Plain Language)</label>
                        <textarea class="form-textarea" id="cs-consistency" placeholder="Were direct and indirect evidence consistent? Any transitivity concerns?"></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="cs-cinema">5. CINeMA Confidence Summary</label>
                        <textarea class="form-textarea" id="cs-cinema" placeholder="Overall confidence level and key reasons..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="cs-rankings">6. Rankings Statement</label>
                        <select class="form-input" id="cs-rankings">
                            <option value="">Select...</option>
                            <option value="suppressed">Rankings SUPPRESSED (explain why)</option>
                            <option value="caution">Rankings included WITH CAUTION</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="cs-applicability">7. Applicability + Key Uncertainties</label>
                        <textarea class="form-textarea" id="cs-applicability" placeholder="Who does this apply to? What are the key limitations?"></textarea>
                    </div>
                    <button class="copy-btn" onclick="generateClinicalSummary()">Generate & Copy</button>
                    <div class="template-output" id="cs-output"></div>
                </div>
            </div>

            <!-- CondGO NMA -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">⚠️ Appendix K: Emergency Fix Mode (CondGO) <span class="template-badge badge-essential">EMERGENCY</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">CondGO is ≤72 hours, no thrash. NMA-specific triggers included.</p>
                    <div class="form-row">
                        <label class="form-label" for="cg-trigger">Trigger</label>
                        <select class="form-input" id="cg-trigger">
                            <option value="">Select trigger...</option>
                            <option value="disconnect">Disconnected network discovered late</option>
                            <option value="inconsistency">Severe inconsistency without resolution path</option>
                            <option value="convergence">Bayesian convergence failure</option>
                            <option value="frequentist">Frequentist non-identifiability</option>
                            <option value="transitivity">Transitivity violation</option>
                            <option value="rerun">Rerun mismatch</option>
                            <option value="other">Other (specify)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Allowed Actions (check all that apply)</label>
                        <div style="display:grid;gap:8px">
                            <label><input type="checkbox" id="cg-a1"> Rule-based node remap + rerun</label>
                            <label><input type="checkbox" id="cg-a2"> Prespecified sensitivity analysis</label>
                            <label><input type="checkbox" id="cg-a3"> Restrict to connected component</label>
                            <label><input type="checkbox" id="cg-a4"> Suppress rankings</label>
                            <label><input type="checkbox" id="cg-a5"> Downgrade CINeMA confidence</label>
                            <label><input type="checkbox" id="cg-a6"> Repair source-citation/extraction errors</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="cg-exit">Exit Decision</label>
                        <select class="form-input" id="cg-exit">
                            <option value="">Select...</option>
                            <option value="pass">PASS — Issue resolved</option>
                            <option value="minimal">MINIMAL — Submit prespecified version</option>
                            <option value="terminate">TERMINATE — Archive with failure log</option>
                        </select>
                    </div>
                    <button class="copy-btn" onclick="generateCondGO()">Generate & Copy</button>
                    <div class="template-output" id="cg-output"></div>
                </div>
            </div>

            <!-- Audit 1 Template -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">📋 Appendix D1: Audit 1 (Days 18-20) <span class="template-badge badge-essential">QA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">10% trace audit + node mapping verification. Non-integrator auditor required.</p>
                    <div class="form-row">
                        <label class="form-label" for="a1-auditor">Auditor Name (non-integrator)</label>
                        <input type="text" class="form-input" id="a1-auditor" placeholder="Name of auditor">
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="a1-dates">Date Range</label>
                        <input type="text" class="form-input" id="a1-dates" placeholder="e.g., Days 18-20">
                    </div>
                    <h4 style="margin:16px 0 8px;font-size:13px">10% Sample Trace (check each)</h4>
                    <div style="display:grid;gap:8px;margin-bottom:16px">
                        <label style="font-size:13px"><input type="checkbox" id="a1-c1"> Sample matches source PDF (n events, N total)</label>
                        <label style="font-size:13px"><input type="checkbox" id="a1-c2"> Effect size calculation correct</label>
                        <label style="font-size:13px"><input type="checkbox" id="a1-c3"> Arm→Node mapping consistent with dictionary</label>
                        <label style="font-size:13px"><input type="checkbox" id="a1-c4"> Multi-arm handling correct</label>
                        <label style="font-size:13px"><input type="checkbox" id="a1-c5"> RoB judgment supported by data</label>
                    </div>
                    <h4 style="margin:16px 0 8px;font-size:13px">Node Mapping Verification</h4>
                    <div style="display:grid;gap:8px;margin-bottom:16px">
                        <label style="font-size:13px"><input type="checkbox" id="a1-n1"> All studies mapped to correct nodes</label>
                        <label style="font-size:13px"><input type="checkbox" id="a1-n2"> Grouping rules applied consistently</label>
                        <label style="font-size:13px"><input type="checkbox" id="a1-n3"> No orphan treatments</label>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="a1-discrepancies">Discrepancies Found</label>
                        <textarea class="form-textarea" id="a1-discrepancies" placeholder="List any errors or inconsistencies..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="a1-result">Audit 1 Result</label>
                        <select class="form-input" id="a1-result">
                            <option value="">Select...</option>
                            <option value="pass">PASS - No critical errors</option>
                            <option value="minor">PASS with minor corrections</option>
                            <option value="fail">FAIL - Major errors requiring re-extraction</option>
                        </select>
                    </div>
                    <button class="copy-btn" onclick="generateAudit1()">Generate & Copy</button>
                    <div class="template-output" id="a1-output"></div>
                </div>
            </div>

            <!-- Audit 2 Template -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔬 Appendix D2: Audit 2 (Days 30-32) <span class="template-badge badge-essential">QA</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Rerun verification + influential study check. Must pass before FREEZE.</p>
                    <div class="form-row">
                        <label class="form-label" for="a2-auditor">Auditor Name</label>
                        <input type="text" class="form-input" id="a2-auditor" placeholder="Name of auditor">
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="a2-dates">Date Range</label>
                        <input type="text" class="form-input" id="a2-dates" placeholder="e.g., Days 30-32">
                    </div>
                    <h4 style="margin:16px 0 8px;font-size:13px">Rerun Verification</h4>
                    <div style="display:grid;gap:8px;margin-bottom:16px">
                        <label style="font-size:13px"><input type="checkbox" id="a2-c1"> Independent rerun matches primary results</label>
                        <label style="font-size:13px"><input type="checkbox" id="a2-c2"> All effect estimates within equivalence bounds</label>
                        <label style="font-size:13px"><input type="checkbox" id="a2-c3"> Rankings (if reported) identical</label>
                        <label style="font-size:13px"><input type="checkbox" id="a2-c4"> CINeMA ratings consistent</label>
                    </div>
                    <h4 style="margin:16px 0 8px;font-size:13px">Influential Study Check (top 20% by weight)</h4>
                    <div style="display:grid;gap:8px;margin-bottom:16px">
                        <label style="font-size:13px"><input type="checkbox" id="a2-i1"> Identified influential studies listed</label>
                        <label style="font-size:13px"><input type="checkbox" id="a2-i2"> Leave-one-out sensitivity performed</label>
                        <label style="font-size:13px"><input type="checkbox" id="a2-i3"> No single study changes conclusions</label>
                        <label style="font-size:13px"><input type="checkbox" id="a2-i4"> Data extraction double-checked for influential studies</label>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="a2-equivalence">Rerun Match Summary</label>
                        <textarea class="form-textarea" id="a2-equivalence" placeholder="Primary: OR 0.75 [0.62-0.91], Rerun: OR 0.75 [0.62-0.91] → MATCH"></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="a2-issues">Issues Identified</label>
                        <textarea class="form-textarea" id="a2-issues" placeholder="List any discrepancies or concerns..."></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label" for="a2-result">Audit 2 Result</label>
                        <select class="form-input" id="a2-result">
                            <option value="">Select...</option>
                            <option value="pass">PASS - Ready for FREEZE</option>
                            <option value="minor">PASS with minor corrections</option>
                            <option value="fail">FAIL - Rerun mismatch (trigger CondGO)</option>
                        </select>
                    </div>
                    <button class="copy-btn" onclick="generateAudit2()">Generate & Copy</button>
                    <div class="template-output" id="a2-output"></div>
                </div>
            </div>

            <!-- Pod Handoff Checklists -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🤝 Pod Handoff Checklists <span class="template-badge badge-reference">COORDINATION</span></div>
                    <span>â–¼</span>
                </div>
                <div class="template-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Use these checklists when transitioning work between pods. Both giving and receiving pod must confirm.</p>

                    <div class="handoff-card">
                        <div class="handoff-title">📋 Search → Full-Text Handoff (Day ~10)</div>
                        <div class="handoff-items">
                            <label class="handoff-item"><input type="checkbox"> All search results exported and deduplicated</label>
                            <label class="handoff-item"><input type="checkbox"> PRISMA "Records identified" count confirmed</label>
                            <label class="handoff-item"><input type="checkbox"> Screening decisions documented</label>
                            <label class="handoff-item"><input type="checkbox"> Full-text retrieval list provided</label>
                            <label class="handoff-item"><input type="checkbox"> Known difficult-to-obtain papers flagged</label>
                        </div>
                    </div>

                    <div class="handoff-card">
                        <div class="handoff-title">📄 Full-Text → Extraction Handoff (Day ~14)</div>
                        <div class="handoff-items">
                            <label class="handoff-item"><input type="checkbox"> All PDFs organized and accessible</label>
                            <label class="handoff-item"><input type="checkbox"> Exclusion reasons documented for each excluded study</label>
                            <label class="handoff-item"><input type="checkbox"> Final included studies list confirmed</label>
                            <label class="handoff-item"><input type="checkbox"> Multi-arm studies flagged</label>
                            <label class="handoff-item"><input type="checkbox"> Node Dictionary shared with extraction team</label>
                        </div>
                    </div>

                    <div class="handoff-card">
                        <div class="handoff-title">📊 Extraction → Modeling Handoff (Day ~28)</div>
                        <div class="handoff-items">
                            <label class="handoff-item"><input type="checkbox"> All arm-level data extracted and verified</label>
                            <label class="handoff-item"><input type="checkbox"> Arm→Node mapping complete with source citation</label>
                            <label class="handoff-item"><input type="checkbox"> RoB assessments complete</label>
                            <label class="handoff-item"><input type="checkbox"> Effect modifier data extracted</label>
                            <label class="handoff-item"><input type="checkbox"> Data file format matches Model Contract specs</label>
                            <label class="handoff-item"><input type="checkbox"> Audit 1 passed</label>
                        </div>
                    </div>

                    <div class="handoff-card">
                        <div class="handoff-title">📈 Modeling → Write Handoff (Day ~34)</div>
                        <div class="handoff-items">
                            <label class="handoff-item"><input type="checkbox"> All analyses complete and reproducible</label>
                            <label class="handoff-item"><input type="checkbox"> League table finalized</label>
                            <label class="handoff-item"><input type="checkbox"> CINeMA assessment complete</label>
                            <label class="handoff-item"><input type="checkbox"> Ranking decision (report/suppress) documented</label>
                            <label class="handoff-item"><input type="checkbox"> Figures exported in publication format</label>
                            <label class="handoff-item"><input type="checkbox"> Audit 2 passed</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- REFERENCE PAGE -->
        <div class="page" id="page-reference" role="tabpanel">
            <div class="card">
                <div class="card-header"><div class="card-title">NMA-Specific Concepts</div></div>
                <div class="card-body">
                    <h4 style="margin-bottom:12px">Transitivity Assumption</h4>
                    <div style="background:var(--bg);padding:12px;border-radius:8px;font-size:13px;margin-bottom:16px">
                        The assumption that indirect comparisons are valid because studies are sufficiently similar in effect modifiers. If populations differ systematically, indirect evidence may be biased.
                    </div>

                    <h4 style="margin-bottom:12px">Consistency vs Inconsistency</h4>
                    <table class="ref-table">
                        <thead><tr><th>Type</th><th>Description</th><th>Test</th></tr></thead>
                        <tbody>
                            <tr><td><strong>Global</strong></td><td>Overall network coherence</td><td>Design-by-treatment interaction</td></tr>
                            <tr><td><strong>Local</strong></td><td>Specific comparison coherence</td><td>Node-splitting, loop-specific</td></tr>
                        </tbody>
                    </table>

                    <h4 style="margin:16px 0 12px">CINeMA Domains</h4>
                    <table class="ref-table">
                        <thead><tr><th>Domain</th><th>Question</th></tr></thead>
                        <tbody>
                            <tr><td>Within-study bias</td><td>Risk of bias in included studies?</td></tr>
                            <tr><td>Reporting bias</td><td>Missing studies/outcomes?</td></tr>
                            <tr><td>Indirectness</td><td>Applicability to PICO?</td></tr>
                            <tr><td>Imprecision</td><td>Confidence interval width?</td></tr>
                            <tr><td>Heterogeneity</td><td>Between-study variability?</td></tr>
                            <tr><td>Incoherence</td><td>Direct vs indirect agreement?</td></tr>
                        </tbody>
                    </table>

                    <h4 style="margin:16px 0 12px">When to Suppress Rankings</h4>
                    <div style="background:var(--danger-light);padding:12px;border-radius:8px;font-size:13px;border:1px solid var(--danger)">
                        <strong>Suppress if ANY:</strong><br>
                        • CINeMA confidence "Low" for key contrasts<br>
                        • Severe incoherence affecting key contrasts<br>
                        • Transitivity concerns "High"<br>
                        • Effect sizes not clinically meaningful
                    </div>
                </div>
            </div>
        </div>

        <!-- HELP PAGE -->
        <div class="page" id="page-help" role="tabpanel">
            <div class="card">
                <div class="card-header"><div class="card-title">NMA Quick Reference</div></div>
                <div class="card-body">
                    <h4 style="margin-bottom:12px">Key Differences from Pairwise</h4>
                    <table class="ref-table">
                        <thead><tr><th>Aspect</th><th>Pairwise</th><th>NMA</th></tr></thead>
                        <tbody>
                            <tr><td>Comparisons</td><td>A vs B</td><td>Multiple treatments simultaneously</td></tr>
                            <tr><td>Confidence</td><td>GRADE</td><td>CINeMA (6 domains)</td></tr>
                            <tr><td>Key assumption</td><td>Homogeneity</td><td>Transitivity + Consistency</td></tr>
                            <tr><td>Rankings</td><td>N/A</td><td>SUCRA/P-scores (with suppression rules)</td></tr>
                            <tr><td>Node mapping</td><td>N/A</td><td>Critical (lock at DoD-A)</td></tr>
                        </tbody>
                    </table>

                    <h4 style="margin:16px 0 12px">Decision Trees</h4>
                    <div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:8px">
                        <strong>Network disconnected?</strong><br>
                        → If prespecified component plan exists: analyze separately with limitations<br>
                        → If not: trigger CondGO; may need to route out
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:8px">
                        <strong>Inconsistency detected?</strong><br>
                        → Run local tests to identify problematic loops<br>
                        → Check transitivity (effect modifier imbalance)<br>
                        → Consider sensitivity excluding outlier studies<br>
                        → Downgrade CINeMA; consider ranking suppression
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:8px">
                        <strong>Bayesian model won't converge?</strong><br>
                        → Check priors (too informative/vague?)<br>
                        → Increase iterations/chains<br>
                        → If still fails after 72h: CondGO → switch to frequentist or terminate
                    </div>
                </div>
            </div>

            <!-- Worked NMA Example -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📖 Worked Example: Antidepressants NMA</div>
                    <span class="nma-indicator">LEARNING</span>
                </div>
                <div class="card-body">
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Walk through a mini-NMA comparing 4 antidepressants for depression.</p>

                    <div class="example-box">
                        <div class="example-title">Scenario</div>
                        <p style="font-size:13px">Compare efficacy of 4 treatments for major depression: Placebo, Drug A, Drug B, Drug C. We have 12 RCTs with the following direct comparisons:</p>
                        <ul style="font-size:12px;margin:8px 0 0 20px">
                            <li>5 trials: Placebo vs Drug A</li>
                            <li>3 trials: Placebo vs Drug B</li>
                            <li>2 trials: Drug A vs Drug B</li>
                            <li>2 trials: Drug A vs Drug C</li>
                        </ul>
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">1</span>
                        <strong>Node Dictionary</strong><br>
                        <code style="font-size:11px;background:var(--bg);padding:2px 6px;border-radius:4px">
                        Node 1: Placebo | Node 2: Drug A | Node 3: Drug B | Node 4: Drug C
                        </code>
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">2</span>
                        <strong>Check Connectivity</strong><br>
                        ✅ Network is connected (all nodes reachable)<br>
                        ⚠️ Note: No direct Placebo vs Drug C trials — this comparison is <em>indirect only</em>
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">3</span>
                        <strong>Assess Transitivity</strong><br>
                        Check effect modifiers across comparisons:<br>
                        • Severity: All trials in moderate-severe depression ✅<br>
                        • Age: Mean age 35-45 across all trials ✅<br>
                        • Duration: 8-12 weeks ✅<br>
                        → <strong>Transitivity: Low concern</strong>
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">4</span>
                        <strong>Run NMA Model</strong><br>
                        Using frequentist random-effects (netmeta in R):<br>
                        <code style="font-size:11px;background:var(--bg);padding:2px 6px;border-radius:4px;display:block;margin-top:4px">
                        Drug A vs Placebo: OR 1.45 [1.20, 1.75]<br>
                        Drug B vs Placebo: OR 1.38 [1.10, 1.73]<br>
                        Drug C vs Placebo: OR 1.52 [1.15, 2.01] ← indirect!
                        </code>
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">5</span>
                        <strong>Check Consistency</strong><br>
                        Global test (design-by-treatment): p = 0.42 → No evidence of inconsistency ✅<br>
                        Node-splitting for A vs B: Direct OR 1.05, Indirect OR 1.08, p = 0.85 ✅
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">6</span>
                        <strong>CINeMA Assessment (Drug C vs Placebo)</strong><br>
                        • Within-study bias: Some concerns (3/4 trials high RoB)<br>
                        • Indirectness: Low concern<br>
                        • Imprecision: Some concerns (CI crosses 1.5 threshold)<br>
                        • Heterogeneity: Low concern (I² = 28%)<br>
                        • Incoherence: Low concern<br>
                        → <strong>Overall: Moderate confidence</strong>
                    </div>

                    <div class="example-step">
                        <span class="example-step-num">7</span>
                        <strong>Rankings Decision</strong><br>
                        P-scores: Drug C (72%), Drug A (68%), Drug B (45%), Placebo (15%)<br>
                        ✅ CINeMA not "Low" for key contrasts<br>
                        ✅ No severe incoherence<br>
                        ✅ Transitivity OK<br>
                        → <strong>Rankings CAN be reported</strong> (with caution language)
                    </div>

                    <div style="background:var(--success-light);padding:12px;border-radius:8px;border:1px solid var(--success);margin-top:12px;font-size:13px">
                        <strong>✅ Conclusion:</strong> All 4 drugs show benefit vs placebo. Drug C ranks highest but evidence is indirect only. Recommend Drug A or B as first-line (more direct evidence). Drug C may be considered with acknowledgment of indirect evidence.
                    </div>
                </div>
            </div>
        </div>

        <!-- GLOSSARY PAGE -->
        <div class="page" id="page-glossary" role="tabpanel">
            <div class="card">
                <div class="card-header"><div class="card-title">NMA Glossary</div></div>
                <div class="card-body" id="glossaryContent">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settingsModal" role="dialog" aria-modal="true">
    <div class="modal-card">
        <div class="modal-header">
            <div class="modal-title">⚙️ Settings</div>
            <button class="modal-close" aria-label="Close" onclick="closeModal('settingsModal')">×</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <label class="form-label" for="projectNameInput">Project Name</label>
                <input type="text" class="form-input" id="projectNameInput" placeholder="My NMA Project">
            </div>
            <div class="btn-row" style="margin-top:16px">
                <button class="copy-btn" onclick="exportData()">⬇️ Export Data</button>
                <button class="download-btn" onclick="resetData()">🗑️ Reset All</button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== STATE =====
let state = {
    day: 1,
    role: '',
    bootcamp: {},
    nodeDictionary: '',
    modelContract: {},
    cinema: {},
    rankingChecks: {},
    transitivityChecks: {},
    prismaChecks: {},
    tasks: {},
    taskAssignees: {},
    dodChecked: {},
    dodGates: { A: false, B: false, C: false, D: false, E: false },
    nodeCount: 0,
    studyCount: 0,
    effectModifiers: ''
};

// ===== CONSTANTS =====
const ROLE_NAMES = {
    integrator: 'Integrator',
    deputy: 'Deputy',
    search: 'Search & Screen',
    fulltext: 'Full-Text',
    extraction: 'Extraction & Quality Risk (RoB)',
    network: 'Network Architecture',
    modeling: 'Modeling & Write'
};

const PHASES = [
    { id: 'A', name: 'Protocol + Model Contract', days: [1, 4], cls: 'phase-a' },
    { id: 'B', name: 'Search + Viability', days: [6, 12], cls: 'phase-b' },
    { id: 'C', name: 'Extraction + Mapping', days: [12, 28], cls: 'phase-c' },
    { id: 'D', name: 'Model + CINeMA', days: [24, 34], cls: 'phase-d' },
    { id: 'E', name: 'Submission', days: [34, 40], cls: 'phase-e' }
];

const DOD_CHECKLISTS = {
    A: [
        { id: 'a1', text: 'PICOS + primary outcome + effect direction + timepoint rule' },
        { id: 'a2', text: 'Node Dictionary v1 locked (≤12 nodes)' },
        { id: 'a3', text: 'Grouping/splitting rules documented' },
        { id: 'a4', text: 'Model Contract locked (Bayesian vs Frequentist + diagnostics)' },
        { id: 'a5', text: 'Transitivity effect modifiers listed (≤6)' },
        { id: 'a6', text: 'Consistency plan specified (global + local tests)' },
        { id: 'a7', text: 'Ranking policy + suppression rule locked' },
        { id: 'a8', text: 'CondGO triggers included' },
        { id: 'a9', text: 'Study plan registered (PROSPERO/protocols.io)' },
        { id: 'a10', text: 'Signed by Integrator + non-integrator' }
    ],
    B: [
        { id: 'b1', text: 'Search strings saved verbatim' },
        { id: 'b2', text: 'Search dates + limits recorded' },
        { id: 'b3', text: 'Dedup method recorded' },
        { id: 'b4', text: 'Screening alignment check completed' },
        { id: 'b5', text: 'Study-flow (PRISMA) counts live' },
        { id: 'b6', text: 'Network viability confirmed (all thresholds pass)' },
        { id: 'b7', text: 'Node count ≤12 after mapping' }
    ],
    C: [
        { id: 'c1', text: 'Arm-level extraction template frozen' },
        { id: 'c2', text: 'Arm→Node mapping complete with source citation' },
        { id: 'c3', text: 'Multi-arm handling rule applied consistently' },
        { id: 'c4', text: 'Key fields verified (Appendix F)' },
        { id: 'c5', text: 'Discrepancy arbitration functioning' },
        { id: 'c6', text: 'Audit 1 (10% trace + node mapping) passed' }
    ],
    D: [
        { id: 'd1', text: 'Capsule runs from clean, versioned inputs' },
        { id: 'd2', text: 'Required diagnostics met per Model Contract' },
        { id: 'd3', text: 'Global inconsistency test performed' },
        { id: 'd4', text: 'Local inconsistency checks performed' },
        { id: 'd5', text: 'League table produced with uncertainty intervals' },
        { id: 'd6', text: 'CINeMA completed for primary outcome' },
        { id: 'd7', text: 'Ranking outputs adhere to suppression rule' },
        { id: 'd8', text: 'Red-team Audit 2 passed' }
    ],
    E: [
        { id: 'e1', text: 'PRISMA-NMA checklist complete' },
        { id: 'e2', text: 'Two independent capsule reruns equivalent' },
        { id: 'e3', text: 'Clinical summary includes NMA interpretation constraints' },
        { id: 'e4', text: 'Deviations log complete' },
        { id: 'e5', text: 'Audit pack complete' },
        { id: 'e6', text: 'Submission pack ready' }
    ]
};

const GLOSSARY = [
    { term: 'Node', plain: 'A treatment option in the network. Each unique intervention is a node.', technical: 'Vertex in the network graph representing a treatment class or specific intervention.' },
    { term: 'Edge', plain: 'A line connecting two nodes, representing studies that directly compared those treatments.', technical: 'Graph edge weighted by number of studies or participants in that direct comparison.' },
    { term: 'Direct evidence', plain: 'Results from studies that directly compared two treatments head-to-head.', technical: 'Evidence from RCTs where both treatments were randomized arms in the same trial.' },
    { term: 'Indirect evidence', plain: 'Results inferred by comparing treatments through a common comparator (A vs B via A-C and B-C studies).', technical: 'Evidence derived mathematically by combining direct evidence through network paths.' },
    { term: 'Transitivity', plain: 'The assumption that studies are similar enough to combine indirect evidence.', technical: 'Effect modifiers are similarly distributed across comparisons, making indirect evidence valid.' },
    { term: 'Effect modifier', plain: 'A variable that changes how well a treatment works (e.g., disease severity, age).', technical: 'Covariate that interacts with treatment to modify the effect size.' },
    { term: 'Consistency', plain: 'Direct and indirect evidence agree.', technical: 'No statistical evidence of disagreement between direct and indirect estimates.' },
    { term: 'Incoherence', plain: 'When direct and indirect evidence disagree (the opposite of consistency).', technical: 'Statistically significant difference between direct and indirect effect estimates.' },
    { term: 'CINeMA', plain: 'Confidence in Network Meta-Analysis. A framework to rate how much you trust NMA results.', technical: '6-domain framework assessing within-study bias, reporting bias, indirectness, imprecision, heterogeneity, and incoherence.' },
    { term: 'SUCRA', plain: 'Surface Under Cumulative Ranking curve. A number from 0-100% showing how likely a treatment ranks best.', technical: 'Bayesian probability that a treatment is best, accounting for all rank positions.' },
    { term: 'P-score', plain: 'Frequentist version of SUCRA. Same interpretation: higher = more likely to be best.', technical: 'Mean extent of certainty that a treatment is better than competitors, derived from frequentist NMA.' },
    { term: 'Node-splitting', plain: 'A test that checks if direct and indirect evidence disagree for a specific comparison.', technical: 'Local inconsistency assessment separating direct from indirect evidence.' },
    { term: 'League Table', plain: 'A table showing all treatment comparisons in a matrix format.', technical: 'Matrix of pairwise effect estimates and confidence intervals for all comparisons.' },
    { term: 'Model Contract', plain: 'The locked agreement on which analysis method and settings to use.', technical: 'Prespecified analysis plan including method choice, priors/estimators, and diagnostic criteria.' },
    { term: 'Multi-arm trial', plain: 'A study comparing 3+ treatments at once. Needs special handling in NMA.', technical: 'Trial with ≥3 arms requiring correlation adjustment for shared control arm.' },
    { term: 'Tau-squared (τ²)', plain: 'A measure of how different studies are from each other (heterogeneity).', technical: 'Between-study variance in random-effects meta-analysis.' },
    { term: 'Prediction interval', plain: 'The range where a future study\'s result would likely fall.', technical: '95% interval accounting for both uncertainty in mean effect and between-study heterogeneity.' }
];

const DAILY_GOALS = {
    1: 'Complete Bootcamp + Draft Node Dictionary v1',
    2: 'Finalize PICOS + Begin Model Contract',
    3: 'Lock Model Contract + Ranking Policy',
    4: 'Sign off DoD-A-NMA',
    6: 'Execute searches',
    10: 'Complete screening + Network viability check',
    12: 'Sign off DoD-B-NMA',
    18: 'Audit 1 begins',
    20: 'Audit 1 complete',
    28: 'Sign off DoD-C-NMA',
    30: 'Run full analysis + Begin CINeMA',
    32: 'Audit 2 begins',
    33: 'Audit 2 complete',
    34: 'Sign off DoD-D-NMA + FREEZE',
    40: 'Submit! DoD-E-NMA complete'
};

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    if (state.role) {
        document.getElementById('onboarding').classList.add('hidden');
        document.getElementById('app').style.display = 'block';
        render();
    }
    loadDarkMode();
});

function loadState() {
    const saved = localStorage.getItem('metasprint-nma');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            delete data.__proto__; delete data.constructor; delete data.prototype;
            // Deep merge nested objects to preserve new defaults
            const nestedKeys = ['bootcamp', 'modelContract', 'cinema', 'rankingChecks',
                'transitivityChecks', 'prismaChecks', 'tasks', 'taskAssignees', 'dodChecked',
                'dodGates', 'achievementsEarned'];
            for (const key of nestedKeys) {
                if (state[key] && data[key] && typeof data[key] === 'object') {
                    data[key] = { ...state[key], ...data[key] };
                }
            }
            state = { ...state, ...data };
        } catch(e) {}
    }
}

function save() {
    try { localStorage.setItem('metasprint-nma', JSON.stringify(state)); }
    catch(e) { if (e.name === 'QuotaExceededError') showToast('Storage full — export your data to free space', 'error'); }
}

// ===== ONBOARDING =====
function toggleElig(el) {
    el.classList.toggle('checked');
    const allChecked = document.querySelectorAll('.elig-item.checked').length === document.querySelectorAll('.elig-item').length;
    document.getElementById('nextBtn1').disabled = !allChecked;
}

function goToStep2() {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
}

function selectRole(el, role) {
    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    state.role = role;
    document.getElementById('startBtn').disabled = false;
}

function startApp() {
    save();
    document.getElementById('onboarding').classList.add('hidden');
    document.getElementById('app').style.display = 'block';
    render();
}

function showRoleChange() {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('onboarding').classList.remove('hidden');
}

// ===== RENDER =====
function buildRiskState() {
    var d = state.day;
    var gates = state.dodGates || {};
    var studyCount = state.studyCount ?? 0;
    var daysToFreeze = Math.max(0, 34 - d);
    var risks = [];
    var points = 0;
    var gateDeadlines = { A: 4, B: 12, C: 28, D: 34, E: 40 };

    ['A', 'B', 'C', 'D', 'E'].forEach(function(gate) {
        var deadline = gateDeadlines[gate];
        if (d > deadline && !gates[gate]) {
            var overdue = d - deadline;
            risks.push({ level: 'high', text: 'DoD-' + gate + ' overdue by ' + overdue + ' day(s).' });
            points += 3;
        }
    });

    if (d < 34 && daysToFreeze <= 3 && !gates.D) {
        risks.push({ level: 'medium', text: 'Freeze in ' + daysToFreeze + ' day(s), but DoD-D is not signed off.' });
        points += 2;
    }

    if (studyCount > 0 && (studyCount < 40 || studyCount > 60)) {
        risks.push({ level: 'medium', text: 'Study count ' + studyCount + ' is outside target range (40-60).' });
        points += 1;
    } else if (d > 12 && studyCount === 0) {
        risks.push({ level: 'medium', text: 'Study count is still zero after Day 12. Verify PRISMA and extraction logs.' });
        points += 1;
    }

    var level = 'low';
    if (points >= 4) level = 'high';
    else if (points >= 2) level = 'medium';

    if (risks.length === 0) {
        risks.push({ level: 'low', text: 'No active risks. Keep daily outputs on schedule.' });
    }

    return { level: level, items: risks };
}

function renderRiskPanel() {
    var badge = document.getElementById('riskStatusBadge');
    var list = document.getElementById('riskList');
    if (!badge || !list) return;

    var risk = buildRiskState();
    badge.className = 'risk-badge ' + risk.level;
    badge.textContent = risk.level.toUpperCase();

    var html = '';
    risk.items.forEach(function(item) {
        var cls = 'risk-item';
        if (item.level === 'high') cls += ' high';
        else if (item.level === 'medium') cls += ' medium';
        html += '<li class="' + cls + '">' + escapeHtml(item.text) + '</li>';
    });
    list.innerHTML = html;
}

function render() {
    const d = state.day;
    document.getElementById('dayNum').textContent = d;
    document.getElementById('prevDayBtn').disabled = d <= 1;
    document.getElementById('nextDayBtn').disabled = d >= 40;
    document.getElementById('roleBadge').textContent = ROLE_NAMES[state.role] || state.role;
    document.getElementById('freezeBanner').classList.toggle('hidden', d < 34);

    // Timeline
    document.getElementById('timelineFill').style.width = ((d / 40) * 100) + '%';
    const timelineBar = document.getElementById('timelineBar');
    if (timelineBar) timelineBar.setAttribute('aria-valuenow', d);

    // Phase badge
    const phase = PHASES.find(p => d >= p.days[0] && d <= p.days[1]) || PHASES[0];
    const badge = document.getElementById('phaseBadge');
    badge.textContent = phase.name;
    badge.className = 'phase-badge ' + phase.cls;

    // Health dashboard
    document.getElementById('daysRemaining').textContent = 40 - d;
    document.getElementById('nodeCount').textContent = state.nodeCount ?? 0;
    document.getElementById('studyCount').textContent = state.studyCount ?? 0;
    const gatesPassed = ['A','B','C','D','E'].filter(g => state.dodGates[g]).length;
    document.getElementById('gatesPassed').textContent = gatesPassed + '/5';

    // Gate dots
    ['A','B','C','D','E'].forEach(g => {
        const dot = document.getElementById('gate' + g);
        dot.classList.remove('passed', 'current');
        if (state.dodGates[g]) dot.classList.add('passed');
    });

    // Health score
    let score = 100;
    if (d > 4 && !state.dodGates.A) score -= 20;
    if (d > 12 && !state.dodGates.B) score -= 20;
    if (d > 28 && !state.dodGates.C) score -= 20;
    if (d > 34 && !state.dodGates.D) score -= 20;
    const scoreEl = document.getElementById('healthScore');
    scoreEl.textContent = score + '%';
    scoreEl.className = 'health-score ' + (score >= 80 ? 'good' : score >= 50 ? 'warning' : 'danger');

    renderRiskPanel();

    // Bootcamp visibility
    document.getElementById('bootcampCard').style.display = d <= 2 ? 'block' : 'none';

    // Goal
    const goal = DAILY_GOALS[d] || 'Continue current phase tasks';
    document.getElementById('goalText').textContent = goal;

    // Tasks
    renderTasks();

    // DoD page
    renderDoD();

    // Network stats
    document.getElementById('netNodes').textContent = state.nodeCount ?? 0;
    document.getElementById('netStudies').textContent = state.studyCount ?? 0;

    // Glossary
    renderGlossary();
}

function renderTasks() {
    const d = state.day;
    const role = state.role;
    let tasks = [];

    // Tasks with suggested owners
    if (d === 1) {
        tasks = [
            { text: 'Complete NMA Bootcamp (45 min)', owner: 'All' },
            { text: 'Draft Node Dictionary v1', owner: 'Network' },
            { text: 'Review PICOS', owner: 'Integrator' }
        ];
    } else if (d <= 4) {
        tasks = [
            { text: 'Finalize Node Dictionary', owner: 'Network' },
            { text: 'Complete Model Contract', owner: 'Modeling' },
            { text: 'Lock ranking policy', owner: 'Integrator' }
        ];
    } else if (d <= 12) {
        if (role === 'search') tasks = [
            { text: 'Execute database searches', owner: 'Search' },
            { text: 'Document search strings', owner: 'Search' }
        ];
        else if (role === 'network') tasks = [
            { text: 'Prepare viability assessment', owner: 'Network' },
            { text: 'Validate node mapping rules', owner: 'Network' }
        ];
        else tasks = [
            { text: 'Support search/screen phase', owner: role },
            { text: 'Review node assignments', owner: role }
        ];
    } else if (d <= 28) {
        if (role === 'extraction') tasks = [
            { text: 'Continue arm-level extraction', owner: 'Extraction' },
            { text: 'Verify key fields', owner: 'Extraction' }
        ];
        else if (role === 'network') tasks = [
            { text: 'Monitor node mapping consistency', owner: 'Network' },
            { text: 'Flag multi-arm issues', owner: 'Network' }
        ];
        else tasks = [
            { text: 'Support extraction', owner: role },
            { text: 'Prepare for Audit 1', owner: 'Deputy' }
        ];
    } else if (d <= 34) {
        if (role === 'modeling') tasks = [
            { text: 'Run NMA model', owner: 'Modeling' },
            { text: 'Complete CINeMA', owner: 'Modeling' },
            { text: 'Produce league table', owner: 'Modeling' }
        ];
        else tasks = [
            { text: 'Support analysis', owner: role },
            { text: 'Review outputs', owner: role }
        ];
    } else {
        tasks = [
            { text: 'Final manuscript review', owner: 'Integrator' },
            { text: 'Complete PRISMA-NMA checklist', owner: 'Integrator' },
            { text: 'Verify rerun equivalence', owner: 'Deputy' }
        ];
    }

    let html = '';
    tasks.forEach((task, i) => {
        const key = `${d}-${i}`;
        const checked = state.tasks[key];
        const assignee = state.taskAssignees?.[key] || task.owner || '';
        const safeAssignee = escapeHtml(assignee);
        html += `<div class="checklist-item ${checked ? 'checked' : ''}" tabindex="0" style="position:relative" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleTask('${key}')}">
            <div class="check-box" onclick="toggleTask('${key}')"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
            <div class="checklist-content" onclick="toggleTask('${key}')" style="flex:1">
                <div class="checklist-title">${task.text}</div>
            </div>
            <input type="text" value="${safeAssignee}" placeholder="Owner" onclick="event.stopPropagation()" onchange="setTaskAssignee('${key}', this.value)" style="width:70px;padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:11px;text-align:center;background:var(--bg)">
        </div>`;
    });
    document.getElementById('tasksContainer').innerHTML = html;
}

function setTaskAssignee(key, value) {
    if (!state.taskAssignees) state.taskAssignees = {};
    state.taskAssignees[key] = value;
    save();
    showToast('Assignee updated');
}

function toggleTask(key) {
    state.tasks[key] = !state.tasks[key];
    save();
    renderTasks();
    showToast('Saved');
}

function renderDoD() {
    let html = '';
    PHASES.forEach(phase => {
        const items = DOD_CHECKLISTS[phase.id] || [];
        const checkedCount = items.filter(item => state.dodChecked[item.id]).length;
        const allChecked = checkedCount === items.length;
        const passed = state.dodGates[phase.id];

        let statusText = passed ? '✓ PASSED' : allChecked ? '◉ Ready' : `${checkedCount}/${items.length}`;
        let statusClass = passed ? 'gate-passed' : allChecked ? 'gate-ready' : 'gate-pending';

        html += `<div class="dod-section">
            <div class="dod-header ${phase.cls}">
                <div class="dod-title">DoD-${phase.id}-NMA: ${phase.name}</div>
                <div class="dod-gate-status ${statusClass}">${statusText}</div>
            </div>`;

        items.forEach(item => {
            const checked = state.dodChecked[item.id];
            html += `<div class="checklist-item ${checked ? 'checked' : ''}" onclick="toggleDoD('${item.id}')">
                <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                <div class="checklist-content"><div class="checklist-title">${item.text}</div></div>
            </div>`;
        });

        if (allChecked && !passed) {
            html += `<button class="copy-btn" style="width:100%;margin-top:12px" onclick="signOffGate('${phase.id}')">✍️ Sign Off DoD-${phase.id}-NMA</button>`;
        }
        html += '</div>';
    });
    document.getElementById('dodContainer').innerHTML = html;
}

function toggleDoD(id) {
    state.dodChecked[id] = !state.dodChecked[id];
    save();
    renderDoD();
    showToast('Saved');
}

function signOffGate(gateId) {
    if (!confirm(`Sign off DoD-${gateId}-NMA? This confirms all checklist items are complete.`)) return;
    state.dodGates[gateId] = true;
    save();
    render();
    showToast(`🎉 DoD-${gateId}-NMA PASSED!`);
    launchConfetti();
}

function renderGlossary() {
    let html = '';
    GLOSSARY.forEach(item => {
        html += `<div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border)">
            <div style="font-weight:700;color:var(--nma)">${escapeHtml(item.term)}</div>
            <div style="margin-top:4px">${escapeHtml(item.plain)}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px;font-style:italic">${escapeHtml(item.technical)}</div>
        </div>`;
    });
    document.getElementById('glossaryContent').innerHTML = html;
}

// ===== NAVIGATION =====
function changeDay(delta) {
    state.day = Math.max(1, Math.min(40, state.day + delta));
    save();
    render();
}

// ===== MORE TABS DROPDOWN =====
const MORE_TAB_PAGES = ['stories', 'reference', 'help', 'glossary'];

function toggleMoreTabs(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('moreTabsDropdown');
    const btn = dropdown.previousElementSibling;
    const isOpen = dropdown.classList.contains('visible');
    dropdown.classList.toggle('visible', !isOpen);
    btn.setAttribute('aria-expanded', !isOpen);
    if (!isOpen) {
        const firstItem = dropdown.querySelector('.tab-more-item');
        if (firstItem) firstItem.focus();
        document.addEventListener('click', closeMoreTabsOnOutsideClick);
        document.addEventListener('keydown', handleMoreTabsKeyboard);
    } else {
        document.removeEventListener('click', closeMoreTabsOnOutsideClick);
        document.removeEventListener('keydown', handleMoreTabsKeyboard);
    }
}

function closeMoreTabsOnOutsideClick(e) {
    const wrapper = document.querySelector('.tab-more-wrapper');
    if (!wrapper.contains(e.target)) closeMoreDropdown();
}

function handleMoreTabsKeyboard(e) {
    const dropdown = document.getElementById('moreTabsDropdown');
    if (!dropdown.classList.contains('visible')) return;
    const items = Array.from(dropdown.querySelectorAll('.tab-more-item'));
    const idx = items.indexOf(document.activeElement);
    if (e.key === 'Escape') { closeMoreDropdown(); dropdown.previousElementSibling.focus(); e.preventDefault(); }
    else if (e.key === 'ArrowDown') { e.preventDefault(); items[Math.min(idx + 1, items.length - 1)].focus(); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); items[Math.max(idx - 1, 0)].focus(); }
}

function closeMoreDropdown() {
    const dropdown = document.getElementById('moreTabsDropdown');
    if (dropdown) {
        dropdown.classList.remove('visible');
        dropdown.previousElementSibling.setAttribute('aria-expanded', 'false');
    }
    document.removeEventListener('click', closeMoreTabsOnOutsideClick);
    document.removeEventListener('keydown', handleMoreTabsKeyboard);
}

function showPageFromMore(pageId, clickedItem) {
    closeMoreDropdown();
    document.querySelectorAll('.tab-more-item').forEach(i => i.classList.remove('active'));
    if (clickedItem) clickedItem.classList.add('active');
    const moreBtn = document.querySelector('.tab-more-btn');
    if (moreBtn) moreBtn.classList.add('has-active');
    showPage(pageId, null);
}

function showPage(pageId, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });

    // Close More dropdown and clear its active states
    closeMoreDropdown();
    document.querySelectorAll('.tab-more-item').forEach(i => i.classList.remove('active'));
    const moreBtn = document.querySelector('.tab-more-btn');
    if (moreBtn) moreBtn.classList.remove('has-active');

    if (MORE_TAB_PAGES.includes(pageId)) {
        const item = document.querySelector('.tab-more-item[data-page="' + pageId + '"]');
        if (item) item.classList.add('active');
        if (moreBtn) moreBtn.classList.add('has-active');
    } else if (btn && btn.classList) {
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');
    }

    document.getElementById('page-' + pageId).classList.add('active');
}

function showDayJump() {
    document.getElementById('dayJumpModal').classList.add('visible');
    const input = document.getElementById('dayJumpInput');
    input.value = state.day;
    input.select();
}

function closeDayJump(e) {
    if (e && e.target !== e.currentTarget) return;
    document.getElementById('dayJumpModal').classList.remove('visible');
}

function jumpToDay() {
    const val = parseInt(document.getElementById('dayJumpInput').value, 10) ?? 1;
    state.day = Math.max(1, Math.min(40, val));
    save();
    render();
    closeDayJump();
    showToast(`Jumped to Day ${state.day}`);
}

function handleDayJumpKey(e) {
    if (e.key === 'Enter') jumpToDay();
    else if (e.key === 'Escape') closeDayJump();
}

// ===== BOOTCAMP ===== (defined later with lesson-opening behavior)

// ===== DARK MODE =====
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    try { localStorage.setItem('metasprint_nma_dark', isDark ? 'true' : 'false'); } catch(e) {}
    document.getElementById('darkModeBtn').textContent = isDark ? '☀️' : '🌙';
}

function loadDarkMode() {
    if (localStorage.getItem('metasprint_nma_dark') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeBtn').textContent = '☀️';
    }
}

// ===== MODALS =====
let _modalTrigger = null;
function openModal(id) {
    _modalTrigger = document.activeElement;
    const modal = document.getElementById(id);
    modal.classList.add('visible');
    const focusable = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (focusable) setTimeout(() => focusable.focus(), 50);
}
function closeModal(id) {
    document.getElementById(id).classList.remove('visible');
    if (_modalTrigger) { _modalTrigger.focus(); _modalTrigger = null; }
}

// ===== TEMPLATES =====
function toggleTemplate(el) {
    const body = el.nextElementSibling;
    body.classList.toggle('open');
    el.setAttribute('aria-expanded', body.classList.contains('open') ? 'true' : 'false');
}

function escapeHtml(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function showOutput(id, text) {
    const el = document.getElementById(id);
    el.textContent = text;
    el.classList.add('visible');
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard');
    }).catch(() => {
        showToast('Saved (clipboard unavailable)');
    });
}

function generateModelContract() {
    const text = `MODEL CONTRACT (NMA)
=====================================
Method: ${document.getElementById('mc-method').value === 'freq' ? 'Frequentist' : 'Bayesian'} random-effects NMA
Estimator/Prior: ${document.getElementById('mc-estimator').value}
Multi-arm: ${document.getElementById('mc-multiarm').value}
Global inconsistency: ${document.getElementById('mc-global').value}
Local inconsistency: ${document.getElementById('mc-local').value}
Convergence: ${document.getElementById('mc-convergence').value}

LOCKED at DoD-A-NMA. No changes except via CondGO.`;
    showOutput('mc-output', text);
}

function generateRankingPolicy() {
    const text = `RANKING POLICY
=====================================
Metric: ${document.getElementById('rp-metric').value}
Decision: ${document.getElementById('rp-suppress').value}
Justification: ${document.getElementById('rp-justify').value}

LOCKED at DoD-A-NMA.`;
    showOutput('rp-output', text);
}

function generateViabilityReport() {
    const text = `NETWORK VIABILITY REPORT
=====================================
Nodes: ${document.getElementById('nv-nodes').value}
Studies: ${document.getElementById('nv-studies').value}
Connectedness: ${document.getElementById('nv-connected').value}
Sparsity flags: ${document.getElementById('nv-sparse').value}
Modifier missingness: ${document.getElementById('nv-missing').value}
DECISION: ${document.getElementById('nv-decision').value}`;
    showOutput('nv-output', text);
}

function generateClinicalSummary() {
    const text = `CLINICAL SUMMARY PANEL (NMA)
=====================================
1. PICOS: ${document.getElementById('cs-picos').value}
2. Main contrasts: ${document.getElementById('cs-contrasts').value}
3. Absolute effects: ${document.getElementById('cs-absolute').value}
4. Consistency: ${document.getElementById('cs-consistency').value}
5. CINeMA: ${document.getElementById('cs-cinema').value}
6. Rankings: ${document.getElementById('cs-rankings').value}
7. Applicability: ${document.getElementById('cs-applicability').value}`;
    showOutput('cs-output', text);
}

function generateCondGO() {
    const actions = [];
    if (document.getElementById('cg-a1').checked) actions.push('Node remap');
    if (document.getElementById('cg-a2').checked) actions.push('Sensitivity analysis');
    if (document.getElementById('cg-a3').checked) actions.push('Restrict to component');
    if (document.getElementById('cg-a4').checked) actions.push('Suppress rankings');
    if (document.getElementById('cg-a5').checked) actions.push('Downgrade CINeMA');
    if (document.getElementById('cg-a6').checked) actions.push('Repair errors');
    const text = `CONDGO DECISION (NMA)
=====================================
Trigger: ${document.getElementById('cg-trigger').value}
Actions: ${actions.join(', ')}
Exit: ${document.getElementById('cg-exit').value}

≤72 hours. No new outcomes/priors/nodes.`;
    showOutput('cg-output', text);
}

// ===== CINeMA =====
function saveCINeMA() {
    state.cinema = {
        wsb: document.getElementById('cinema-wsb').value,
        rb: document.getElementById('cinema-rb').value,
        ind: document.getElementById('cinema-ind').value,
        imp: document.getElementById('cinema-imp').value,
        het: document.getElementById('cinema-het').value,
        inc: document.getElementById('cinema-inc').value,
        overall: document.getElementById('cinema-overall').value,
        justification: document.getElementById('cinema-justification').value
    };
    save();
    showToast('CINeMA saved');
}

function generateCINeMAReport() {
    const text = `CINeMA CONFIDENCE ASSESSMENT
=====================================
Within-study bias: ${document.getElementById('cinema-wsb').value}
Reporting bias: ${document.getElementById('cinema-rb').value}
Indirectness: ${document.getElementById('cinema-ind').value}
Imprecision: ${document.getElementById('cinema-imp').value}
Heterogeneity: ${document.getElementById('cinema-het').value}
Incoherence: ${document.getElementById('cinema-inc').value}

OVERALL: ${document.getElementById('cinema-overall').value}
Justification: ${document.getElementById('cinema-justification').value}`;
    showOutput('cinema-output', text);
}

function toggleRankCheck(el, check) {
    el.classList.toggle('checked');
    state.rankingChecks[check] = el.classList.contains('checked');
    save();
    updateRankingResult();
}

function updateRankingResult() {
    const checks = state.rankingChecks || {};
    const allPass = checks.confidence && checks.incoherence && checks.transitivity && checks.clinical;
    const result = document.getElementById('rankingResult');
    result.style.display = 'block';
    if (allPass) {
        result.className = 'alert alert-success';
        result.innerHTML = '<div class="alert-icon">✅</div><div class="alert-content"><div class="alert-title">Rankings CAN be reported</div><div class="alert-text">All conditions pass. Include with appropriate caution language.</div></div>';
    } else {
        result.className = 'alert alert-danger';
        result.innerHTML = '<div class="alert-icon">🚫</div><div class="alert-content"><div class="alert-title">Rankings must be SUPPRESSED</div><div class="alert-text">Report only effect estimates with uncertainty + confidence grading.</div></div>';
    }
}

// ===== NETWORK =====
function saveNodeDictionary() {
    state.nodeDictionary = document.getElementById('nodeDictionary').value;
    const lines = state.nodeDictionary.split('\n').filter(l => l.trim());
    state.nodeCount = lines.length;
    save();
    render();
    showToast('Node dictionary saved');
}

function saveModelContract() {
    const getValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : '';
    };

    state.modelContract = {
        method: getValue('modelMethod'),
        software: getValue('modelSoftware'),
        zeroCells: getValue('modelZeroCells'),
        minStudies: getValue('modelMinStudies'),
        prior: getValue('modelPrior'),
        convergence: getValue('modelConvergence')
    };
    save();
    showToast('Model contract saved');
}

// ===== UTILITIES =====
let toastTimeout;
function showToast(msg, type = 'success') {
    const toast = document.getElementById('toast');
    document.getElementById('toastText').textContent = msg;
    toast.className = 'toast visible' + (type === 'error' ? ' error' : '');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => toast.classList.remove('visible'), 2500);
}

function launchConfetti() {
    const container = document.getElementById('confettiContainer');
    const colors = ['#0891B2', '#059669', '#D97706', '#DC2626', '#7C3AED'];
    for (let i = 0; i < 80; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + '%';
        c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        c.style.animationDelay = Math.random() * 0.5 + 's';
        container.appendChild(c);
    }
    setTimeout(() => container.innerHTML = '', 4000);
}

function exportData() {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = 'metasprint-nma-backup.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function resetData() {
    if (!confirm('Reset all data? This cannot be undone.')) return;
    localStorage.removeItem('metasprint-nma');
    location.reload();
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    // Global Escape handler - close any visible modal/overlay
    if (e.key === 'Escape') {
        const visibleModal = document.querySelector('.modal.visible');
        if (visibleModal) { closeModal(visibleModal.id); e.preventDefault(); return; }
        const dayJump = document.querySelector('.day-jump-modal.visible');
        if (dayJump) { closeDayJump(); e.preventDefault(); return; }
        const standup = document.querySelector('.standup-modal.open');
        if (standup) { closeStandupModal(); e.preventDefault(); return; }
        const onboarding = document.getElementById('onboarding');
        if (onboarding && !onboarding.classList.contains('hidden') && state.role) { onboarding.classList.add('hidden'); e.preventDefault(); return; }
    }
    if (document.getElementById('app').style.display === 'none') return;
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
    if (document.querySelector('.modal.visible, .day-jump-modal.visible, .standup-modal.open')) return;
    if (e.key === 'ArrowLeft') { changeDay(-1); e.preventDefault(); }
    else if (e.key === 'ArrowRight') { changeDay(1); e.preventDefault(); }
});

// ===== BOOTCAMP LESSONS =====
let currentLesson = 0;
const lessons = ['nodes', 'transitivity', 'inconsistency', 'rankings', 'cinema'];

function openBootcampLesson(module) {
    const idx = lessons.indexOf(module);
    if (idx >= 0) currentLesson = idx;
    showLesson();
    openModal('bootcampModal');
}

function showLesson() {
    lessons.forEach((l, i) => {
        document.getElementById('lesson-' + l).style.display = i === currentLesson ? 'block' : 'none';
    });
    document.getElementById('lessonCounter').textContent = (currentLesson + 1) + ' / ' + lessons.length;
    document.getElementById('prevLessonBtn').disabled = currentLesson === 0;
    document.getElementById('nextLessonBtn').textContent = currentLesson === lessons.length - 1 ? 'Finish ✓' : 'Next →';
}

function nextLesson() {
    if (currentLesson < lessons.length - 1) {
        currentLesson++;
        showLesson();
    } else {
        closeModal('bootcampModal');
        showToast('Bootcamp complete!');
    }
}

function prevLesson() {
    if (currentLesson > 0) {
        currentLesson--;
        showLesson();
    }
}

// ===== DEADLINE ALERTS =====
function renderDeadlineAlerts() {
    const d = state.day;
    let alerts = [];

    // DoD-A alert (due Day 4)
    if (d <= 4 && !state.dodGates.A) {
        const daysLeft = 4 - d;
        if (daysLeft <= 2) {
            alerts.push({ type: daysLeft === 0 ? 'danger' : 'warning', icon: '⚠️', title: `DoD-A-NMA due ${daysLeft === 0 ? 'TODAY' : 'in ' + daysLeft + ' day(s)'}`, text: 'Protocol + Model Contract + Node Dictionary must be locked' });
        }
    }

    // DoD-B alert (due Day 12)
    if (d > 4 && d <= 12 && !state.dodGates.B) {
        const daysLeft = 12 - d;
        if (daysLeft <= 3) {
            alerts.push({ type: daysLeft === 0 ? 'danger' : 'warning', icon: '🔍', title: `DoD-B-NMA due ${daysLeft === 0 ? 'TODAY' : 'in ' + daysLeft + ' day(s)'}`, text: 'Search complete + Network viability confirmed' });
        }
    }

    // Audit 1 alert (Days 18-20)
    if (d >= 16 && d <= 20) {
        if (d < 18) alerts.push({ type: 'info', icon: '📋', title: `Audit 1 starts in ${18 - d} day(s)`, text: '10% trace audit + node mapping check' });
        else if (d <= 20) alerts.push({ type: 'warning', icon: '📋', title: 'Audit 1 in progress', text: 'Complete by Day 20' });
    }

    // DoD-C alert (due Day 28)
    if (d > 12 && d <= 28 && !state.dodGates.C) {
        const daysLeft = 28 - d;
        if (daysLeft <= 3) {
            alerts.push({ type: daysLeft === 0 ? 'danger' : 'warning', icon: '📊', title: `DoD-C-NMA due ${daysLeft === 0 ? 'TODAY' : 'in ' + daysLeft + ' day(s)'}`, text: 'Extraction + Arm→Node mapping complete' });
        }
    }

    // Audit 2 alert (Days 30-32)
    if (d >= 28 && d <= 32) {
        if (d < 30) alerts.push({ type: 'info', icon: '🔬', title: `Audit 2 starts in ${30 - d} day(s)`, text: 'Rerun verification + influential study check' });
        else if (d <= 32) alerts.push({ type: 'warning', icon: '🔬', title: 'Audit 2 in progress', text: 'Complete by Day 32' });
    }

    // DoD-D + Freeze alert (Day 34)
    if (d > 28 && d <= 34 && !state.dodGates.D) {
        const daysLeft = 34 - d;
        if (daysLeft <= 3) {
            alerts.push({ type: daysLeft === 0 ? 'danger' : 'warning', icon: '🔒', title: `FREEZE ${daysLeft === 0 ? 'TODAY' : 'in ' + daysLeft + ' day(s)'}`, text: 'DoD-D-NMA + No new studies/nodes/models after Day 34' });
        }
    }

    // Submission alert (Day 40)
    if (d > 34 && d <= 40) {
        const daysLeft = 40 - d;
        alerts.push({ type: daysLeft <= 2 ? 'danger' : 'info', icon: '🚀', title: `Submission ${daysLeft === 0 ? 'TODAY' : 'in ' + daysLeft + ' day(s)'}`, text: 'Complete PRISMA-NMA + Final manuscript' });
    }

    // On track message
    if (alerts.length === 0 && d <= 40) {
        const nextGate = !state.dodGates.A ? 'A' : !state.dodGates.B ? 'B' : !state.dodGates.C ? 'C' : !state.dodGates.D ? 'D' : 'E';
        alerts.push({ type: 'success', icon: '✅', title: 'On track', text: `Next milestone: DoD-${nextGate}-NMA` });
    }

    let html = '';
    alerts.forEach(a => {
        html += `<div class="alert alert-${a.type}" style="margin-bottom:8px">
            <div class="alert-icon">${a.icon}</div>
            <div class="alert-content">
                <div class="alert-title">${a.title}</div>
                <div class="alert-text">${a.text}</div>
            </div>
        </div>`;
    });
    document.getElementById('deadlineAlerts').innerHTML = html;
}

// ===== STUDY COUNT =====
function promptStudyCount() {
    const current = state.studyCount ?? 0;
    const input = prompt('Enter number of included studies:', current);
    if (input !== null && !isNaN(parseInt(input))) {
        state.studyCount = parseInt(input);
        save();
        render();
        // Warn if outside range
        if (state.studyCount > 60) {
            showToast('⚠️ Warning: >60 studies may exceed capacity');
        } else if (state.studyCount < 10 && state.studyCount > 0) {
            showToast('⚠️ Warning: <10 studies may limit network');
        } else {
            showToast('Study count updated');
        }
    }
}

// ===== EFFECT MODIFIERS =====
function saveEffectModifiers() {
    state.effectModifiers = document.getElementById('effectModifiers').value;
    save();
    showToast('Effect modifiers saved');
}

// ===== TRANSITIVITY ASSESSMENT =====
function toggleTransitivity(el, item) {
    el.classList.toggle('checked');
    if (!state.transitivityChecks) state.transitivityChecks = {};
    state.transitivityChecks[item] = el.classList.contains('checked');
    save();
    updateTransitivityResult();
}

function updateTransitivityResult() {
    const checks = state.transitivityChecks || {};
    const total = Object.keys(checks).filter(k => checks[k]).length;
    const result = document.getElementById('transitivityResult');
    if (!result) return;
    result.style.display = 'block';
    if (total >= 4) {
        result.className = 'alert alert-success';
        result.innerHTML = '<div class="alert-icon">✅</div><div class="alert-content"><div class="alert-title">Transitivity: Low concern</div><div class="alert-text">Effect modifiers appear balanced across comparisons.</div></div>';
    } else if (total >= 2) {
        result.className = 'alert alert-warning';
        result.innerHTML = '<div class="alert-icon">⚠️</div><div class="alert-content"><div class="alert-title">Transitivity: Some concerns</div><div class="alert-text">Some imbalance in effect modifiers. Document in limitations.</div></div>';
    } else {
        result.className = 'alert alert-danger';
        result.innerHTML = '<div class="alert-icon">🚫</div><div class="alert-content"><div class="alert-title">Transitivity: Major concerns</div><div class="alert-text">Significant imbalance. Consider suppressing rankings.</div></div>';
    }
}

// Render extensions are consolidated at end of file

// ===== PRISMA-NMA =====
function togglePrisma(el, item) {
    el.classList.toggle('checked');
    if (!state.prismaChecks) state.prismaChecks = {};
    state.prismaChecks[item] = el.classList.contains('checked');
    save();
}

// ===== AUDIT GENERATORS =====
function generateAudit1() {
    const checks = [];
    if (document.getElementById('a1-c1').checked) checks.push('Sample matches source');
    if (document.getElementById('a1-c2').checked) checks.push('Effect size correct');
    if (document.getElementById('a1-c3').checked) checks.push('Node mapping consistent');
    if (document.getElementById('a1-c4').checked) checks.push('Multi-arm correct');
    if (document.getElementById('a1-c5').checked) checks.push('RoB supported');
    const nodeChecks = [];
    if (document.getElementById('a1-n1').checked) nodeChecks.push('All mapped');
    if (document.getElementById('a1-n2').checked) nodeChecks.push('Rules consistent');
    if (document.getElementById('a1-n3').checked) nodeChecks.push('No orphans');

    const text = `AUDIT 1 REPORT (Days 18-20)
=====================================
Auditor: ${document.getElementById('a1-auditor').value}
Dates: ${document.getElementById('a1-dates').value}

10% TRACE CHECKS:
${checks.map(c => '✓ ' + c).join('\n')}

NODE MAPPING VERIFICATION:
${nodeChecks.map(c => '✓ ' + c).join('\n')}

Discrepancies: ${document.getElementById('a1-discrepancies').value || 'None'}

RESULT: ${document.getElementById('a1-result').value?.toUpperCase() || 'PENDING'}`;
    showOutput('a1-output', text);
}

function generateAudit2() {
    const rerunChecks = [];
    if (document.getElementById('a2-c1').checked) rerunChecks.push('Rerun matches');
    if (document.getElementById('a2-c2').checked) rerunChecks.push('Within equivalence');
    if (document.getElementById('a2-c3').checked) rerunChecks.push('Rankings identical');
    if (document.getElementById('a2-c4').checked) rerunChecks.push('CINeMA consistent');
    const influentialChecks = [];
    if (document.getElementById('a2-i1').checked) influentialChecks.push('Influential listed');
    if (document.getElementById('a2-i2').checked) influentialChecks.push('Leave-one-out done');
    if (document.getElementById('a2-i3').checked) influentialChecks.push('No single study changes');
    if (document.getElementById('a2-i4').checked) influentialChecks.push('Data double-checked');

    const text = `AUDIT 2 REPORT (Days 30-32)
=====================================
Auditor: ${document.getElementById('a2-auditor').value}
Dates: ${document.getElementById('a2-dates').value}

RERUN VERIFICATION:
${rerunChecks.map(c => '✓ ' + c).join('\n')}

INFLUENTIAL STUDY CHECK:
${influentialChecks.map(c => '✓ ' + c).join('\n')}

Equivalence Summary:
${document.getElementById('a2-equivalence').value || 'Not documented'}

Issues: ${document.getElementById('a2-issues').value || 'None'}

RESULT: ${document.getElementById('a2-result').value?.toUpperCase() || 'PENDING'}`;
    showOutput('a2-output', text);
}

// ===== BOOTCAMP MODULE CLICK =====
function toggleBootcamp(el, module) {
    el.classList.toggle('completed');
    state.bootcamp[module] = el.classList.contains('completed');
    save();
    // Also open the lesson content
    openBootcampLesson(module);
}

// ===== TAB PROGRESS INDICATORS =====
function updateTabBadges() {
    const d = state.day;
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        // Remove existing badges
        const existing = tab.querySelector('.tab-badge');
        if (existing) existing.remove();
    });

    // Network tab - needs attention if no nodes defined
    if (!state.nodeDictionary && d >= 1) {
        addTabBadge('network', 'needs-attention');
    } else if (state.nodeCount > 0) {
        addTabBadge('network', 'complete');
    }

    // DoD tab - needs attention if gates due
    const nextGate = !state.dodGates.A ? 'A' : !state.dodGates.B ? 'B' : !state.dodGates.C ? 'C' : !state.dodGates.D ? 'D' : 'E';
    const gateDays = { A: 4, B: 12, C: 28, D: 34, E: 40 };
    if (d >= gateDays[nextGate] - 2 && !state.dodGates[nextGate]) {
        addTabBadge('dod', 'needs-attention');
    }

    // CINeMA tab - needs attention after Day 28
    if (d >= 28 && !state.cinema.overall) {
        addTabBadge('cinema', 'needs-attention');
    } else if (state.cinema.overall) {
        addTabBadge('cinema', 'complete');
    }

    // Timeline tab - complete indicator for PRISMA
    const prismaComplete = state.prismaChecks && Object.keys(state.prismaChecks).filter(k => state.prismaChecks[k]).length >= 8;
    if (prismaComplete) {
        addTabBadge('timeline', 'complete');
    }
}

function addTabBadge(tabName, type) {
    const tabMap = {
        'network': 2,
        'dod': 3,
        'cinema': 4,
        'timeline': 1
    };
    const tabs = document.querySelectorAll('.tab');
    const tabIndex = tabMap[tabName];
    if (tabs[tabIndex]) {
        const badge = document.createElement('span');
        badge.className = 'tab-badge ' + type;
        tabs[tabIndex].appendChild(badge);
    }
}

// ===== NETWORK GRAPH VISUALIZATION =====
function renderNetworkGraph() {
    const nodeCount = state.nodeCount ?? 0;
    if (nodeCount < 2) {
        document.getElementById('networkSvg').innerHTML = `
            <text x="200" y="90" text-anchor="middle" fill="var(--text-muted)" font-size="13">
                Add nodes to Node Dictionary to see network preview
            </text>`;
        return;
    }

    const svg = document.getElementById('networkSvg');
    const cx = 200, cy = 90, radius = 70;
    const nodes = [];
    const labels = state.nodeDictionary.split('\n').filter(l => l.trim()).slice(0, 12);

    // Calculate node positions in a circle
    for (let i = 0; i < Math.min(nodeCount, 12); i++) {
        const angle = (i / nodeCount) * 2 * Math.PI - Math.PI/2;
        nodes.push({
            x: cx + radius * Math.cos(angle),
            y: cy + radius * Math.sin(angle),
            label: labels[i] ? labels[i].replace(/^Node \d+:\s*/i, '').substring(0, 8) : `N${i+1}`
        });
    }

    // Create edges (connect adjacent + some cross edges for connected network)
    let edgesHtml = '';
    for (let i = 0; i < nodes.length; i++) {
        // Connect to next node
        const j = (i + 1) % nodes.length;
        edgesHtml += `<line class="network-edge" x1="${nodes[i].x}" y1="${nodes[i].y}" x2="${nodes[j].x}" y2="${nodes[j].y}"/>`;

        // Add a cross-edge for larger networks
        if (nodes.length > 4 && i < nodes.length / 2) {
            const k = (i + Math.floor(nodes.length / 2)) % nodes.length;
            edgesHtml += `<line class="network-edge" x1="${nodes[i].x}" y1="${nodes[i].y}" x2="${nodes[k].x}" y2="${nodes[k].y}" stroke-dasharray="4,2" opacity="0.5"/>`;
        }
    }

    // Create nodes
    let nodesHtml = '';
    const colors = ['#0891B2', '#059669', '#D97706', '#DC2626', '#7C3AED', '#0D9488', '#4F46E5', '#DB2777'];
    nodes.forEach((node, i) => {
        const color = colors[i % colors.length];
        nodesHtml += `
            <g class="network-node" transform="translate(${node.x}, ${node.y})">
                <circle r="18" fill="${color}" stroke="white" stroke-width="2"/>
                <text class="network-label" y="4" fill="white" font-size="9">${escapeHtml(node.label.substring(0, 3))}</text>
            </g>`;
    });

    svg.innerHTML = `<g id="networkEdges">${edgesHtml}</g><g id="networkNodes">${nodesHtml}</g>`;

    // Update edge count estimate
    document.getElementById('netEdges').textContent = Math.min(nodeCount + Math.floor(nodeCount/2), nodeCount * (nodeCount-1) / 2);
}

// Override saveNodeDictionary to also render graph
saveNodeDictionary = function() {
    state.nodeDictionary = document.getElementById('nodeDictionary').value;
    const lines = state.nodeDictionary.split('\n').filter(l => l.trim());
    state.nodeCount = lines.length;
    save();
    render();
    renderNetworkGraph();
    updateTabBadges();
    showToast('Node dictionary saved');
};

// Render extensions are consolidated at end of file

// ===== EVIDENCE REVERSAL STORIES =====
function toggleStory(header) {
    const body = header.nextElementSibling;
    body.classList.toggle('open');
    header.setAttribute('aria-expanded', body.classList.contains('open') ? 'true' : 'false');
    // Track which stories have been read
    const storyNum = header.querySelector('.story-number').textContent;
    if (!state.storiesRead) state.storiesRead = {};
    state.storiesRead[storyNum] = true;
    save();
    updateAchievements();
}

// ===== ACHIEVEMENTS SYSTEM =====
function updateAchievements() {
    const dodChecked = state.dodChecked || {};
    const dodItems = DOD_CHECKLISTS;
    const dodCheckedCount = (gateId) => (dodItems[gateId] || []).filter(item => dodChecked[item.id]).length;
    const achievements = {
        bootcamp: checkBootcampComplete(),
        dodA: state.dodGates?.A || dodCheckedCount('A') >= (dodItems.A || []).length,
        nodes: (state.nodeCount ?? 0) >= 4,
        dodB: state.dodGates?.B || dodCheckedCount('B') >= (dodItems.B || []).length,
        prisma: checkPrismaComplete(),
        dodC: state.dodGates?.C || dodCheckedCount('C') >= (dodItems.C || []).length,
        cinema: checkCinemaComplete(),
        dodD: state.dodGates?.D || dodCheckedCount('D') >= (dodItems.D || []).length,
        stories: state.storiesRead && Object.keys(state.storiesRead).length >= 4,
        dodE: state.dodGates?.E || dodCheckedCount('E') >= (dodItems.E || []).length
    };

    if (!state.achievementsEarned) state.achievementsEarned = {};
    let earned = 0;
    Object.entries(achievements).forEach(([key, unlocked]) => {
        const el = document.querySelector(`[data-check="${key}"]`);
        if (el) {
            if (unlocked) {
                el.classList.add('earned');
                // Show celebration toast only for genuinely new unlocks
                if (!state.achievementsEarned[key]) {
                    state.achievementsEarned[key] = true;
                    save();
                    const name = el.querySelector('.achievement-name').textContent;
                    showToast(`🏆 Achievement Unlocked: ${name}!`);
                }
                earned++;
            } else {
                el.classList.remove('earned');
            }
        }
    });

    const countEl = document.getElementById('achieveCount');
    if (countEl) countEl.textContent = `${earned}/10`;
}

function checkBootcampComplete() {
    const modules = ['nodes', 'transitivity', 'inconsistency', 'rankings', 'cinema'];
    return state.bootcamp && modules.every(m => state.bootcamp[m]);
}

function checkPrismaComplete() {
    // Check if PRISMA-NMA checklist is mostly complete
    return state.prismaChecks && Object.values(state.prismaChecks).filter(v => v).length >= 6;
}

function checkCinemaComplete() {
    // Check if all 6 CINeMA domains are rated
    return state.cinema && Object.values(state.cinema).filter(v => v !== '').length >= 6;
}

// ===== DAILY STANDUP GENERATOR =====
function openStandupModal() {
    generateStandup();
    document.getElementById('standupModal').classList.add('open');
}

function closeStandupModal(e) {
    if (!e || e.target === e.currentTarget) {
        document.getElementById('standupModal').classList.remove('open');
    }
}

function generateStandup() {
    const day = state.day ?? 1;
    const yesterday = [];
    const today = [];
    const blockers = [];

    // Yesterday's completed tasks (from previous day)
    if (day > 1) {
        const prevTasks = getPhaseTasks(day - 1);
        const completed = prevTasks.filter(t => state.tasks && state.tasks[t.id]);
        yesterday.push(...completed.slice(0, 3).map(t => t.text));
        if (completed.length === 0) yesterday.push('(No tasks logged)');
    } else {
        yesterday.push('Day 1 - Project kickoff');
    }

    // Today's planned tasks
    const todayTasks = getPhaseTasks(day);
    const incomplete = todayTasks.filter(t => !state.tasks || !state.tasks[t.id]);
    today.push(...incomplete.slice(0, 4).map(t => t.text));
    if (today.length === 0) today.push('All tasks complete!');

    // Blockers (incomplete DoD items for current gate)
    const gate = getActiveGate(day);
    if (gate) {
        const gateItems = DOD_CHECKLISTS[gate] || [];
        const unchecked = gateItems.filter(item => !state.dodChecked[item.id]);
        if (unchecked.length > 0) {
            blockers.push(`${unchecked.length} DoD items remaining for DoD-${gate}-NMA`);
        }
    }
    if (blockers.length === 0) blockers.push('No blockers');

    // Render
    document.getElementById('standupYesterday').innerHTML = yesterday.map(t => `<div class="standup-item">• ${escapeHtml(t)}</div>`).join('');
    document.getElementById('standupToday').innerHTML = today.map(t => `<div class="standup-item">• ${escapeHtml(t)}</div>`).join('');
    document.getElementById('standupBlockers').innerHTML = blockers.map(t => `<div class="standup-item">⚠️ ${escapeHtml(t)}</div>`).join('');

    // Status
    const gatesPassed = ['A', 'B', 'C', 'D', 'E'].filter(g => state.dodGates[g]).length;
    const daysLeft = 40 - day;
    const studies = state.studyCount ?? 0;
    document.getElementById('standupStatus').innerHTML = `
        <div class="standup-item">📅 Day ${day}/40 (${daysLeft} days remaining)</div>
        <div class="standup-item">🔗 ${state.nodeCount ?? 0} nodes | ${studies} studies</div>
        <div class="standup-item">🚪 ${gatesPassed}/5 gates passed</div>
    `;
}

function getPhaseTasks(day) {
    // Return sample tasks based on day/phase
    if (day <= 3) return [
        { id: 'task1', text: 'Finalize Node Dictionary' },
        { id: 'task2', text: 'Lock protocol assumptions' },
        { id: 'task3', text: 'Complete DoD-A checklist' }
    ];
    if (day <= 10) return [
        { id: 'task4', text: 'Run database searches' },
        { id: 'task5', text: 'De-duplicate records' },
        { id: 'task6', text: 'Complete title/abstract screening' }
    ];
    if (day <= 28) return [
        { id: 'task7', text: 'Full-text screening' },
        { id: 'task8', text: 'Data extraction' },
        { id: 'task9', text: 'RoB assessment' }
    ];
    if (day <= 33) return [
        { id: 'task10', text: 'Run NMA models' },
        { id: 'task11', text: 'Check inconsistency' },
        { id: 'task12', text: 'Generate rankings' }
    ];
    return [
        { id: 'task13', text: 'Complete CINeMA' },
        { id: 'task14', text: 'Write manuscript' },
        { id: 'task15', text: 'Final submission' }
    ];
}

function getActiveGate(day) {
    if (day <= 3) return 'A';
    if (day <= 10) return 'B';
    if (day <= 28) return 'C';
    if (day <= 33) return 'D';
    return 'E';
}

function copyStandup() {
    const day = state.day ?? 1;
    const yesterdayEl = document.getElementById('standupYesterday');
    const todayEl = document.getElementById('standupToday');
    const blockersEl = document.getElementById('standupBlockers');
    const statusEl = document.getElementById('standupStatus');

    const text = `📋 META-SPRINT NMA Standup - Day ${day}

✅ YESTERDAY:
${yesterdayEl.innerText}

📌 TODAY:
${todayEl.innerText}

🚧 BLOCKERS:
${blockersEl.innerText}

📊 STATUS:
${statusEl.innerText}
`;

    navigator.clipboard.writeText(text).then(() => {
        showToast('Standup copied to clipboard!');
        closeStandupModal();
    }).catch(() => {
        showToast('Standup generated (clipboard unavailable)');
        closeStandupModal();
    });
}

// ===== PRISMA FLOW TRACKER =====
function savePrismaFlow() {
    state.prismaFlow = {
        identified: parseInt(document.getElementById('prismaIdentified')?.value, 10) ?? 0,
        duplicates: parseInt(document.getElementById('prismaDuplicates')?.value, 10) ?? 0,
        screened: parseInt(document.getElementById('prismaScreened')?.value, 10) ?? 0,
        excluded: parseInt(document.getElementById('prismaExcluded')?.value, 10) ?? 0,
        fullText: parseInt(document.getElementById('prismaFullText')?.value, 10) ?? 0,
        included: parseInt(document.getElementById('prismaIncluded')?.value, 10) ?? 0
    };
    state.studyCount = state.prismaFlow.included ?? 0;
    var studyEl = document.getElementById('studyCount');
    if (studyEl) studyEl.textContent = state.studyCount;
    save();

    // Update target display
    const targetEl = document.getElementById('prismaTarget');
    if (targetEl) {
        const included = state.prismaFlow.included;
        targetEl.textContent = included;
        targetEl.style.color = (included >= 40 && included <= 60) ? 'var(--success)' :
                               (included > 0) ? 'var(--warning)' : 'var(--text)';
    }

    // Show calculated suggestions
    const p = state.prismaFlow;
    const calcScreened = document.getElementById('calcScreened');
    const calcFullText = document.getElementById('calcFullText');
    if (calcScreened && p.identified > 0) {
        calcScreened.textContent = `Expected: ≤${p.identified - p.duplicates}`;
    }
    if (calcFullText && p.screened > 0) {
        calcFullText.textContent = `Expected: ≤${p.screened - p.excluded}`;
    }

    updateAchievements();
}

function loadPrismaFlow() {
    if (state.prismaFlow) {
        const fields = ['identified', 'duplicates', 'screened', 'excluded', 'fullText', 'included'];
        fields.forEach(f => {
            const el = document.getElementById('prisma' + f.charAt(0).toUpperCase() + f.slice(1));
            if (el) el.value = state.prismaFlow[f] || '';
        });
        validatePrisma();
        savePrismaFlow(); // Update displays
    }
}

function updateStudyCount() {
    const included = parseInt(document.getElementById('prismaIncluded')?.value, 10) ?? 0;
    if (included > 0) {
        state.studyCount = included;
        save();
        const el = document.getElementById('studyCount');
        if (el) el.textContent = included;
    }
}

// ===== PRISMA VALIDATION =====
function validatePrisma() {
    // Called when PRISMA numbers change
    const identified = parseInt(document.getElementById('prismaIdentified')?.value, 10) ?? 0;
    const duplicates = parseInt(document.getElementById('prismaDuplicates')?.value, 10) ?? 0;
    const screened = parseInt(document.getElementById('prismaScreened')?.value, 10) ?? 0;
    const excluded = parseInt(document.getElementById('prismaExcluded')?.value, 10) ?? 0;
    const fullText = parseInt(document.getElementById('prismaFullText')?.value, 10) ?? 0;
    const included = parseInt(document.getElementById('prismaIncluded')?.value, 10) ?? 0;

    const warningEl = document.getElementById('prismaWarning');
    if (!warningEl) return;

    const warnings = [];

    // Validation rules
    if (identified > 0 && screened > identified - duplicates) {
        warnings.push(`Screened (${screened}) should be ≤ Identified - Duplicates (${identified - duplicates})`);
    }
    if (screened > 0 && fullText > screened - excluded) {
        warnings.push(`Full-text (${fullText}) should be ≤ Screened - Excluded (${screened - excluded})`);
    }
    if (included > fullText) {
        warnings.push(`Included (${included}) cannot exceed Full-text (${fullText})`);
    }
    if (included > 0 && (included < 40 || included > 60)) {
        warnings.push(`Studies included (${included}) outside META-SPRINT range (40-60)`);
    }

    if (warnings.length > 0) {
        warningEl.innerHTML = '&#9888; ' + warnings.map(w => escapeHtml(w)).join('<br>&#9888; ');
        warningEl.classList.add('visible');
        warningEl.classList.remove('prisma-valid');
    } else if (included > 0) {
        warningEl.innerHTML = '✓ PRISMA numbers validated successfully';
        warningEl.classList.add('visible', 'prisma-valid');
    } else {
        warningEl.classList.remove('visible');
    }
}

// Consolidated render extension — replaces 3 separate monkey-patches
const _baseRender = render;
render = function() {
    _baseRender();
    try { renderDeadlineAlerts(); } catch(e) { console.warn('renderDeadlineAlerts:', e); }
    try { updateTabBadges(); } catch(e) { console.warn('updateTabBadges:', e); }
    try { renderNetworkGraph(); } catch(e) { console.warn('renderNetworkGraph:', e); }
    setTimeout(() => {
        try { updateAchievements(); } catch(e) { console.warn('updateAchievements:', e); }
        try { loadPrismaFlow(); } catch(e) { console.warn('loadPrismaFlow:', e); }
    }, 100);
};

// Restore bootcamp state after first DOMContentLoaded (runs after the init listener above)
document.addEventListener('DOMContentLoaded', () => {
    if (state.role && state.bootcamp) {
        Object.entries(state.bootcamp).forEach(([module, completed]) => {
            if (completed && /^[a-zA-Z0-9_-]+$/.test(module)) {
                try {
                    const el = document.querySelector(`.bootcamp-module[onclick*="'${module}'"]`);
                    if (el) el.classList.add('completed');
                } catch(e) { /* invalid selector */ }
            }
        });
    }
});
</script>

</body>
</html>
