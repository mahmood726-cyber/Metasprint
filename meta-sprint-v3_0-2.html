<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>META-SPRINT V3.2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #F8FAFC;
            --surface: #FFFFFF;
            --border: #E2E8F0;
            --border-strong: #CBD5E1;
            --text: #0F172A;
            --text-secondary: #475569;
            --text-muted: #64748B;
            --accent: #2563EB;
            --accent-light: #DBEAFE;
            --success: #059669;
            --success-light: #D1FAE5;
            --warning: #D97706;
            --warning-light: #FEF3C7;
            --danger: #DC2626;
            --danger-light: #FEE2E2;
            --purple: #7C3AED;
            --purple-light: #EDE9FE;
            --warning-bg: #FFFBEB;
            --warning-border: #F59E0B;
            --warning-title: #B45309;
            --warning-text: #92400E;
        }

        /* Dark Mode */
        .dark-mode {
            --bg: #0F172A;
            --surface: #1E293B;
            --border: #334155;
            --border-strong: #475569;
            --text: #F1F5F9;
            --text-secondary: #CBD5E1;
            --text-muted: #94A3B8;
            --accent: #3B82F6;
            --accent-light: #1E3A5F;
            --success: #10B981;
            --success-light: #032E23;
            --warning: #F59E0B;
            --warning-light: #4A2008;
            --danger: #EF4444;
            --danger-light: #451A1A;
            --purple: #A78BFA;
            --purple-light: #2E1065;
            --warning-bg: #422006;
            --warning-border: #92400E;
            --warning-title: #FBBF24;
            --warning-text: #FDE68A;
        }
        .dark-mode .form-input, .dark-mode .form-textarea, .dark-mode select { background: var(--surface); color: var(--text); }
        .dark-mode .protocol-input { background: var(--surface); }
        .dark-mode .template-form { background: var(--surface); }
        .dark-mode .ref-table tr:hover td { background: var(--border); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; font-size: 14px; }
        .container { max-width: 900px; margin: 0 auto; padding: 16px; }
        
        /* Header */
        .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 16px; position: sticky; top: 0; z-index: 100; }
        .header-inner { max-width: 900px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
        .logo { font-weight: 700; font-size: 18px; color: var(--accent); }
        .logo span { color: var(--text-muted); font-weight: 400; font-size: 12px; }
        .header-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .role-badge { background: var(--accent-light); color: var(--accent); padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .day-control { display: flex; align-items: center; gap: 8px; }
        .day-btn { width: 44px; height: 44px; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .day-btn:hover:not(:disabled) { background: var(--bg); }
        .day-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .day-btn:hover:not(:disabled) { border-color: var(--accent); }
        .day-display { font-weight: 700; font-size: 16px; min-width: 70px; text-align: center; }
        .day-hint { font-size: 12px; color: var(--text-muted); text-align: center; margin-top: 2px; }
        .day-hint.pulse { animation: hintPulse 2s ease-in-out 3; }
        @keyframes hintPulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; color: var(--accent); } }
        
        /* Toast notification */
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--success); color: white; padding: 12px 20px; border-radius: 8px; font-weight: 500; font-size: 13px; z-index: 1000; opacity: 0; transform: translateY(20px); transition: all 0.3s ease; pointer-events: none; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast.error { background: var(--danger); }
        
        /* Workload indicator */
        .workload-badge { display: inline-flex; align-items: center; gap: 6px; background: var(--bg); border: 1px solid var(--border); padding: 4px 10px; border-radius: 6px; font-size: 12px; color: var(--text-secondary); }
        .workload-badge.peak { background: var(--warning-light); border-color: var(--warning); color: var(--warning); }
        
        /* Tabs */
        .tabs { display: flex; gap: 4px; background: var(--surface); padding: 8px 16px; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .tab { padding: 12px 16px; border: none; background: none; font-family: inherit; font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-radius: 6px; white-space: nowrap; }
        .tab:hover { background: var(--bg); }
        .tab.active { background: var(--accent-light); color: var(--accent); }
        
        /* Cards */
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
        .card-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .card-title { font-weight: 600; font-size: 15px; }
        .card-body { padding: 16px; }
        
        /* Phase badges */
        .phase-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .phase-a { background: var(--purple-light); color: var(--purple); }
        .phase-b { background: var(--accent-light); color: var(--accent); }
        .phase-c { background: var(--warning-light); color: var(--warning); }
        .phase-d { background: var(--success-light); color: var(--success); }
        .phase-e { background: var(--danger-light); color: var(--danger); }
        
        /* Timeline */
        .timeline-bar { height: 8px; background: var(--border); border-radius: 4px; position: relative; margin: 16px 0; }
        .timeline-fill { height: 100%; background: var(--accent); border-radius: 4px; transition: width 0.3s; }
        .timeline-markers { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .timeline-marker { text-align: center; }
        .timeline-marker.active { color: var(--accent); font-weight: 600; }
        .timeline-marker.passed { color: var(--success); }
        
        /* Alerts */
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: flex-start; gap: 12px; }
        .alert-icon { font-size: 18px; flex-shrink: 0; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; margin-bottom: 2px; }
        .alert-text { font-size: 13px; }
        .alert-story { font-size: 11px; color: inherit; opacity: 0.85; margin-top: 8px; padding-top: 8px; border-top: 1px dashed currentColor; line-height: 1.5; font-style: italic; }
        .alert-info { background: var(--accent-light); border: 1px solid var(--accent); }
        .alert-warning { background: var(--warning-light); border: 1px solid var(--warning); }
        .alert-danger { background: var(--danger-light); border: 1px solid var(--danger); }
        .alert-success { background: var(--success-light); border: 1px solid var(--success); }
        
        /* Checklist */
        .checklist-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s; }
        .checklist-item:hover { background: var(--bg); }
        .checklist-item.checked { background: var(--success-light); border-color: var(--success); }
        .checklist-item.just-checked { animation: checkPulse 0.3s ease-out; }
        @keyframes checkPulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); box-shadow: 0 0 0 4px var(--success-light); } 100% { transform: scale(1); } }
        .check-box { width: 20px; height: 20px; border: 2px solid var(--border-strong); border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
        .checklist-item.checked .check-box { background: var(--success); border-color: var(--success); }
        .check-box svg { color: white; display: none; }
        .checklist-item.checked .check-box svg { display: block; }
        .checklist-content { flex: 1; }
        .checklist-title { font-weight: 500; }
        .checklist-hint { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        .story-hint { font-size: 11px; color: var(--text-muted); font-style: italic; margin-top: 6px; padding-top: 6px; border-top: 1px dashed var(--border); line-height: 1.5; cursor: default; }
        .checklist-item.checked .story-hint { color: var(--success); border-color: var(--success); opacity: 0.8; }

        /* No tasks message */
        .no-tasks { padding: 24px; text-align: center; color: var(--text-secondary); background: var(--bg); border-radius: 8px; }
        .no-tasks-icon { font-size: 32px; margin-bottom: 8px; }
        .no-tasks-title { font-weight: 600; margin-bottom: 4px; color: var(--text); }
        .no-tasks-text { font-size: 13px; }
        
        /* Help box */
        .help-box { background: var(--accent-light); border: 1px solid var(--accent); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; }
        .help-box-title { font-weight: 600; color: var(--accent); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .help-box-text { font-size: 13px; color: var(--text-secondary); }
        
        /* Templates */
        .template-card { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; overflow: hidden; }
        .template-header { padding: 12px 16px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .template-header:hover { background: var(--border); }
        .template-name { font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .template-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .badge-essential { background: var(--danger-light); color: var(--danger); }
        .badge-reference { background: var(--accent-light); color: var(--accent); }
        .badge-emergency { background: var(--warning-light); color: var(--warning); }
        .template-body { padding: 16px; display: none; }
        .template-body.open { display: block; }
        .template-explain { background: var(--warning-bg); border: 1px solid var(--warning-border); border-radius: 8px; padding: 12px; margin-bottom: 16px; }
        .template-explain-title { font-weight: 600; color: var(--warning-title); margin-bottom: 4px; }
        .template-explain-text { font-size: 13px; color: var(--warning-text); }
        .template-story { font-size: 12px; color: var(--warning-text); margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--warning-border); line-height: 1.6; }
        .template-when { background: var(--success-light); border-radius: 6px; padding: 8px 12px; font-size: 12px; color: var(--success); margin-bottom: 16px; }
        .template-form { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
        .form-row { margin-bottom: 12px; }
        .form-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; display: block; }
        .form-input, .form-textarea { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; }
        .form-textarea { resize: vertical; min-height: 60px; }
        .form-hint { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        .copy-btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-family: inherit; font-weight: 600; cursor: pointer; margin-top: 12px; }
        .copy-btn:hover { background: #1D4ED8; }
        .btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
        .download-btn { background: var(--surface); color: var(--text); border: 1px solid var(--border); padding: 10px 20px; border-radius: 6px; font-family: inherit; font-weight: 600; cursor: pointer; }
        .download-btn:hover { background: var(--bg); border-color: var(--border-strong); }
        .template-output { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-top: 12px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; white-space: pre-wrap; display: none; }
        .template-output.visible { display: block; }
        
        /* Reference tables */
        .ref-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .ref-table th, .ref-table td { padding: 10px 12px; border: 1px solid var(--border); text-align: left; }
        .ref-table th { background: var(--bg); font-weight: 600; }
        .ref-table tr:hover td { background: var(--bg); }
        
        /* Protocol registration */
        .protocol-reg { background: var(--purple-light); border: 2px solid var(--purple); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .protocol-reg-title { font-weight: 700; color: var(--purple); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .protocol-reg-text { font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; }
        .protocol-input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .protocol-input { flex: 1; padding: 10px 12px; border: 1px solid var(--purple); border-radius: 6px; font-family: inherit; font-size: 13px; transition: border-color 0.2s, background-color 0.2s; }
        .protocol-input.valid { border-color: var(--success); background-color: rgba(5, 150, 105, 0.05); }
        .protocol-input.invalid { border-color: var(--danger); background-color: rgba(220, 38, 38, 0.05); }
        .protocol-validation { font-size: 12px; min-height: 18px; margin-bottom: 8px; }
        .protocol-validation.valid { color: var(--success); }
        .protocol-validation.invalid { color: var(--danger); }
        .protocol-open-btn { padding: 10px 14px; background: var(--surface); border: 1px solid var(--purple); border-radius: 6px; cursor: pointer; font-size: 13px; white-space: nowrap; transition: all 0.2s; }
        .protocol-open-btn:hover:not(:disabled) { background: var(--purple-light); }
        .protocol-open-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .protocol-check { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.15s; }
        .protocol-check.checked { background: var(--success-light); border-color: var(--success); }
        .protocol-check.disabled { opacity: 0.5; cursor: not-allowed; background: var(--bg); }
        .protocol-check-hint { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        
        /* Onboarding */
        .onboarding { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px; overflow-y: auto; }
        .onboarding.hidden { display: none; }
        .onboarding-card { background: var(--surface); border-radius: 16px; width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; }
        .onboarding-body { padding: 32px 24px; }
        .onboarding-step { text-align: center; margin-bottom: 24px; }
        .step-num { display: inline-block; width: 32px; height: 32px; background: var(--accent); color: white; border-radius: 50%; font-weight: 700; line-height: 32px; margin-bottom: 8px; }
        .onboarding-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .onboarding-desc { color: var(--text-secondary); font-size: 14px; }
        .eligibility-list { margin-bottom: 20px; }
        .elig-item { display: flex; align-items: center; gap: 12px; padding: 14px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
        .elig-item:hover { background: var(--bg); }
        .elig-item.checked { background: var(--success-light); border-color: var(--success); }
        .elig-check { width: 22px; height: 22px; border: 2px solid var(--border-strong); border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .elig-item.checked .elig-check { background: var(--success); border-color: var(--success); }
        .elig-check svg { color: white; display: none; }
        .elig-item.checked .elig-check svg { display: block; }
        .elig-text { font-size: 14px; }
        .role-grid { display: grid; gap: 8px; margin-bottom: 24px; }
        .role-btn { display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px solid var(--border); border-radius: 10px; background: var(--surface); cursor: pointer; text-align: left; font-family: inherit; }
        .role-btn:hover { border-color: var(--border-strong); }
        .role-btn.selected { border-color: var(--accent); background: var(--accent-light); }
        .role-icon { width: 40px; height: 40px; background: var(--bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .role-info { flex: 1; }
        .role-name { font-weight: 600; font-size: 15px; }
        .role-desc { font-size: 12px; color: var(--text-secondary); }
        .start-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; font-family: inherit; font-size: 15px; font-weight: 600; cursor: pointer; }
        .start-btn:hover { background: #1D4ED8; }
        .start-btn:disabled { background: var(--border-strong); cursor: not-allowed; }
        
        /* Pages */
        .page { display: none; }
        .page.active { display: block; }
        
        /* Freeze banner */
        .freeze-banner { background: var(--danger); color: white; padding: 12px 16px; text-align: center; font-weight: 600; }
        .freeze-banner.hidden { display: none; }
        
        /* Glossary */
        .glossary-search { padding: 16px; border-bottom: 1px solid var(--border); }
        .glossary-search-input { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 14px; }
        .glossary-search-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
        .glossary-item { padding: 16px; border-bottom: 1px solid var(--border); }
        .glossary-item:last-child { border-bottom: none; }
        .glossary-item.hidden { display: none; }
        .glossary-term { font-weight: 700; color: var(--accent); margin-bottom: 4px; }
        .glossary-plain { font-size: 15px; margin-bottom: 8px; }
        .glossary-technical { font-size: 12px; color: var(--text-muted); font-style: italic; }
        .glossary-story { font-size: 12px; color: var(--text-secondary); margin-top: 10px; padding: 10px 12px; background: linear-gradient(135deg, var(--warning-light) 0%, var(--bg) 100%); border-left: 3px solid var(--warning); border-radius: 0 6px 6px 0; line-height: 1.6; }
        .glossary-no-results { padding: 24px; text-align: center; color: var(--text-muted); }
        
        /* PRISMA formula hints */
        .prisma-formula { font-size: 11px; color: var(--text-muted); font-style: italic; margin-top: 4px; text-align: center; }
        
        /* Decision tree */
        .decision-scenario { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; overflow: hidden; }
        .decision-header { padding: 14px 16px; background: var(--bg); cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .decision-header:hover { background: var(--border); }
        .decision-icon { font-size: 20px; }
        .decision-title { font-weight: 600; flex: 1; }
        .decision-arrow { color: var(--text-muted); transition: transform 0.2s; }
        .decision-scenario.open .decision-arrow { transform: rotate(180deg); }
        .decision-body { padding: 16px; display: none; }
        .decision-scenario.open .decision-body { display: block; }
        .decision-step { display: flex; gap: 12px; margin-bottom: 12px; padding-left: 8px; border-left: 3px solid var(--accent); }
        .step-num-small { width: 24px; height: 24px; background: var(--accent); color: white; border-radius: 50%; font-size: 12px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .decision-allowed { background: var(--success-light); border: 1px solid var(--success); border-radius: 6px; padding: 10px 12px; margin-top: 12px; }
        .decision-forbidden { background: var(--danger-light); border: 1px solid var(--danger); border-radius: 6px; padding: 10px 12px; margin-top: 8px; }
        .decision-label { font-weight: 700; font-size: 11px; text-transform: uppercase; margin-bottom: 4px; }
        .decision-allowed .decision-label { color: var(--success); }
        .decision-forbidden .decision-label { color: var(--danger); }
        
        /* Template categories */
        .template-category { margin-bottom: 24px; }
        .template-category-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: linear-gradient(135deg, var(--accent-light) 0%, var(--bg) 100%); border-radius: 8px; margin-bottom: 12px; cursor: pointer; }
        .template-category-header:hover { background: var(--accent-light); }
        .template-category-header.reference { background: linear-gradient(135deg, var(--purple-light) 0%, var(--bg) 100%); }
        .template-category-header.reference:hover { background: var(--purple-light); }
        .template-category-title { font-weight: 700; font-size: 14px; color: var(--accent); flex: 1; }
        .template-category-header.reference .template-category-title { color: var(--purple); }
        .template-category-count { font-size: 12px; color: var(--text-secondary); background: var(--surface); padding: 2px 8px; border-radius: 10px; }
        .template-category-arrow { color: var(--text-muted); transition: transform 0.2s; }
        .template-category.collapsed .template-category-arrow { transform: rotate(-90deg); }
        .template-category.collapsed .template-category-content { display: none; }

        /* Quick start box */
        .quick-start { background: linear-gradient(135deg, var(--success-light) 0%, var(--bg) 100%); border: 1px solid var(--success); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .quick-start-title { font-weight: 700; color: var(--success); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .quick-start-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .quick-start-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border); }
        .quick-start-key { font-family: 'IBM Plex Mono', monospace; font-size: 12px; font-weight: 600; background: var(--bg); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); white-space: nowrap; }
        .quick-start-desc { font-size: 13px; color: var(--text-secondary); }

        /* Project Health Dashboard */
        .health-dashboard { background: linear-gradient(135deg, var(--surface) 0%, var(--bg) 100%); border: 2px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .health-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
        .health-title { font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .health-score { font-size: 24px; font-weight: 700; }
        .health-score.good { color: var(--success); }
        .health-score.warning { color: var(--warning); }
        .health-score.danger { color: var(--danger); }
        .health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .health-stat { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center; }
        .health-stat-value { font-size: 20px; font-weight: 700; color: var(--accent); }
        .health-stat-value.urgent { color: var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .health-stat-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .gate-dots { display: flex; gap: 6px; justify-content: center; margin-top: 12px; }
        .gate-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: var(--text-muted); }
        .gate-dot.passed { background: var(--success); border-color: var(--success); color: white; }
        .gate-dot.current { border-color: var(--warning); color: var(--warning); animation: pulse 1.5s infinite; }
        .next-gate-banner { background: var(--warning-light); border: 1px solid var(--warning); border-radius: 8px; padding: 10px 14px; margin-top: 12px; display: flex; align-items: center; gap: 10px; }
        .next-gate-banner.urgent { background: var(--danger-light); border-color: var(--danger); }
        .next-gate-icon { font-size: 20px; }
        .next-gate-text { flex: 1; font-size: 13px; }
        .next-gate-text strong { color: var(--warning); }
        .next-gate-banner.urgent .next-gate-text strong { color: var(--danger); }
        .risk-panel { margin-top: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
        .risk-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px; }
        .risk-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); letter-spacing: 0.02em; text-transform: uppercase; }
        .risk-badge { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 999px; }
        .risk-badge.low { background: var(--success-light); color: var(--success); }
        .risk-badge.medium { background: var(--warning-light); color: var(--warning); }
        .risk-badge.high { background: var(--danger-light); color: var(--danger); }
        .risk-list { list-style: none; margin: 0; padding: 0; display: grid; gap: 6px; }
        .risk-item { font-size: 12px; color: var(--text-secondary); padding: 6px 8px; border-radius: 6px; background: var(--bg); border: 1px solid var(--border); }
        .risk-item.medium { border-color: var(--warning); background: var(--warning-light); color: var(--warning); }
        .risk-item.high { border-color: var(--danger); background: var(--danger-light); color: var(--danger); }

        /* Study counter in header */
        .study-counter { display: flex; align-items: center; gap: 6px; background: var(--purple-light); border: 1px solid var(--purple); padding: 4px 10px; border-radius: 6px; font-size: 12px; color: var(--purple); }
        .study-counter input { width: 40px; padding: 2px 4px; border: 1px solid var(--purple); border-radius: 4px; font-size: 12px; text-align: center; background: white; }
        .study-counter.warning { background: var(--warning-light); border-color: var(--warning); color: var(--warning); }
        .study-counter.warning input { border-color: var(--warning); }

        /* Mobile improvements */
        @media (max-width: 640px) {
            .header-inner { flex-direction: column; align-items: stretch; }
            .header-controls { justify-content: center; }
            .day-hint { display: none; }
            .ref-table { font-size: 12px; }
            .ref-table th, .ref-table td { padding: 8px; }
            .template-form { padding: 12px; }
            .form-input, .form-textarea { font-size: 16px; } /* Prevent zoom on iOS */
            .btn-row { flex-direction: column; }
            .copy-btn, .download-btn { width: 100%; margin-top: 8px; }
            .card-header { flex-direction: column; align-items: flex-start; }
            .workload-badge { margin-top: 8px; }
            .toast { left: 16px; right: 16px; bottom: 16px; }
            .protocol-input-row { flex-direction: column; }
            .protocol-input { min-width: 100%; }
        }
        
        /* Responsive table wrapper */
        .table-wrapper { overflow-x: auto; margin: -16px; padding: 16px; }
        @media (max-width: 640px) {
            .table-wrapper { margin: -12px; padding: 12px; }
        }
        
        /* V3.0 New Styles */
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
        .modal.visible { display: flex; }
        .modal-card { background: var(--surface); border-radius: 16px; width: 100%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font-weight: 700; font-size: 18px; }
        .modal-close { width: 44px; height: 44px; border: none; background: var(--bg); border-radius: 8px; cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: var(--border); }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 12px; justify-content: flex-end; }
        
        .project-selector { display: flex; align-items: center; gap: 8px; }
        .project-dropdown { padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; background: var(--surface); cursor: pointer; max-width: 150px; }
        .project-dropdown:hover { border-color: var(--accent); }
        .new-project-btn { width: 28px; height: 28px; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .new-project-btn:hover { background: var(--accent-light); border-color: var(--accent); }
        
        .prisma-diagram { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 16px; }
        .prisma-row { display: flex; justify-content: center; gap: 16px; margin-bottom: 8px; flex-wrap: wrap; }
        .prisma-box { background: var(--surface); border: 2px solid var(--border); border-radius: 8px; padding: 12px 16px; min-width: 140px; text-align: center; }
        .prisma-box.highlight { border-color: var(--accent); background: var(--accent-light); }
        .prisma-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; margin-bottom: 4px; }
        .prisma-value { font-size: 24px; font-weight: 700; color: var(--text); }
        .prisma-arrow { text-align: center; font-size: 20px; color: var(--text-muted); margin: 4px 0; }
        .prisma-exclusions { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-size: 12px; max-width: 200px; }
        
        .audit-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .audit-stat { background: var(--bg); border-radius: 8px; padding: 16px; text-align: center; }
        .audit-stat-value { font-size: 28px; font-weight: 700; color: var(--accent); }
        .audit-stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
        
        .dod-section { margin-bottom: 24px; }
        .dod-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 12px; border-radius: 8px; }
        .dod-header.phase-a { background: var(--purple-light); }
        .dod-header.phase-b { background: var(--accent-light); }
        .dod-header.phase-c { background: var(--warning-light); }
        .dod-header.phase-d { background: var(--success-light); }
        .dod-header.phase-e { background: var(--danger-light); }
        .dod-title { font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .dod-gate-status { padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .gate-pending { background: var(--bg); color: var(--text-muted); }
        .gate-ready { background: var(--warning-light); color: var(--warning); }
        .gate-passed { background: var(--success-light); color: var(--success); }
        
        .sync-code-box { background: var(--bg); border: 2px dashed var(--border); border-radius: 8px; padding: 16px; margin: 16px 0; }
        .sync-code { font-family: 'IBM Plex Mono', monospace; font-size: 11px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 12px; word-break: break-all; max-height: 120px; overflow-y: auto; }
        .sync-code-length { font-size: 11px; color: var(--text-muted); margin-top: 6px; }
        .sync-code-warning { background: var(--warning-light); border: 1px solid var(--warning); border-radius: 6px; padding: 10px 12px; margin-top: 10px; font-size: 12px; color: var(--warning); }
        
        .settings-section { margin-bottom: 24px; }
        .settings-title { font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        
        @media (max-width: 640px) {
            .project-dropdown { max-width: 120px; }
            .prisma-box { min-width: 100px; padding: 8px 12px; }
            .prisma-value { font-size: 20px; }
        }

        /* First Time Wizard */
        .wizard-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); display: none; align-items: center; justify-content: center; z-index: 1001; padding: 16px; }
        .wizard-overlay.visible { display: flex; }
        .wizard-card { background: var(--surface); border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .wizard-header { padding: 24px; text-align: center; background: linear-gradient(135deg, var(--accent-light) 0%, var(--purple-light) 100%); border-radius: 16px 16px 0 0; }
        .wizard-header h2 { font-size: 24px; margin-bottom: 8px; }
        .wizard-header p { color: var(--text-secondary); font-size: 14px; }
        .wizard-body { padding: 24px; }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }
        .wizard-step-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .wizard-step-num { width: 28px; height: 28px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; }
        .wizard-tip { background: var(--bg); border-left: 3px solid var(--accent); padding: 12px 16px; margin-bottom: 16px; border-radius: 0 8px 8px 0; }
        .wizard-tip-title { font-weight: 600; font-size: 13px; color: var(--accent); margin-bottom: 4px; }
        .wizard-tip-text { font-size: 13px; color: var(--text-secondary); }
        .wizard-action-list { list-style: none; margin-bottom: 16px; }
        .wizard-action-list li { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .wizard-action-list li:last-child { border-bottom: none; }
        .wizard-action-icon { width: 24px; font-size: 16px; }
        .wizard-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; }
        .wizard-dots { display: flex; gap: 6px; align-items: center; }
        .wizard-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); transition: all 0.2s; }
        .wizard-dot.active { background: var(--accent); width: 20px; border-radius: 4px; }
        .wizard-dot.done { background: var(--success); }
        .wizard-btn { padding: 10px 20px; border: none; border-radius: 8px; font-family: inherit; font-weight: 600; cursor: pointer; }
        .wizard-btn-secondary { background: var(--bg); color: var(--text-secondary); }
        .wizard-btn-secondary:hover { background: var(--border); }
        .wizard-btn-primary { background: var(--accent); color: white; }
        .wizard-btn-primary:hover { background: #1D4ED8; }
        .wizard-dismiss { font-size: 12px; color: var(--text-muted); text-align: center; margin-top: 16px; cursor: pointer; }
        .wizard-dismiss:hover { text-decoration: underline; }

        /* Enterprise Mode Toggle */
        .enterprise-toggle { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--purple-light); border: 1px solid var(--purple); border-radius: 8px; cursor: pointer; }
        .enterprise-toggle input { width: 18px; height: 18px; accent-color: var(--purple); }
        .enterprise-toggle-text { flex: 1; }
        .enterprise-toggle-title { font-weight: 600; color: var(--purple); font-size: 14px; }
        .enterprise-toggle-desc { font-size: 12px; color: var(--text-secondary); }
        .enterprise-only { display: none; }
        .enterprise-enabled .enterprise-only { display: block; }
        .enterprise-badge { background: var(--purple); color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 6px; }

        /* Team Assignment (Enterprise) */
        .task-owner { display: flex; align-items: center; gap: 6px; margin-top: 8px; }
        .task-owner-label { font-size: 11px; color: var(--text-muted); }
        .task-owner-input { width: 80px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; }
        .task-owner-badge { background: var(--accent-light); color: var(--accent); padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }

        /* Sub-tab Navigation (Tab Groups) */
        .tab-group { display: inline-flex; background: var(--bg); border-radius: 8px; padding: 4px; margin-right: 8px; }
        .tab-group .tab { padding: 6px 12px; margin: 0; border-radius: 6px; font-size: 12px; }
        .tab-group .tab.active { background: var(--surface); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .tabs-main { display: flex; gap: 8px; flex-wrap: wrap; }

        /* Interactive Tutorial */
        .tutorial-section { background: linear-gradient(135deg, var(--success-light) 0%, var(--bg) 100%); border: 1px solid var(--success); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .tutorial-title { font-weight: 700; font-size: 16px; color: var(--success); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .tutorial-steps { counter-reset: tutorial-step; }
        .tutorial-step { display: flex; gap: 16px; padding: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; }
        .tutorial-step:hover { border-color: var(--success); box-shadow: 0 2px 8px rgba(5, 150, 105, 0.1); }
        .tutorial-step.completed { background: var(--success-light); border-color: var(--success); }
        .tutorial-step-num { counter-increment: tutorial-step; width: 32px; height: 32px; background: var(--bg); border: 2px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: var(--text-secondary); flex-shrink: 0; }
        .tutorial-step.completed .tutorial-step-num { background: var(--success); border-color: var(--success); color: white; }
        .tutorial-step-num::before { content: counter(tutorial-step); }
        .tutorial-step-content { flex: 1; }
        .tutorial-step-title { font-weight: 600; margin-bottom: 4px; }
        .tutorial-step-desc { font-size: 13px; color: var(--text-secondary); }
        .tutorial-step-action { font-size: 12px; color: var(--accent); font-weight: 500; margin-top: 6px; display: flex; align-items: center; gap: 4px; }
        .tutorial-progress { display: flex; align-items: center; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
        .tutorial-progress-bar { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .tutorial-progress-fill { height: 100%; background: var(--success); transition: width 0.3s; }
        .tutorial-progress-text { font-size: 12px; color: var(--text-secondary); font-weight: 500; }

        /* Dark Mode Toggle */
        .dark-toggle { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 13px; }
        .dark-toggle:hover { border-color: var(--accent); }
        .dark-toggle-icon { font-size: 16px; }

        /* Quick Day Jump */
        .day-display-clickable { cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background 0.15s; }
        .day-display-clickable:hover { background: var(--accent-light); }
        .day-jump-modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: center; justify-content: center; z-index: 1001; }
        .day-jump-modal.visible { display: flex; }
        .day-jump-card { background: var(--surface); border-radius: 12px; padding: 24px; width: min(280px, calc(100vw - 32px)); text-align: center; }
        .day-jump-title { font-weight: 700; margin-bottom: 16px; }
        .day-jump-input { width: 100px; padding: 12px; font-size: 24px; font-weight: 700; text-align: center; border: 2px solid var(--accent); border-radius: 8px; font-family: inherit; }
        .day-jump-input:focus { outline: none; box-shadow: 0 0 0 3px var(--accent-light); }
        .day-jump-btns { display: flex; gap: 8px; margin-top: 16px; justify-content: center; }

        /* Confetti Celebration */
        .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
        .confetti { position: absolute; width: 10px; height: 10px; opacity: 0; animation: confetti-fall 3s ease-out forwards; }
        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Workload Summary (Enterprise) */
        .workload-summary { background: var(--purple-light); border: 1px solid var(--purple); border-radius: 8px; padding: 16px; margin-top: 16px; }
        .workload-summary-title { font-weight: 600; color: var(--purple); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .workload-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .workload-person { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 10px; text-align: center; }
        .workload-person-name { font-weight: 600; font-size: 14px; color: var(--accent); }
        .workload-person-count { font-size: 12px; color: var(--text-secondary); }

        /* Forest Plot Guide */
        .forest-guide { background: linear-gradient(135deg, var(--accent-light) 0%, var(--bg) 100%); border: 1px solid var(--accent); border-radius: 12px; padding: 16px; margin-top: 16px; }
        .forest-guide-title { font-weight: 700; color: var(--accent); margin-bottom: 12px; }
        .forest-diagram { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; line-height: 1.4; overflow-x: auto; }
        .forest-legend { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; margin-top: 12px; }
        .forest-legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .forest-legend-symbol { width: 20px; text-align: center; font-weight: 700; }

        /* Focus visible */
        :focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

        /* Modal elevation */
        .modal-card, .onboarding-card, .wizard-card { box-shadow: 0 20px 60px rgba(0,0,0,0.25); }

        /* Print styles */
        @media print { .header, .tabs, .toast, .modal, .wizard-overlay, .onboarding, .day-jump-modal, .confetti-container { display: none !important; } body { background: white !important; color: black !important; } .card { break-inside: avoid; box-shadow: none; border: 1px solid #ccc; } .container { max-width: 100%; } }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; } }

        /* Tablet breakpoint */
        @media (min-width: 641px) and (max-width: 899px) { .health-grid { grid-template-columns: repeat(3, 1fr); } .role-grid { grid-template-columns: repeat(2, 1fr); } }

        /* PRISMA validation warning */
        .prisma-warning { background: var(--warning-light); border: 1px solid var(--warning); border-radius: 8px; padding: 10px 14px; margin-top: 12px; font-size: 13px; color: var(--warning); display: none; }
        .prisma-warning.visible { display: block; }

        /* Protocol badge compact */
        .protocol-badge-compact { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 16px; font-size: 13px; }
        .protocol-badge-compact.registered { background: var(--success-light); border-color: var(--success); color: var(--success); }
        .protocol-badge-compact.not-registered { background: var(--warning-light); border-color: var(--warning); color: var(--warning); }

        /* ===== 2-TIER TAB SYSTEM ===== */
        .tab-more-wrapper { position: relative; display: inline-flex; }
        .tab-more-btn { padding: 12px 16px; border: none; background: none; font-family: inherit; font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-radius: 6px; white-space: nowrap; display: flex; align-items: center; gap: 4px; }
        .tab-more-btn:hover { background: var(--bg); }
        .tab-more-btn.has-active { color: var(--accent); }
        .tab-more-dropdown { display: none; position: absolute; top: 100%; right: 0; min-width: 220px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 200; padding: 4px; }
        .tab-more-dropdown.visible { display: block; }
        .tab-more-item { display: block; width: 100%; padding: 10px 14px; border: none; background: none; font-family: inherit; font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-radius: 6px; text-align: left; white-space: nowrap; }
        .tab-more-item:hover { background: var(--bg); }
        .tab-more-item:focus-visible { outline: 2px solid var(--accent); outline-offset: -2px; }
        .tab-more-item.active { background: var(--accent-light); color: var(--accent); }
        .dark-mode .tab-more-dropdown { box-shadow: 0 8px 24px rgba(0,0,0,0.4); }

        /* ===== EXTRACTION TABLE ===== */
        .extraction-toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .extraction-toolbar .copy-btn { font-size: 12px; padding: 6px 12px; }
        .table-wrapper { overflow-x: auto; margin-top: 12px; }
        .extraction-table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 800px; }
        .extraction-table th { background: var(--bg); padding: 8px 10px; text-align: left; font-weight: 600; font-size: 12px; color: var(--text-secondary); border-bottom: 2px solid var(--border); white-space: nowrap; cursor: pointer; user-select: none; }
        .extraction-table th:hover { color: var(--accent); }
        .extraction-table th .sort-arrow { font-size: 10px; margin-left: 4px; opacity: 0.5; }
        .extraction-table th .sort-arrow.active { opacity: 1; color: var(--accent); }
        .extraction-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .extraction-input { width: 100%; padding: 5px 8px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; font-size: 13px; background: var(--surface); color: var(--text); }
        .extraction-input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 2px var(--accent-light); }
        .extraction-input.narrow { width: 80px; }
        .extraction-input.medium { width: 100px; }
        .extraction-select { padding: 5px 8px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; font-size: 12px; background: var(--surface); color: var(--text); }
        .extraction-delete { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 16px; padding: 4px 8px; border-radius: 4px; }
        .extraction-delete:hover { background: var(--danger-light); }
        .extraction-summary { display: flex; gap: 16px; flex-wrap: wrap; padding: 12px 16px; background: var(--bg); border-radius: 8px; margin-top: 12px; font-size: 13px; }
        .extraction-summary-item { display: flex; align-items: center; gap: 6px; }
        .extraction-summary-value { font-weight: 700; color: var(--accent); }
        .dark-mode .extraction-input, .dark-mode .extraction-select { background: var(--bg); }

        /* ===== ROB 2 TRAFFIC LIGHT ===== */
        .rob-section-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; cursor: pointer; border-top: 1px solid var(--border); margin-top: 16px; }
        .rob-section-header:hover { background: var(--bg); }
        .rob-summary-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 12px; overflow-x: auto; display: block; }
        .rob-summary-table th { padding: 6px 8px; background: var(--bg); font-weight: 600; text-align: center; border-bottom: 2px solid var(--border); white-space: nowrap; }
        .rob-summary-table th.rob-study-header { text-align: left; min-width: 120px; }
        .rob-summary-table td { padding: 6px 8px; text-align: center; border-bottom: 1px solid var(--border); }
        .rob-dot { display: inline-block; width: 20px; height: 20px; border-radius: 50%; }
        .rob-dot.low { background: var(--success); }
        .rob-dot.some { background: var(--warning); }
        .rob-dot.high { background: var(--danger); }
        .rob-dot.empty { background: var(--border); }
        .rob-entry-panel { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-top: 12px; display: none; }
        .rob-entry-panel.visible { display: block; }
        .rob-entry-domain { margin-bottom: 14px; }
        .rob-domain-label { font-weight: 600; font-size: 13px; margin-bottom: 6px; }
        .rob-domain-hint { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
        .rob-judgment-btns { display: flex; gap: 6px; flex-wrap: wrap; }
        .rob-judgment-btn { padding: 6px 14px; border: 2px solid var(--border); border-radius: 6px; background: var(--surface); font-family: inherit; font-size: 12px; font-weight: 500; cursor: pointer; color: var(--text-secondary); }
        .rob-judgment-btn:hover { border-color: var(--text-muted); }
        .rob-judgment-btn.selected-low { border-color: var(--success); background: var(--success-light); color: var(--success); }
        .rob-judgment-btn.selected-some { border-color: var(--warning); background: var(--warning-light); color: var(--warning); }
        .rob-judgment-btn.selected-high { border-color: var(--danger); background: var(--danger-light); color: var(--danger); }
        .rob-support-input { width: 100%; margin-top: 6px; padding: 5px 8px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; font-size: 12px; background: var(--surface); color: var(--text); }
        .rob-grade-banner { margin-top: 12px; padding: 10px 14px; background: var(--accent-light); border: 1px solid var(--accent); border-radius: 8px; font-size: 13px; color: var(--accent); }
        .rob-toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }

        /* ===== OIS CALCULATOR ===== */
        .ois-panel { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-top: 12px; display: none; }
        .ois-panel.visible { display: block; }
        .ois-toggle-group { display: flex; gap: 0; margin-bottom: 12px; }
        .ois-toggle-btn { flex: 1; padding: 8px 12px; border: 1px solid var(--border); background: var(--surface); font-family: inherit; font-size: 13px; cursor: pointer; color: var(--text-secondary); }
        .ois-toggle-btn:first-child { border-radius: 6px 0 0 6px; }
        .ois-toggle-btn:last-child { border-radius: 0 6px 6px 0; }
        .ois-toggle-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .ois-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 12px; }
        .ois-field label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
        .ois-field input { width: 100%; padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; font-size: 13px; background: var(--surface); color: var(--text); }
        .ois-result-box { margin-top: 12px; padding: 14px; border-radius: 8px; font-size: 14px; }
        .ois-result-box.adequate { background: var(--success-light); border: 1px solid var(--success); color: var(--success); }
        .ois-result-box.inadequate { background: var(--danger-light); border: 1px solid var(--danger); color: var(--danger); }
        .ois-result-box.borderline { background: var(--warning-light); border: 1px solid var(--warning); color: var(--warning); }
        .ois-value { font-size: 20px; font-weight: 700; }
        .ois-comparison { font-size: 13px; margin-top: 6px; }
        .ois-formula { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--text-muted); margin-top: 8px; padding: 8px; background: var(--surface); border-radius: 4px; overflow-x: auto; }
        .dark-mode .ois-field input { background: var(--surface); }

        /* ===== PICO SEARCH BUILDER ===== */
        .sb-elements { display: grid; gap: 16px; margin-bottom: 16px; }
        .sb-element-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 14px; }
        .sb-element-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .sb-element-label { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: white; flex-shrink: 0; }
        .sb-label-p { background: var(--purple); }
        .sb-label-i { background: #0D9488; }
        .sb-label-c { background: var(--warning); }
        .sb-label-o { background: var(--success); }
        .sb-element-title { font-weight: 600; font-size: 14px; }
        .sb-field { margin-bottom: 8px; }
        .sb-field label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 3px; }
        .sb-field input, .sb-field textarea { width: 100%; padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; font-size: 13px; background: var(--surface); color: var(--text); }
        .sb-field textarea { min-height: 60px; resize: vertical; }
        .sb-output-section { margin-top: 16px; }
        .sb-db-panel { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin-bottom: 10px; }
        .sb-db-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .sb-db-label { font-weight: 600; font-size: 13px; }
        .sb-output-text { font-family: 'IBM Plex Mono', monospace; font-size: 12px; background: var(--surface); padding: 10px; border-radius: 4px; border: 1px solid var(--border); white-space: pre-wrap; word-break: break-word; min-height: 40px; color: var(--text); }
        .sb-toggle-row { display: flex; gap: 16px; margin-bottom: 12px; }
        .sb-toggle-row label { display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer; }
        .dark-mode .sb-field input, .dark-mode .sb-field textarea { background: var(--bg); }
    </style>
</head>
<body>

<!-- TOAST NOTIFICATION -->
<div class="toast" id="toast" aria-live="polite" aria-atomic="true">
    <span id="toastIcon">✓</span>
    <span id="toastText">Saved</span>
</div>

<!-- CONFETTI CONTAINER -->
<div class="confetti-container" id="confettiContainer" aria-hidden="true"></div>

<!-- DAY JUMP MODAL -->
<div class="day-jump-modal" id="dayJumpModal" onclick="closeDayJump(event)">
    <div class="day-jump-card" onclick="event.stopPropagation()">
        <div class="day-jump-title">Jump to Day</div>
        <input type="number" class="day-jump-input" id="dayJumpInput" inputmode="numeric" aria-label="Jump to day (1-40)" min="1" max="40" value="1" onkeydown="handleDayJumpKey(event)">
        <div class="day-jump-btns">
            <button class="wizard-btn wizard-btn-secondary" onclick="closeDayJump()">Cancel</button>
            <button class="wizard-btn wizard-btn-primary" onclick="jumpToDay()">Go</button>
        </div>
    </div>
</div>

<!-- FIRST TIME WIZARD -->
<div class="wizard-overlay" id="wizardOverlay">
    <div class="wizard-card">
        <div class="wizard-header">
            <h2>🚀 Welcome to META-SPRINT!</h2>
            <p>Let's get you set up for a successful 40-day sprint</p>
        </div>
        <div class="wizard-body">
            <!-- Step 1: Understand the Sprint -->
            <div class="wizard-step active" data-step="1">
                <div class="wizard-step-title">
                    <span class="wizard-step-num">1</span>
                    What is META-SPRINT?
                </div>
                <div class="wizard-tip">
                    <div class="wizard-tip-title">The Core Idea</div>
                    <div class="wizard-tip-text">META-SPRINT is a 40-day structured framework for completing a pairwise meta-analysis with <strong>5 quality gates</strong> that prevent errors before they compound.</div>
                </div>
                <ul class="wizard-action-list">
                    <li><span class="wizard-action-icon">📋</span><div><strong>Day 1-3:</strong> Lock your study plan (Checkpoint A / DoD-A)</div></li>
                    <li><span class="wizard-action-icon">🔍</span><div><strong>Day 4-10:</strong> Finish search and screening (Checkpoint B / DoD-B)</div></li>
                    <li><span class="wizard-action-icon">📊</span><div><strong>Day 11-28:</strong> Extract data and check study quality risk (RoB) (Checkpoint C / DoD-C)</div></li>
                    <li><span class="wizard-action-icon">📈</span><div><strong>Day 29-33:</strong> Run analysis (Checkpoint D / DoD-D)</div></li>
                    <li><span class="wizard-action-icon">📝</span><div><strong>Day 34-40:</strong> Write and submit (Checkpoint E / DoD-E)</div></li>
                </ul>
            </div>

            <!-- Step 2: Day 1 Priority -->
            <div class="wizard-step" data-step="2">
                <div class="wizard-step-title">
                    <span class="wizard-step-num">2</span>
                    Day 1: Your First Task
                </div>
                <div class="wizard-tip">
                    <div class="wizard-tip-title">Study Plan Registration</div>
                    <div class="wizard-tip-text">Before anything else, register your study plan (protocol) on PROSPERO or protocols.io. This is <strong>required</strong> for Checkpoint A (DoD-A).</div>
                </div>
                <ul class="wizard-action-list">
                    <li><span class="wizard-action-icon">1️⃣</span><div>Go to <strong>PROSPERO</strong> (prospero.crd.york.ac.uk) or <strong>protocols.io</strong></div></li>
                    <li><span class="wizard-action-icon">2️⃣</span><div>Register your systematic review study plan (protocol)</div></li>
                    <li><span class="wizard-action-icon">3️⃣</span><div>Paste the link in the <strong>Study Plan Registration</strong> box on the Today page</div></li>
                    <li><span class="wizard-action-icon">4️⃣</span><div>Check off "Study plan is public" once the page is live</div></li>
                </ul>
            </div>

            <!-- Step 3: Key Features -->
            <div class="wizard-step" data-step="3">
                <div class="wizard-step-title">
                    <span class="wizard-step-num">3</span>
                    Key Features to Know
                </div>
                <div class="wizard-tip">
                    <div class="wizard-tip-title">Navigation Tips</div>
                    <div class="wizard-tip-text">Use <strong>← →</strong> arrow keys to navigate days. Press numbers <strong>1-0</strong> to jump to tabs.</div>
                </div>
                <ul class="wizard-action-list">
                    <li><span class="wizard-action-icon">📊</span><div><strong>Health Dashboard:</strong> Shows your progress at a glance on the Today page</div></li>
                    <li><span class="wizard-action-icon">✅</span><div><strong>Checkpoints (DoD):</strong> 5 quality checkpoints you must pass</div></li>
                    <li><span class="wizard-action-icon">📝</span><div><strong>Templates:</strong> 14 ready-to-use forms for audits, decisions, and more</div></li>
                    <li><span class="wizard-action-icon">💡</span><div><strong>Glossary:</strong> Every term explained in plain English</div></li>
                </ul>
            </div>

            <!-- Step 4: You're Ready -->
            <div class="wizard-step" data-step="4">
                <div class="wizard-step-title">
                    <span class="wizard-step-num">4</span>
                    You're All Set!
                </div>
                <div class="wizard-tip" style="background:var(--success-light);border-color:var(--success)">
                    <div class="wizard-tip-title" style="color:var(--success)">Quick Start Checklist</div>
                    <div class="wizard-tip-text">
                        ✅ Register study plan (PROSPERO/protocols.io)<br>
                        ✅ Fill in the Study Plan Registration box<br>
                        ✅ Review Checkpoint A (DoD-A) items<br>
                        ✅ Check back daily to see your tasks
                    </div>
                </div>
                <ul class="wizard-action-list">
                    <li><span class="wizard-action-icon">📖</span><div><strong>Need help?</strong> Check the Help tab or Glossary anytime</div></li>
                    <li><span class="wizard-action-icon">💾</span><div><strong>Data saves automatically</strong> to your browser</div></li>
                    <li><span class="wizard-action-icon">👥</span><div><strong>Team sync:</strong> Use Settings → Team Sync to share progress</div></li>
                </ul>
            </div>
        </div>
        <div class="wizard-footer">
            <button class="wizard-btn wizard-btn-secondary" id="wizardPrevBtn" onclick="wizardNav(-1)" style="visibility:hidden">← Back</button>
            <div class="wizard-dots">
                <div class="wizard-dot active" data-dot="1"></div>
                <div class="wizard-dot" data-dot="2"></div>
                <div class="wizard-dot" data-dot="3"></div>
                <div class="wizard-dot" data-dot="4"></div>
            </div>
            <button class="wizard-btn wizard-btn-primary" id="wizardNextBtn" onclick="wizardNav(1)">Next →</button>
        </div>
        <div class="wizard-dismiss" tabindex="0" role="button" onclick="closeWizard()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">Skip tutorial - I know what I'm doing</div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settingsModal" role="dialog" aria-modal="true">
    <div class="modal-card">
        <div class="modal-header">
            <div class="modal-title">⚙️ Settings & Data</div>
            <button class="modal-close" aria-label="Close" onclick="closeModal('settingsModal')">×</button>
        </div>
        <div class="modal-body">
            <div class="settings-section">
                <div class="settings-title">📂 Project Management</div>
                <div class="form-row">
                    <label class="form-label" for="projectNameInput">Current Project Name</label>
                    <input type="text" class="form-input" id="projectNameInput" placeholder="My Meta-Analysis" onchange="updateProjectName()">
                </div>
                <div class="btn-row" style="margin-top:12px">
                    <button class="download-btn" onclick="createNewProject()">âž• New Project</button>
                    <button class="download-btn" onclick="deleteCurrentProject()" style="color:var(--danger)">🗑️ Delete Project</button>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">💾 Export / Import State</div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Save your progress to a file or restore from a backup.</p>
                <div class="btn-row">
                    <button class="copy-btn" onclick="exportAllState()">⬇️ Export All Data</button>
                    <button class="download-btn" onclick="document.getElementById('importFile').click()">⬆️ Import Data</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importState(event)">
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">👥 Team Sync</div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Share project state with team members via sync code.</p>
                <div class="btn-row">
                    <button class="copy-btn" onclick="generateSyncCode()">📤 Generate Sync Code</button>
                    <button class="download-btn" onclick="showImportSyncModal()">📥 Import Sync Code</button>
                </div>
                <div class="sync-code-box" id="syncCodeBox" style="display:none">
                    <div style="font-size:12px;font-weight:600;margin-bottom:8px">Share this code with your team:</div>
                    <div class="sync-code" id="syncCodeOutput"></div>
                    <div class="sync-code-length" id="syncCodeLength"></div>
                    <div class="sync-code-warning" id="syncCodeWarning" style="display:none">⚠️ Large sync code detected. Consider exporting as JSON file instead for easier sharing.</div>
                    <button class="download-btn" style="margin-top:12px;width:100%" onclick="copySyncCode()">📋 Copy Code</button>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">📅 Calendar Integration</div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Export milestones to your calendar app (Google Calendar, Outlook, Apple Calendar).</p>
                <div class="btn-row">
                    <button class="copy-btn" onclick="exportCalendarMilestones()">📅 Export Milestones (.ics)</button>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">⌨️ Keyboard Shortcuts</div>
                <div style="font-size:13px;color:var(--text-secondary)">
                    <div style="display:flex;justify-content:space-between;padding:4px 0"><span>← / →</span><span>Navigate days</span></div>
                    <div style="display:flex;justify-content:space-between;padding:4px 0"><span>Ctrl+Z / ⌘Z</span><span>Undo last checkbox</span></div>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">🏢 Enterprise Features</div>
                <label class="enterprise-toggle">
                    <input type="checkbox" id="enterpriseToggle" onchange="toggleEnterpriseMode()">
                    <div class="enterprise-toggle-text">
                        <div class="enterprise-toggle-title">Enable Enterprise Mode</div>
                        <div class="enterprise-toggle-desc">Adds team assignment tracking for tasks and DoD items. Ideal for multi-person teams.</div>
                    </div>
                </label>
            </div>
            <div class="settings-section">
                <div class="settings-title" style="color:var(--danger)">⚠️ Danger Zone</div>
                <button class="download-btn" onclick="resetAllData()" style="color:var(--danger);border-color:var(--danger)">🗑️ Reset All Data</button>
            </div>
        </div>
    </div>
</div>

<!-- SYNC IMPORT MODAL -->
<div class="modal" id="syncImportModal" role="dialog" aria-modal="true">
    <div class="modal-card">
        <div class="modal-header">
            <div class="modal-title">📥 Import Sync Code</div>
            <button class="modal-close" aria-label="Close" onclick="closeModal('syncImportModal')">×</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <label class="form-label" for="syncImportInput">Paste sync code from team member:</label>
                <textarea class="form-textarea" id="syncImportInput" style="min-height:120px;font-family:'IBM Plex Mono',monospace;font-size:11px" placeholder="Paste the sync code here..."></textarea>
            </div>
            <div class="alert alert-warning">
                <div class="alert-icon">⚠️</div>
                <div class="alert-content">
                    <div class="alert-title">This will overwrite current project</div>
                    <div class="alert-text">The imported state will replace your current project's data.</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="download-btn" onclick="closeModal('syncImportModal')">Cancel</button>
            <button class="copy-btn" onclick="importSyncCode()">Import & Sync</button>
        </div>
    </div>
</div>

<!-- NEW PROJECT MODAL -->
<div class="modal" id="newProjectModal" role="dialog" aria-modal="true">
    <div class="modal-card">
        <div class="modal-header">
            <div class="modal-title">âž• Create New Project</div>
            <button class="modal-close" aria-label="Close" onclick="closeModal('newProjectModal')">×</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <label class="form-label" for="newProjectNameInput">Project Name</label>
                <input type="text" class="form-input" id="newProjectNameInput" placeholder="e.g., Colchicine STEMI Review">
            </div>
        </div>
        <div class="modal-footer">
            <button class="download-btn" onclick="closeModal('newProjectModal')">Cancel</button>
            <button class="copy-btn" onclick="confirmNewProject()">Create Project</button>
        </div>
    </div>
</div>

<!-- ONBOARDING -->
<div class="onboarding" id="onboarding">
    <div class="onboarding-card">
        <div class="onboarding-body">
            <div id="step1">
                <div class="onboarding-step">
                    <div class="step-num">1</div>
                    <div class="onboarding-title">Is your project eligible?</div>
                    <div class="onboarding-desc">META-SPRINT works for specific types of reviews. Confirm all boxes:</div>
                </div>
                <div class="eligibility-list">
                    <div class="elig-item" onclick="toggleElig(this)">
                        <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="elig-text"><strong>40-60 studies</strong> — Not tiny (&lt;15) or huge (&gt;100)</div>
                    </div>
                    <div class="elig-item" onclick="toggleElig(this)">
                        <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="elig-text"><strong>Standard effect sizes</strong> — OR, RR, HR, MD, or SMD</div>
                    </div>
                    <div class="elig-item" onclick="toggleElig(this)">
                        <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="elig-text"><strong>Published data only</strong> — No IPD (individual patient data)</div>
                    </div>
                    <div class="elig-item" onclick="toggleElig(this)">
                        <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="elig-text"><strong>Pairwise comparison</strong> — Not network meta-analysis</div>
                    </div>
                    <div class="elig-item" onclick="toggleElig(this)">
                        <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                        <div class="elig-text"><strong>12-person team available</strong> — ≤2 hours/day each</div>
                    </div>
                </div>
                <div class="alert alert-warning" id="eligWarning" style="display:none">
                    <div class="alert-icon">⚠️</div>
                    <div class="alert-content">
                        <div class="alert-title">Not all boxes checked</div>
                        <div class="alert-text">If your project doesn't fit these criteria, META-SPRINT may not be the right approach.</div>
                    </div>
                </div>
                <button class="start-btn" id="nextBtn1" disabled onclick="goToStep2()">Continue →</button>
            </div>
            <div id="step2" style="display:none">
                <div class="onboarding-step">
                    <div class="step-num">2</div>
                    <div class="onboarding-title">What's your role?</div>
                    <div class="onboarding-desc">Select your primary role. You'll see tasks specific to your job.</div>
                </div>
                <div class="role-grid">
                    <button class="role-btn" onclick="selectRole(this, 'integrator')">
                        <div class="role-icon">🎯</div>
                        <div class="role-info"><div class="role-name">Integrator</div><div class="role-desc">Project lead. Owns timeline, gates, decisions, submission.</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'deputy')">
                        <div class="role-icon">📋</div>
                        <div class="role-info"><div class="role-name">Deputy Integrator</div><div class="role-desc">Manages decision queue. Approves minor changes. Rotates weekly.</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'search')">
                        <div class="role-icon">🔍</div>
                        <div class="role-info"><div class="role-name">Search & Screen Pod</div><div class="role-desc">2 people. Searches, deduplicates, screens titles/abstracts.</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'fulltext')">
                        <div class="role-icon">📄</div>
                        <div class="role-info"><div class="role-name">Full-Text Pod</div><div class="role-desc">2 people. Retrieves papers, confirms inclusion, records exclusions.</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'extraction')">
                        <div class="role-icon">📊</div>
                        <div class="role-info"><div class="role-name">Extraction & Quality Risk (RoB) Pod</div><div class="role-desc">5 people. Extracts data, assesses risk of bias, verifies fields.</div></div>
                    </button>
                    <button class="role-btn" onclick="selectRole(this, 'analysis')">
                        <div class="role-icon">📈</div>
                        <div class="role-info"><div class="role-name">Analysis & Write Pod</div><div class="role-desc">1 person. Runs analyses, maintains manuscript, coordinates writing.</div></div>
                    </button>
                </div>
                <button class="start-btn" id="startBtn" disabled onclick="startApp()">Start META-SPRINT →</button>
            </div>
        </div>
    </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none">
    <div class="freeze-banner hidden" id="freezeBanner">🔒 FREEZE IN EFFECT — No new studies after Day 34</div>
    
    <header class="header">
        <div class="header-inner">
            <div class="logo">META-SPRINT <span>V3.2.0</span></div>
            <div class="header-controls">
                <div class="project-selector">
                    <select class="project-dropdown" id="projectDropdown" onchange="switchProject()" aria-label="Select project">
                        <option value="default">Default Project</option>
                    </select>
                    <button class="new-project-btn" onclick="createNewProject()" title="New project" aria-label="Create new project">+</button>
                </div>
                <div class="role-badge" id="roleBadge" tabindex="0" role="button" onclick="showRoleChange()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">Integrator</div>
                <div class="day-control">
                    <button class="day-btn" id="prevBtn" onclick="changeDay(-1)" title="Previous day (← arrow key)">←</button>
                    <div>
                        <div class="day-display day-display-clickable" tabindex="0" role="button" onclick="showDayJump()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}" title="Click to jump to any day">Day <span id="dayNum">1</span>/40</div>
                        <div class="day-hint">← → or click</div>
                    </div>
                    <button class="day-btn" id="nextBtn" onclick="changeDay(1)" title="Next day (→ arrow key)">→</button>
                </div>
                <button class="day-btn" onclick="toggleDarkMode()" title="Toggle dark mode" aria-label="Toggle dark mode" id="darkModeBtn">🌙</button>
                <button class="day-btn" onclick="openModal('settingsModal')" title="Settings" aria-label="Open settings">⚙️</button>
            </div>
        </div>
    </header>
    
    <div class="tabs" id="tabsContainer" role="tablist">
        <button class="tab active" data-page="today" onclick="showPage('today', this)" role="tab" aria-selected="true">📋 Today</button>
        <button class="tab" data-page="timeline" onclick="showPage('timeline', this)" role="tab" aria-selected="false">📅 Timeline</button>
        <button class="tab" data-page="dod" onclick="showPage('dod', this)" role="tab" aria-selected="false">✅ Checkpoints</button>
        <button class="tab" data-page="prisma" onclick="showPage('prisma', this)" role="tab" aria-selected="false">📊 Study Flow</button>
        <button class="tab" data-page="extraction" onclick="showPage('extraction', this)" role="tab" aria-selected="false">🔬 Extraction</button>
        <button class="tab" data-page="templates" onclick="showPage('templates', this)" role="tab" aria-selected="false">📝 Templates</button>
        <button class="tab" data-page="audit" onclick="showPage('audit', this)" role="tab" aria-selected="false">📦 Audit Pack</button>
        <div class="tab-more-wrapper">
            <button class="tab-more-btn" onclick="toggleMoreTabs(event)" aria-expanded="false" aria-haspopup="true" title="More pages">More ▾</button>
            <div class="tab-more-dropdown" id="moreTabsDropdown" role="menu">
                <button class="tab-more-item" data-page="search" onclick="showPageFromMore('search', this)" role="menuitem">🔍 PICO Search Builder</button>
                <button class="tab-more-item" data-page="reference" onclick="showPageFromMore('reference', this)" role="menuitem">📚 Reference</button>
                <button class="tab-more-item" data-page="help" onclick="showPageFromMore('help', this)" role="menuitem">❓ Help</button>
                <button class="tab-more-item" data-page="glossary" onclick="showPageFromMore('glossary', this)" role="menuitem">💡 Glossary</button>
                <button class="tab-more-item" data-page="casestudy" onclick="showPageFromMore('casestudy', this)" role="menuitem">📖 Case Study</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- TODAY PAGE -->
        <div class="page active" id="page-today" role="tabpanel">
            <!-- PROJECT HEALTH DASHBOARD -->
            <div class="health-dashboard" id="healthDashboard">
                <div class="health-header">
                    <div class="health-title">📊 Project Health</div>
                    <div class="health-score" id="healthScore">--</div>
                </div>
                <div class="health-grid">
                    <div class="health-stat">
                        <div class="health-stat-value" id="daysRemaining">40</div>
                        <div class="health-stat-label">Days Left</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-stat-value" id="daysToFreeze">34</div>
                        <div class="health-stat-label">Until Freeze</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-stat-value" id="gatesPassed">0/5</div>
                        <div class="health-stat-label">Checkpoints Passed</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-stat-value" id="studyCount">0</div>
                        <div class="health-stat-label">Studies</div>
                        <input type="number" id="studyCountInput" min="0" max="100" value="0" onchange="updateStudyCount()" style="width:50px;margin-top:6px;padding:4px;border:1px solid var(--border);border-radius:4px;text-align:center;font-size:12px" title="Enter included study count">
                    </div>
                </div>
                <div class="gate-dots">
                    <div class="gate-dot" id="gateA" title="DoD-A: Study Plan">A</div>
                    <div class="gate-dot" id="gateB" title="DoD-B: Search">B</div>
                    <div class="gate-dot" id="gateC" title="DoD-C: Extraction">C</div>
                    <div class="gate-dot" id="gateD" title="DoD-D: Analysis">D</div>
                    <div class="gate-dot" id="gateE" title="DoD-E: Submission">E</div>
                </div>
                <div class="next-gate-banner" id="nextGateBanner" style="display:none">
                    <div class="next-gate-icon">⏰</div>
                    <div class="next-gate-text" id="nextGateText"></div>
                </div>
                <div class="risk-panel" id="riskPanel">
                    <div class="risk-header">
                        <div class="risk-title">Project Risk</div>
                        <div class="risk-badge low" id="riskStatusBadge" aria-live="polite">LOW</div>
                    </div>
                    <ul class="risk-list" id="riskList" aria-live="polite">
                        <li class="risk-item">No active risks. Keep completing daily tasks.</li>
                    </ul>
                </div>
                <!-- Workload Summary (Enterprise Only) -->
                <div class="workload-summary enterprise-only" id="workloadSummary" style="display:none">
                    <div class="workload-summary-title">👥 Team Workload</div>
                    <div class="workload-grid" id="workloadGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Progress</div>
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <div class="workload-badge" id="workloadBadge">⏱️ ~0.7h/day</div>
                        <div class="phase-badge phase-a" id="phaseBadge">Study Plan</div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="timeline-bar" role="progressbar" aria-valuemin="0" aria-valuemax="40" aria-valuenow="1" aria-label="Sprint progress"><div class="timeline-fill" id="timelineFill" style="width: 0%"></div></div>
                    <div class="timeline-markers">
                        <div class="timeline-marker" id="m1">D3<br>DoD-A</div>
                        <div class="timeline-marker" id="m2">D10<br>DoD-B</div>
                        <div class="timeline-marker" id="m3">D20<br>Audit1</div>
                        <div class="timeline-marker" id="m4">D28<br>DoD-C</div>
                        <div class="timeline-marker" id="m5">D33<br>DoD-D</div>
                        <div class="timeline-marker" id="m6">D34<br>Freeze</div>
                        <div class="timeline-marker" id="m7">D40<br>Submit</div>
                    </div>
                </div>
            </div>
            
            <div class="protocol-reg" id="protocolReg">
                <div class="protocol-reg-title">📋 Study Plan Registration Required</div>
                <div class="protocol-reg-text">Before Checkpoint A (DoD-A) can pass, your study plan (protocol) must be registered on <strong>PROSPERO</strong> or <strong>protocols.io</strong>. Registration usually publishes in &lt;24 hours.</div>
                <div class="protocol-input-row">
                    <input type="text" class="protocol-input" id="protocolUrl" placeholder="Paste PROSPERO or protocols.io link here..." oninput="onProtocolUrlChange()">
                    <button class="protocol-open-btn" id="protocolOpenBtn" onclick="openProtocolUrl()" disabled title="Open in new tab">🔗 Open</button>
                </div>
                <div class="protocol-validation" id="protocolValidation"></div>
                <div class="protocol-check disabled" id="protocolCheck" tabindex="0" onclick="toggleProtocolPublished()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}" role="checkbox" aria-checked="false">
                    <div class="elig-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                    <span>Study plan page is public and accessible</span>
                </div>
                <div class="protocol-check-hint" id="protocolHint">Enter a valid PROSPERO or protocols.io link above to enable this checkbox</div>
            </div>
            
            <div class="alert alert-info" id="todayGoal">
                <div class="alert-icon">🎯</div>
                <div class="alert-content">
                    <div class="alert-title">Today's Goal</div>
                    <div class="alert-text" id="goalText">Loading...</div>
                </div>
            </div>
            
            <div id="alertsContainer"></div>
            
            <div class="card">
                <div class="card-header"><div class="card-title">Your Tasks Today</div></div>
                <div class="card-body" id="tasksContainer"></div>
            </div>
            
            <div class="card">
                <div class="card-header"><div class="card-title">Quick Actions</div></div>
                <div class="card-body" id="quickActions"></div>
            </div>
        </div>

        <!-- TIMELINE PAGE -->
        <div class="page" id="page-timeline" role="tabpanel">
            <div class="card">
                <div class="card-header"><div class="card-title">40-Day Schedule</div></div>
                <div class="card-body">
                    <div class="help-box">
                        <div class="help-box-title">💡 How to read this</div>
                        <div class="help-box-text">Each phase has a required checkpoint (DoD gate). Green = passed, Yellow = in progress.</div>
                    </div>
                    <table class="ref-table">
                        <thead><tr><th>Phase</th><th>Days</th><th>Gate</th><th>Status</th></tr></thead>
                        <tbody id="timelineTable"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">Key Milestones</div></div>
                <div class="card-body">
                    <table class="ref-table">
                        <thead><tr><th>Day</th><th>Event</th><th>What happens</th></tr></thead>
                        <tbody>
                            <tr><td>3</td><td>DoD-A</td><td>Study plan locked. No more changes to PICOS, outcomes, or methods.</td></tr>
                            <tr><td>10</td><td>DoD-B</td><td>Search done. Screening finished. Study flow (PRISMA) counts final.</td></tr>
                            <tr><td>18-20</td><td>Audit 1</td><td>10% of studies traced end-to-end. Major errors trigger Emergency Fix Mode (CondGO).</td></tr>
                            <tr><td>28</td><td>DoD-C</td><td>Data extraction complete. All key data entered and checked.</td></tr>
                            <tr><td>30-32</td><td>Audit 2</td><td>Full rerun check. High-impact studies re-checked.</td></tr>
                            <tr><td>33</td><td>DoD-D</td><td>Analysis locked. Main results final.</td></tr>
                            <tr><td>34</td><td>FREEZE</td><td>No new studies. Only corrections allowed.</td></tr>
                            <tr><td>40</td><td>Submit</td><td>Manuscript and audit pack submitted.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">Weekly Workload (Appendix O)</div></div>
                <div class="card-body">
                    <table class="ref-table">
                        <thead><tr><th>Week</th><th>Days</th><th>Avg hrs/person/day</th><th>Focus</th></tr></thead>
                        <tbody>
                            <tr><td>1</td><td>1-7</td><td>~0.7h</td><td>Study plan, setup, search launch</td></tr>
                            <tr><td>2</td><td>8-14</td><td>~1.7h</td><td>Screening, full-text, start extraction</td></tr>
                            <tr><td>3</td><td>15-21</td><td>~2.0h</td><td>Peak extraction, Audit 1</td></tr>
                            <tr><td>4</td><td>22-28</td><td>~2.0h</td><td>Finish extraction, analysis</td></tr>
                            <tr><td>5</td><td>29-35</td><td>~1.4h</td><td>Audit 2, freeze, writing</td></tr>
                            <tr><td>6</td><td>36-40</td><td>~1.3h</td><td>Final writing, submission</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- DOD GATES PAGE -->
        <div class="page" id="page-dod" role="tabpanel">
            <div class="help-box">
                <div class="help-box-title">✅ Definition of Done (DoD) Checkpoints</div>
                <div class="help-box-text">Track completion of each checkpoint. All items must be checked before a checkpoint can pass. Integrator signs off.</div>
            </div>
            <div id="dodContainer"></div>
        </div>

        <!-- PRISMA PAGE -->
        <div class="page" id="page-prisma" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📊 Study Flow Diagram (PRISMA)</div>
                    <div style="display:flex;gap:8px">
                        <button class="download-btn" onclick="exportPRISMASVG()">⬇️ Export SVG</button>
                        <button class="download-btn" onclick="copyPRISMAText()">📋 Copy Text</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="help-box">
                        <div class="help-box-title">📝 Enter your counts below</div>
                        <div class="help-box-text">The diagram updates automatically. Final counts should be locked at DoD-B (Day 10).</div>
                    </div>
                    
                    <div class="prisma-diagram">
                        <div class="prisma-row">
                            <div class="prisma-box">
                                <div class="prisma-label">Records Identified</div>
                                <input type="number" class="form-input" id="prisma-identified" style="text-align:center;font-size:20px;font-weight:700" value="0" onchange="updatePRISMA()">
                            </div>
                        </div>
                        <div class="prisma-arrow">↓</div>
                        <div class="prisma-row">
                            <div class="prisma-box">
                                <div class="prisma-label">After Duplicates Removed</div>
                                <input type="number" class="form-input" id="prisma-deduped" style="text-align:center;font-size:20px;font-weight:700" value="0" onchange="updatePRISMA()">
                            </div>
                        </div>
                        <div class="prisma-arrow">↓</div>
                        <div class="prisma-row" style="gap:24px">
                            <div class="prisma-box">
                                <div class="prisma-label">Screened</div>
                                <div class="prisma-value" id="prisma-screened-display">0</div>
                                <div class="prisma-formula">= After Duplicates Removed</div>
                            </div>
                            <div class="prisma-exclusions">
                                <div style="font-weight:600;margin-bottom:8px">Excluded (Title/Abstract)</div>
                                <input type="number" class="form-input" id="prisma-excluded-screen" style="text-align:center" value="0" onchange="updatePRISMA()">
                            </div>
                        </div>
                        <div class="prisma-arrow">↓</div>
                        <div class="prisma-row" style="gap:24px">
                            <div class="prisma-box">
                                <div class="prisma-label">Full-text Assessed</div>
                                <div class="prisma-value" id="prisma-fulltext-display">0</div>
                                <div class="prisma-formula">= Screened − Excluded</div>
                            </div>
                            <div class="prisma-exclusions">
                                <div style="font-weight:600;margin-bottom:8px">Excluded (Full-text)</div>
                                <input type="number" class="form-input" id="prisma-excluded-fulltext" style="text-align:center" value="0" onchange="updatePRISMA()">
                                <textarea class="form-textarea" id="prisma-exclusion-reasons" style="margin-top:8px;min-height:80px" placeholder="Reasons:&#10;• Wrong population (n)&#10;• Wrong intervention (n)&#10;• No usable data (n)" onchange="savePRISMA()"></textarea>
                            </div>
                        </div>
                        <div class="prisma-arrow">↓</div>
                        <div class="prisma-row">
                            <div class="prisma-box highlight">
                                <div class="prisma-label">Studies Included</div>
                                <div class="prisma-value" id="prisma-included-display">0</div>
                                <div class="prisma-formula">= Full-text − Excluded</div>
                            </div>
                        </div>
                        <div class="prisma-warning" id="prismaWarning">Flow counts are inconsistent. Check that identified >= after duplicates removed >= screened - excluded >= included.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXTRACTION PAGE -->
        <div class="page" id="page-extraction" role="tabpanel">
            <div class="help-box">
                <div class="help-box-title">🔬 Per-Study Data Extraction</div>
                <div class="help-box-text">Record each included study's effect estimate, sample size, and confidence interval. This table feeds the RoB assessment and OIS calculator below. Use Import CSV to load data from a spreadsheet.</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📊 Extracted Studies</div>
                    <div class="extraction-toolbar">
                        <button class="copy-btn" onclick="addStudyRow()">+ Add Study</button>
                        <button class="copy-btn" onclick="document.getElementById('csvImportInput').click()">📥 Import CSV</button>
                        <button class="copy-btn" onclick="exportStudiesCSV()">📤 Export CSV</button>
                    </div>
                </div>
                <div class="card-body">
                    <input type="file" id="csvImportInput" accept=".csv,.txt" style="display:none" onchange="handleCSVImport(event)">
                    <div class="table-wrapper">
                        <table class="extraction-table" id="extractionTable">
                            <thead>
                                <tr>
                                    <th onclick="sortStudies('authorYear')">Study ID <span class="sort-arrow" id="sort-authorYear">▲</span></th>
                                    <th onclick="sortStudies('nTotal')">N total <span class="sort-arrow" id="sort-nTotal">▲</span></th>
                                    <th onclick="sortStudies('nIntervention')">N int. <span class="sort-arrow" id="sort-nIntervention">▲</span></th>
                                    <th onclick="sortStudies('nControl')">N ctrl <span class="sort-arrow" id="sort-nControl">▲</span></th>
                                    <th onclick="sortStudies('effectEstimate')">Effect <span class="sort-arrow" id="sort-effectEstimate">▲</span></th>
                                    <th onclick="sortStudies('lowerCI')">Lower CI <span class="sort-arrow" id="sort-lowerCI">▲</span></th>
                                    <th onclick="sortStudies('upperCI')">Upper CI <span class="sort-arrow" id="sort-upperCI">▲</span></th>
                                    <th>Type</th>
                                    <th onclick="sortStudies('weight')">Weight <span class="sort-arrow" id="sort-weight">▲</span></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="extractionTableBody"></tbody>
                        </table>
                    </div>
                    <div class="extraction-summary" id="extractionSummary" style="display:none"></div>
                </div>
            </div>

            <!-- RoB 2 Section (embedded in Extraction) -->
            <div class="card" id="robCard">
                <div class="rob-section-header" onclick="toggleRoBSection()" tabindex="0" role="button" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="card-title">⚖️ Risk of Bias (RoB 2)</div>
                    <span class="decision-arrow" id="robArrow">▼</span>
                </div>
                <div class="card-body" id="robBody" style="display:none">
                    <div class="help-box">
                        <div class="help-box-title">How RoB 2 works</div>
                        <div class="help-box-text">Assess 5 bias domains per study: Randomization, Deviations, Missing Data, Measurement, and Selection. Each gets Low / Some concerns / High risk. The overall judgment follows the worst domain. Results auto-feed into the GRADE assessment.</div>
                    </div>
                    <div id="robSummaryTable"></div>
                    <div class="rob-entry-panel" id="robEntryPanel">
                        <h4 id="robEntryTitle" style="margin-bottom:12px"></h4>
                        <div id="robEntryDomains"></div>
                        <div style="margin-top:12px">
                            <button class="copy-btn" onclick="closeRoBEntry()">Done</button>
                        </div>
                    </div>
                    <div class="rob-grade-banner" id="robGradeBanner" style="display:none"></div>
                    <div class="rob-toolbar">
                        <button class="copy-btn" onclick="exportRoBSVG()">📊 Export SVG</button>
                        <button class="copy-btn" onclick="copyRoBSummary()">📋 Copy Summary</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AUDIT PACK PAGE -->
        <div class="page" id="page-audit" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📦 Audit Pack Summary</div>
                    <button class="copy-btn" onclick="downloadAuditPack()">⬇️ Download Full Audit Pack</button>
                </div>
                <div class="card-body">
                    <div class="help-box">
                        <div class="help-box-title">📋 What's in the Audit Pack?</div>
                        <div class="help-box-text">All templates generated, task completions, DoD gate sign-offs, and PRISMA counts. This is your reproducibility documentation.</div>
                    </div>
                    
                    <div class="audit-summary" id="auditSummary">
                        <div class="audit-stat">
                            <div class="audit-stat-value" id="audit-templates">0</div>
                            <div class="audit-stat-label">Templates Generated</div>
                        </div>
                        <div class="audit-stat">
                            <div class="audit-stat-value" id="audit-tasks">0</div>
                            <div class="audit-stat-label">Tasks Completed</div>
                        </div>
                        <div class="audit-stat">
                            <div class="audit-stat-value" id="audit-dod">0/5</div>
                            <div class="audit-stat-label">Checkpoints Passed (DoD)</div>
                        </div>
                        <div class="audit-stat">
                            <div class="audit-stat-value" id="audit-deviations">0</div>
                            <div class="audit-stat-label">Deviations Logged</div>
                        </div>
                    </div>
                    
                    <h4 style="margin:24px 0 12px">Audit-Grade Index</h4>
                    <div class="help-box" style="background:var(--bg);border-color:var(--border)">
                        <div class="help-box-title" style="color:var(--text)">Score: <span id="auditGradeScore">0</span>/9</div>
                        <div class="help-box-text">Target: 9/9 for submission (includes GRADE).</div>
                    </div>
                    <div id="auditGradeChecklist"></div>
                    
                    <h4 style="margin:24px 0 12px">Template Log</h4>
                    <div id="templateLogContainer" style="max-height:400px;overflow-y:auto">
                        <p style="color:var(--text-muted);font-size:13px">No templates generated yet. Use the Templates tab to create documentation.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TEMPLATES PAGE -->
        <div class="page" id="page-templates" role="tabpanel">
            <div class="help-box">
                <div class="help-box-title">📝 How to use templates</div>
                <div class="help-box-text">Click any template to expand. Fill in fields, then click "Copy". Each template explains what it is and when to use it.</div>
            </div>

            <!-- Template Overview -->
            <div class="card" style="margin-bottom:16px">
                <div class="card-body" style="padding:12px 16px">
                    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between">
                        <div style="font-size:13px;color:var(--text-secondary)">15 templates organized by type:</div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <span class="template-badge badge-essential">10 ESSENTIAL</span>
                            <span class="template-badge badge-reference">3 REFERENCE</span>
                            <span class="template-badge badge-emergency">2 EMERGENCY</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appendix A: Consult Pack -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">📋 Appendix A: Consult Pack <span class="template-badge badge-essential">ESSENTIAL</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">A one-page briefing you must prepare <em>before</em> asking the Integrator to make any decision. It forces you to think clearly and saves everyone's time. No Consult Pack = no meeting.</div>
                        <div class="template-story">📖 <strong>The HRT consensus failure:</strong> For 20 years, experts discussed hormone therapy in unstructured meetings. Observational data "felt" convincing. No one wrote down options and tradeoffs. The WHI trial proved everyone wrong. This template forces evidence, alternatives, and risks onto paper—where intuition can't hide.</div>
                    </div>
                    <div class="template-when"><strong>📅 When to use:</strong> Before any decision meeting, escalation, or approval request.</div>
                    <div class="template-form">
                        <div class="form-row">
                            <label class="form-label" for="consult-decision">Decision Statement (one sentence)</label>
                            <input type="text" class="form-input" id="consult-decision" placeholder="We need to decide: [what exactly]">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="consult-context">Context (≤5 bullets)</label>
                            <textarea class="form-textarea" id="consult-context" placeholder="• Background point 1&#10;• Why this matters now"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="consult-evidence">Evidence (≤6 bullets with links)</label>
                            <textarea class="form-textarea" id="consult-evidence" placeholder="• Study X reports... [link]&#10;• Protocol says... [section]"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="consult-optionA">Option A (with risks)</label>
                            <textarea class="form-textarea" id="consult-optionA" placeholder="Do X. Validity risk: [low/med/high]. Timeline risk: [days]"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="consult-optionB">Option B (with risks)</label>
                            <textarea class="form-textarea" id="consult-optionB" placeholder="Do Y. Validity risk: [low/med/high]. Timeline risk: [days]"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="consult-rec">Your Recommendation</label>
                            <input type="text" class="form-input" id="consult-rec" placeholder="I recommend Option [A/B] because...">
                        </div>
                        <div class="btn-row">
                            <button class="copy-btn" onclick="generateConsult()">Generate & Copy</button>
                            <button class="download-btn" onclick="downloadTemplate('consult')">⬇ Download .txt</button>
                        </div>
                        <div class="template-output" id="consult-output"></div>
                    </div>
                </div>
            </div>
            
            <!-- Appendix C: Red-Team Micro-Check -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔴 Appendix C: Red-Team Daily Micro-Check <span class="template-badge badge-essential">ESSENTIAL</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">Every day, 2 team members (rotating) spend 12-15 minutes each checking data quality on auto-selected studies. This catches errors early.</div>
                        <div class="template-story">📖 <strong>The Boldt detection:</strong> Joachim Boldt published 90+ fraudulent anesthesia studies. Collaborative peer review missed it for years. An adversarial red-team checker noticed impossible patient recruitment rates. 12 minutes of skeptical checking caught what years of friendly review missed. Your red-team is your fraud firewall.</div>
                    </div>
                    <div class="template-when"><strong>📅 When to use:</strong> Every day from Day 11 onwards. Each checker fills one form per study.</div>
                    <div class="alert alert-info" style="margin-bottom:16px">
                        <div class="alert-icon">🎲</div>
                        <div class="alert-content">
                            <div class="alert-title">How are studies selected?</div>
                            <div class="alert-text"><strong>Influential:</strong> Top 20% by inverse-variance weight (or largest N).<br><strong>Random:</strong> Uniform random from all included.</div>
                        </div>
                    </div>
                    <div class="template-form">
                        <div class="form-row">
                            <label class="form-label" for="rt-study">Study ID</label>
                            <input type="text" class="form-input" id="rt-study" placeholder="e.g., Smith 2019">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="rt-type">Selection Type</label>
                            <select class="form-input" id="rt-type"><option value="">Select...</option><option>Influential (high-weight)</option><option>Random</option></select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="rt-check">Check Type</label>
                            <select class="form-input" id="rt-check">
                                <option value="">Select...</option>
                                <option>Directionality — Does effect direction match source?</option>
                                <option>Unit/Time — Are units converted correctly?</option>
                                <option>Outcome vs Protocol — Does outcome match protocol?</option>
                                <option>Timepoint — Is correct timepoint used?</option>
                                <option>Overlap — Same patients as another study?</option>
                                <option>Source citation — Can every number be traced?</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="rt-result">Result</label>
                            <select class="form-input" id="rt-result" onchange="toggleRTFail()"><option value="">Select...</option><option value="pass">✅ PASS</option><option value="fail">❌ FAIL</option></select>
                        </div>
                        <div class="form-row" id="rt-fail-row" style="display:none">
                            <label class="form-label" for="rt-error">Error Details</label>
                            <textarea class="form-textarea" id="rt-error" placeholder="Which field(s) wrong? What should they be?"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="rt-checker">Checker Name</label>
                            <input type="text" class="form-input" id="rt-checker" placeholder="Your name">
                        </div>
                        <div class="btn-row">
                            <button class="copy-btn" onclick="generateRedTeam()">Generate & Copy</button>
                            <button class="download-btn" onclick="downloadTemplate('rt')">⬇ Download .txt</button>
                        </div>
                        <div class="template-output" id="rt-output"></div>
                    </div>
                </div>
            </div>
            
            <!-- Appendix D: Audit Forms -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔍 Appendix D: Formal Audit Forms <span class="template-badge badge-essential">ESSENTIAL</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text"><strong>Audit 1</strong> (Days 18-20): Trace 10% of studies from source paper to final dataset. <strong>Audit 2</strong> (Days 30-32): Check reruns match and re-check high-impact studies. Failures trigger Emergency Fix Mode (CondGO).</div>
                        <div class="template-story">📖 <strong>The Poldermans audit failure:</strong> Don Poldermans fabricated data in studies that shaped European surgical guidelines. No audit traced his numbers to source documents—because the patients didn't exist. When you audit source citation, you're asking: "Can I find this patient in this table?" His fake data would have failed this test. 800,000 people died from guidelines built on unaudited fabrication.</div>
                    </div>
                    <h4 style="margin:16px 0 8px;color:var(--accent)">Audit 1: Trace Audit (Days 18-20)</h4>
                    <div class="template-form">
                        <div class="form-row">
                            <label class="form-label" for="a1-studies">Studies Audited (min 5, ≥2 influential)</label>
                            <textarea class="form-textarea" id="a1-studies" placeholder="Smith 2019 (influential)&#10;Jones 2020 (influential)&#10;Chen 2018 (random)"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label">Check chain: Included? → Key fields correct? → Effect value correct? → Right outcome/timepoint? → Source citation present?</label>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="a1-errors">Errors Found</label>
                            <textarea class="form-textarea" id="a1-errors" placeholder="Study X: [field] was wrong. Or: No errors."></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="a1-result">Result</label>
                            <select class="form-input" id="a1-result"><option>Select...</option><option>✅ PASS — ≤1 major error, no drift</option><option>❌ FAIL — ≥2 errors OR drift → Emergency Fix Mode (CondGO)</option></select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="a1-auditors">Auditors</label>
                            <input type="text" class="form-input" id="a1-auditors" placeholder="Names">
                        </div>
                        <button class="copy-btn" onclick="generateAudit1()">Generate Audit 1</button>
                        <div class="template-output" id="a1-output"></div>
                    </div>
                    <h4 style="margin:24px 0 8px;color:var(--accent)">Audit 2: Rerun Match Check (Days 30-32)</h4>
                    <div class="template-form">
                        <div class="form-row">
                            <label class="form-label" for="a2-rerun">Rerun Match Test (tolerance: ≤0.001 for effects, 1% for I²)</label>
                            <select class="form-input" id="a2-rerun"><option>Select...</option><option>✅ PASS — identical results</option><option>❌ FAIL — mismatch</option></select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="a2-influential">Influential Studies Verified</label>
                            <textarea class="form-textarea" id="a2-influential" placeholder="Smith 2019: ✅&#10;Jones 2020: ✅"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="a2-result">Result</label>
                            <select class="form-input" id="a2-result"><option>Select...</option><option>✅ PASS — Ready for DoD-D</option><option>❌ FAIL → Emergency Fix Mode (CondGO)</option></select>
                        </div>
                        <button class="copy-btn" onclick="generateAudit2()">Generate Audit 2</button>
                        <div class="template-output" id="a2-output"></div>
                    </div>
                </div>
            </div>
            
            <!-- Appendix E: Calibration -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">⚖️ Appendix E: Team Alignment & Dispute Rules <span class="template-badge badge-reference">REFERENCE</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">Before screening or extraction, run a quick alignment check so everyone applies rules the same way. If people disagree, use the dispute rule below.</div>
                    </div>
                    <h4 style="margin:16px 0 8px;color:var(--accent)">Screening Alignment Check (before Day 6)</h4>
                    <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px;font-size:13px">
                        1. Two screeners independently screen first <strong>50 titles/abstracts</strong><br>
                        2. Compare decisions. Need <strong>≥80% agreement</strong><br>
                        3. If &lt;80%: discuss, revise guide, repeat with next 25
                    </div>
                    <h4 style="margin:16px 0 8px;color:var(--accent)">Extraction Alignment Check (before Day 11)</h4>
                    <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px;font-size:13px">
                        1. Two extractors independently extract first <strong>5 studies</strong><br>
                        2. Compare key fields. Need <strong>≤10% mismatch</strong><br>
                        3. If &gt;10%: discuss, revise form, repeat with next 3
                    </div>
                    <h4 style="margin:16px 0 8px;color:var(--accent)">Disagreement Resolution</h4>
                    <div style="background:var(--bg);padding:16px;border-radius:8px;font-size:13px">
                        If two people disagree: Integrator + one uninvolved red-team member review and decide. Record it in the Deviation Log if it changes interpretation.
                    </div>
                </div>
            </div>
            
            <!-- Appendix F: Critical Fields -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">✅ Appendix F: Critical Fields Checklist <span class="template-badge badge-essential">ESSENTIAL</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">These are numbers that can change your final result. Each one must be double-checked and linked to its exact source location (page/table/figure).</div>
                        <div class="template-story">📖 <strong>The COLCOT near-disaster:</strong> In one meta-analysis, the largest trial's intervention and control arms were swapped in extraction. One error in one key field would have reversed the entire conclusion. Key fields need two checks and clear source citations.</div>
                    </div>
                    <table class="ref-table" style="margin-top:16px">
                        <thead><tr><th>Critical Field</th><th>What to record</th></tr></thead>
                        <tbody>
                            <tr><td><strong>Study ID</strong></td><td>First author + year</td></tr>
                            <tr><td><strong>Arms + N</strong></td><td>Treatment vs control, sample size per arm</td></tr>
                            <tr><td><strong>Outcome definition</strong></td><td>Exact outcome (matches study plan?)</td></tr>
                            <tr><td><strong>Timepoint</strong></td><td>When measured (matches study plan rule?)</td></tr>
                            <tr><td><strong>Binary: events/total</strong></td><td>Events in each arm + N</td></tr>
                            <tr><td><strong>Continuous: mean/SD/N</strong></td><td>Mean, SD, N per arm</td></tr>
                            <tr><td><strong>HR + SE/CI</strong></td><td>Hazard ratio with SE or 95% CI</td></tr>
                            <tr><td><strong>Directionality</strong></td><td>Which direction is "good"?</td></tr>
                            <tr><td><strong>Missing data</strong></td><td>Dropouts, ITT vs planned-treatment analysis</td></tr>
                            <tr><td><strong>Source citation</strong></td><td>Page/table/figure for EACH field</td></tr>
                        </tbody>
                    </table>
                    <div class="alert alert-warning" style="margin-top:16px">
                        <div class="alert-icon">⚠️</div>
                        <div class="alert-content"><div class="alert-title">Source citation is mandatory</div><div class="alert-text">Every number needs a source like "Table 2, p.1234". No source = no trust.</div></div>
                    </div>
                </div>
            </div>
            
            <!-- Appendix G: Rerun Match -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🔄 Appendix G: Rerun Match Rules <span class="template-badge badge-reference">REFERENCE</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">Two independent reruns should give the same result (within tight tolerance). If they do not match, something is wrong.</div>
                        <div class="template-story">📖 <strong>The reproducibility crisis:</strong> Nature (2016) found 70% of researchers couldn't reproduce others' work—and 50% couldn't reproduce their own. The Tamiflu Cochrane battle was won because independent analysts could rerun the analysis and verify claims. Reproducibility is not bureaucracy; it's the foundation of trust.</div>
                    </div>
                    <h4 style="margin:16px 0 8px;color:var(--success)">✅ MATCHED if all checks pass:</h4>
                    <table class="ref-table">
                        <thead><tr><th>Check</th><th>Tolerance</th></tr></thead>
                        <tbody>
                            <tr><td>Included study count</td><td>Exactly identical</td></tr>
                            <tr><td>Effect sizes (log scale)</td><td>≤0.001</td></tr>
                            <tr><td>Pooled effect</td><td>≤0.001</td></tr>
                            <tr><td>Standard error</td><td>≤0.001</td></tr>
                            <tr><td>I² (study-to-study differences)</td><td>Within 1%</td></tr>
                            <tr><td>τ² (spread between studies)</td><td>≤0.001</td></tr>
                        </tbody>
                    </table>
                    <h4 style="margin:16px 0 8px;color:var(--danger)">❌ If mismatch:</h4>
                    <div style="background:var(--danger-light);padding:16px;border-radius:8px;font-size:13px">
                        1. Classify the mismatch: rounding, data entry, or code issue?<br>
                        2. Fix the source of error<br>
                        3. If late (Day 33+): trigger Emergency Fix Mode (CondGO)
                    </div>
                </div>
            </div>
            
            <!-- Appendix H: Overlaps -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">👥 Appendix H: Overlaps & Multi-Arm Studies <span class="template-badge badge-reference">REFERENCE</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">Rules for duplicate participants across papers or trials with 3+ arms. Never count the same patient twice.</div>
                    </div>
                    <h4 style="margin:16px 0 8px;color:var(--accent)">Study Families (multiple papers, same patients)</h4>
                    <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px;font-size:13px">
                        <strong>Rule:</strong> One data point per outcome/timepoint per study family.<br>
                        Prefer the most complete report + the timepoint defined in your study plan.
                    </div>
                    <h4 style="margin:16px 0 8px;color:var(--accent)">Overlapping Cohorts</h4>
                    <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px;font-size:13px">
                        <strong>Rule:</strong> Define your priority order in advance (for example, prefer larger N). Choose one and document it.
                    </div>
                    <h4 style="margin:16px 0 8px;color:var(--accent)">Multi-Arm Trials</h4>
                    <div style="background:var(--bg);padding:16px;border-radius:8px;font-size:13px">
                        <strong>Options:</strong><br>
                        1. Combine similar arms into one<br>
                        2. Split shared control N equally<br>
                        3. Select one comparison (pre-defined in study plan)
                    </div>
                </div>
            </div>
            
            <!-- Appendix I: Deviations Log -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">📝 Appendix I: Deviations Log <span class="template-badge badge-essential">ESSENTIAL</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">Record any time you do something differently from the original study plan (protocol). This change log protects transparency.</div>
                        <div class="template-story">📖 <strong>The outcome switching epidemic:</strong> A PLOS Medicine study found 31% of trials changed primary outcomes between registration and publication—always in directions that made results look better. Undocumented deviations enable this manipulation. Your log isn't confession; it's transparency. Hidden deviations are fraud; documented deviations are science.</div>
                    </div>
                    <div class="template-when"><strong>📅 When to use:</strong> Any study-plan deviation. Must be complete before submission.</div>
                    <div class="template-form">
                        <div class="form-row">
                            <label class="form-label" for="dev-id">Deviation ID</label>
                            <input type="text" class="form-input" id="dev-id" placeholder="DEV-001">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="dev-date">Date</label>
                            <input type="date" class="form-input" id="dev-date">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="dev-type">Type</label>
                            <select class="form-input" id="dev-type"><option>Select...</option><option>Eligibility change</option><option>Outcome change</option><option>Timepoint change</option><option>Analysis change</option><option>Other</option></select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="dev-what">What Changed</label>
                            <textarea class="form-textarea" id="dev-what" placeholder="Study plan said X, we did Y"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="dev-why">Why</label>
                            <textarea class="form-textarea" id="dev-why" placeholder="Justification"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="dev-impact">Impact on Primary Outcome</label>
                            <select class="form-input" id="dev-impact"><option>Select...</option><option>None</option><option>Minor</option><option>Major</option></select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="dev-approvers">Approved by</label>
                            <input type="text" class="form-input" id="dev-approvers" placeholder="Integrator + red-team reviewer">
                        </div>
                        <div class="btn-row">
                            <button class="copy-btn" onclick="generateDeviation()">Generate & Copy</button>
                            <button class="download-btn" onclick="downloadTemplate('dev')">⬇ Download .txt</button>
                        </div>
                        <div class="template-output" id="dev-output"></div>
                    </div>
                </div>
            </div>
            
            <!-- Appendix J: Clinical Summary -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🏥 Appendix J: Clinical Summary Panel <span class="template-badge badge-essential">ESSENTIAL</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">Turns statistical output into language clinicians can act on. Answers: "What does this mean for my patients?"</div>
                        <div class="template-story">📖 <strong>The translation gap:</strong> The CAST trial reported "significantly reduced PVC frequency" (surrogate). Clinicians heard "works." They didn't see "increased mortality" until 50,000 patients died. Your summary must translate relative effects (OR 0.75) into absolute terms (5 fewer deaths per 1000) and explicitly address uncertainty. Clinicians make real decisions; give them real numbers.</div>
                    </div>
                    <div class="template-when"><strong>📅 When to use:</strong> Required in final manuscript (DoD-E).</div>
                    <div class="template-form">
                        <div class="form-row">
                            <label class="form-label" for="clin-picos">1. Study Question Summary (PICOS, 2-3 lines)</label>
                            <textarea class="form-textarea" id="clin-picos" placeholder="Population: [who]&#10;Intervention: [what]&#10;Comparison: [vs what]&#10;Outcome: [measured]"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="clin-result">2. Main Result (simple wording)</label>
                            <textarea class="form-textarea" id="clin-result" placeholder="Combined result was X (95% CI Y-Z), [favoring/not favoring] intervention. I² (study-to-study differences) = X%."></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="clin-rob">3. Study Quality Risk Summary (RoB)</label>
                            <textarea class="form-textarea" id="clin-rob" placeholder="Most studies had [low/high] quality risk (RoB). Removing high-risk studies [changed/didn't change] the conclusion."></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="clin-absolute">4. Real-World Impact (if feasible)</label>
                            <textarea class="form-textarea" id="clin-absolute" placeholder="Using baseline risk X% from [source], this means Y fewer/more events per 1000 people."></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="clin-applicability">5. Applicability</label>
                            <textarea class="form-textarea" id="clin-applicability" placeholder="Results apply to [population]. May not apply to [specific groups]."></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="clin-uncertainties">6. What We Are Still Unsure About (1-3 bullets)</label>
                            <textarea class="form-textarea" id="clin-uncertainties" placeholder="• Uncertainty 1&#10;• Uncertainty 2"></textarea>
                        </div>
                        <div class="btn-row">
                            <button class="copy-btn" onclick="generateClinical()">Generate & Copy</button>
                            <button class="download-btn" onclick="downloadTemplate('clin')">⬇ Download .txt</button>
                        </div>
                        <div class="template-output" id="clin-output"></div>
                    </div>
                </div>
            </div>

            <!-- Evidence Confidence Check (GRADE) -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">⭐ Evidence Confidence Check (GRADE) <span class="template-badge badge-essential">ESSENTIAL</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">GRADE is a standard way to rate how confident you are in the evidence, from HIGH to VERY LOW. Required by Cochrane and many journals.</div>
                        <div class="template-story">📖 <strong>The Certainty Revolution:</strong> Before GRADE, meta-analyses reported p-values without context. "Statistically significant" results from biased, imprecise, indirect evidence were treated the same as robust findings. GRADE forces you to state: "How confident are we that this effect is real?" The Tamiflu review showed "significant" benefit—but GRADE revealed LOW certainty due to publication bias and outcome switching. Certainty is not statistical significance.</div>
                    </div>
                    <div class="template-when"><strong>📅 When to use:</strong> Before DoD-E (Day 38-40). Complete for primary outcome and key secondary outcomes.</div>
                    <div class="alert alert-info" style="margin-bottom:16px">
                        <div class="alert-icon">📊</div>
                        <div class="alert-content">
                            <div class="alert-title">GRADE Domains (5 checks that can lower confidence)</div>
                            <div class="alert-text">Study quality risk • Study disagreement • Indirect evidence • Wide uncertainty • Publication bias</div>
                        </div>
                    </div>
                    <div class="template-form">
                        <div class="form-row">
                            <label class="form-label" for="grade-outcome">Outcome You Are Rating</label>
                            <input type="text" class="form-input" id="grade-outcome" placeholder="e.g., Major adverse cardiac events (MACE)">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="grade-studies">Number of Studies / Participants</label>
                            <input type="text" class="form-input" id="grade-studies" placeholder="e.g., 8 RCTs, n=12,547">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="grade-effect">Main Effect Estimate</label>
                            <input type="text" class="form-input" id="grade-effect" placeholder="e.g., RR 0.65 (95% CI 0.49-0.88)">
                        </div>
                        <h4 style="margin:16px 0 8px;color:var(--accent)">Confidence Checks</h4>
                        <div class="form-row">
                            <label class="form-label" for="grade-rob">1. Study Quality Risk (RoB)</label>
                            <select class="form-input" id="grade-rob" onchange="suggestGRADE()">
                                <option value="none">No serious concern</option>
                                <option value="serious">Serious (−1)</option>
                                <option value="vserious">Very serious (−2)</option>
                            </select>
                            <input type="text" class="form-input" id="grade-rob-reason" placeholder="Reason (if downgraded)" style="margin-top:4px">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="grade-incon">2. Study Disagreement (I², prediction interval)</label>
                            <select class="form-input" id="grade-incon" onchange="suggestGRADE()">
                                <option value="none">No serious concern</option>
                                <option value="serious">Serious (−1)</option>
                                <option value="vserious">Very serious (−2)</option>
                            </select>
                            <input type="text" class="form-input" id="grade-incon-reason" placeholder="Reason (if downgraded)" style="margin-top:4px">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="grade-indirect">3. Indirectness (PICO match)</label>
                            <select class="form-input" id="grade-indirect" onchange="suggestGRADE()">
                                <option value="none">No serious concern</option>
                                <option value="serious">Serious (−1)</option>
                                <option value="vserious">Very serious (−2)</option>
                            </select>
                            <input type="text" class="form-input" id="grade-indirect-reason" placeholder="Reason (if downgraded)" style="margin-top:4px">
                        </div>
                        <!-- OIS Calculator Panel -->
                        <div class="form-row">
                            <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:8px 0" onclick="toggleOISPanel()" tabindex="0" role="button" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                                <label class="form-label" style="margin:0;cursor:pointer">📐 OIS Calculator (Optimal Information Size)</label>
                                <span class="decision-arrow" id="oisArrow">▼</span>
                            </div>
                            <div class="ois-panel" id="oisPanel">
                                <div class="help-box" style="margin-bottom:12px">
                                    <div class="help-box-text">OIS is the minimum sample size your meta-analysis needs to detect a meaningful effect. If total N is below OIS, consider downgrading imprecision in GRADE.</div>
                                </div>
                                <div class="ois-toggle-group">
                                    <button class="ois-toggle-btn active" onclick="setOISType('binary')">Binary</button>
                                    <button class="ois-toggle-btn" onclick="setOISType('continuous')">Continuous</button>
                                </div>
                                <div id="oisBinaryInputs" class="ois-inputs">
                                    <div class="ois-field"><label>Control event rate (p1)</label><input type="text" id="ois-p1" value="0.20" placeholder="e.g. 0.20"></div>
                                    <div class="ois-field"><label>Intervention event rate (p2)</label><input type="text" id="ois-p2" value="0.15" placeholder="e.g. 0.15"></div>
                                </div>
                                <div id="oisContinuousInputs" class="ois-inputs" style="display:none">
                                    <div class="ois-field"><label>Pooled SD</label><input type="text" id="ois-sd" placeholder="e.g. 10"></div>
                                    <div class="ois-field"><label>Min. important difference</label><input type="text" id="ois-delta" placeholder="e.g. 2.5"></div>
                                </div>
                                <div class="ois-inputs">
                                    <div class="ois-field"><label>Alpha (two-sided)</label><input type="text" id="ois-alpha" value="0.05"></div>
                                    <div class="ois-field"><label>Power</label><input type="text" id="ois-power" value="0.80"></div>
                                    <div class="ois-field"><label>I-squared % (optional)</label><input type="text" id="ois-i2" placeholder="e.g. 50"></div>
                                </div>
                                <button class="copy-btn" onclick="calculateOIS()" style="margin-top:8px">Calculate OIS</button>
                                <div id="oisResult"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="grade-imprec">4. Uncertainty Width (CI width, OIS) <span id="oisGradeSuggestion" style="font-weight:normal;font-size:11px;color:var(--accent)"></span></label>
                            <select class="form-input" id="grade-imprec" onchange="suggestGRADE()">
                                <option value="none">No serious concern</option>
                                <option value="serious">Serious (−1)</option>
                                <option value="vserious">Very serious (−2)</option>
                            </select>
                            <input type="text" class="form-input" id="grade-imprec-reason" placeholder="Reason (if downgraded)" style="margin-top:4px">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="grade-pubbias">5. Publication Bias (missing negative studies)</label>
                            <select class="form-input" id="grade-pubbias" onchange="suggestGRADE()">
                                <option value="none">Undetected / Unlikely</option>
                                <option value="serious">Strongly suspected (−1)</option>
                                <option value="vserious">Very strongly suspected (−2)</option>
                            </select>
                            <input type="text" class="form-input" id="grade-pubbias-reason" placeholder="Reason (if downgraded)" style="margin-top:4px">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="grade-overall">Overall Confidence Rating <span id="grade-suggestion" style="font-weight:normal;font-size:11px;color:var(--accent)"></span></label>
                            <select class="form-input" id="grade-overall">
                                <option value="high">⊕⊕⊕⊕ HIGH — Very confident this is close to the true effect</option>
                                <option value="moderate">⊕⊕⊕◯ MODERATE — Fairly confident, but true effect may differ</option>
                                <option value="low">⊕⊕◯◯ LOW — Limited confidence; true effect may be quite different</option>
                                <option value="verylow">⊕◯◯◯ VERY LOW — Very uncertain about this estimate</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="grade-summary">Plain Language Summary</label>
                            <textarea class="form-textarea" id="grade-summary" placeholder="e.g., We have moderate certainty that colchicine reduces MACE. The true effect is likely to be close to the estimated effect, but may be substantially different."></textarea>
                        </div>
                        <div class="btn-row">
                            <button class="copy-btn" onclick="generateGRADE()">Generate & Copy</button>
                            <button class="download-btn" onclick="downloadTemplate('grade')">⬇ Download .txt</button>
                        </div>
                        <div class="template-output" id="grade-output"></div>
                    </div>
                </div>
            </div>

            <!-- Appendix K: CondGO -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🚨 Appendix K: Emergency Fix Mode (CondGO) <span class="template-badge badge-emergency">EMERGENCY</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text"><strong>CondGO</strong> is Emergency Fix Mode. You get <strong>72 hours</strong> to fix a serious issue using only allowed actions. If not fixed, you stop.</div>
                        <div class="template-story">📖 <strong>The Avandia timeline:</strong> GSK saw cardiovascular signals in 2000. They chose to "watch and wait" with no deadline, no forced action. Seven years later, Nissen's meta-analysis exposed the harm. Tens of thousands were hurt. CondGO exists because "we'll deal with it eventually" kills people. 72 hours forces action or termination—no middle ground where problems fester.</div>
                    </div>
                    <div class="alert alert-danger" style="margin-bottom:16px">
                        <div class="alert-icon">⏱️</div>
                        <div class="alert-content"><div class="alert-title">72-Hour Hard Limit</div><div class="alert-text">No extensions. Make a decision before time runs out.</div></div>
                    </div>
                    <div class="template-form">
                        <div class="form-row">
                            <label class="form-label" for="condgo-trigger">Trigger</label>
                            <select class="form-input" id="condgo-trigger"><option>Select...</option><option>DoD-D failed at Day 33</option><option>Audit found ≥2 major errors</option><option>Late drift from study plan</option><option>Rerun mismatch</option></select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="condgo-start">Start Time</label>
                            <input type="datetime-local" class="form-input" id="condgo-start">
                        </div>
                        <h4 style="margin:16px 0 8px;color:var(--success)">✅ ALLOWED Actions</h4>
                        <div style="background:var(--success-light);padding:12px;border-radius:8px;margin-bottom:12px">
                            <label style="display:block;margin-bottom:8px"><input type="checkbox" id="cg-a1"> Correct extraction errors (with source citation)</label>
                            <label style="display:block;margin-bottom:8px"><input type="checkbox" id="cg-a2"> Correct effect-size conversions</label>
                            <label style="display:block;margin-bottom:8px"><input type="checkbox" id="cg-a3"> Resolve overlaps/duplicates</label>
                            <label style="display:block;margin-bottom:8px"><input type="checkbox" id="cg-a4"> Repair audit files</label>
                            <label style="display:block"><input type="checkbox" id="cg-a5"> Rerun to verify match</label>
                        </div>
                        <h4 style="margin:16px 0 8px;color:var(--danger)">❌ FORBIDDEN</h4>
                        <div style="background:var(--danger-light);padding:12px;border-radius:8px;margin-bottom:12px;font-size:13px">
                            • New outcomes or post-hoc subgrouping<br>• New bespoke models<br>• Adding new studies after freeze
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="condgo-exit">Exit Decision</label>
                            <select class="form-input" id="condgo-exit"><option>Select...</option><option>✅ PASS — Fixed</option><option>📦 Submit minimal version</option><option>🛑 Terminate (use Failure Log)</option></select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="condgo-approvers">Approvers</label>
                            <input type="text" class="form-input" id="condgo-approvers" placeholder="Integrator + other">
                        </div>
                        <div class="btn-row">
                            <button class="copy-btn" onclick="generateCondGO()">Generate & Copy</button>
                            <button class="download-btn" onclick="downloadTemplate('condgo')">⬇ Download .txt</button>
                        </div>
                        <div class="template-output" id="condgo-output"></div>
                    </div>
                </div>
            </div>
            
            <!-- Appendix L: Failure Log -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🛑 Appendix L: Failure Log (Termination) <span class="template-badge badge-emergency">EMERGENCY</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">If your project is stopped, complete this form and archive everything. This helps prevent publication bias, where only "successful" reviews get shared.</div>
                    </div>
                    <div class="template-form">
                        <div class="form-row">
                            <label class="form-label" for="fail-title">Project Title</label>
                            <input type="text" class="form-input" id="fail-title" placeholder="Title of terminated review">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="fail-date">Termination Date</label>
                            <input type="date" class="form-input" id="fail-date">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="fail-reason">Termination Reason</label>
                            <textarea class="form-textarea" id="fail-reason" placeholder="Why was project terminated?"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="fail-search">Search Strings</label>
                            <textarea class="form-textarea" id="fail-search" placeholder="All search strings used"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="fail-prisma">PRISMA Counts</label>
                            <textarea class="form-textarea" id="fail-prisma" placeholder="Identified: X&#10;Screened: X&#10;Included: X"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="fail-outcomes">Outcomes Changed After Lock?</label>
                            <select class="form-input" id="fail-outcomes"><option>No — Unchanged</option><option>Yes — Disclose</option></select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="fail-archive">Archive Location</label>
                            <input type="text" class="form-input" id="fail-archive" placeholder="OSF, Zenodo, etc. URL">
                        </div>
                        <div class="btn-row">
                            <button class="copy-btn" onclick="generateFailure()">Generate & Copy</button>
                            <button class="download-btn" onclick="downloadTemplate('fail')">⬇ Download .txt</button>
                        </div>
                        <div class="template-output" id="fail-output"></div>
                    </div>
                </div>
            </div>
            
            <!-- Appendix M: Audit-Grade Index -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">🏆 Appendix M: Trustworthiness Check (Audit-Grade Index) <span class="template-badge badge-essential">ESSENTIAL</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">9 yes/no checks. ALL must be YES to pass. This is your minimum trust standard.</div>
                    </div>
                    <div class="template-when"><strong>📅 When to use:</strong> Before DoD-E (Day 40). All 9 must pass.</div>
                    <table class="ref-table" style="margin-top:16px">
                        <thead><tr><th>#</th><th>Requirement</th><th>Auto-tracked?</th></tr></thead>
                        <tbody>
                            <tr><td>1</td><td>Study plan registered (PROSPERO/protocols.io) before search</td><td>✓</td></tr>
                            <tr><td>2</td><td>PRISMA flow counts entered (included > 0)</td><td>✓</td></tr>
                            <tr><td>3</td><td>DoD-A: Study Plan Lock signed off</td><td>✓</td></tr>
                            <tr><td>4</td><td>DoD-B: Search Lock signed off</td><td>✓</td></tr>
                            <tr><td>5</td><td>Audit 1 (Trace Audit) template completed</td><td>✓</td></tr>
                            <tr><td>6</td><td>DoD-C: Extraction Lock signed off</td><td>✓</td></tr>
                            <tr><td>7</td><td>Audit 2 (Rerun Verification) template completed</td><td>✓</td></tr>
                            <tr><td>8</td><td>Evidence confidence check (GRADE) completed</td><td>✓</td></tr>
                            <tr><td>9</td><td>Clinical Summary Panel completed</td><td>✓</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Appendix N: Standards Mapping -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">📊 Appendix N: Standards Crosswalk (Simple View) <span class="template-badge badge-reference">REFERENCE</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">Shows how each META-SPRINT part maps to major quality standards (PRISMA, AMSTAR2, ROBIS).</div>
                    </div>
                    <table class="ref-table" style="margin-top:16px">
                        <thead><tr><th>META-SPRINT Component</th><th>Standard Domain</th></tr></thead>
                        <tbody>
                            <tr><td>Study-plan lock + deviation log</td><td>PRISMA transparency; AMSTAR2 protocol; ROBIS process bias</td></tr>
                            <tr><td>Search log + study-flow (PRISMA) counts</td><td>PRISMA completeness; ROBIS selection bias</td></tr>
                            <tr><td>Key-field verification + red-team</td><td>ROBIS data collection bias</td></tr>
                            <tr><td>Study quality risk (RoB) + sensitivity analysis</td><td>AMSTAR2 critical domain; ROBIS synthesis</td></tr>
                            <tr><td>Evidence confidence check (GRADE)</td><td>GRADE framework; required by Cochrane; journal standard</td></tr>
                            <tr><td>Rerun match checks</td><td>Reproducibility</td></tr>
                            <tr><td>Freeze + Emergency Fix Mode (CondGO) + failure archive</td><td>Reduces late drift and selective discontinuation</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- NEW: Publication Bias Assessment Template -->
            <div class="template-card">
                <div class="template-header" tabindex="0" role="button" aria-expanded="false" onclick="toggleTemplate(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                    <div class="template-name">📉 Missing-Study Bias Check (Publication Bias) <span class="template-badge badge-essential">ESSENTIAL</span></div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="template-body">
                    <div class="template-explain">
                        <div class="template-explain-title">🤔 What is this?</div>
                        <div class="template-explain-text">A checklist to check whether missing unpublished studies may be skewing your result. Uses funnel plots and simple statistical tests.</div>
                        <div class="template-story">📖 <strong>The antidepressant scandal:</strong> In 2008, Turner et al. showed that 94% of published antidepressant trials were positive, but FDA data revealed only 51% were actually positive. Selective publication inflated apparent efficacy by 32%. Your funnel plot and Egger's test help detect if your meta-analysis suffers from the same distortion.</div>
                    </div>
                    <div class="template-when"><strong>📅 When to use:</strong> During DoD-D (analysis phase) when you have ≥10 studies. Required for the GRADE publication-bias check.</div>

                    <div class="alert alert-info" style="margin-bottom:16px">
                        <div class="alert-icon">📊</div>
                        <div class="alert-content">
                            <div class="alert-title">Minimum Study Count</div>
                            <div class="alert-text">Funnel plots are weak with fewer than 10 studies. Egger's test also needs ≥10 studies. If fewer, report that limitation.</div>
                        </div>
                    </div>

                    <div class="template-form">
                        <h4 style="margin:0 0 12px;color:var(--accent)">Step 1: Funnel Plot Visual Check</h4>
                        <div class="form-row">
                            <label class="form-label" for="pb-nstudies">Number of studies in funnel plot</label>
                            <input type="number" class="form-input" id="pb-nstudies" min="0" placeholder="e.g., 15">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="pb-symmetry">Funnel plot shape</label>
                            <select class="form-input" id="pb-symmetry">
                                <option value="">Select assessment...</option>
                                <option value="symmetric">Balanced shape — No clear visual bias</option>
                                <option value="minor">Slightly unbalanced — Possible small-study effects</option>
                                <option value="major">Clearly unbalanced — Likely missing-study bias</option>
                                <option value="unclear">Unclear — Insufficient studies to judge</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="pb-visual">Visual notes</label>
                            <textarea class="form-textarea" id="pb-visual" placeholder="Describe what you see:&#10;• Are small studies balanced on both sides?&#10;• Any obvious gaps?&#10;• Any outliers?"></textarea>
                        </div>

                        <h4 style="margin:16px 0 12px;color:var(--accent)">Step 2: Statistical Check</h4>
                        <div class="form-row">
                            <label class="form-label" for="pb-egger">Egger's test result</label>
                            <select class="form-input" id="pb-egger">
                                <option value="">Select result...</option>
                                <option value="ns">Not significant (p > 0.10) — No clear asymmetry signal</option>
                                <option value="sig">Significant (p ≤ 0.10) — Asymmetry signal present</option>
                                <option value="na">Not applicable (<10 studies)</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="pb-pvalue">Egger's test p-value (if applicable)</label>
                            <input type="text" class="form-input" id="pb-pvalue" placeholder="e.g., 0.23">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="pb-othertests">Other tests performed (optional)</label>
                            <textarea class="form-textarea" id="pb-othertests" placeholder="e.g., Begg's test: p = 0.15&#10;Trim-and-fill: 2 imputed studies&#10;Peters' test for binary outcomes: p = 0.08"></textarea>
                        </div>

                        <h4 style="margin:16px 0 12px;color:var(--accent)">Step 3: GRADE Rating</h4>
                        <div class="form-row">
                            <label class="form-label" for="pb-grade">GRADE Publication Bias domain rating</label>
                            <select class="form-input" id="pb-grade">
                                <option value="">Select rating...</option>
                                <option value="none">No serious concern — Balanced plot and non-significant tests</option>
                                <option value="serious">Serious concern — Unbalanced plot OR significant test</option>
                                <option value="veryserious">Very serious concern — Unbalanced plot AND significant test</option>
                                <option value="undetected">Undetected — <10 studies, cannot assess</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="pb-justify">Justification for rating</label>
                            <textarea class="form-textarea" id="pb-justify" placeholder="Explain your rating:&#10;• What evidence supports this conclusion?&#10;• Any mitigating factors?"></textarea>
                        </div>

                        <h4 style="margin:16px 0 12px;color:var(--accent)">Step 4: Sensitivity Check (if bias detected)</h4>
                        <div class="form-row">
                            <label class="form-label" for="pb-trimfill">Trim-and-fill adjustment (if applicable)</label>
                            <textarea class="form-textarea" id="pb-trimfill" placeholder="Studies imputed: X&#10;Adjusted effect: [OR/RR/MD] (95% CI)&#10;Change from original: [describe]"></textarea>
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="pb-impact">Impact on conclusion</label>
                            <select class="form-input" id="pb-impact">
                                <option value="">Select impact...</option>
                                <option value="unchanged">Conclusions unchanged after adjustment</option>
                                <option value="attenuated">Effect attenuated but remains significant</option>
                                <option value="changed">Effect no longer significant after adjustment</option>
                                <option value="na">Not applicable — No bias detected</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <label class="form-label" for="pb-assessor">Assessor</label>
                            <input type="text" class="form-input" id="pb-assessor" placeholder="Your name">
                        </div>
                        <div class="form-row">
                            <label class="form-label" for="pb-date">Date</label>
                            <input type="date" class="form-input" id="pb-date">
                        </div>

                        <div class="btn-row">
                            <button class="copy-btn" onclick="generatePubBias()">Generate & Copy</button>
                            <button class="download-btn" onclick="downloadTemplate('pubbias')">⬇ Download .txt</button>
                        </div>
                        <div class="template-output" id="pb-output"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PICO SEARCH BUILDER PAGE -->
        <div class="page" id="page-search" role="tabpanel">
            <div class="help-box">
                <div class="help-box-title">🔍 PICO-to-Search Builder</div>
                <div class="help-box-text">Define your Population, Intervention, Comparator, and Outcome terms. Add synonyms and MeSH/Emtree terms. The builder generates database-specific Boolean search strings for PubMed, Embase, and Cochrane Library.</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">PICO Elements</div>
                    <div class="extraction-toolbar">
                        <button class="copy-btn" onclick="clearSearchBuilder()">Clear All</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="sb-toggle-row">
                        <label><input type="checkbox" id="sb-includeC" checked onchange="updateSearchPreview()"> Include Comparator</label>
                        <label><input type="checkbox" id="sb-includeO" checked onchange="updateSearchPreview()"> Include Outcome</label>
                    </div>
                    <div class="sb-elements">
                        <div class="sb-element-card">
                            <div class="sb-element-header"><div class="sb-element-label sb-label-p">P</div><div class="sb-element-title">Population</div></div>
                            <div class="sb-field"><label>Main term</label><input type="text" id="sb-p-main" placeholder="e.g. heart failure" oninput="updateSearchPreview()"></div>
                            <div class="sb-field"><label>Synonyms (one per line)</label><textarea id="sb-p-syn" placeholder="cardiac failure&#10;CHF&#10;ventricular dysfunction" oninput="updateSearchPreview()"></textarea></div>
                            <div class="sb-field"><label>MeSH / Emtree terms (one per line)</label><textarea id="sb-p-mesh" placeholder="Heart Failure&#10;Ventricular Dysfunction" oninput="updateSearchPreview()"></textarea></div>
                        </div>
                        <div class="sb-element-card">
                            <div class="sb-element-header"><div class="sb-element-label sb-label-i">I</div><div class="sb-element-title">Intervention</div></div>
                            <div class="sb-field"><label>Main term</label><input type="text" id="sb-i-main" placeholder="e.g. SGLT2 inhibitor" oninput="updateSearchPreview()"></div>
                            <div class="sb-field"><label>Synonyms (one per line)</label><textarea id="sb-i-syn" placeholder="empagliflozin&#10;dapagliflozin&#10;canagliflozin" oninput="updateSearchPreview()"></textarea></div>
                            <div class="sb-field"><label>MeSH / Emtree terms (one per line)</label><textarea id="sb-i-mesh" placeholder="Sodium-Glucose Transporter 2 Inhibitors" oninput="updateSearchPreview()"></textarea></div>
                        </div>
                        <div class="sb-element-card">
                            <div class="sb-element-header"><div class="sb-element-label sb-label-c">C</div><div class="sb-element-title">Comparator</div></div>
                            <div class="sb-field"><label>Main term</label><input type="text" id="sb-c-main" placeholder="e.g. placebo" oninput="updateSearchPreview()"></div>
                            <div class="sb-field"><label>Synonyms (one per line)</label><textarea id="sb-c-syn" placeholder="control&#10;sham&#10;usual care" oninput="updateSearchPreview()"></textarea></div>
                            <div class="sb-field"><label>MeSH / Emtree terms (one per line)</label><textarea id="sb-c-mesh" placeholder="" oninput="updateSearchPreview()"></textarea></div>
                        </div>
                        <div class="sb-element-card">
                            <div class="sb-element-header"><div class="sb-element-label sb-label-o">O</div><div class="sb-element-title">Outcome</div></div>
                            <div class="sb-field"><label>Main term</label><input type="text" id="sb-o-main" placeholder="e.g. mortality" oninput="updateSearchPreview()"></div>
                            <div class="sb-field"><label>Synonyms (one per line)</label><textarea id="sb-o-syn" placeholder="death&#10;survival&#10;all-cause mortality" oninput="updateSearchPreview()"></textarea></div>
                            <div class="sb-field"><label>MeSH / Emtree terms (one per line)</label><textarea id="sb-o-mesh" placeholder="Mortality" oninput="updateSearchPreview()"></textarea></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Generated Search Strings</div>
                    <div class="extraction-toolbar">
                        <button class="copy-btn" onclick="downloadAllSearchStrings()">⬇ Download All (.txt)</button>
                    </div>
                </div>
                <div class="card-body sb-output-section">
                    <div class="sb-db-panel">
                        <div class="sb-db-header"><span class="sb-db-label">PubMed</span><button class="copy-btn" onclick="copySearchString('pubmed')">Copy</button></div>
                        <div class="sb-output-text" id="sb-output-pubmed">Enter PICO terms above to generate search string...</div>
                    </div>
                    <div class="sb-db-panel">
                        <div class="sb-db-header"><span class="sb-db-label">Embase (Ovid)</span><button class="copy-btn" onclick="copySearchString('embase')">Copy</button></div>
                        <div class="sb-output-text" id="sb-output-embase">Enter PICO terms above to generate search string...</div>
                    </div>
                    <div class="sb-db-panel">
                        <div class="sb-db-header"><span class="sb-db-label">Cochrane Library</span><button class="copy-btn" onclick="copySearchString('cochrane')">Copy</button></div>
                        <div class="sb-output-text" id="sb-output-cochrane">Enter PICO terms above to generate search string...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- REFERENCE PAGE -->
        <div class="page" id="page-reference" role="tabpanel">
            <div class="card">
                <div class="card-header"><div class="card-title">Effect Measure Edge Cases (§11)</div></div>
                <div class="card-body">
                    <div class="help-box">
                        <div class="help-box-title">📐 When data isn't straightforward</div>
                        <div class="help-box-text">Decide your rule at DoD-A (Checkpoint A) and apply it consistently.</div>
                    </div>
                    <h4 style="margin:16px 0 8px">Primary Effect Measures</h4>
                    <table class="ref-table">
                        <thead><tr><th>Outcome Type</th><th>Options</th></tr></thead>
                        <tbody>
                            <tr><td>Binary</td><td>Risk Ratio (RR) or Odds Ratio (OR)</td></tr>
                            <tr><td>Continuous</td><td>Mean Difference (MD) or Standardized MD (SMD)</td></tr>
                            <tr><td>Time-to-event</td><td>Hazard Ratio (HR)</td></tr>
                        </tbody>
                    </table>
                    <h4 style="margin:16px 0 8px">Zero Cells</h4>
                    <div style="background:var(--bg);padding:12px;border-radius:8px;font-size:13px">Default: Add 0.5 correction when any cell is zero.</div>
                    <h4 style="margin:16px 0 8px">Missing SDs</h4>
                    <div style="background:var(--bg);padding:12px;border-radius:8px;font-size:13px">
                        Option 1: Calculate from SE/CI/p-values<br>
                        Option 2: Estimate from pooled SD (document this)<br>
                        Option 3: Exclude (document impact)<br>
                        <strong>Always run a sensitivity check excluding estimated values.</strong>
                    </div>
                    <h4 style="margin:16px 0 8px">Medians/IQR</h4>
                    <div style="background:var(--bg);padding:12px;border-radius:8px;font-size:13px">Default: Do NOT convert unless pre-specified. If converted, run a sensitivity check excluding converted values.</div>
                    <h4 style="margin:16px 0 8px">Adjusted vs Unadjusted (Observational)</h4>
                    <div style="background:var(--bg);padding:12px;border-radius:8px;font-size:13px">If including observational studies: define your preference order in advance (for example, adjusted preferred) and apply it consistently. Document in extraction notes.</div>
                </div>
            </div>

            <!-- Forest Plot Interpretation Guide -->
            <div class="card">
                <div class="card-header"><div class="card-title">📊 Forest Plot Guide (Simple Read)</div></div>
                <div class="card-body">
                    <div class="help-box">
                        <div class="help-box-title">🌲 Reading a Forest Plot</div>
                        <div class="help-box-text">A forest plot shows each study's result and the combined result. Use this to read it quickly.</div>
                    </div>

                    <div class="forest-guide">
                        <div class="forest-guide-title">Visual Example (ASCII)</div>
                        <div class="forest-diagram">
                                          Favors Control    Favors Treatment
                                                │
Study A      ────────[■]────────               │    0.65 [0.42, 1.01]
Study B            ──[■■]──                    │    0.78 [0.61, 0.99]*
Study C     ─────────[■]─────────              │    0.91 [0.55, 1.50]
Study D               [■■■]                    │    0.72 [0.58, 0.89]*
Study E          ────[■]────                   │    0.85 [0.64, 1.13]
                                               │
POOLED            ──[◆◆]──                     │    0.77 [0.67, 0.88]*
                  ──────────────────┼──────────────────
                               0.5  │  1.0  │  1.5   2.0
                                    │ (null)
                        </div>
                        <div class="forest-legend">
                            <div class="forest-legend-item"><span class="forest-legend-symbol">â– </span> Study effect (size = weight)</div>
                            <div class="forest-legend-item"><span class="forest-legend-symbol">───</span> 95% Confidence Interval</div>
                            <div class="forest-legend-item"><span class="forest-legend-symbol">â—†</span> Pooled estimate (diamond)</div>
                            <div class="forest-legend-item"><span class="forest-legend-symbol">│</span> Line of no effect (null)</div>
                            <div class="forest-legend-item"><span class="forest-legend-symbol">*</span> Statistically significant</div>
                        </div>
                    </div>

                    <h4 style="margin:16px 0 8px">Key Interpretation Points</h4>
                    <table class="ref-table">
                        <thead><tr><th>Element</th><th>What to Look For</th></tr></thead>
                        <tbody>
                            <tr><td><strong>Direction</strong></td><td>Which side of the null line? Left = favors control/intervention depending on outcome</td></tr>
                            <tr><td><strong>Precision</strong></td><td>Narrow CI = more precise. Wide CI = uncertain. Diamond width shows pooled precision</td></tr>
                            <tr><td><strong>Significance</strong></td><td>CI crosses the null line = not statistically significant. CI does not cross = statistically significant</td></tr>
                            <tr><td><strong>Study-to-study differences</strong></td><td>How spread out are studies? Check I². Above 50% often means substantial differences</td></tr>
                            <tr><td><strong>Influential studies</strong></td><td>Large squares = high weight. Do they drive the result? Run leave-one-out</td></tr>
                        </tbody>
                    </table>

                    <h4 style="margin:16px 0 8px">Common Pitfalls</h4>
                    <div style="background:var(--danger-light);padding:12px;border-radius:8px;font-size:13px;border:1px solid var(--danger)">
                        <strong>❌ Don't:</strong><br>
                        • Confuse statistical significance with real clinical importance<br>
                        • Ignore studies with wide CIs (they still contribute information)<br>
                        • Over-interpret subgroup analyses (often underpowered)<br>
                        • Forget to check the scale (log vs linear)
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><div class="card-title">Checkpoint (DoD) Checklists (Full)</div></div>
                <div class="card-body">
                    <h4 style="color:var(--purple)">DoD-A: Study Plan Lock (Days 1-3)</h4>
                    <ul style="margin-left:20px;margin-bottom:16px;font-size:13px">
                        <li>PICOS + inclusion/exclusion</li>
                        <li>Primary outcome (metric, direction, effect measure)</li>
                        <li>Timepoint rule</li>
                        <li>Model choice (fixed/random)</li>
                        <li>Sensitivity set (min: fixed vs random, leave-one-out)</li>
                        <li>Secondary outcomes labelled exploratory</li>
                        <li>Emergency Fix Mode (CondGO) triggers embedded</li>
                        <li><strong>Study plan registered on PROSPERO/protocols.io</strong></li>
                        <li>Signed by Integrator + one non-integrator</li>
                    </ul>
                    <h4 style="color:var(--accent)">DoD-B: Search Lock (Days 4-10)</h4>
                    <ul style="margin-left:20px;margin-bottom:16px;font-size:13px">
                        <li>Search strings saved verbatim</li>
                        <li>Search dates + limits recorded</li>
                        <li>Dedup method recorded</li>
                        <li>Screening alignment check completed</li>
                        <li>Study-flow (PRISMA) counts live</li>
                        <li>Screening log exportable</li>
                    </ul>
                    <h4 style="color:var(--warning)">DoD-C: Extraction Lock (Days 11-28)</h4>
                    <ul style="margin-left:20px;margin-bottom:16px;font-size:13px">
                        <li>Extraction template frozen</li>
                        <li>Study quality risk tool (RoB) + decision rules written</li>
                        <li>Key fields verified by second person</li>
                        <li>Overlap rules applied</li>
                        <li>Disagreement resolution process active</li>
                    </ul>
                    <h4 style="color:var(--success)">DoD-D: Analysis Lock (Days 29-33)</h4>
                    <ul style="margin-left:20px;margin-bottom:16px;font-size:13px">
                        <li>Capsule runs end-to-end</li>
                        <li>Forest plot + study-difference (I²) outputs</li>
                        <li>Sensitivity set executed</li>
                        <li>Influential study decisions documented</li>
                        <li>Audit 2 completed</li>
                        <li>Rerun match criteria satisfied</li>
                    </ul>
                    <h4 style="color:var(--danger)">DoD-E: Submission Lock (Days 34-40)</h4>
                    <ul style="margin-left:20px;font-size:13px">
                        <li>Study-flow (PRISMA) checklist complete</li>
                        <li>All appendices complete</li>
                        <li>Two reruns match</li>
                        <li>Clinical Summary Panel included</li>
                        <li>Deviations log complete</li>
                        <li>Evidence confidence check (GRADE) completed</li>
                        <li>Trustworthiness check: 9/9</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><div class="card-title">Role Responsibilities</div></div>
                <div class="card-body">
                    <table class="ref-table">
                        <thead><tr><th>Role</th><th>#</th><th>Responsibilities</th></tr></thead>
                        <tbody>
                            <tr><td><strong>Integrator</strong></td><td>1</td><td>Timeline, gates, audit pack, submission, arbitration</td></tr>
                            <tr><td><strong>Deputy</strong></td><td>1</td><td>Decision queue, minor approvals (rotates weekly)</td></tr>
                            <tr><td><strong>Search & Screen</strong></td><td>2</td><td>Search, dedup, title/abstract screening, PRISMA</td></tr>
                            <tr><td><strong>Full-Text</strong></td><td>2</td><td>Retrieval, inclusion, exclusion reasons</td></tr>
                            <tr><td><strong>Extraction & Quality Risk (RoB)</strong></td><td>5</td><td>Data extraction, RoB, field verification</td></tr>
                            <tr><td><strong>Analysis & Write</strong></td><td>1</td><td>Analysis run package (capsule), manuscript, writing coordination</td></tr>
                        </tbody>
                    </table>
                    <p style="margin-top:12px;font-size:13px;color:var(--text-secondary)"><strong>Red-team:</strong> 2 people/day rotating from non-integrator roles.</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><div class="card-title">Scope Boundaries</div></div>
                <div class="card-body">
                    <h4 style="color:var(--success)">✅ META-SPRINT is FOR:</h4>
                    <ul style="margin-left:20px;margin-bottom:16px;font-size:13px">
                        <li>40-60 included studies</li>
                        <li>Standard effect sizes (OR, RR, HR, MD, SMD)</li>
                        <li>No IPD</li>
                        <li>Extraction from publications</li>
                    </ul>
                    <h4 style="color:var(--danger)">❌ NOT FOR (use dedicated variant apps instead):</h4>
                    <ul style="margin-left:20px;font-size:13px">
                        <li>Network meta-analysis (use META-SPRINT NMA)</li>
                        <li>IPD meta-analysis (use META-SPRINT IPD)</li>
                        <li>Living systematic reviews (use META-SPRINT Living)</li>
                        <li>Complex non-prespecified corrections</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- HELP PAGE -->
        <div class="page" id="page-help" role="tabpanel">
            <div class="quick-start">
                <div class="quick-start-title">âš¡ Quick Start</div>
                <div class="quick-start-grid">
                    <div class="quick-start-item"><div class="quick-start-key">← →</div><div class="quick-start-desc">Navigate days</div></div>
                    <div class="quick-start-item"><div class="quick-start-key">Ctrl+Z</div><div class="quick-start-desc">Undo checkbox</div></div>
                    <div class="quick-start-item"><div class="quick-start-key">⚙️</div><div class="quick-start-desc">Settings & sync</div></div>
                    <div class="quick-start-item"><div class="quick-start-key">📋 Today</div><div class="quick-start-desc">Your daily tasks</div></div>
                </div>
            </div>

            <!-- Interactive Tutorial -->
            <div class="tutorial-section" id="tutorialSection">
                <div class="tutorial-title">📚 Step-by-Step Tutorial</div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Complete these steps to master META-SPRINT. Click each step to mark as done.</p>
                <div class="tutorial-steps">
                    <div class="tutorial-step" onclick="toggleTutorialStep(this)" data-step="tut-1">
                        <div class="tutorial-step-num"></div>
                        <div class="tutorial-step-content">
                            <div class="tutorial-step-title">Register your study plan</div>
                            <div class="tutorial-step-desc">Go to PROSPERO or protocols.io and register your systematic review study plan (protocol). This is required for DoD-A.</div>
                            <div class="tutorial-step-action">→ Paste link in the Today page Study Plan Registration box</div>
                        </div>
                    </div>
                    <div class="tutorial-step" onclick="toggleTutorialStep(this)" data-step="tut-2">
                        <div class="tutorial-step-num"></div>
                        <div class="tutorial-step-content">
                            <div class="tutorial-step-title">Explore the Checkpoints tab</div>
                            <div class="tutorial-step-desc">Review all 5 Definition of Done checkpoints (A-E). Understand what is required at each one.</div>
                            <div class="tutorial-step-action">→ Go to Checkpoints (DoD) tab and read the DoD-A checklist</div>
                        </div>
                    </div>
                    <div class="tutorial-step" onclick="toggleTutorialStep(this)" data-step="tut-3">
                        <div class="tutorial-step-num"></div>
                        <div class="tutorial-step-content">
                            <div class="tutorial-step-title">Browse the Templates</div>
                            <div class="tutorial-step-desc">Familiarize yourself with the 15 templates. The Consult Pack (Appendix A) and Red-Team Micro-Check (Appendix C) are essential.</div>
                            <div class="tutorial-step-action">→ Open Templates tab and expand Appendix A</div>
                        </div>
                    </div>
                    <div class="tutorial-step" onclick="toggleTutorialStep(this)" data-step="tut-4">
                        <div class="tutorial-step-num"></div>
                        <div class="tutorial-step-content">
                            <div class="tutorial-step-title">Understand the Timeline</div>
                            <div class="tutorial-step-desc">See how the 40 days break into phases. Note key milestones: checkpoints, audits, and the Day 34 freeze.</div>
                            <div class="tutorial-step-action">→ Go to Timeline tab and review the weekly breakdown</div>
                        </div>
                    </div>
                    <div class="tutorial-step" onclick="toggleTutorialStep(this)" data-step="tut-5">
                        <div class="tutorial-step-num"></div>
                        <div class="tutorial-step-content">
                            <div class="tutorial-step-title">Set up the Study Flow (PRISMA)</div>
                            <div class="tutorial-step-desc">Enter your initial database search counts. Update these as screening progresses.</div>
                            <div class="tutorial-step-action">→ Go to PRISMA tab and enter "Records from databases"</div>
                        </div>
                    </div>
                    <div class="tutorial-step" onclick="toggleTutorialStep(this)" data-step="tut-6">
                        <div class="tutorial-step-num"></div>
                        <div class="tutorial-step-content">
                            <div class="tutorial-step-title">Check the Glossary</div>
                            <div class="tutorial-step-desc">Look up any unfamiliar terms like "Emergency Fix Mode (CondGO)", "Red-Team", "WIP limit", or "Influential study".</div>
                            <div class="tutorial-step-action">→ Go to Glossary tab and search for "CondGO"</div>
                        </div>
                    </div>
                    <div class="tutorial-step" onclick="toggleTutorialStep(this)" data-step="tut-7">
                        <div class="tutorial-step-num"></div>
                        <div class="tutorial-step-content">
                            <div class="tutorial-step-title">Set up team sync (if multi-person)</div>
                            <div class="tutorial-step-desc">Use Settings → Team Sync to share progress with collaborators via sync codes.</div>
                            <div class="tutorial-step-action">→ Click ⚙️ Settings and try "Generate Sync Code"</div>
                        </div>
                    </div>
                    <div class="tutorial-step" onclick="toggleTutorialStep(this)" data-step="tut-8">
                        <div class="tutorial-step-num"></div>
                        <div class="tutorial-step-content">
                            <div class="tutorial-step-title">Complete Day 1 tasks</div>
                            <div class="tutorial-step-desc">Check off all Day 1 items in Today's task list. These set up your study plan foundation.</div>
                            <div class="tutorial-step-action">→ Return to Today tab and complete all checkboxes</div>
                        </div>
                    </div>
                </div>
                <div class="tutorial-progress">
                    <div class="tutorial-progress-bar"><div class="tutorial-progress-fill" id="tutorialProgressFill" style="width:0%"></div></div>
                    <div class="tutorial-progress-text" id="tutorialProgressText">0/8 completed</div>
                </div>
                <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
                    <button class="download-btn" onclick="resetTutorialProgress()" style="font-size:12px">↺ Reset Progress</button>
                    <button class="download-btn" onclick="showWizard()" style="font-size:12px">🚀 Show Welcome Wizard</button>
                </div>
            </div>

            <div class="help-box">
                <div class="help-box-title">🆘 Decision Trees</div>
                <div class="help-box-text">Click a scenario for step-by-step guidance.</div>
            </div>

            <div class="decision-scenario" onclick="toggleDecision(this)">
                <div class="decision-header" tabindex="0" role="button" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.parentElement.click()}">
                    <div class="decision-icon">🔢</div>
                    <div class="decision-title">I found a data error in extraction</div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="decision-body">
                    <div class="decision-step"><div class="step-num-small">1</div><div>Is it a key field that affects results? If not, fix and move on.</div></div>
                    <div class="decision-step"><div class="step-num-small">2</div><div>Fix with source citation (cite the correct source).</div></div>
                    <div class="decision-step"><div class="step-num-small">3</div><div>Log correction in change log.</div></div>
                    <div class="decision-step"><div class="step-num-small">4</div><div>If high-impact study, notify Integrator.</div></div>
                    <div class="decision-allowed"><div class="decision-label">✅ Allowed</div>Fix errors, correct conversions, add source citation</div>
                    <div class="decision-forbidden"><div class="decision-label">❌ Forbidden</div>Change outcome definition, change timepoint rules</div>
                </div>
            </div>
            
            <div class="decision-scenario" onclick="toggleDecision(this)">
                <div class="decision-header" tabindex="0" role="button" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.parentElement.click()}">
                    <div class="decision-icon">🚫</div>
                    <div class="decision-title">A checkpoint (DoD gate) failed</div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="decision-body">
                    <div class="decision-step"><div class="step-num-small">1</div><div>Identify which items failed.</div></div>
                    <div class="decision-step"><div class="step-num-small">2</div><div>If fixable in ≤24h: Fix it, re-check.</div></div>
                    <div class="decision-step"><div class="step-num-small">3</div><div>If Day 33+ and DoD-D fails: trigger Emergency Fix Mode (CondGO).</div></div>
                    <div class="decision-step"><div class="step-num-small">4</div><div>In Emergency Fix Mode: 72h to fix or decide to stop.</div></div>
                    <div class="decision-allowed"><div class="decision-label">✅ Allowed</div>Pause, fix issues, use Emergency Fix Mode if late</div>
                    <div class="decision-forbidden"><div class="decision-label">❌ Forbidden</div>Skip gate, proceed without PASS</div>
                </div>
            </div>
            
            <div class="decision-scenario" onclick="toggleDecision(this)">
                <div class="decision-header" tabindex="0" role="button" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.parentElement.click()}">
                    <div class="decision-icon">🔍</div>
                    <div class="decision-title">Audit found problems</div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="decision-body">
                    <div class="decision-step"><div class="step-num-small">1</div><div>Count major errors.</div></div>
                    <div class="decision-step"><div class="step-num-small">2</div><div>≤1 error, no drift: PASS. Fix and continue.</div></div>
                    <div class="decision-step"><div class="step-num-small">3</div><div>≥2 errors OR drift: FAIL → Emergency Fix Mode (CondGO).</div></div>
                    <div class="decision-allowed"><div class="decision-label">✅ Allowed</div>Correct all errors, expand audit if needed</div>
                    <div class="decision-forbidden"><div class="decision-label">❌ Forbidden</div>Ignore findings, selectively fix</div>
                </div>
            </div>
            
            <div class="decision-scenario" onclick="toggleDecision(this)">
                <div class="decision-header" tabindex="0" role="button" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.parentElement.click()}">
                    <div class="decision-icon">🔄</div>
                    <div class="decision-title">Rerun results don't match</div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="decision-body">
                    <div class="decision-step"><div class="step-num-small">1</div><div>Within tolerance (≤0.001, 1% I²)? → PASS</div></div>
                    <div class="decision-step"><div class="step-num-small">2</div><div>Classify mismatch: rounding, data input, or code?</div></div>
                    <div class="decision-step"><div class="step-num-small">3</div><div>Fix source. Rerun both.</div></div>
                    <div class="decision-step"><div class="step-num-small">4</div><div>If Day 33+ and unresolved: Emergency Fix Mode (CondGO).</div></div>
                    <div class="decision-allowed"><div class="decision-label">✅ Allowed</div>Debug, fix data entry, document changes</div>
                    <div class="decision-forbidden"><div class="decision-label">❌ Forbidden</div>Pick better-looking result, proceed without resolution</div>
                </div>
            </div>
            
            <div class="decision-scenario" onclick="toggleDecision(this)">
                <div class="decision-header" tabindex="0" role="button" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.parentElement.click()}">
                    <div class="decision-icon">📚</div>
                    <div class="decision-title">Found new study after freeze (Day 34+)</div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="decision-body">
                    <div class="decision-step"><div class="step-num-small">1</div><div>Was it pre-logged as "pending retrieval"?</div></div>
                    <div class="decision-step"><div class="step-num-small">2</div><div>YES: Get Integrator approval + change log. Include.</div></div>
                    <div class="decision-step"><div class="step-num-small">3</div><div>NO (truly new): Cannot add. Note as limitation.</div></div>
                    <div class="decision-allowed"><div class="decision-label">✅ Allowed</div>Include pre-logged pending, note new as limitation</div>
                    <div class="decision-forbidden"><div class="decision-label">❌ Forbidden</div>Add truly new study, backdate discovery</div>
                </div>
            </div>
            
            <div class="decision-scenario" onclick="toggleDecision(this)">
                <div class="decision-header" tabindex="0" role="button" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.parentElement.click()}">
                    <div class="decision-icon">👥</div>
                    <div class="decision-title">Two studies share same patients</div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="decision-body">
                    <div class="decision-step"><div class="step-num-small">1</div><div>Confirm overlap (same trial reg? acknowledged?)</div></div>
                    <div class="decision-step"><div class="step-num-small">2</div><div>Check your study plan's pre-defined priority rule.</div></div>
                    <div class="decision-step"><div class="step-num-small">3</div><div>Apply consistently. Document.</div></div>
                    <div class="decision-allowed"><div class="decision-label">✅ Allowed</div>Follow study plan rule, use one dataset</div>
                    <div class="decision-forbidden"><div class="decision-label">❌ Forbidden</div>Include both (double-counting), pick based on better result</div>
                </div>
            </div>
        </div>

        <!-- GLOSSARY PAGE -->
        <div class="page" id="page-glossary" role="tabpanel">
            <div class="card">
                <div class="card-header"><div class="card-title">Glossary — Plain English</div></div>
                <div class="card-body" style="padding:0">
                    <div class="glossary-search">
                        <input type="text" class="glossary-search-input" id="glossarySearch" placeholder="Search glossary terms..." oninput="filterGlossary()">
                    </div>
                    <div id="glossaryItems">
                    <div class="glossary-item">
                        <div class="glossary-term">Checkpoint (DoD: Definition of Done)</div>
                        <div class="glossary-plain">A must-pass checklist before moving to the next phase. It is pass/fail, not partial credit.</div>
                        <div class="glossary-technical">Short note: mandatory phase gate.</div>
                        <div class="glossary-story">📖 The CAST lesson: "Almost done" with protocol isn't done. Incomplete PICOS led to surrogate outcomes being trusted—50,000 died. Gates exist because partial work kills.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Emergency Fix Mode (CondGO)</div>
                        <div class="glossary-plain">A 72-hour emergency window to fix serious problems using only allowed repairs.</div>
                        <div class="glossary-technical">Short note: time-limited rescue protocol.</div>
                        <div class="glossary-story">📖 Without CondGO, teams either ignore problems or stop everything. The Avandia timeline shows what happens when problems are ignored: 7 years of silence, then disaster. CondGO forces immediate, bounded action.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">WIP Limit</div>
                        <div class="glossary-plain">You can only work on 2 things at once. Finish one before starting another.</div>
                        <div class="glossary-technical">Short note: max 2 active tasks per person.</div>
                        <div class="glossary-story">📖 Context-switching causes errors. The Poldermans fraud spread across 90+ papers because verification was "in progress" on too many fronts. Focus prevents fraud from hiding in complexity.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Influential Study</div>
                        <div class="glossary-plain">A study that strongly affects your result, usually because it is large or precise.</div>
                        <div class="glossary-technical">Short note: often top-weighted studies.</div>
                        <div class="glossary-story">📖 The cardiac stem cell collapse: When Harvard retracted 31 papers, the "influential" ones had been cited 4,000+ times. Your highest-weight studies are your greatest vulnerability. Verify them most carefully.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Source Citation (Source citation)</div>
                        <div class="glossary-plain">The exact place a number came from, for example "Table 2, p.1234."</div>
                        <div class="glossary-technical">Short note: traceable source link for extracted data.</div>
                        <div class="glossary-story">📖 The Poldermans firewall: His fabricated data passed review because no one asked "which table?" When you write "Table 2, p.1234," you're asking: does this patient exist? Source citation is fraud detection.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Red-Team</div>
                        <div class="glossary-plain">Two team members who act as quality checkers each day, looking for mistakes.</div>
                        <div class="glossary-technical">Short note: rotating daily quality-check role.</div>
                        <div class="glossary-story">📖 The Boldt detection: Joachim Boldt's fraud (90+ fake studies) was caught when an anesthesia red-team noticed impossible recruitment rates. Daily adversarial checking catches what collaborative review misses.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Freeze</div>
                        <div class="glossary-plain">After Day 34, no new studies can be added. Scope is locked.</div>
                        <div class="glossary-technical">Short note: hard stop for adding new studies.</div>
                        <div class="glossary-story">📖 The BMP scandal: Industry kept "finding" new spine surgery studies that favored their product. Each addition moved the pooled estimate. Freeze prevents weaponized scope creep.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Consult Pack</div>
                        <div class="glossary-plain">A one-page document you must prepare before asking for any decision. No pack = no meeting.</div>
                        <div class="glossary-technical">Short note: one-page decision brief.</div>
                        <div class="glossary-story">📖 Unstructured decisions enable bias. The HRT consensus emerged from experts talking without structured evidence—observational data "felt" convincing. Structure forces options, evidence, and tradeoffs onto paper.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Capsule</div>
                        <div class="glossary-plain">A complete analysis package — code, data, instructions. Anyone can run it and get identical results.</div>
                        <div class="glossary-technical">Short note: shareable run package with fixed inputs.</div>
                        <div class="glossary-story">📖 The reproducibility crisis: Nature (2016) found 70% of researchers couldn't reproduce others' work. The Tamiflu Cochrane review succeeded because Roche eventually had to release data that could be independently analyzed.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Critical Field</div>
                        <div class="glossary-plain">Data points that directly affect your result. Must be double-checked with source citation.</div>
                        <div class="glossary-technical">Short note: high-impact fields requiring verification.</div>
                        <div class="glossary-story">📖 The COLCOT swap: One extractor misread which bar was intervention vs control in a figure. That single error in the largest trial would have reversed the entire meta-analysis conclusion. Key fields need two pairs of eyes.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Study-to-Study Differences (Heterogeneity, I²)</div>
                        <div class="glossary-plain">How much studies disagree. Low means similar results; high means you should investigate why.</div>
                        <div class="glossary-technical">Short note: I² estimates between-study spread.</div>
                        <div class="glossary-story">📖 The Avandia signal: Nissen's meta-analysis showed harm with I²=0%—homogeneous disaster. Low heterogeneity isn't always good; it can mean all studies are consistently showing something important. Investigate both high AND suspiciously low I².</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">PRISMA</div>
                        <div class="glossary-plain">A reporting standard. The flow chart shows how many studies were found, screened, and included.</div>
                        <div class="glossary-technical">Short note: reporting checklist for systematic reviews.</div>
                        <div class="glossary-story">📖 PRISMA emerged from QUOROM failures: reviews were black boxes. Now journals desk-reject incomplete PRISMA. Your flow diagram is your transparency contract—numbers must add up.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Publication Bias</div>
                        <div class="glossary-plain">When studies with negative or boring results never get published, leaving only positive findings visible.</div>
                        <div class="glossary-technical">Short note: negative studies missing from the literature.</div>
                        <div class="glossary-story">📖 The Lorcainide burial: A 1980 trial showed this anti-arrhythmic increased deaths. It was never published—"not interesting." A decade later, similar drugs killed 50,000 people. The unpublished study would have prevented disaster.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Surrogate Outcome</div>
                        <div class="glossary-plain">A measurement that substitutes for what you really care about—like cholesterol instead of heart attacks.</div>
                        <div class="glossary-technical">Short note: stand-in measure instead of real patient outcome.</div>
                        <div class="glossary-story">📖 The CAST tragedy: PVC suppression (surrogate) looked great. Survival (real outcome) was terrible. The drugs that "fixed" the ECG killed the patients. Surrogates lie.</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Study Quality Risk (Risk of Bias, RoB)</div>
                        <div class="glossary-plain">A check of whether study methods could have skewed results.</div>
                        <div class="glossary-technical">Short note: structured tool-based quality-risk assessment.</div>
                        <div class="glossary-story">📖 The stem cell collapse: RoB assessments rated fraudulent studies as "low risk" because they had randomization, blinding, complete follow-up—all fabricated. RoB tools catch bad methods, not fraud. You need both RoB AND verification.</div>
                    </div>
                    </div>
                    <div class="glossary-no-results" id="glossaryNoResults" style="display:none">No matching terms found</div>
                </div>
            </div>
        </div>
        
        <!-- CASE STUDY PAGE -->
        <div class="page" id="page-casestudy" role="tabpanel">
            <div class="card" style="background: linear-gradient(135deg, var(--purple) 0%, var(--accent) 100%); color: white; border: none;">
                <div class="card-body" style="text-align: center; padding: 32px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">📖</div>
                    <h2 style="margin: 0 0 8px; font-size: 24px;">The Colchicine Review</h2>
                    <p style="margin: 0; opacity: 0.9; font-size: 15px;">A 40-day systematic review with 4 crises and 0 failures</p>
                    <p style="margin: 8px 0 0; opacity: 0.7; font-size: 12px;">Teaching example (8 RCTs). Real META-SPRINT reviews typically include 40-60 studies.</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><div class="card-title">The Question</div><div class="phase-badge phase-a">Day 1</div></div>
                <div class="card-body">
                    <p style="font-size: 18px; font-weight: 600; margin: 0 0 16px; color: var(--purple);">"Does colchicine reduce major cardiac events after heart attack?"</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent);">8</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">RCTs</div>
                        </div>
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent);">11,774</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Patients</div>
                        </div>
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent);">40</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Days</div>
                        </div>
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent);">4</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Crises</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CRISIS 1 -->
            <div class="decision-scenario" onclick="toggleDecision(this)">
                <div class="decision-header" tabindex="0" role="button" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.parentElement.click()}">
                    <div class="decision-icon" style="background: var(--warning-light); color: var(--warning);">1</div>
                    <div>
                        <div class="decision-title">"Which timepoint do we use?"</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Day 2 — Protocol Phase</div>
                    </div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="decision-body">
                    <div style="background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">The Problem</div>
                        <p style="margin: 0; font-size: 14px;">Trials report MACE at 30 days, 90 days, 1 year, and 3 years. The protocol said "longest follow-up" but two reviewers disagreed: Does "longest" mean longest available per trial, or should we pick one timepoint for all?</p>
                    </div>
                    
                    <div style="font-weight: 600; margin-bottom: 8px;">💬 The Consult Pack</div>
                    <div style="background: white; border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; white-space: pre-wrap; margin-bottom: 16px;">CONSULT PACK — Day 2
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Issue: Timepoint selection rule ambiguous
Raised by: Ahmed (Extraction Lead)
Blocking: Cannot finalize extraction template

BACKGROUND
Protocol states: "Primary outcome at longest follow-up"
Trials report: 30d, 90d, 1y, 2y, 3y (varies by trial)

OPTIONS
A) Longest available per trial
   Pro: Maximizes data, matches protocol wording
   Con: Mixes timepoints, harder to interpret

B) Fixed timepoint (1 year) for all
   Pro: Cleaner comparison, easier to interpret  
   Con: Loses 2 trials without 1y data

C) Longest ≥1 year, else longest available
   Pro: Balances both concerns
   Con: Still some mixing

RECOMMENDATION: Option C
DECISION NEEDED BY: Day 3 (DoD-A deadline)</div>
                    
                    <div style="background: var(--success-light); border-left: 3px solid var(--success); padding: 12px; border-radius: 0 6px 6px 0; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: var(--success); margin-bottom: 4px;">⚖️ The Decision</div>
                        <p style="margin: 0; font-size: 14px;">Option C adopted. Rule added to protocol: "Use longest follow-up ≥1 year where available; otherwise use longest available. Document actual timepoint per study."</p>
                    </div>
                    
                    <div style="background: var(--purple-light); border-left: 3px solid var(--purple); padding: 12px; border-radius: 0 6px 6px 0;">
                        <div style="font-weight: 600; color: var(--purple); margin-bottom: 4px;">📝 What this taught</div>
                        <p style="margin: 0; font-size: 14px;">Ambiguity in protocol → disagreement in extraction. Specificity at Day 1 saves conflict at Day 20. The 15 minutes spent on this Consult Pack prevented hours of rework.</p>
                    </div>
                </div>
            </div>
            
            <!-- CRISIS 2 -->
            <div class="decision-scenario" onclick="toggleDecision(this)">
                <div class="decision-header" tabindex="0" role="button" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.parentElement.click()}">
                    <div class="decision-icon" style="background: var(--danger-light); color: var(--danger);">2</div>
                    <div>
                        <div class="decision-title">"The arms are swapped"</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Day 14 — Extraction Phase</div>
                    </div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="decision-body">
                    <div style="background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">The Problem</div>
                        <p style="margin: 0; font-size: 14px;">Red-team checker Fatima pulls COLCOT (n=4,745) — the largest trial. Quick forest plot shows colchicine <em>increases</em> events. Every other trial shows benefit. Something is wrong.</p>
                        <p style="margin: 12px 0 0; font-size: 14px;">She opens the PDF. Figure 3. The bars are unlabeled. The extractor assumed left = intervention. <strong>It was right = intervention.</strong></p>
                    </div>
                    
                    <div style="font-weight: 600; margin-bottom: 8px;">🔴 The Red-Team Micro-Check</div>
                    <div style="background: white; border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; white-space: pre-wrap; margin-bottom: 16px;">RED-TEAM MICRO-CHECK — Day 14
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Checker: Fatima Hassan
Study: Tardif 2019 (COLCOT)
Check type: Critical field verification

FINDING
☒ ERROR FOUND

Field: Event counts (MACE)
Extracted: Colchicine 131/2,366 vs Placebo 91/2,379
Actual:    Colchicine 91/2,366 vs Placebo 131/2,379

Root cause: Figure 3 unlabeled bars, extractor assumed
            left=intervention (was right=intervention)

Impact: CRITICAL — Flips trial from harm to benefit
        This trial is 40% of total weight

ACTION REQUIRED
☒ Immediate correction with source citation
☐ Escalate to Integrator
☐ Expand audit scope

Source: Tardif et al. NEJM 2019, Figure 3 + Table 2
        (Table 2 confirms correct allocation)</div>
                    
                    <div style="background: var(--success-light); border-left: 3px solid var(--success); padding: 12px; border-radius: 0 6px 6px 0; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: var(--success); margin-bottom: 4px;">⚖️ The Decision</div>
                        <p style="margin: 0; font-size: 14px;">Fix with source citation (cite Table 2). Log correction. Do NOT expand audit — single error, clear cause (unlabeled figure), not systematic. Extractor briefed on verifying arm labels from multiple sources.</p>
                    </div>
                    
                    <div style="background: var(--purple-light); border-left: 3px solid var(--purple); padding: 12px; border-radius: 0 6px 6px 0;">
                        <div style="font-weight: 600; color: var(--purple); margin-bottom: 4px;">📝 What this taught</div>
                        <p style="margin: 0; font-size: 14px;"><strong>Influential studies get checked. This is why.</strong> One swapped arm in the largest trial would have flipped the entire conclusion from "colchicine helps" to "colchicine harms." The red-team system exists for exactly this moment.</p>
                    </div>
                </div>
            </div>
            
            <!-- CRISIS 3 -->
            <div class="decision-scenario" onclick="toggleDecision(this)">
                <div class="decision-header" tabindex="0" role="button" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.parentElement.click()}">
                    <div class="decision-icon" style="background: var(--warning-light); color: var(--warning);">3</div>
                    <div>
                        <div class="decision-title">"Should we split by dose?"</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Day 22 — Extraction Phase</div>
                    </div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="decision-body">
                    <div style="background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">The Problem</div>
                        <p style="margin: 0; font-size: 14px;">Clinical advisor Dr. Mahmood reviews the extraction sheet. "Three trials used low-dose (0.5mg), five used high-dose (1mg). The mechanism might differ. Shouldn't you analyze them separately?"</p>
                        <p style="margin: 12px 0 0; font-size: 14px;">He's probably right. But this wasn't in the protocol. Day 22 is too late to change the primary analysis.</p>
                    </div>
                    
                    <div style="font-weight: 600; margin-bottom: 8px;">📋 The Deviation Log</div>
                    <div style="background: white; border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; white-space: pre-wrap; margin-bottom: 16px;">DEVIATION LOG ENTRY — Day 22
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ID: DEV-003
Type: Analysis addition (post-hoc)
Logged by: Sarah Chen (Integrator)

ORIGINAL PROTOCOL
"Primary analysis: all trials pooled regardless of dose"
No subgroup by dose was prespecified.

DEVIATION
Adding sensitivity analysis: high-dose (≥1mg) trials only

RATIONALE  
Clinical advisor raised mechanistic concern about dose-
response. 3 trials used 0.5mg, 5 trials used ≥1mg.
Legitimate scientific question.

CLASSIFICATION
☐ Protocol amendment (changes primary)
☒ Sensitivity addition (exploratory only)

APPROVAL
Primary analysis: UNCHANGED
New analysis: Labelled "exploratory, post-hoc"
Approved by: Sarah Chen, Day 22</div>
                    
                    <div style="background: var(--success-light); border-left: 3px solid var(--success); padding: 12px; border-radius: 0 6px 6px 0; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: var(--success); margin-bottom: 4px;">⚖️ The Decision</div>
                        <p style="margin: 0; font-size: 14px;">Add as SENSITIVITY analysis only. Label clearly as "exploratory, post-hoc." Primary analysis unchanged. Report both in paper with appropriate caveats.</p>
                    </div>
                    
                    <div style="background: var(--purple-light); border-left: 3px solid var(--purple); padding: 12px; border-radius: 0 6px 6px 0;">
                        <div style="font-weight: 600; color: var(--purple); margin-bottom: 4px;">📝 What this taught</div>
                        <p style="margin: 0; font-size: 14px;"><strong>Good ideas after Day 3 go in sensitivity, not primary.</strong> The protocol protects you from yourself. Dr. Mahmood's suggestion was scientifically valid — but acting on it by changing the primary analysis would have introduced bias. The deviation log lets you have it both ways: explore the question while protecting the integrity of your prespecified analysis.</p>
                    </div>
                </div>
            </div>
            
            <!-- CRISIS 4 -->
            <div class="decision-scenario" onclick="toggleDecision(this)">
                <div class="decision-header" tabindex="0" role="button" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.parentElement.click()}">
                    <div class="decision-icon" style="background: var(--danger-light); color: var(--danger);">4</div>
                    <div>
                        <div class="decision-title">"The numbers don't match"</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Day 31 — Analysis Phase</div>
                    </div>
                    <span class="decision-arrow">â–¼</span>
                </div>
                <div class="decision-body">
                    <div style="background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">The Problem</div>
                        <p style="margin: 0; font-size: 14px;">Audit 2. Two analysts independently rerun the meta-analysis from the locked dataset.</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid var(--border);">
                                <div style="font-size: 11px; color: var(--text-secondary);">Analyst A</div>
                                <div style="font-size: 16px; font-weight: 600;">RR = 0.6534</div>
                                <div style="font-size: 14px;">I² = 34.2%</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid var(--border);">
                                <div style="font-size: 11px; color: var(--text-secondary);">Analyst B</div>
                                <div style="font-size: 16px; font-weight: 600;">RR = 0.6529</div>
                                <div style="font-size: 14px;">I² = 31.8%</div>
                            </div>
                        </div>
                        <p style="margin: 12px 0 0; font-size: 14px;">RR difference: 0.0005 (tolerance: 0.001) ✓<br>I² difference: <strong>2.4%</strong> (tolerance: 1%) ✗</p>
                    </div>
                    
                    <div style="font-weight: 600; margin-bottom: 8px;">🔍 The Investigation</div>
                    <div style="background: white; border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-size: 14px; margin-bottom: 16px;">
                        <p style="margin: 0 0 12px;">Line-by-line comparison of inputs. Seven trials match exactly. One doesn't:</p>
                        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            <tr style="background: var(--bg);"><th style="padding: 8px; text-align: left;">Study</th><th style="padding: 8px;">Analyst A (SE)</th><th style="padding: 8px;">Analyst B (SE)</th></tr>
                            <tr><td style="padding: 8px; border-bottom: 1px solid var(--border);">Nidorf 2020</td><td style="padding: 8px; border-bottom: 1px solid var(--border);">0.0847</td><td style="padding: 8px; border-bottom: 1px solid var(--border); color: var(--danger); font-weight: 600;">0.08</td></tr>
                        </table>
                        <p style="margin: 12px 0 0; font-size: 13px;">Analyst B had rounded the SE to 2 decimal places when transcribing. Original extraction sheet shows 0.0847.</p>
                    </div>
                    
                    <div style="background: var(--success-light); border-left: 3px solid var(--success); padding: 12px; border-radius: 0 6px 6px 0; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: var(--success); margin-bottom: 4px;">⚖️ The Decision</div>
                        <p style="margin: 0; font-size: 14px;">Fix rounding error. Analyst B reruns with correct SE. Both now match: RR = 0.6534, I² = 34.2%. Equivalence satisfied. <strong>No CondGO needed</strong> — resolved same day.</p>
                    </div>
                    
                    <div style="background: var(--purple-light); border-left: 3px solid var(--purple); padding: 12px; border-radius: 0 6px 6px 0;">
                        <div style="font-weight: 600; color: var(--purple); margin-bottom: 4px;">📝 What this taught</div>
                        <p style="margin: 0; font-size: 14px;"><strong>"Close enough" isn't.</strong> The tolerance exists for a reason. A 0.0047 difference in one SE created a 2.4% difference in I². In a different review, that could change interpretation from "low heterogeneity" to "moderate heterogeneity." The rerun requirement caught what eyeballing never would.</p>
                    </div>
                </div>
            </div>
            
            <!-- THE RESULT -->
            <div class="card" style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%); color: white; border: none;">
                <div class="card-header" style="border: none;"><div class="card-title" style="color: white;">The Result</div><div class="phase-badge" style="background: rgba(255,255,255,0.2); color: white;">Day 40</div></div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 700;">RR 0.65</div>
                            <div style="font-size: 12px; opacity: 0.9;">95% CI: 0.49–0.88</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 700;">I² 34%</div>
                            <div style="font-size: 12px; opacity: 0.9;">Low-moderate heterogeneity</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 700;">9/9</div>
                            <div style="font-size: 12px; opacity: 0.9;">Audit-Grade Index</div>
                        </div>
                    </div>
                    <p style="margin: 0; font-size: 15px; text-align: center; opacity: 0.95;"><strong>Colchicine reduces major cardiac events by ~35% after STEMI.</strong><br>The review survived 4 crises because the system caught them.</p>
                </div>
            </div>
            
            <!-- SUMMARY LESSONS -->
            <div class="card">
                <div class="card-header"><div class="card-title">Why the system worked</div></div>
                <div class="card-body" style="padding: 0;">
                    <div class="glossary-item">
                        <div class="glossary-term">Crisis 1 → Consult Pack</div>
                        <div class="glossary-plain">15 minutes of structured discussion prevented hours of rework</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Crisis 2 → Red-Team</div>
                        <div class="glossary-plain">Rotating checkers caught what the extractor couldn't see</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Crisis 3 → Deviation Log</div>
                        <div class="glossary-plain">Good ideas were captured without compromising preregistration</div>
                    </div>
                    <div class="glossary-item">
                        <div class="glossary-term">Crisis 4 → Rerun Tolerance</div>
                        <div class="glossary-plain">Numerical precision requirements caught silent errors</div>
                    </div>
                </div>
            </div>
            
            <div class="help-box" style="text-align: center;">
                <div class="help-box-title">Ready to start your own review?</div>
                <div class="help-box-text">Go to <strong>📋 Today</strong> to begin, or <strong>📝 Templates</strong> to see the blank forms used in this case study.</div>
            </div>
        </div>
    </div>
</div>

<script>
// ===== LZ-STRING COMPRESSION =====
// LZ-String v1.4.4 - Copyright (c) 2013 pieroxy - MIT License
var LZString = (function() {
    var f = String.fromCharCode;
    var keyStrBase64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
    var baseReverseDic = {};

    function getBaseValue(alphabet, character) {
        if (!baseReverseDic[alphabet]) {
            baseReverseDic[alphabet] = {};
            for (var i = 0; i < alphabet.length; i++) {
                baseReverseDic[alphabet][alphabet.charAt(i)] = i;
            }
        }
        return baseReverseDic[alphabet][character];
    }

    function compress(uncompressed) {
        if (uncompressed == null) return "";
        var i, value, context_dictionary = {}, context_dictionaryToCreate = {},
            context_c = "", context_wc = "", context_w = "",
            context_enlargeIn = 2, context_dictSize = 3, context_numBits = 2,
            context_data = [], context_data_val = 0, context_data_position = 0, ii;

        for (ii = 0; ii < uncompressed.length; ii++) {
            context_c = uncompressed.charAt(ii);
            if (!Object.prototype.hasOwnProperty.call(context_dictionary, context_c)) {
                context_dictionary[context_c] = context_dictSize++;
                context_dictionaryToCreate[context_c] = true;
            }
            context_wc = context_w + context_c;
            if (Object.prototype.hasOwnProperty.call(context_dictionary, context_wc)) {
                context_w = context_wc;
            } else {
                if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_w)) {
                    if (context_w.charCodeAt(0) < 256) {
                        for (i = 0; i < context_numBits; i++) {
                            context_data_val = (context_data_val << 1);
                            if (context_data_position == 15) {
                                context_data_position = 0;
                                context_data.push(f(context_data_val));
                                context_data_val = 0;
                            } else { context_data_position++; }
                        }
                        value = context_w.charCodeAt(0);
                        for (i = 0; i < 8; i++) {
                            context_data_val = (context_data_val << 1) | (value & 1);
                            if (context_data_position == 15) {
                                context_data_position = 0;
                                context_data.push(f(context_data_val));
                                context_data_val = 0;
                            } else { context_data_position++; }
                            value = value >> 1;
                        }
                    } else {
                        value = 1;
                        for (i = 0; i < context_numBits; i++) {
                            context_data_val = (context_data_val << 1) | value;
                            if (context_data_position == 15) {
                                context_data_position = 0;
                                context_data.push(f(context_data_val));
                                context_data_val = 0;
                            } else { context_data_position++; }
                            value = 0;
                        }
                        value = context_w.charCodeAt(0);
                        for (i = 0; i < 16; i++) {
                            context_data_val = (context_data_val << 1) | (value & 1);
                            if (context_data_position == 15) {
                                context_data_position = 0;
                                context_data.push(f(context_data_val));
                                context_data_val = 0;
                            } else { context_data_position++; }
                            value = value >> 1;
                        }
                    }
                    context_enlargeIn--;
                    if (context_enlargeIn == 0) {
                        context_enlargeIn = Math.pow(2, context_numBits);
                        context_numBits++;
                    }
                    delete context_dictionaryToCreate[context_w];
                } else {
                    value = context_dictionary[context_w];
                    for (i = 0; i < context_numBits; i++) {
                        context_data_val = (context_data_val << 1) | (value & 1);
                        if (context_data_position == 15) {
                            context_data_position = 0;
                            context_data.push(f(context_data_val));
                            context_data_val = 0;
                        } else { context_data_position++; }
                        value = value >> 1;
                    }
                }
                context_enlargeIn--;
                if (context_enlargeIn == 0) {
                    context_enlargeIn = Math.pow(2, context_numBits);
                    context_numBits++;
                }
                context_dictionary[context_wc] = context_dictSize++;
                context_w = String(context_c);
            }
        }
        if (context_w !== "") {
            if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_w)) {
                if (context_w.charCodeAt(0) < 256) {
                    for (i = 0; i < context_numBits; i++) {
                        context_data_val = (context_data_val << 1);
                        if (context_data_position == 15) {
                            context_data_position = 0;
                            context_data.push(f(context_data_val));
                            context_data_val = 0;
                        } else { context_data_position++; }
                    }
                    value = context_w.charCodeAt(0);
                    for (i = 0; i < 8; i++) {
                        context_data_val = (context_data_val << 1) | (value & 1);
                        if (context_data_position == 15) {
                            context_data_position = 0;
                            context_data.push(f(context_data_val));
                            context_data_val = 0;
                        } else { context_data_position++; }
                        value = value >> 1;
                    }
                } else {
                    value = 1;
                    for (i = 0; i < context_numBits; i++) {
                        context_data_val = (context_data_val << 1) | value;
                        if (context_data_position == 15) {
                            context_data_position = 0;
                            context_data.push(f(context_data_val));
                            context_data_val = 0;
                        } else { context_data_position++; }
                        value = 0;
                    }
                    value = context_w.charCodeAt(0);
                    for (i = 0; i < 16; i++) {
                        context_data_val = (context_data_val << 1) | (value & 1);
                        if (context_data_position == 15) {
                            context_data_position = 0;
                            context_data.push(f(context_data_val));
                            context_data_val = 0;
                        } else { context_data_position++; }
                        value = value >> 1;
                    }
                }
                context_enlargeIn--;
                if (context_enlargeIn == 0) {
                    context_enlargeIn = Math.pow(2, context_numBits);
                    context_numBits++;
                }
                delete context_dictionaryToCreate[context_w];
            } else {
                value = context_dictionary[context_w];
                for (i = 0; i < context_numBits; i++) {
                    context_data_val = (context_data_val << 1) | (value & 1);
                    if (context_data_position == 15) {
                        context_data_position = 0;
                        context_data.push(f(context_data_val));
                        context_data_val = 0;
                    } else { context_data_position++; }
                    value = value >> 1;
                }
            }
            context_enlargeIn--;
            if (context_enlargeIn == 0) {
                context_enlargeIn = Math.pow(2, context_numBits);
                context_numBits++;
            }
        }
        value = 2;
        for (i = 0; i < context_numBits; i++) {
            context_data_val = (context_data_val << 1) | (value & 1);
            if (context_data_position == 15) {
                context_data_position = 0;
                context_data.push(f(context_data_val));
                context_data_val = 0;
            } else { context_data_position++; }
            value = value >> 1;
        }
        while (true) {
            context_data_val = (context_data_val << 1);
            if (context_data_position == 15) {
                context_data.push(f(context_data_val));
                break;
            } else { context_data_position++; }
        }
        return context_data.join('');
    }

    function decompress(compressed) {
        if (compressed == null) return "";
        if (compressed == "") return null;
        var dictionary = [], enlargeIn = 4, dictSize = 4, numBits = 3,
            entry = "", result = [], i, w, c, data = { val: compressed.charCodeAt(0), position: 32768, index: 1 };

        for (i = 0; i < 3; i++) { dictionary[i] = i; }
        var bits = 0, maxpower = Math.pow(2, 2), power = 1;
        while (power != maxpower) {
            var resb = data.val & data.position;
            data.position >>= 1;
            if (data.position == 0) { data.position = 32768; data.val = compressed.charCodeAt(data.index++); }
            bits |= (resb > 0 ? 1 : 0) * power;
            power <<= 1;
        }
        var next = bits;
        switch (next) {
            case 0:
                bits = 0; maxpower = Math.pow(2, 8); power = 1;
                while (power != maxpower) {
                    resb = data.val & data.position;
                    data.position >>= 1;
                    if (data.position == 0) { data.position = 32768; data.val = compressed.charCodeAt(data.index++); }
                    bits |= (resb > 0 ? 1 : 0) * power;
                    power <<= 1;
                }
                c = f(bits); break;
            case 1:
                bits = 0; maxpower = Math.pow(2, 16); power = 1;
                while (power != maxpower) {
                    resb = data.val & data.position;
                    data.position >>= 1;
                    if (data.position == 0) { data.position = 32768; data.val = compressed.charCodeAt(data.index++); }
                    bits |= (resb > 0 ? 1 : 0) * power;
                    power <<= 1;
                }
                c = f(bits); break;
            case 2: return "";
        }
        dictionary[3] = c; w = c; result.push(c);
        while (true) {
            if (data.index > compressed.length) return "";
            bits = 0; maxpower = Math.pow(2, numBits); power = 1;
            while (power != maxpower) {
                resb = data.val & data.position;
                data.position >>= 1;
                if (data.position == 0) { data.position = 32768; data.val = compressed.charCodeAt(data.index++); }
                bits |= (resb > 0 ? 1 : 0) * power;
                power <<= 1;
            }
            c = bits;
            switch (c) {
                case 0:
                    bits = 0; maxpower = Math.pow(2, 8); power = 1;
                    while (power != maxpower) {
                        resb = data.val & data.position;
                        data.position >>= 1;
                        if (data.position == 0) { data.position = 32768; data.val = compressed.charCodeAt(data.index++); }
                        bits |= (resb > 0 ? 1 : 0) * power;
                        power <<= 1;
                    }
                    dictionary[dictSize++] = f(bits);
                    c = dictSize - 1; enlargeIn--; break;
                case 1:
                    bits = 0; maxpower = Math.pow(2, 16); power = 1;
                    while (power != maxpower) {
                        resb = data.val & data.position;
                        data.position >>= 1;
                        if (data.position == 0) { data.position = 32768; data.val = compressed.charCodeAt(data.index++); }
                        bits |= (resb > 0 ? 1 : 0) * power;
                        power <<= 1;
                    }
                    dictionary[dictSize++] = f(bits);
                    c = dictSize - 1; enlargeIn--; break;
                case 2: return result.join('');
            }
            if (enlargeIn == 0) { enlargeIn = Math.pow(2, numBits); numBits++; }
            if (dictionary[c]) { entry = dictionary[c]; }
            else { if (c === dictSize) { entry = w + w.charAt(0); } else { return null; } }
            result.push(entry);
            dictionary[dictSize++] = w + entry.charAt(0);
            enlargeIn--;
            if (enlargeIn == 0) { enlargeIn = Math.pow(2, numBits); numBits++; }
            w = entry;
        }
    }

    function compressToBase64(input) {
        if (input == null) return "";
        var res = compress(input);
        if (res === "") return "";
        var output = [], chr1, chr2, chr3, enc1, enc2, enc3, enc4, i = 0;
        while (i < res.length * 2) {
            if (i % 2 == 0) { chr1 = res.charCodeAt(i / 2) >> 8; chr2 = res.charCodeAt(i / 2) & 255;
                if (i / 2 + 1 < res.length) { chr3 = res.charCodeAt(i / 2 + 1) >> 8; } else { chr3 = NaN; }
            } else { chr1 = res.charCodeAt((i - 1) / 2) & 255;
                if ((i + 1) / 2 < res.length) { chr2 = res.charCodeAt((i + 1) / 2) >> 8; chr3 = res.charCodeAt((i + 1) / 2) & 255;
                } else { chr2 = NaN; chr3 = NaN; }
            }
            i += 3;
            enc1 = chr1 >> 2;
            enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
            enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
            enc4 = chr3 & 63;
            if (isNaN(chr2)) { enc3 = enc4 = 64; } else if (isNaN(chr3)) { enc4 = 64; }
            output.push(keyStrBase64.charAt(enc1) + keyStrBase64.charAt(enc2) + keyStrBase64.charAt(enc3) + keyStrBase64.charAt(enc4));
        }
        return output.join('');
    }

    function decompressFromBase64(input) {
        if (input == null) return "";
        if (input == "") return null;
        var output = [], ol = 0, chr1, chr2, chr3, enc1, enc2, enc3, enc4, i = 0;
        input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");
        while (i < input.length) {
            enc1 = getBaseValue(keyStrBase64, input.charAt(i++));
            enc2 = getBaseValue(keyStrBase64, input.charAt(i++));
            enc3 = getBaseValue(keyStrBase64, input.charAt(i++));
            enc4 = getBaseValue(keyStrBase64, input.charAt(i++));
            chr1 = (enc1 << 2) | (enc2 >> 4);
            chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
            chr3 = ((enc3 & 3) << 6) | enc4;
            if (ol % 2 == 0) { output.push(String.fromCharCode((chr1 << 8) | chr2));
                if (enc3 != 64) { output.push(String.fromCharCode((chr3 << 8))); }
            } else { output.push(String.fromCharCode((output.pop().charCodeAt(0)) | chr1));
                if (enc3 != 64) { output.push(String.fromCharCode((chr2 << 8) | chr3)); }
            }
            ol += 3;
        }
        return decompress(output.join(''));
    }

    return {
        compress: compress,
        decompress: decompress,
        compressToBase64: compressToBase64,
        decompressFromBase64: decompressFromBase64
    };
})();

// ===== UNDO STACK =====
const undoStack = [];
const MAX_UNDO = 50;

function pushUndo(action, data) {
    undoStack.push({ action, data, timestamp: Date.now() });
    if (undoStack.length > MAX_UNDO) undoStack.shift();
}

function popUndo() {
    if (undoStack.length === 0) return null;
    return undoStack.pop();
}

function performUndo() {
    const item = popUndo();
    if (!item) {
        showToast('Nothing to undo', 'error');
        return;
    }

    const project = getProject();
    if (item.action === 'checkbox') {
        // Restore checkbox state
        if (item.data.type === 'dod') {
            project.dodChecked[item.data.id] = item.data.previousState;
        } else if (item.data.type === 'task') {
            project.completed[item.data.id] = item.data.previousState;
        } else if (item.data.type === 'protocol') {
            const canPublish = isValidProtocolUrl(project.protocolUrl || '').valid;
            project.protocolPublished = !!item.data.previousState && canPublish;
        }
        save();
        render();
        showToast('Undo: Checkbox restored');
    }
}

// ===== CALENDAR EXPORT =====
function exportCalendarMilestones() {
    const project = getProject();
    const startDate = new Date();
    const projectName = project.name || 'META-SPRINT';

    const milestoneEvents = [
        { day: 3, title: 'DoD-A: Study Plan Lock', desc: 'Sign off DoD-A. Study plan must be locked and registered.' },
        { day: 10, title: 'DoD-B: Search Complete', desc: 'Search complete. Screening finished. Study-flow (PRISMA) counts final.' },
        { day: 18, title: 'Audit 1 Begins', desc: '10% trace audit. Check key fields and source citations.' },
        { day: 20, title: 'Audit 1 Deadline', desc: 'Complete Audit 1 verification.' },
        { day: 28, title: 'DoD-C: Extraction Complete', desc: 'All data extracted and verified.' },
        { day: 30, title: 'Audit 2 Begins', desc: 'Rerun match verification. Check all high-impact studies.' },
        { day: 33, title: 'DoD-D: Analysis Locked', desc: 'All results final. No changes to analysis.' },
        { day: 34, title: 'FREEZE', desc: 'No new studies allowed. Only corrections permitted.' },
        { day: 40, title: 'SUBMISSION', desc: 'Submit manuscript and audit pack.' }
    ];

    let icsContent = `BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//META-SPRINT//Calendar Export//EN\r\nCALSCALE:GREGORIAN\r\nMETHOD:PUBLISH\r\nX-WR-CALNAME:${projectName.replace(/[,;\\]/g, '\\$&')} Milestones\r\n`;

    const now = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    milestoneEvents.forEach((event, i) => {
        const eventDate = new Date(startDate);
        eventDate.setDate(startDate.getDate() + event.day - project.day);

        const dateOnly = eventDate.toISOString().slice(0,10).replace(/-/g, '');
        const uid = `metasprint-d${event.day}-${Date.now()}-${i}@metasprint`;
        const summary = `[${projectName}] Day ${event.day}: ${event.title}`.replace(/[,;\\]/g, '\\$&');
        const desc = event.desc.replace(/[,;\\]/g, '\\$&').replace(/\n/g, '\\n');

        icsContent += `BEGIN:VEVENT\r\nUID:${uid}\r\nDTSTAMP:${now}\r\nDTSTART;VALUE=DATE:${dateOnly}\r\nSUMMARY:${summary}\r\nDESCRIPTION:${desc}\r\nEND:VEVENT\r\n`;
    });

    icsContent += 'END:VCALENDAR\r\n';

    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${projectName.replace(/[^a-z0-9]/gi, '_').replace(/^_+|_+$/g, '') || 'project'}_milestones.ics`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Calendar exported (.ics)');
}

// ===== DATA =====
const PHASES = [
    { id: 'A', name: 'Study Plan', days: [1, 3], cls: 'phase-a' },
    { id: 'B', name: 'Search & Screen', days: [4, 10], cls: 'phase-b' },
    { id: 'C', name: 'Extraction', days: [11, 28], cls: 'phase-c' },
    { id: 'D', name: 'Analysis', days: [29, 33], cls: 'phase-d' },
    { id: 'E', name: 'Submission', days: [34, 40], cls: 'phase-e' }
];

const MILESTONES = [3, 10, 20, 28, 33, 34, 40];

const WORKLOAD = [
    { days: [1, 7], hours: '~0.7h', peak: false },
    { days: [8, 14], hours: '~1.7h', peak: false },
    { days: [15, 21], hours: '~2.0h', peak: true },
    { days: [22, 28], hours: '~2.0h', peak: true },
    { days: [29, 35], hours: '~1.4h', peak: false },
    { days: [36, 40], hours: '~1.3h', peak: false }
];

const GOALS = {
    1: "Finalize and register your study plan on PROSPERO or protocols.io.",
    2: "Complete the study plan: PICOS, outcomes, and timepoint rules.",
    3: "Sign off DoD-A. Study plan must be locked and registered.",
    4: "Begin search execution.",
    5: "Continue search. Start deduplication.",
    6: "Complete search. Begin screening.",
    7: "Continue screening. Run alignment check if needed.",
    8: "Continue screening. Update study-flow (PRISMA) counts.",
    9: "Complete screening. Begin full-text.",
    10: "Sign off DoD-B. Search complete.",
    11: "Begin extraction.",
    12: "Continue extraction. Verify key fields.",
    15: "Continue extraction. Mid-point check.",
    18: "Audit 1 begins. 10% trace audit.",
    19: "Continue Audit 1.",
    20: "Complete Audit 1.",
    25: "Final extraction push.",
    28: "Sign off DoD-C. Extraction complete.",
    29: "Run full analysis.",
    30: "Audit 2 begins.",
    31: "Continue Audit 2.",
    32: "Complete Audit 2.",
    33: "Sign off DoD-D. Analysis locked.",
    34: "FREEZE begins. Final writing.",
    35: "Continue writing.",
    38: "Final proofreading.",
    40: "Submit! DoD-E complete."
};

const ROLE_TASKS = {
    integrator: {
        1: ["Review study plan draft", "Set up workspace", "Confirm assignments"],
        3: ["Sign DoD-A", "Verify study plan registered", "Lock study plan"],
        10: ["Sign DoD-B", "Review study-flow (PRISMA)", "Approve screening"],
        18: ["Oversee Audit 1"],
        28: ["Sign DoD-C"],
        30: ["Oversee Audit 2"],
        33: ["Sign DoD-D"],
        40: ["Final DoD-E", "Submit"]
    },
    deputy: { default: ["Monitor decision queue (≤3/day)", "Triage requests", "Approve minor changes"] },
    search: {
        4: ["Execute search", "Document strings"],
        6: ["Complete search", "Begin screening"],
        10: ["Verify DoD-B counts"]
    },
    fulltext: {
        9: ["Begin retrieval"],
        11: ["Continue inclusion decisions", "Document exclusions"]
    },
    extraction: {
        11: ["Begin extraction"],
        15: ["Continue extraction", "Verify fields"],
        20: ["Support Audit 1"],
        28: ["Final verification"]
    },
    analysis: {
        21: ["Set up run package (capsule)"],
        29: ["Run full analysis"],
        30: ["Support Audit 2 reruns"],
        33: ["Lock outputs"],
        40: ["Final manuscript review"]
    }
};

const ROLE_NAMES = {
    integrator: 'Integrator',
    deputy: 'Deputy',
    search: 'Search & Screen',
    fulltext: 'Full-Text',
    extraction: 'Extraction & Quality Risk (RoB)',
    analysis: 'Analysis & Write'
};

const DOD_CHECKLISTS = {
    A: [
        { id: 'a1', text: 'PICOS + inclusion/exclusion defined', story: 'The HRT Reversal: Vague population definitions in observational HRT studies led to 20 years of wrong conclusions. WHI trial revealed the "healthy user bias" that loose criteria had hidden.' },
        { id: 'a2', text: 'Primary outcome specified', story: 'The CAST Tragedy: Anti-arrhythmic drugs improved surrogate outcomes (ECG readings) while killing 50,000+ patients. Your primary outcome must be what patients feel, not what machines measure.' },
        { id: 'a3', text: 'Timepoint rule documented', story: 'The Vioxx Lesson: Merck\'s CV risk only appeared after 18 months. Early timepoints looked safe. Your timepoint rule determines what truth you can see.' },
        { id: 'a4', text: 'Model choice specified (fixed/random)', story: 'Post-hoc model switching is a known manipulation. Pre-specify your model; changing it later to get "better" results is p-hacking.' },
        { id: 'a5', text: 'Sensitivity set defined', story: 'The Tamiflu Illusion: Roche\'s main analysis showed benefit. Sensitivity analyses (which they hid) showed the effect disappeared. Define your sensitivity tests before you see the data.' },
        { id: 'a6', text: 'Secondary outcomes labelled exploratory', story: 'The SSRI Youth Crisis: Secondary analyses "found" suicide risk signals that primary analyses missed. Unlabelled secondary outcomes get cherry-picked. Label them exploratory.' },
        { id: 'a7', text: 'Emergency Fix Mode (CondGO) triggers embedded', story: 'Without pre-specified emergency triggers, teams improvise under pressure. CondGO triggers defined at protocol stage ensure structured crisis response instead of ad-hoc decisions.' },
        { id: 'a8', text: 'Study plan registered (PROSPERO/protocols.io)', story: 'The Outcome Switching Epidemic: A PLOS study found 31% of trials changed primary outcomes between registration and publication. Registration timestamps your promises.' },
        { id: 'a9', text: 'Signed by Integrator + one non-integrator', story: 'The Poldermans Fraud: One researcher fabricated data that killed 800,000 people. Single points of authority enable fraud. Two signatures means two people verified.' }
    ],
    B: [
        { id: 'b1', text: 'Search strings saved verbatim', story: 'The Cochrane Retraction: A Cochrane review was retracted when auditors couldn\'t reproduce the search. "We used PubMed" is not a method. Every character matters.' },
        { id: 'b2', text: 'Search dates + limits recorded', story: 'Databases update daily. A search on Monday finds different studies than Tuesday. Your dates are your timestamp of what universe you searched.' },
        { id: 'b3', text: 'Dedup method recorded', story: 'The Sheffield PRISMA Problem: A review reported 5,200 records screened. Post-publication audit found 1,800 were duplicates. The PRISMA was fiction. Paper retracted.' },
        { id: 'b4', text: 'Screening alignment check completed', story: 'The Inclusion Drift: Two screeners with 60% agreement included contradictory studies. The meta-analysis pooled apples and oranges. Calibrate before you screen.' },
        { id: 'b5', text: 'Study-flow (PRISMA) counts live', story: 'PRISMA exists because of the QUOROM failures. Journals now desk-reject reviews with inconsistent flow diagrams. Your numbers must add up.' },
        { id: 'b6', text: 'Screening log exportable', story: 'Peer reviewers increasingly request raw screening data. "Trust us" is no longer acceptable. Your log is your evidence.' }
    ],
    C: [
        { id: 'c1', text: 'Extraction template frozen', story: 'The BMP Scandal: Spine surgery meta-analyses kept "refining" extraction as results emerged. Industry-funded refinements always favored industry. Freeze your template.' },
        { id: 'c2', text: 'Study quality risk (RoB) tool + decision rules written', story: 'The Stem Cell Collapse: Risk of bias assessments rated fraudulent studies as "low risk." Without decision rules, RoB becomes opinion. Write the rules before you see the studies.' },
        { id: 'c3', text: 'Key fields verified by second person', story: 'The Poldermans Firewall: His fabricated data passed single-extractor review. Dual extraction with verification catches both fraud and honest error. One pair of eyes is not enough.' },
        { id: 'c4', text: 'Overlap rules applied', story: 'The Boldt Overlap: Joachim Boldt published 90+ fraudulent studies with overlapping patients. Meta-analyses counted the same fake patients multiple times. Check for overlap.' },
        { id: 'c5', text: 'Disagreement resolution process active', story: 'Disagreements reveal ambiguity in your protocol. Every arbitration decision should refine your rules. Document them—they\'re protocol amendments.' }
    ],
    D: [
        { id: 'd1', text: 'Run package (capsule) works end-to-end', story: 'The Reproducibility Crisis: 70% of researchers failed to reproduce others\' results (Nature, 2016). If your analysis isn\'t automated end-to-end, it isn\'t reproducible.' },
        { id: 'd2', text: 'Forest + study-difference (I²) outputs', story: 'The Avandia Warning: Nissen\'s forest plot showed clear harm, but I² was 0%—homogeneous disaster. Both the effect AND its consistency matter.' },
        { id: 'd3', text: 'Sensitivity set executed', story: 'The ACCORD Surprise: Main analysis showed benefit from intensive glucose control. Sensitivity analyses revealed the deaths. Run every sensitivity you promised.' },
        { id: 'd4', text: 'High-impact study decisions documented', story: 'The Cardiac Stem Cell Purge: When Harvard retracted 31 papers, every meta-analysis that included them needed re-analysis. Know which studies drive your result.' },
        { id: 'd5', text: 'Audit 2 completed', story: 'The Xigris Failure: Activated protein C was approved on one trial, then failed replication. Your Audit 2 is your internal replication. If you can\'t replicate yourself, neither can anyone else.' },
        { id: 'd6', text: 'Rerun match rules satisfied', story: 'Floating-point errors, package updates, and random seeds cause "identical" analyses to diverge. Tolerance: ≤0.001 for effects, 1% for I². Exact match = reproducible.' }
    ],
    E: [
        { id: 'e1', text: 'Study-flow (PRISMA) checklist complete', story: 'PRISMA was created because reviews were unreportable black boxes. Journals use it as a gate. Incomplete PRISMA = desk rejection.' },
        { id: 'e2', text: 'All appendices complete', story: 'The Tamiflu Appendix Victory: Cochrane\'s detailed appendices exposed Roche\'s hidden data. Your appendices are your evidence locker. Completeness enables verification.' },
        { id: 'e3', text: 'Two reruns match', story: 'The Final Test: If today\'s run differs from yesterday\'s with no data changes, something is wrong. Two equivalent reruns prove stability.' },
        { id: 'e4', text: 'Clinical Summary Panel included', story: 'The Translation Gap: Meta-analyses report odds ratios; clinicians need absolute risks. "OR 0.75" means nothing without "5 fewer deaths per 1000." Translate your statistics.' },
        { id: 'e5', text: 'Evidence confidence check (GRADE) completed', story: 'The Certainty Revolution: Before GRADE, "statistically significant" was enough. Now journals require certainty ratings. A LOW certainty "significant" result tells a different story than HIGH certainty. GRADE separates evidence quality from statistical significance.' },
        { id: 'e6', text: 'Deviations log complete', story: 'Every protocol deviation is a potential bias. The log isn\'t confession—it\'s transparency. Hidden deviations are fraud; documented deviations are science.' },
        { id: 'e7', text: 'Trustworthiness check: 9/9', story: 'The TruthCert Standard: External verification requires documentation. 9/9 means every claim is traceable including GRADE certainty. This is the minimum for a trustworthy review.' }
    ]
};

const AUDIT_GRADE_CRITERIA = [
    { id: 'ag1', text: 'Study plan registered before search', check: () => getProject().protocolPublished },
    { id: 'ag2', text: 'Study-flow (PRISMA) counts complete', check: () => (getProject().prisma?.included ?? 0) > 0 },
    { id: 'ag3', text: 'DoD-A signed off', check: () => getProject().dodGates?.A },
    { id: 'ag4', text: 'DoD-B signed off', check: () => getProject().dodGates?.B },
    { id: 'ag5', text: 'Audit 1 template completed', check: () => (getProject().templateLog || []).some(t => t.type === 'a1') },
    { id: 'ag6', text: 'DoD-C signed off', check: () => getProject().dodGates?.C },
    { id: 'ag7', text: 'Audit 2 template completed', check: () => (getProject().templateLog || []).some(t => t.type === 'a2') },
    { id: 'ag8', text: 'Evidence confidence check (GRADE) completed', check: () => (getProject().templateLog || []).some(t => t.type === 'grade') },
    { id: 'ag9', text: 'Clinical Summary completed', check: () => (getProject().templateLog || []).some(t => t.type === 'clin') }
];

// ===== STATE (Multi-project) =====
let globalState = {
    currentProject: 'default',
    projects: {
        default: createEmptyProject('Default Project')
    }
};

function createEmptyProject(name) {
    return {
        name: sanitizeProjectName(name),
        day: 1,
        role: '',
        protocolUrl: '',
        protocolPublished: false,
        completed: {},
        templateLog: [],
        dodChecked: {},
        dodGates: { A: false, B: false, C: false, D: false, E: false },
        prisma: { identified: 0, deduped: 0, excludedScreen: 0, excludedFulltext: 0, exclusionReasons: '', included: 0 },
        studyCount: 0,
        studies: [],
        robAssessments: [],
        searchBuilder: null,
        taskOwners: {},
        dodOwners: {},
        enterpriseMode: false,
        tutorialCompleted: [],
        createdAt: new Date().toISOString()
    };
}

function sanitizeProjectName(name) {
    const raw = String(name || '').replace(/[\r\n\t]/g, ' ').trim();
    return raw ? raw.slice(0, 80) : 'New Project';
}

function toSafeInt(value, fallback = 0, min = 0, max = 1000000) {
    const n = Number.parseInt(value, 10);
    if (!Number.isFinite(n)) return fallback;
    return Math.min(max, Math.max(min, n));
}

function normalizeOwnerTag(owner) {
    return String(owner || '')
        .toUpperCase()
        .replace(/[^A-Z0-9-]/g, '')
        .slice(0, 12);
}

const MAX_PROJECTS = 50;
const MAX_BOOLEAN_MAP_ENTRIES = 5000;
const MAX_OWNER_MAP_ENTRIES = 2000;
const MAX_BOOLEAN_MAP_SCAN_ENTRIES = 10000;
const MAX_OWNER_MAP_SCAN_ENTRIES = 5000;
const MAX_PROJECT_SCAN_ENTRIES = 500;
const MAX_TEMPLATE_LOG_SCAN_ENTRIES = 1000;
const MAX_IMPORT_FILE_BYTES = 5 * 1024 * 1024;
const MAX_SYNC_CODE_LENGTH = 500000;
const MAX_SYNC_JSON_LENGTH = 2 * 1024 * 1024;

function sanitizeBooleanMap(input) {
    if (!input || typeof input !== 'object' || Array.isArray(input)) return {};
    const out = {};
    let scanned = 0;
    let accepted = 0;
    for (const key in input) {
        if (!Object.prototype.hasOwnProperty.call(input, key)) continue;
        if (scanned >= MAX_BOOLEAN_MAP_SCAN_ENTRIES || accepted >= MAX_BOOLEAN_MAP_ENTRIES) break;
        scanned++;
        if (typeof key !== 'string' || key.startsWith('__')) continue;
        if (!/^[a-z0-9_-]{1,64}$/i.test(key)) continue;
        out[key] = !!input[key];
        accepted++;
    }
    return out;
}

function sanitizeOwnersMap(input) {
    if (!input || typeof input !== 'object' || Array.isArray(input)) return {};
    const out = {};
    let scanned = 0;
    let accepted = 0;
    for (const key in input) {
        if (!Object.prototype.hasOwnProperty.call(input, key)) continue;
        if (scanned >= MAX_OWNER_MAP_SCAN_ENTRIES || accepted >= MAX_OWNER_MAP_ENTRIES) break;
        scanned++;
        if (typeof key !== 'string' || key.startsWith('__')) continue;
        if (!/^[a-z0-9_-]{1,64}$/i.test(key)) continue;
        const normalized = normalizeOwnerTag(input[key]);
        if (!normalized) continue;
        out[key] = normalized;
        accepted++;
    }
    return out;
}

function sanitizeTemplateLog(entries) {
    if (!Array.isArray(entries)) return [];
    const nowIso = new Date().toISOString();
    const safe = [];
    const source = entries.slice(-MAX_TEMPLATE_LOG_SCAN_ENTRIES);

    source.forEach((entry) => {
        if (!entry || typeof entry !== 'object' || Array.isArray(entry)) return;

        let type = String(entry.type || '')
            .replace(/[^A-Za-z0-9-]/g, '')
            .slice(0, 24);

        const lowerType = type.toLowerCase();
        if (/^dod-[abcde]$/.test(lowerType)) {
            type = 'dod-' + lowerType.slice(4).toUpperCase();
        } else {
            type = lowerType;
        }

        if (!type) return;

        const day = toSafeInt(entry.day, 1, 1, 40);
        const timestampDate = new Date(entry.timestamp);
        const timestamp = Number.isNaN(timestampDate.getTime()) ? nowIso : timestampDate.toISOString();
        const content = String(entry.content || '').slice(0, 5000);

        safe.push({ type, day, timestamp, content });
    });

    return safe.slice(-200);
}

function sanitizeProjectData(project, fallbackName = 'Default Project') {
    const base = createEmptyProject(sanitizeProjectName(fallbackName));
    if (!project || typeof project !== 'object' || Array.isArray(project)) return base;

    const role = (typeof project.role === 'string' && ROLE_NAMES[project.role]) ? project.role : '';
    const protocolUrl = String(project.protocolUrl || '').trim().slice(0, 500);
    const protocolValid = isValidProtocolUrl(protocolUrl).valid;

    const prismaRaw = project.prisma && typeof project.prisma === 'object' ? project.prisma : {};
    const prisma = {
        identified: toSafeInt(prismaRaw.identified, 0),
        deduped: toSafeInt(prismaRaw.deduped, 0),
        excludedScreen: toSafeInt(prismaRaw.excludedScreen, 0),
        excludedFulltext: toSafeInt(prismaRaw.excludedFulltext, 0),
        exclusionReasons: String(prismaRaw.exclusionReasons || '').slice(0, 3000),
        included: toSafeInt(prismaRaw.included, 0)
    };

    const rawGates = project.dodGates && typeof project.dodGates === 'object' ? project.dodGates : {};
    const dodGates = {
        A: !!rawGates.A,
        B: !!rawGates.B,
        C: !!rawGates.C,
        D: !!rawGates.D,
        E: !!rawGates.E
    };

    const tutorialCompleted = Array.isArray(project.tutorialCompleted)
        ? Array.from(
            new Set(
                project.tutorialCompleted
                    .map((v) => String(v || '').toLowerCase().replace(/[^a-z0-9_-]/g, '').slice(0, 24))
                    .filter((v) => v.startsWith('tut-'))
            )
        ).slice(0, 200)
        : [];

    const createdAtDate = new Date(project.createdAt);
    const createdAt = Number.isNaN(createdAtDate.getTime()) ? base.createdAt : createdAtDate.toISOString();
    const studyCount = Math.max(toSafeInt(project.studyCount, prisma.included, 0), prisma.included);

    // Sanitize studies array
    const studies = sanitizeStudiesArray(project.studies);
    // Sanitize RoB assessments
    const robAssessments = sanitizeRoBArray(project.robAssessments);
    // Sanitize search builder
    const searchBuilder = sanitizeSearchBuilder(project.searchBuilder);

    return {
        ...base,
        name: sanitizeProjectName(project.name || fallbackName),
        day: toSafeInt(project.day, 1, 1, 40),
        role,
        protocolUrl,
        protocolPublished: !!project.protocolPublished && protocolValid,
        completed: sanitizeBooleanMap(project.completed),
        templateLog: sanitizeTemplateLog(project.templateLog),
        dodChecked: sanitizeBooleanMap(project.dodChecked),
        dodGates,
        prisma,
        studyCount,
        studies,
        robAssessments,
        searchBuilder,
        taskOwners: sanitizeOwnersMap(project.taskOwners),
        dodOwners: sanitizeOwnersMap(project.dodOwners),
        enterpriseMode: !!project.enterpriseMode,
        tutorialCompleted,
        createdAt
    };
}

function toSafeFloat(value, fallback = null) {
    const n = parseFloat(value);
    return Number.isFinite(n) ? n : fallback;
}

const VALID_ROB_JUDGMENTS = ['low', 'some', 'high', ''];
const VALID_EFFECT_TYPES = ['OR', 'RR', 'HR', 'MD', 'SMD', 'RD', 'Other'];

function sanitizeStudiesArray(input) {
    if (!Array.isArray(input)) return [];
    const safe = [];
    const source = input.slice(0, 500);
    source.forEach(s => {
        if (!s || typeof s !== 'object') return;
        safe.push({
            id: String(s.id || '').slice(0, 40) || ('s' + Date.now()),
            authorYear: String(s.authorYear || '').slice(0, 200),
            nTotal: toSafeFloat(s.nTotal),
            nIntervention: toSafeFloat(s.nIntervention),
            nControl: toSafeFloat(s.nControl),
            effectEstimate: toSafeFloat(s.effectEstimate),
            lowerCI: toSafeFloat(s.lowerCI),
            upperCI: toSafeFloat(s.upperCI),
            effectType: VALID_EFFECT_TYPES.includes(s.effectType) ? s.effectType : 'OR',
            weight: toSafeFloat(s.weight),
            notes: String(s.notes || '').slice(0, 500)
        });
    });
    return safe;
}

function sanitizeRoBArray(input) {
    if (!Array.isArray(input)) return [];
    const safe = [];
    const source = input.slice(0, 500);
    source.forEach(r => {
        if (!r || typeof r !== 'object') return;
        const entry = {
            studyId: String(r.studyId || '').slice(0, 40),
            authorYear: String(r.authorYear || '').slice(0, 200)
        };
        ['d1','d2','d3','d4','d5','overall'].forEach(d => {
            entry[d] = VALID_ROB_JUDGMENTS.includes(r[d]) ? r[d] : '';
            entry[d + 'Support'] = String(r[d + 'Support'] || '').slice(0, 500);
        });
        safe.push(entry);
    });
    return safe;
}

function sanitizeSearchBuilder(input) {
    if (!input || typeof input !== 'object') return null;
    const sb = { includeC: !!input.includeC, includeO: !!input.includeO };
    ['P','I','C','O'].forEach(el => {
        const raw = input[el] && typeof input[el] === 'object' ? input[el] : {};
        sb[el] = {
            main: String(raw.main || '').slice(0, 200),
            synonyms: Array.isArray(raw.synonyms) ? raw.synonyms.slice(0, 20).map(s => String(s || '').slice(0, 200)) : [],
            mesh: Array.isArray(raw.mesh) ? raw.mesh.slice(0, 10).map(s => String(s || '').slice(0, 200)) : []
        };
    });
    return sb;
}

function sanitizeGlobalState(data) {
    const safe = { currentProject: 'default', projects: {} };

    const projectsInput = data && typeof data === 'object' ? data.projects : null;
    if (projectsInput && typeof projectsInput === 'object' && !Array.isArray(projectsInput)) {
        let accepted = 0;
        if (Object.prototype.hasOwnProperty.call(projectsInput, 'default')) {
            safe.projects.default = sanitizeProjectData(projectsInput.default, projectsInput.default?.name || 'Default Project');
            accepted = 1;
        }

        let scanned = 0;
        for (const id in projectsInput) {
            if (!Object.prototype.hasOwnProperty.call(projectsInput, id)) continue;
            if (scanned >= MAX_PROJECT_SCAN_ENTRIES || accepted >= MAX_PROJECTS) break;
            scanned++;
            if (id === 'default') continue;
            if (typeof id !== 'string' || id.startsWith('__')) continue;
            if (!/^[a-z0-9_-]{1,64}$/i.test(id)) continue;
            safe.projects[id] = sanitizeProjectData(projectsInput[id], projectsInput[id]?.name || 'Project');
            accepted++;
        }
    }

    if (!safe.projects.default) {
        const ids = Object.keys(safe.projects);
        if (ids.length >= MAX_PROJECTS) {
            const removable = ids.find((id) => id !== 'default');
            if (removable) delete safe.projects[removable];
        }
        safe.projects.default = createEmptyProject('Default Project');
    }

    const requested = (data && typeof data.currentProject === 'string') ? data.currentProject : 'default';
    safe.currentProject = safe.projects[requested] ? requested : Object.keys(safe.projects)[0];
    return safe;
}

function getProject() {
    if (!globalState.projects || typeof globalState.projects !== 'object' || Array.isArray(globalState.projects)) {
        globalState.projects = { default: createEmptyProject('Default Project') };
        globalState.currentProject = 'default';
    }

    if (!globalState.projects[globalState.currentProject]) {
        const ids = Object.keys(globalState.projects);
        if (ids.length > 0) {
            globalState.currentProject = ids[0];
        } else {
            globalState.projects.default = createEmptyProject('Default Project');
            globalState.currentProject = 'default';
        }
    }
    return globalState.projects[globalState.currentProject];
}

function setProject(data) {
    const current = getProject();
    const merged = { ...current, ...(data || {}) };
    const fallbackName = merged.name || current.name || 'Project';
    globalState.projects[globalState.currentProject] = sanitizeProjectData(merged, fallbackName);
}

// Legacy compatibility - state getter/setter that proxies to current project
// Using a proxy object instead of a variable to ensure property access works correctly
const state = new Proxy({}, {
    get: (target, prop) => {
        const project = getProject();
        return project ? project[prop] : undefined;
    },
    set: (target, prop, value) => {
        const project = getProject();
        if (project) {
            project[prop] = value;
            return true;
        }
        return false;
    },
    has: (target, prop) => {
        const project = getProject();
        return project ? prop in project : false;
    },
    ownKeys: () => {
        const project = getProject();
        return project ? Object.keys(project) : [];
    },
    getOwnPropertyDescriptor: (target, prop) => {
        const project = getProject();
        if (project && prop in project) {
            return { configurable: true, enumerable: true, writable: true, value: project[prop] };
        }
        return undefined;
    }
});

// ===== TOAST =====
let toastTimeout;
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    document.getElementById('toastText').textContent = message;
    document.getElementById('toastIcon').textContent = type === 'error' ? '✗' : '✓';
    toast.className = 'toast visible' + (type === 'error' ? ' error' : '');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => toast.classList.remove('visible'), 2500);
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
    // Try new format first
    const savedNew = localStorage.getItem('metasprint-v3');
    if (savedNew) {
        try {
            const data = JSON.parse(savedNew);
            globalState = sanitizeGlobalState(data);
        } catch(e) {}
    } else {
        // Migrate from old format
        const savedOld = localStorage.getItem('metasprint-v9');
        if (savedOld) {
            try {
                const oldState = JSON.parse(savedOld);
                globalState.projects.default = sanitizeProjectData(
                    { ...createEmptyProject('Default Project'), ...oldState },
                    'Default Project'
                );
                globalState.currentProject = 'default';
            } catch(e) {}
        }
    }
    
    if (getProject().role) {
        document.getElementById('onboarding').classList.add('hidden');
        document.getElementById('app').style.display = 'block';
        render();

        // Load enterprise mode
        loadEnterpriseMode();

        // Load tutorial progress
        loadTutorialProgress();

        // Pulse day hint for users on Day 1-3 to highlight keyboard navigation
        if (getProject().day <= 3 && !localStorage.getItem('metasprint-hint-seen')) {
            const hint = document.querySelector('.day-hint');
            if (hint) hint.classList.add('pulse');
            // Mark as seen after animation completes
            setTimeout(() => { try { localStorage.setItem('metasprint-hint-seen', 'true'); } catch(e) {} }, 6000);
        }

        // Show first-time wizard for new users (Day 1, wizard not yet seen)
        if (getProject().day === 1 && !localStorage.getItem('metasprint_wizard_seen')) {
            setTimeout(showWizard, 500);
        }
    }

    // Load dark mode preference
    loadDarkMode();

    updateProjectDropdown();
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        // Escape closes any visible overlay
        if (e.key === 'Escape') {
            const visibleModal = document.querySelector('.modal.visible');
            if (visibleModal) { closeModal(visibleModal.id); e.preventDefault(); return; }
            const dayJump = document.querySelector('.day-jump-modal.visible');
            if (dayJump) { closeDayJump(); e.preventDefault(); return; }
            const wizard = document.querySelector('.wizard-overlay.visible');
            if (wizard) { closeWizard(); e.preventDefault(); return; }
            const onboarding = document.querySelector('.onboarding:not(.hidden)');
            if (onboarding && document.getElementById('app').style.display !== 'none') {
                onboarding.classList.add('hidden'); e.preventDefault(); return;
            }
        }
        // Ctrl+Z for undo (works everywhere except in inputs)
        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
            if (document.querySelector('.modal.visible, .day-jump-modal.visible, .wizard-overlay.visible')) return;
            e.preventDefault();
            performUndo();
            return;
        }
        if (document.getElementById('app').style.display === 'none') return;
        if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
        if (document.querySelector('.modal.visible, .day-jump-modal.visible, .wizard-overlay.visible')) return;
        if (e.key === 'ArrowLeft') { changeDay(-1); e.preventDefault(); }
        else if (e.key === 'ArrowRight') { changeDay(1); e.preventDefault(); }
    });
});

function save() {
    try {
        const current = getProject();
        globalState.projects[globalState.currentProject] = sanitizeProjectData(current, current.name || 'Project');
        localStorage.setItem('metasprint-v3', JSON.stringify(globalState));
    }
    catch(e) { if (e.name === 'QuotaExceededError') showToast('Storage full — export your data to free space', 'error'); }
}

function saveWithToast() {
    save();
    showToast('Progress saved');
}

// ===== PROJECT MANAGEMENT =====
function updateProjectDropdown() {
    const dropdown = document.getElementById('projectDropdown');
    if (!dropdown) return;
    dropdown.innerHTML = '';
    Object.keys(globalState.projects).forEach(id => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = globalState.projects[id].name || id;
        if (id === globalState.currentProject) opt.selected = true;
        dropdown.appendChild(opt);
    });
}

function switchProject() {
    const selected = document.getElementById('projectDropdown').value;
    if (!globalState.projects[selected]) {
        updateProjectDropdown();
        showToast('Invalid project selection', 'error');
        return;
    }
    globalState.currentProject = selected;
    undoStack.length = 0; // Clear undo stack — entries belong to previous project
    save();
    render();
    showToast('Switched to ' + getProject().name);
}

function createNewProject() {
    openModal('newProjectModal');
    document.getElementById('newProjectNameInput').value = '';
    document.getElementById('newProjectNameInput').focus();
}

function confirmNewProject() {
    if (Object.keys(globalState.projects).length >= MAX_PROJECTS) {
        showToast(`Project limit reached (${MAX_PROJECTS})`, 'error');
        return;
    }
    const name = sanitizeProjectName(document.getElementById('newProjectNameInput').value);
    let id = 'proj_' + Date.now();
    while (globalState.projects[id]) {
        id = 'proj_' + Date.now() + '_' + Math.floor(Math.random() * 1000000);
    }
    globalState.projects[id] = createEmptyProject(name);
    globalState.currentProject = id;
    undoStack.length = 0; // New project should not inherit undo history
    save();
    updateProjectDropdown();
    closeModal('newProjectModal');
    
    // Show onboarding for new project
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
    document.querySelectorAll('.elig-item').forEach(el => el.classList.remove('checked'));
    document.getElementById('nextBtn1').disabled = true;
    document.getElementById('onboarding').classList.remove('hidden');
    
    showToast('Created: ' + name);
}

function updateProjectName() {
    const raw = document.getElementById('projectNameInput').value.trim();
    if (raw) {
        setProject({ name: sanitizeProjectName(raw) });
        save();
        updateProjectDropdown();
        showToast('Project renamed');
    }
}

function deleteCurrentProject() {
    if (Object.keys(globalState.projects).length <= 1) {
        showToast('Cannot delete the only project', 'error');
        return;
    }
    if (!confirm('Delete "' + getProject().name + '"? This cannot be undone.')) return;
    
    delete globalState.projects[globalState.currentProject];
    globalState.currentProject = Object.keys(globalState.projects)[0];
    undoStack.length = 0; // Clear undo entries tied to deleted project
    save();
    updateProjectDropdown();
    closeModal('settingsModal');
    render();
    showToast('Project deleted');
}

// ===== EXPORT / IMPORT =====
function exportAllState() {
    const data = JSON.stringify(globalState, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `metasprint-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Exported all data');
}

function importState(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (file.size > MAX_IMPORT_FILE_BYTES) {
        showToast(`Backup file too large (max ${Math.round(MAX_IMPORT_FILE_BYTES / (1024 * 1024))} MB)`, 'error');
        event.target.value = '';
        return;
    }
    const reader = new FileReader();
    reader.onerror = () => {
        showToast('Failed to read backup file', 'error');
        event.target.value = '';
    };
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (data.projects && typeof data.projects === 'object' && Object.keys(data.projects).length > 0) {
                globalState = sanitizeGlobalState(data);
                undoStack.length = 0; // Imported state supersedes previous undo chain
                save();
                updateProjectDropdown();
                render();
                showToast('Data imported successfully');
            } else {
                showToast('Invalid backup file', 'error');
            }
        } catch (err) {
            showToast('Failed to import: ' + err.message, 'error');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// ===== TEAM SYNC =====
function generateSyncCode() {
    const project = getProject();
    const json = JSON.stringify(project);
    // Use LZ-String compression for smaller codes
    const compressed = LZString.compressToBase64(json);
    let uncompressed;
    try { uncompressed = btoa(unescape(encodeURIComponent(json))); } catch(e) { uncompressed = null; }
    // Use whichever is smaller (compression helps for larger data); fallback to LZ if btoa fails
    const code = (!uncompressed || compressed.length < uncompressed.length) ? 'LZ:' + compressed : uncompressed;

    document.getElementById('syncCodeOutput').textContent = code;
    document.getElementById('syncCodeBox').style.display = 'block';

    // Show character count with compression info
    const lengthEl = document.getElementById('syncCodeLength');
    if (lengthEl) {
        const savings = uncompressed ? Math.round((1 - code.length / uncompressed.length) * 100) : 0;
        lengthEl.textContent = `${code.length.toLocaleString()} characters` + (code.startsWith('LZ:') && uncompressed ? ` (${savings}% smaller with compression)` : '');
    }

    // Show warning for large codes
    const warningEl = document.getElementById('syncCodeWarning');
    if (warningEl) {
        warningEl.style.display = code.length > 800 ? 'block' : 'none';
    }
}

function copySyncCode() {
    const code = document.getElementById('syncCodeOutput').textContent;
    navigator.clipboard.writeText(code).then(() => {
        showToast('Sync code copied');
    }).catch(() => {
        showToast('Could not copy — select and copy manually', 'error');
    });
}

function showImportSyncModal() {
    closeModal('settingsModal');
    document.getElementById('syncImportInput').value = '';
    openModal('syncImportModal');
}

function importSyncCode() {
    const rawCode = document.getElementById('syncImportInput').value.trim();
    const code = rawCode.replace(/\s+/g, '');
    if (!code) {
        showToast('Invalid sync code', 'error');
        return;
    }
    if (code.length > MAX_SYNC_CODE_LENGTH) {
        showToast('Sync code is too long', 'error');
        return;
    }
    try {
        let json;
        // Check if compressed with LZ-String
        if (code.startsWith('LZ:')) {
            json = LZString.decompressFromBase64(code.substring(3));
        } else {
            json = decodeURIComponent(escape(atob(code)));
        }
        if (typeof json !== 'string' || !json) {
            showToast('Invalid sync code', 'error');
            return;
        }
        if (json.length > MAX_SYNC_JSON_LENGTH) {
            showToast('Decoded sync payload is too large', 'error');
            return;
        }
        const data = JSON.parse(json);
        if (data && typeof data === 'object' && !Array.isArray(data)) {
            const safeProject = sanitizeProjectData(data, getProject().name || 'Synced Project');
            if (!safeProject.role || !safeProject.day) {
                showToast('Invalid sync code', 'error');
                return;
            }
            setProject(safeProject);
            undoStack.length = 0; // Synced snapshot replaces local progression
            save();
            closeModal('syncImportModal');
            render();
            showToast('Synced successfully');
        } else {
            showToast('Invalid sync code', 'error');
        }
    } catch (err) {
        showToast('Failed to decode sync code', 'error');
    }
}

// ===== MODALS =====
function openModal(id) {
    const modal = document.getElementById(id);
    modal._trigger = document.activeElement;
    modal.classList.add('visible');
    if (id === 'settingsModal') {
        document.getElementById('projectNameInput').value = getProject().name || '';
    }
    setTimeout(() => {
        const f = modal.querySelector('input:not([type=hidden]), button, [tabindex="0"]');
        if (f) f.focus();
    }, 50);
}

function closeModal(id) {
    const modal = document.getElementById(id);
    modal.classList.remove('visible');
    if (modal._trigger) {
        modal._trigger.focus();
        modal._trigger = null;
    }
}

function resetAllData() {
    if (!confirm('This will delete ALL projects and data. Are you sure?')) return;
    if (!confirm('Really? This cannot be undone.')) return;
    localStorage.removeItem('metasprint-v3');
    localStorage.removeItem('metasprint-v9');
    location.reload();
}

// ===== ONBOARDING =====
function toggleElig(el) {
    el.classList.toggle('checked');
    const all = document.querySelectorAll('.elig-item');
    const checked = document.querySelectorAll('.elig-item.checked');
    document.getElementById('nextBtn1').disabled = checked.length < all.length;
    document.getElementById('eligWarning').style.display = (checked.length > 0 && checked.length < all.length) ? 'block' : 'none';
}

function goToStep2() {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
}

function selectRole(el, role) {
    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    state.role = role;
    document.getElementById('startBtn').disabled = false;
}

function startApp() {
    save();
    document.getElementById('onboarding').classList.add('hidden');
    document.getElementById('app').style.display = 'block';
    render();
}

function showRoleChange() {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('onboarding').classList.remove('hidden');
}

// ===== NAVIGATION =====
// Note: showPage() is defined later in the file with proper tab handling

function changeDay(delta) {
    state.day = Math.max(1, Math.min(40, state.day + delta));
    document.querySelector('[role="progressbar"]')?.setAttribute('aria-valuenow', state.day);
    save();
    render();
}

// ===== PROJECT HEALTH DASHBOARD =====
function updateStudyCount() {
    const input = document.getElementById('studyCountInput');
    if (!input) return;
    const count = Math.max(0, parseInt(input.value, 10) ?? 0);
    setProject({ studyCount: count });
    save();
    renderHealthDashboard();
}

function buildRiskState(project, day, gates, studyCount, daysToFreeze) {
    const gateDeadlines = { A: 3, B: 10, C: 28, D: 33, E: 40 };
    const risks = [];
    let points = 0;

    Object.keys(gateDeadlines).forEach((gate) => {
        const deadline = gateDeadlines[gate];
        if (day > deadline && !gates[gate]) {
            const overdueDays = day - deadline;
            risks.push({
                level: 'high',
                text: `DoD-${gate} overdue by ${overdueDays} day(s).`
            });
            points += 3;
        }
    });

    if (day > 3 && !project.protocolPublished) {
        risks.push({
            level: 'high',
            text: 'Study plan is not marked as public after Day 3.'
        });
        points += 2;
    }

    if (daysToFreeze <= 3 && day < 34 && !gates.D) {
        risks.push({
            level: 'medium',
            text: `Freeze in ${daysToFreeze} day(s), but DoD-D is not signed off yet.`
        });
        points += 2;
    }

    if (studyCount > 0 && (studyCount < 40 || studyCount > 60)) {
        risks.push({
            level: 'medium',
            text: `Study count ${studyCount} is outside target range (40-60).`
        });
        points += 1;
    } else if (studyCount === 0 && day > 10) {
        risks.push({
            level: 'medium',
            text: 'Study count is still zero after Day 10. Confirm study-flow (PRISMA) included count.'
        });
        points += 1;
    }

    let level = 'low';
    if (points >= 4) level = 'high';
    else if (points >= 2) level = 'medium';

    if (risks.length === 0) {
        risks.push({ level: 'low', text: 'No active risks. Keep completing daily tasks.' });
    }

    return { level, items: risks };
}

function renderRiskPanel(riskState) {
    const badge = document.getElementById('riskStatusBadge');
    const list = document.getElementById('riskList');
    if (!badge || !list) return;

    badge.className = 'risk-badge ' + riskState.level;
    badge.textContent = riskState.level.toUpperCase();

    list.innerHTML = riskState.items.map((risk) => {
        const cls = risk.level === 'high' ? 'risk-item high' : (risk.level === 'medium' ? 'risk-item medium' : 'risk-item');
        return `<li class="${cls}">${escapeHtml(risk.text)}</li>`;
    }).join('');
}

function renderHealthDashboard() {
    const d = state.day;
    const project = getProject();
    const gates = project.dodGates || {};

    // Days remaining
    const daysLeft = 40 - d;
    const daysToFreeze = Math.max(0, 34 - d);
    document.getElementById('daysRemaining').textContent = daysLeft;
    document.getElementById('daysToFreeze').textContent = daysToFreeze;
    document.getElementById('daysToFreeze').classList.toggle('urgent', daysToFreeze <= 3 && daysToFreeze > 0);

    // Gates passed
    const gatesPassed = ['A', 'B', 'C', 'D', 'E'].filter(g => gates[g]).length;
    document.getElementById('gatesPassed').textContent = `${gatesPassed}/5`;

    // Gate dots
    const gateDeadlines = { A: 3, B: 10, C: 28, D: 33, E: 40 };
    ['A', 'B', 'C', 'D', 'E'].forEach(g => {
        const dot = document.getElementById('gate' + g);
        dot.classList.remove('passed', 'current');
        if (gates[g]) {
            dot.classList.add('passed');
        } else if (d <= gateDeadlines[g] && (g === 'A' || gates[String.fromCharCode(g.charCodeAt(0) - 1)])) {
            dot.classList.add('current');
        }
    });

    // Study count
    const studyCount = project.studyCount ?? 0;
    document.getElementById('studyCount').textContent = studyCount;
    document.getElementById('studyCountInput').value = studyCount;

    // Calculate health score
    let healthScore = 100;
    // Deduct for overdue gates
    if (d > 3 && !gates.A) healthScore -= 20;
    if (d > 10 && !gates.B) healthScore -= 20;
    if (d > 28 && !gates.C) healthScore -= 20;
    if (d > 33 && !gates.D) healthScore -= 20;
    // Deduct for study count outside range
    if (studyCount > 0 && (studyCount < 40 || studyCount > 60)) healthScore -= 10;
    // Bonus for being ahead
    if (d <= 3 && gates.A) healthScore = Math.min(100, healthScore + 5);
    healthScore = Math.max(0, healthScore);

    const scoreEl = document.getElementById('healthScore');
    scoreEl.textContent = healthScore + '%';
    scoreEl.className = 'health-score ' + (healthScore >= 80 ? 'good' : healthScore >= 50 ? 'warning' : 'danger');

    // Next gate banner
    const nextGate = ['A', 'B', 'C', 'D', 'E'].find(g => !gates[g]);
    const banner = document.getElementById('nextGateBanner');
    const bannerText = document.getElementById('nextGateText');
    if (nextGate) {
        const deadline = gateDeadlines[nextGate];
        const daysUntil = deadline - d;
        banner.style.display = 'flex';
        if (daysUntil < 0) {
            banner.className = 'next-gate-banner urgent';
            bannerText.innerHTML = `<strong>⚠️ DoD-${nextGate} is OVERDUE by ${Math.abs(daysUntil)} day(s)!</strong> Complete all required checklist items now.`;
        } else if (daysUntil <= 2) {
            banner.className = 'next-gate-banner urgent';
            bannerText.innerHTML = `<strong>DoD-${nextGate} due in ${daysUntil} day(s)!</strong> Check the Checkpoints (DoD) tab for remaining items.`;
        } else {
            banner.className = 'next-gate-banner';
            bannerText.innerHTML = `Next milestone: <strong>DoD-${nextGate}</strong> on Day ${deadline} (${daysUntil} days)`;
        }
    } else {
        banner.style.display = 'none';
    }

    const riskState = buildRiskState(project, d, gates, studyCount, daysToFreeze);
    renderRiskPanel(riskState);

    // Update workload summary (enterprise only)
    renderWorkloadSummary();
}

// ===== RENDER =====
function render() {
    const d = state.day;
    document.getElementById('dayNum').textContent = d;
    document.getElementById('prevBtn').disabled = d <= 1;
    document.getElementById('nextBtn').disabled = d >= 40;
    document.getElementById('roleBadge').textContent = ROLE_NAMES[state.role] || state.role;
    document.getElementById('freezeBanner').classList.toggle('hidden', d < 34);
    
    // Workload badge
    const workloadInfo = WORKLOAD.find(w => d >= w.days[0] && d <= w.days[1]);
    const workloadBadge = document.getElementById('workloadBadge');
    if (workloadInfo) {
        workloadBadge.textContent = `⏱️ ${workloadInfo.hours}/day`;
        workloadBadge.classList.toggle('peak', workloadInfo.peak);
    }
    
    // Phase badge
    const phase = PHASES.find(p => d >= p.days[0] && d <= p.days[1]) || PHASES[4];
    const badge = document.getElementById('phaseBadge');
    badge.textContent = phase.name;
    badge.className = 'phase-badge ' + phase.cls;
    
    // Timeline
    document.getElementById('timelineFill').style.width = ((d / 40) * 100) + '%';
    
    MILESTONES.forEach((m, i) => {
        const el = document.getElementById('m' + (i + 1));
        if (el) {
            el.classList.remove('active', 'passed');
            if (d >= m) el.classList.add('passed');
            else if (d >= m - 2) el.classList.add('active');
        }
    });
    
    // Study plan registration (full form for first 5 days, compact badge after)
    const protocolReg = document.getElementById('protocolReg');
    let compactBadge = document.getElementById('protocolBadgeCompact');
    if (d <= 5) {
        protocolReg.style.display = 'block';
        if (compactBadge) compactBadge.style.display = 'none';
    } else {
        protocolReg.style.display = 'none';
        if (!compactBadge) {
            compactBadge = document.createElement('div');
            compactBadge.id = 'protocolBadgeCompact';
            compactBadge.className = 'protocol-badge-compact';
            protocolReg.parentElement.insertBefore(compactBadge, protocolReg.nextSibling);
        }
        if (state.protocolPublished && state.protocolUrl) {
            const truncUrl = state.protocolUrl.length > 40 ? state.protocolUrl.substring(0, 40) + '...' : state.protocolUrl;
            compactBadge.className = 'protocol-badge-compact registered';
            compactBadge.innerHTML = '<span>Study plan registered</span> <a href="' + escapeHtml(state.protocolUrl) + '" target="_blank" rel="noopener" style="color:inherit;text-decoration:underline">' + escapeHtml(truncUrl) + '</a>';
        } else {
            compactBadge.className = 'protocol-badge-compact not-registered';
            compactBadge.textContent = 'Study plan not yet registered';
        }
        compactBadge.style.display = 'flex';
    }
    document.getElementById('protocolUrl').value = state.protocolUrl || '';
    updateProtocolCheckState();
    document.getElementById('protocolCheck').classList.toggle('checked', state.protocolPublished);
    
    // Goal
    document.getElementById('goalText').textContent = GOALS[d] || 'Continue current phase work.';

    renderHealthDashboard();
    renderAlerts();
    renderTasks();
    renderTimelineTable();
}

function renderAlerts() {
    const d = state.day;
    let html = '';
    if (d <= 3 && !state.protocolPublished) {
        html += '<div class="alert alert-warning"><div class="alert-icon">📋</div><div class="alert-content"><div class="alert-title">Study plan not registered</div><div class="alert-text">DoD-A requires a registered study plan on PROSPERO or protocols.io.</div><div class="alert-story">📖 A PLOS study found 31% of trials changed primary outcomes between registration and publication. Registration timestamps your original plan.</div></div></div>';
    }
    if (d >= 18 && d <= 20) {
        html += '<div class="alert alert-warning"><div class="alert-icon">🔍</div><div class="alert-content"><div class="alert-title">Audit 1 Window</div><div class="alert-text">10% trace audit. Use Appendix D.</div><div class="alert-story">📖 The Poldermans fraud passed collaborative review for years. 800,000 died from guidelines built on fabricated data. Your trace audit asks: "Does this number exist in this source?" Fraud cannot survive this question.</div></div></div>';
    }
    if (d >= 30 && d <= 32) {
        html += '<div class="alert alert-warning"><div class="alert-icon">🔍</div><div class="alert-content"><div class="alert-title">Audit 2 Window</div><div class="alert-text">Rerun match verification. Use Appendix D.</div><div class="alert-story">📖 The Xigris failure: Activated protein C was approved on one trial, then failed replication. Audit 2 is your internal replication test. If you cannot reproduce your own results, reviewers will not either.</div></div></div>';
    }
    if (d === 34) {
        html += '<div class="alert alert-danger"><div class="alert-icon">🔒</div><div class="alert-content"><div class="alert-title">FREEZE begins today</div><div class="alert-text">No new studies can be added. Only corrections are allowed.</div><div class="alert-story">📖 The BMP scandal: Industry kept "discovering" new studies favoring their product. Each addition shifted the meta-analysis. Freeze prevents late scope creep.</div></div></div>';
    }
    document.getElementById('alertsContainer').innerHTML = html;
}

function renderTasks() {
    const d = state.day;
    const role = state.role;
    let tasks = [];
    if (ROLE_TASKS[role]) tasks = ROLE_TASKS[role][d] || ROLE_TASKS[role].default || [];
    if (role !== 'integrator' && d >= 11 && d <= 33) tasks = [...tasks, "If on red-team today: Complete micro-check (Templates → Red-Team)"];
    
    let html = '';
    if (tasks.length === 0) {
        html = `
            <div class="no-tasks">
                <div class="no-tasks-icon">✓</div>
                <div class="no-tasks-title">No specific tasks today</div>
                <div class="no-tasks-text">Continue your standard ${ROLE_NAMES[role] || role} duties. Check with your pod lead if unsure.</div>
            </div>
        `;
    } else {
        tasks.forEach((task, i) => {
            const key = `${d}-${role}-${i}`;
            const checked = state.completed[key];
            const owner = state.taskOwners?.[key] || '';
            const safeOwner = escapeHtml(owner);
            const enterpriseField = state.enterpriseMode ? `
                <div class="task-owner enterprise-only" onclick="event.stopPropagation()">
                    <span class="task-owner-label">Assigned:</span>
                    ${safeOwner ? `<span class="task-owner-badge">${safeOwner}</span>` : ''}
                    <input type="text" class="task-owner-input" value="${safeOwner}" placeholder="Initials"
                        onchange="updateTaskOwner('${key}', this.value)" onclick="event.stopPropagation()">
                </div>
            ` : '';
            html += `<div class="checklist-item ${checked ? 'checked' : ''}" tabindex="0" onclick="toggleTask('${key}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                <div class="checklist-content">
                    <div class="checklist-title">${escapeHtml(task)}</div>
                    ${enterpriseField}
                </div>
            </div>`;
        });
    }
    document.getElementById('tasksContainer').innerHTML = html;
    
    let actions = '<button class="copy-btn" onclick="showPage(\'templates\')">📝 Open Templates</button>';
    document.getElementById('quickActions').innerHTML = actions;
}

function toggleTask(key) {
    const previousState = state.completed[key] || false;
    // Push to undo stack before changing
    pushUndo('checkbox', { type: 'task', id: key, previousState });

    state.completed[key] = !state.completed[key];
    save();
    renderTasks();
    showToast('Saved (Ctrl+Z to undo)');
}

function updateTaskOwner(key, owner) {
    if (!state.taskOwners) state.taskOwners = {};
    const normalized = normalizeOwnerTag(owner);
    if (normalized) state.taskOwners[key] = normalized;
    else delete state.taskOwners[key];
    save();
    renderTasks();
}

function updateDoDOwner(itemId, owner) {
    const project = getProject();
    if (!project.dodOwners) project.dodOwners = {};
    const normalized = normalizeOwnerTag(owner);
    if (normalized) project.dodOwners[itemId] = normalized;
    else delete project.dodOwners[itemId];
    save();
    renderDoDPage();
}

function renderTimelineTable() {
    let html = '';
    PHASES.forEach(p => {
        const d = state.day;
        let status = 'Upcoming', cls = '';
        if (d > p.days[1]) { status = '✅ Complete'; cls = 'color:var(--success)'; }
        else if (d >= p.days[0]) { status = '🔄 Active'; cls = 'color:var(--warning)'; }
        html += `<tr><td><strong>DoD-${p.id}: ${p.name}</strong></td><td>Days ${p.days[0]}-${p.days[1]}</td><td>Day ${p.days[1]}</td><td style="${cls}">${status}</td></tr>`;
    });
    document.getElementById('timelineTable').innerHTML = html;
}

// ===== PROTOCOL =====
function onProtocolUrlChange() { 
    const input = document.getElementById('protocolUrl');
    const normalized = String(input.value || '').trim().slice(0, 500);
    input.value = normalized;
    state.protocolUrl = normalized;
    updateProtocolCheckState();
    save(); 
}

function normalizeProtocolUrl(url) {
    if (!url || !url.trim()) return null;
    const raw = url.trim();
    const candidate = /^[a-z][a-z0-9+.-]*:/i.test(raw) ? raw : `https://${raw}`;
    try {
        const parsed = new URL(candidate);
        if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') return null;
        if (!parsed.hostname) return null;
        return parsed;
    } catch (e) {
        return null;
    }
}

function isValidProtocolUrl(url) {
    const parsed = normalizeProtocolUrl(url);
    if (!parsed) return { valid: false, type: null, normalizedUrl: null };

    const host = parsed.hostname.toLowerCase();
    const path = parsed.pathname.toLowerCase();

    // Check for PROSPERO URL
    if (host === 'prospero.crd.york.ac.uk' || (host === 'www.crd.york.ac.uk' && path.includes('/prospero'))) {
        return { valid: true, type: 'PROSPERO', normalizedUrl: parsed.toString() };
    }

    // Check for protocols.io URL
    if (host === 'protocols.io' || host.endsWith('.protocols.io')) {
        return { valid: true, type: 'protocols.io', normalizedUrl: parsed.toString() };
    }

    return { valid: true, type: 'Other', normalizedUrl: parsed.toString() };
}

function updateProtocolCheckState() {
    const url = state.protocolUrl || '';
    const validation = isValidProtocolUrl(url);
    const hasUrl = url.trim().length > 0;
    
    const inputEl = document.getElementById('protocolUrl');
    const checkEl = document.getElementById('protocolCheck');
    const hintEl = document.getElementById('protocolHint');
    const validationEl = document.getElementById('protocolValidation');
    const openBtn = document.getElementById('protocolOpenBtn');
    
    // Update input styling
    inputEl.classList.remove('valid', 'invalid');
    if (hasUrl) {
        inputEl.classList.add(validation.valid ? 'valid' : 'invalid');
    }
    
    // Update validation message
    if (validationEl) {
        validationEl.classList.remove('valid', 'invalid');
        if (!hasUrl) {
            validationEl.textContent = '';
        } else if (validation.valid) {
            validationEl.classList.add('valid');
            validationEl.textContent = `✓ Valid ${validation.type} URL`;
        } else {
            validationEl.textContent = '';
        }
    }
    
    // Update Open button
    if (openBtn) {
        openBtn.disabled = !validation.valid;
    }
    
    // Update checkbox state
    if (validation.valid) {
        checkEl.classList.remove('disabled');
        hintEl.textContent = 'Click to confirm this study plan page is public and accessible';
    } else {
        checkEl.classList.add('disabled');
        state.protocolPublished = false;
        checkEl.classList.remove('checked');
        hintEl.textContent = 'Enter a valid link above to enable this checkbox';
    }
}

function openProtocolUrl() {
    const validation = isValidProtocolUrl(state.protocolUrl || '');
    if (validation.valid && validation.normalizedUrl) {
        window.open(validation.normalizedUrl, '_blank', 'noopener,noreferrer');
    }
}

function toggleProtocolPublished() {
    const validation = isValidProtocolUrl(state.protocolUrl);
    if (!validation.valid) return; // Don't toggle if no valid URL

    const previousState = state.protocolPublished || false;
    // Push to undo stack before changing
    pushUndo('checkbox', { type: 'protocol', id: 'protocolPublished', previousState });

    state.protocolPublished = !state.protocolPublished;
    document.getElementById('protocolCheck').classList.toggle('checked', state.protocolPublished);
    save();
    render();
    showToast('Saved (Ctrl+Z to undo)');
}

// ===== TEMPLATES =====
function toggleTemplate(el) {
    const body = el.nextElementSibling;
    if (body && body.classList.contains('template-body')) {
        body.classList.toggle('open');
        el.setAttribute('aria-expanded', body.classList.contains('open') ? 'true' : 'false');
    }
}

function toggleDecision(el) { el.classList.toggle('open'); }
function toggleRTFail() {
    document.getElementById('rt-fail-row').style.display = document.getElementById('rt-result').value === 'fail' ? 'block' : 'none';
}

function escapeHtml(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function showOutput(id, text) {
    const el = document.getElementById(id);
    el.textContent = text;
    el.classList.add('visible');
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard & saved');
    }).catch(() => {
        showToast('Saved (clipboard unavailable)');
    });

    // Log to state for audit trail
    if (!state.templateLog) state.templateLog = [];
    state.templateLog.push({
        type: id.replace('-output', ''),
        timestamp: new Date().toISOString(),
        day: state.day,
        content: text
    });
    while (state.templateLog.length > 200) state.templateLog.shift();
    save();
}

function logTemplate(type, summary) {
    if (!state.templateLog) state.templateLog = [];
    state.templateLog.push({
        type: type,
        timestamp: new Date().toISOString(),
        day: state.day,
        content: summary
    });
    save();
}

function downloadTemplate(type) {
    const outputEl = document.getElementById(type + '-output');
    if (!outputEl || !outputEl.textContent) {
        showToast('Generate template first', 'error');
        return;
    }
    
    const text = outputEl.textContent;
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `metasprint-${type}-day${state.day}-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Downloaded');
}

// Template generators
function generateConsult() {
    const text = `CONSULT PACK — Day ${state.day}
========================================
DECISION: ${document.getElementById('consult-decision').value}
CONTEXT: ${document.getElementById('consult-context').value}
EVIDENCE: ${document.getElementById('consult-evidence').value}
OPTION A: ${document.getElementById('consult-optionA').value}
OPTION B: ${document.getElementById('consult-optionB').value}
RECOMMENDATION: ${document.getElementById('consult-rec').value}
========================================`;
    showOutput('consult-output', text);
}

function generateRedTeam() {
    const result = document.getElementById('rt-result').value;
    let text = `RED-TEAM MICRO-CHECK — Day ${state.day}
========================================
Study: ${document.getElementById('rt-study').value}
Type: ${document.getElementById('rt-type').value}
Check: ${document.getElementById('rt-check').value}
Result: ${result.toUpperCase()}`;
    if (result === 'fail') text += `\nError: ${document.getElementById('rt-error').value}`;
    text += `\nChecker: ${document.getElementById('rt-checker').value}`;
    showOutput('rt-output', text);
}

function generateAudit1() {
    const text = `AUDIT 1 — Days 18-20
========================================
Studies: ${document.getElementById('a1-studies').value}
Errors: ${document.getElementById('a1-errors').value}
Result: ${document.getElementById('a1-result').value}
Auditors: ${document.getElementById('a1-auditors').value}`;
    showOutput('a1-output', text);
}

function generateAudit2() {
    const text = `AUDIT 2 — Days 30-32
========================================
Rerun: ${document.getElementById('a2-rerun').value}
Influential: ${document.getElementById('a2-influential').value}
Result: ${document.getElementById('a2-result').value}`;
    showOutput('a2-output', text);
}

function generateDeviation() {
    const text = `DEVIATION LOG
========================================
ID: ${document.getElementById('dev-id').value}
Date: ${document.getElementById('dev-date').value}
Type: ${document.getElementById('dev-type').value}
What: ${document.getElementById('dev-what').value}
Why: ${document.getElementById('dev-why').value}
Impact: ${document.getElementById('dev-impact').value}
Approved: ${document.getElementById('dev-approvers').value}`;
    showOutput('dev-output', text);
}

function generateClinical() {
    const text = `CLINICAL SUMMARY PANEL
========================================
1. PICOS: ${document.getElementById('clin-picos').value}
2. RESULT: ${document.getElementById('clin-result').value}
3. ROB: ${document.getElementById('clin-rob').value}
4. ABSOLUTE: ${document.getElementById('clin-absolute').value}
5. APPLICABILITY: ${document.getElementById('clin-applicability').value}
6. UNCERTAINTIES: ${document.getElementById('clin-uncertainties').value}`;
    showOutput('clin-output', text);
}

function suggestGRADE() {
    const scores = { none: 0, serious: 1, vserious: 2 };
    const ids = ['grade-rob', 'grade-incon', 'grade-indirect', 'grade-imprec', 'grade-pubbias'];
    let total = 0;
    ids.forEach(id => { total += scores[document.getElementById(id).value] ?? 0; });
    const levels = ['high', 'moderate', 'low', 'verylow'];
    const labels = ['HIGH', 'MODERATE', 'LOW', 'VERY LOW'];
    const idx = Math.min(total, 3);
    const el = document.getElementById('grade-suggestion');
    if (total > 0) {
        el.textContent = '(Suggested: ' + labels[idx] + ' based on ' + total + ' downgrade' + (total > 1 ? 's' : '') + ')';
        document.getElementById('grade-overall').value = levels[idx];
    } else {
        el.textContent = '';
    }
}

function generateGRADE() {
    const certSymbols = { high: '⊕⊕⊕⊕', moderate: '⊕⊕⊕◯', low: '⊕⊕◯◯', verylow: '⊕◯◯◯' };
    const certLabels = { high: 'HIGH', moderate: 'MODERATE', low: 'LOW', verylow: 'VERY LOW' };
    const downgrade = { none: '0', serious: '−1', vserious: '−2' };

    const overall = document.getElementById('grade-overall').value;
    const rob = document.getElementById('grade-rob').value;
    const incon = document.getElementById('grade-incon').value;
    const indirect = document.getElementById('grade-indirect').value;
    const imprec = document.getElementById('grade-imprec').value;
    const pubbias = document.getElementById('grade-pubbias').value;

    const text = `⭐ GRADE CERTAINTY ASSESSMENT
========================================
Outcome: ${document.getElementById('grade-outcome').value}
Studies: ${document.getElementById('grade-studies').value}
Effect: ${document.getElementById('grade-effect').value}

DOMAIN ASSESSMENTS
─────────────────────────────────────
1. Risk of Bias:      ${downgrade[rob]} ${rob !== 'none' ? '(' + document.getElementById('grade-rob-reason').value + ')' : '(No concern)'}
2. Inconsistency:     ${downgrade[incon]} ${incon !== 'none' ? '(' + document.getElementById('grade-incon-reason').value + ')' : '(No concern)'}
3. Indirectness:      ${downgrade[indirect]} ${indirect !== 'none' ? '(' + document.getElementById('grade-indirect-reason').value + ')' : '(No concern)'}
4. Imprecision:       ${downgrade[imprec]} ${imprec !== 'none' ? '(' + document.getElementById('grade-imprec-reason').value + ')' : '(No concern)'}
5. Publication Bias:  ${downgrade[pubbias]} ${pubbias !== 'none' ? '(' + document.getElementById('grade-pubbias-reason').value + ')' : '(Undetected)'}

OVERALL CERTAINTY: ${certSymbols[overall]} ${certLabels[overall]}
─────────────────────────────────────
${document.getElementById('grade-summary').value}

Generated: ${new Date().toISOString().split('T')[0]}`;
    showOutput('grade-output', text);
    logTemplate('grade', `GRADE: ${document.getElementById('grade-outcome').value}`);
}

function generateCondGO() {
    const actions = [];
    if (document.getElementById('cg-a1').checked) actions.push('Correct extraction');
    if (document.getElementById('cg-a2').checked) actions.push('Correct conversions');
    if (document.getElementById('cg-a3').checked) actions.push('Resolve overlaps');
    if (document.getElementById('cg-a4').checked) actions.push('Repair audit pack');
    if (document.getElementById('cg-a5').checked) actions.push('Rerun analysis package (capsule)');
    const text = `⚠️ CONDGO DECISION SHEET
========================================
Trigger: ${document.getElementById('condgo-trigger').value}
Start: ${document.getElementById('condgo-start').value}
Actions: ${actions.join(', ') || 'None'}
Exit: ${document.getElementById('condgo-exit').value}
Approved: ${document.getElementById('condgo-approvers').value}`;
    showOutput('condgo-output', text);
}

function generateFailure() {
    const text = `🛑 FAILURE LOG
========================================
Title: ${document.getElementById('fail-title').value}
Date: ${document.getElementById('fail-date').value}
Reason: ${document.getElementById('fail-reason').value}
Search: ${document.getElementById('fail-search').value}
PRISMA: ${document.getElementById('fail-prisma').value}
Outcomes changed: ${document.getElementById('fail-outcomes').value}
Archive: ${document.getElementById('fail-archive').value}`;
    showOutput('fail-output', text);
}

// ===== PUBLICATION BIAS TEMPLATE =====
function generatePubBias() {
    const nstudies = document.getElementById('pb-nstudies').value;
    const symmetry = document.getElementById('pb-symmetry').value;
    const visual = document.getElementById('pb-visual').value;
    const egger = document.getElementById('pb-egger').value;
    const pvalue = document.getElementById('pb-pvalue').value;
    const othertests = document.getElementById('pb-othertests').value;
    const grade = document.getElementById('pb-grade').value;
    const justify = document.getElementById('pb-justify').value;
    const trimfill = document.getElementById('pb-trimfill').value;
    const impact = document.getElementById('pb-impact').value;
    const assessor = document.getElementById('pb-assessor').value;
    const date = document.getElementById('pb-date').value;

    const gradeLabels = {
        none: 'No serious concern',
        serious: 'Serious concern (−1)',
        veryserious: 'Very serious concern (−2)',
        undetected: 'Undetected (<10 studies)'
    };

    const text = `📉 PUBLICATION BIAS ASSESSMENT
========================================
Date: ${date}
Assessor: ${assessor}

STEP 1: FUNNEL PLOT VISUAL ASSESSMENT
─────────────────────────────────────
Studies in plot: ${nstudies}
Symmetry assessment: ${symmetry}
Visual interpretation:
${visual}

STEP 2: STATISTICAL TESTS
─────────────────────────────────────
Egger's test: ${egger}
${pvalue ? 'p-value: ' + pvalue : ''}
${othertests ? 'Other tests:\n' + othertests : ''}

STEP 3: GRADE RATING
─────────────────────────────────────
Publication Bias domain: ${gradeLabels[grade] || grade}
Justification:
${justify}

STEP 4: SENSITIVITY ANALYSIS
─────────────────────────────────────
${trimfill ? 'Trim-and-fill:\n' + trimfill : 'Not applicable'}
Impact on conclusions: ${impact}

Generated: ${new Date().toISOString().split('T')[0]}`;

    showOutput('pb-output', text);
    logTemplate('pubbias', 'Publication Bias Assessment');
}

// ===== FIRST TIME WIZARD =====
let wizardStep = 1;
const WIZARD_TOTAL_STEPS = 4;

function showWizard() {
    document.getElementById('wizardOverlay').classList.add('visible');
    wizardStep = 1;
    updateWizardUI();
}

function closeWizard() {
    document.getElementById('wizardOverlay').classList.remove('visible');
    // Mark wizard as seen
    try { localStorage.setItem('metasprint_wizard_seen', 'true'); } catch(e) {}
}

function wizardNav(delta) {
    if (delta > 0 && wizardStep >= WIZARD_TOTAL_STEPS) {
        closeWizard();
        return;
    }
    wizardStep = Math.max(1, Math.min(WIZARD_TOTAL_STEPS, wizardStep + delta));
    updateWizardUI();
}

function updateWizardUI() {
    // Update steps
    document.querySelectorAll('.wizard-step').forEach((step, i) => {
        step.classList.toggle('active', i + 1 === wizardStep);
    });
    // Update dots
    document.querySelectorAll('.wizard-dot').forEach((dot, i) => {
        dot.classList.remove('active', 'done');
        if (i + 1 === wizardStep) dot.classList.add('active');
        else if (i + 1 < wizardStep) dot.classList.add('done');
    });
    // Update buttons
    document.getElementById('wizardPrevBtn').style.visibility = wizardStep === 1 ? 'hidden' : 'visible';
    const nextBtn = document.getElementById('wizardNextBtn');
    if (wizardStep === WIZARD_TOTAL_STEPS) {
        nextBtn.textContent = 'Get Started →';
    } else {
        nextBtn.textContent = 'Next →';
    }
}

// ===== ENTERPRISE MODE =====
function toggleEnterpriseMode() {
    const enabled = document.getElementById('enterpriseToggle').checked;
    state.enterpriseMode = enabled;
    save();
    document.body.classList.toggle('enterprise-enabled', enabled);
    // Re-render to show/hide enterprise fields
    render();
    showToast(enabled ? '🏢 Enterprise Mode enabled' : 'Enterprise Mode disabled');
}

function loadEnterpriseMode() {
    const enabled = state.enterpriseMode || false;
    const toggle = document.getElementById('enterpriseToggle');
    if (toggle) toggle.checked = enabled;
    document.body.classList.toggle('enterprise-enabled', enabled);
}

// ===== INTERACTIVE TUTORIAL =====
function toggleTutorialStep(el) {
    el.classList.toggle('completed');
    saveTutorialProgress();
    updateTutorialProgress();
}

function saveTutorialProgress() {
    const completed = [];
    document.querySelectorAll('.tutorial-step.completed').forEach(step => {
        completed.push(step.dataset.step);
    });
    state.tutorialCompleted = completed;
    save();
}

function loadTutorialProgress() {
    const completed = state.tutorialCompleted || [];
    document.querySelectorAll('.tutorial-step').forEach(step => {
        if (completed.includes(step.dataset.step)) {
            step.classList.add('completed');
        }
    });
    updateTutorialProgress();
}

function updateTutorialProgress() {
    const total = document.querySelectorAll('.tutorial-step').length;
    const completed = document.querySelectorAll('.tutorial-step.completed').length;
    const pct = total > 0 ? (completed / total) * 100 : 0;
    const fill = document.getElementById('tutorialProgressFill');
    const text = document.getElementById('tutorialProgressText');
    if (fill) fill.style.width = pct + '%';
    if (text) text.textContent = `${completed}/${total} completed`;
}

function resetTutorialProgress() {
    state.tutorialCompleted = [];
    save();
    document.querySelectorAll('.tutorial-step.completed').forEach(el => el.classList.remove('completed'));
    updateTutorialProgress();
    showToast('Tutorial progress reset');
}

// ===== DARK MODE =====
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    try { localStorage.setItem('metasprint_dark_mode', isDark ? 'true' : 'false'); } catch(e) {}
    document.getElementById('darkModeBtn').textContent = isDark ? '☀️' : '🌙';
    showToast(isDark ? '🌙 Dark mode enabled' : '☀️ Light mode enabled');
}

function loadDarkMode() {
    const isDark = localStorage.getItem('metasprint_dark_mode') === 'true';
    if (isDark) {
        document.body.classList.add('dark-mode');
        const btn = document.getElementById('darkModeBtn');
        if (btn) btn.textContent = '☀️';
    }
}

// ===== QUICK DAY JUMP =====
function showDayJump() {
    const modal = document.getElementById('dayJumpModal');
    const input = document.getElementById('dayJumpInput');
    modal.classList.add('visible');
    input.value = state.day;
    input.select();
    input.focus();
}

function closeDayJump(e) {
    if (e && e.target !== e.currentTarget) return;
    document.getElementById('dayJumpModal').classList.remove('visible');
}

function jumpToDay() {
    const input = document.getElementById('dayJumpInput');
    const targetDay = Math.max(1, Math.min(40, parseInt(input.value, 10) ?? 1));
    state.day = targetDay;
    save();
    render();
    closeDayJump();
    showToast(`Jumped to Day ${targetDay}`);
}

function handleDayJumpKey(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        jumpToDay();
    } else if (e.key === 'Escape') {
        closeDayJump();
    }
}

// ===== CONFETTI CELEBRATION =====
let _confettiTimer;
function launchConfetti() {
    const container = document.getElementById('confettiContainer');
    if (_confettiTimer) { clearTimeout(_confettiTimer); container.innerHTML = ''; }
    const colors = ['#2563EB', '#059669', '#D97706', '#DC2626', '#7C3AED', '#F59E0B', '#10B981'];
    const shapes = ['▪', '●', '▲', '★', '♦'];

    for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
        confetti.textContent = shapes[Math.floor(Math.random() * shapes.length)];
        confetti.style.fontSize = (8 + Math.random() * 12) + 'px';
        container.appendChild(confetti);
    }

    // Clean up after animation
    _confettiTimer = setTimeout(() => {
        container.innerHTML = '';
        _confettiTimer = null;
    }, 4000);
}

// ===== WORKLOAD SUMMARY (ENTERPRISE) =====
function renderWorkloadSummary() {
    if (!state.enterpriseMode) {
        const summary = document.getElementById('workloadSummary');
        if (summary) summary.style.display = 'none';
        return;
    }

    const summary = document.getElementById('workloadSummary');
    const grid = document.getElementById('workloadGrid');
    if (!summary || !grid) return;

    // Collect all assigned owners
    const ownerCounts = {};

    // Count task owners
    if (state.taskOwners) {
        Object.values(state.taskOwners).forEach(owner => {
            if (owner && owner.trim()) {
                const name = owner.trim().toUpperCase();
                ownerCounts[name] = (ownerCounts[name] ?? 0) + 1;
            }
        });
    }

    // Count DoD owners
    const project = getProject();
    if (project.dodOwners) {
        Object.values(project.dodOwners).forEach(owner => {
            if (owner && owner.trim()) {
                const name = owner.trim().toUpperCase();
                ownerCounts[name] = (ownerCounts[name] ?? 0) + 1;
            }
        });
    }

    // Render grid
    const owners = Object.entries(ownerCounts).sort((a, b) => b[1] - a[1]);

    if (owners.length === 0) {
        summary.style.display = 'block';
        grid.innerHTML = '<div style="font-size:12px;color:var(--text-muted);text-align:center;padding:8px">No assignments yet. Add initials to tasks to see workload.</div>';
        return;
    }

    summary.style.display = 'block';
    grid.innerHTML = owners.map(([name, count]) => `
        <div class="workload-person">
            <div class="workload-person-name">${escapeHtml(name)}</div>
            <div class="workload-person-count">${count} task${count !== 1 ? 's' : ''}</div>
        </div>
    `).join('');
}

// ===== DOD GATES =====
function renderDoDPage() {
    const project = getProject();
    let html = '';
    
    PHASES.forEach(phase => {
        const items = DOD_CHECKLISTS[phase.id] || [];
        const checkedCount = items.filter(item => project.dodChecked?.[item.id]).length;
        const allChecked = checkedCount === items.length;
        const gatePassed = project.dodGates?.[phase.id];
        
        let gateStatus, gateClass;
        if (gatePassed) {
            gateStatus = '✓ PASSED';
            gateClass = 'gate-passed';
        } else if (allChecked) {
            gateStatus = 'â—‰ Ready to Sign';
            gateClass = 'gate-ready';
        } else {
            gateStatus = `${checkedCount}/${items.length}`;
            gateClass = 'gate-pending';
        }
        
        html += `<div class="dod-section">
            <div class="dod-header ${phase.cls}">
                <div class="dod-title">${gatePassed ? '✓' : '○'} DoD-${phase.id}: ${phase.name} (Days ${phase.days[0]}-${phase.days[1]})</div>
                <div class="dod-gate-status ${gateClass}">${gateStatus}</div>
            </div>`;
        
        items.forEach(item => {
            const isChecked = project.dodChecked?.[item.id];
            const storyHtml = item.story ? `<div class="checklist-hint story-hint" onclick="event.stopPropagation()">📖 ${item.story}</div>` : '';
            const owner = project.dodOwners?.[item.id] || '';
            const safeOwner = escapeHtml(owner);
            const enterpriseField = state.enterpriseMode ? `
                <div class="task-owner enterprise-only" onclick="event.stopPropagation()">
                    <span class="task-owner-label">Assigned:</span>
                    ${owner ? `<span class="task-owner-badge">${safeOwner}</span>` : ''}
                    <input type="text" class="task-owner-input" value="${safeOwner}" placeholder="Initials"
                        onchange="updateDoDOwner('${item.id}', this.value)" onclick="event.stopPropagation()">
                </div>
            ` : '';
            html += `<div class="checklist-item ${isChecked ? 'checked' : ''}" tabindex="0" onclick="toggleDoDItem('${item.id}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}" role="checkbox" aria-checked="${isChecked}">
                <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
                <div class="checklist-content">
                    <div class="checklist-title">${item.text}</div>
                    ${storyHtml}
                    ${enterpriseField}
                </div>
            </div>`;
        });
        
        if (allChecked && !gatePassed) {
            html += `<button class="copy-btn" style="width:100%;margin-top:12px" onclick="signOffGate('${phase.id}')">✍️ Sign Off DoD-${phase.id}</button>`;
        }
        
        html += '</div>';
    });
    
    document.getElementById('dodContainer').innerHTML = html;
}

function toggleDoDItem(itemId) {
    const project = getProject();
    const previousState = project.dodChecked?.[itemId] || false;
    // Push to undo stack before changing
    pushUndo('checkbox', { type: 'dod', id: itemId, previousState });

    const dodChecked = { ...(project.dodChecked || {}) };
    dodChecked[itemId] = !dodChecked[itemId];
    setProject({ dodChecked });
    save();
    renderDoDPage();
    showToast('Saved (Ctrl+Z to undo)');
}

function signOffGate(gateId) {
    if (!confirm(`Sign off DoD-${gateId}? This confirms all checklist items are complete.`)) return;

    const project = getProject();
    const dodGates = { ...(project.dodGates || {}) };
    dodGates[gateId] = true;

    const templateLog = [...(project.templateLog || []), {
        type: `dod-${gateId}`,
        timestamp: new Date().toISOString(),
        day: project.day,
        content: `DoD-${gateId} signed off by ${ROLE_NAMES[project.role] || project.role}`
    }];

    setProject({ dodGates, templateLog });
    saveWithToast();
    renderDoDPage();
    renderHealthDashboard();

    // Celebration!
    showToast(`🎉 DoD-${gateId} PASSED!`);
    launchConfetti();

    // Check if all gates passed
    const allGates = ['A', 'B', 'C', 'D', 'E'];
    const passedCount = allGates.filter(g => dodGates[g]).length;
    if (passedCount === 5) {
        setTimeout(() => {
            showToast('🏆 ALL GATES PASSED! Ready for submission!');
            launchConfetti();
        }, 2000);
    }
}

// ===== PRISMA =====
function loadPRISMA() {
    const prisma = getProject().prisma || {};
    document.getElementById('prisma-identified').value = prisma.identified ?? 0;
    document.getElementById('prisma-deduped').value = prisma.deduped ?? 0;
    document.getElementById('prisma-excluded-screen').value = prisma.excludedScreen ?? 0;
    document.getElementById('prisma-excluded-fulltext').value = prisma.excludedFulltext ?? 0;
    document.getElementById('prisma-exclusion-reasons').value = prisma.exclusionReasons || '';
    updatePRISMA();
}

function updatePRISMA() {
    const identified = parseInt(document.getElementById('prisma-identified').value, 10) ?? 0;
    let deduped = parseInt(document.getElementById('prisma-deduped').value, 10) ?? 0;
    if (deduped > identified && identified > 0) {
        deduped = identified;
        document.getElementById('prisma-deduped').value = deduped;
    }
    const excludedScreen = parseInt(document.getElementById('prisma-excluded-screen').value, 10) ?? 0;
    const excludedFulltext = parseInt(document.getElementById('prisma-excluded-fulltext').value, 10) ?? 0;

    const screened = deduped;
    const fulltext = Math.max(0, screened - excludedScreen);
    const included = Math.max(0, fulltext - excludedFulltext);
    
    document.getElementById('prisma-screened-display').textContent = screened;
    document.getElementById('prisma-fulltext-display').textContent = fulltext;
    document.getElementById('prisma-included-display').textContent = included;

    // PRISMA flow validation
    const warn = document.getElementById('prismaWarning');
    if (warn && identified > 0) {
        const invalid = deduped > identified || excludedScreen > screened || excludedFulltext > fulltext;
        warn.classList.toggle('visible', invalid);
    } else if (warn) {
        warn.classList.remove('visible');
    }

    savePRISMA();
}

function savePRISMA() {
    const prisma = {
        identified: parseInt(document.getElementById('prisma-identified').value, 10) ?? 0,
        deduped: parseInt(document.getElementById('prisma-deduped').value, 10) ?? 0,
        excludedScreen: parseInt(document.getElementById('prisma-excluded-screen').value, 10) ?? 0,
        excludedFulltext: parseInt(document.getElementById('prisma-excluded-fulltext').value, 10) ?? 0,
        exclusionReasons: document.getElementById('prisma-exclusion-reasons').value,
        included: parseInt(document.getElementById('prisma-included-display').textContent, 10) ?? 0
    };
    setProject({ prisma, studyCount: prisma.included });
    save();

    const studyCountInput = document.getElementById('studyCountInput');
    if (studyCountInput && document.activeElement !== studyCountInput) {
        studyCountInput.value = prisma.included;
    }
    if (document.getElementById('healthDashboard')) {
        renderHealthDashboard();
    }
}

function copyPRISMAText() {
    const p = getProject().prisma || {};
    const screened = p.deduped ?? 0;
    const fulltext = Math.max(0, screened - (p.excludedScreen ?? 0));
    const included = Math.max(0, fulltext - (p.excludedFulltext ?? 0));
    
    const text = `STUDY-FLOW (PRISMA) DIAGRAM
====================
Records identified: ${p.identified ?? 0}
After duplicates removed: ${p.deduped ?? 0}
Records screened: ${screened}
Excluded (title/abstract): ${p.excludedScreen ?? 0}
Full-text assessed: ${fulltext}
Excluded (full-text): ${p.excludedFulltext ?? 0}
Studies included: ${included}

Exclusion Reasons:
${p.exclusionReasons || 'Not specified'}`;
    
    navigator.clipboard.writeText(text).then(() => {
        showToast('PRISMA text copied');
    }).catch(() => {
        showToast('Saved (clipboard unavailable)');
    });
}

function exportPRISMASVG() {
    const p = getProject().prisma || {};
    const identified = parseInt(p.identified, 10) ?? 0;
    const deduped = parseInt(p.deduped, 10) ?? 0;
    const excludedScreen = parseInt(p.excludedScreen, 10) ?? 0;
    const excludedFulltext = parseInt(p.excludedFulltext, 10) ?? 0;
    const screened = deduped;
    const fulltext = Math.max(0, screened - excludedScreen);
    const included = Math.max(0, fulltext - excludedFulltext);
    
    const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="600" height="500" viewBox="0 0 600 500">
  <style>
    .box { fill: #fff; stroke: #334155; stroke-width: 2; }
    .box-highlight { fill: #DBEAFE; stroke: #2563EB; stroke-width: 2; }
    .text { font-family: Arial, sans-serif; font-size: 12px; fill: #0F172A; }
    .label { font-family: Arial, sans-serif; font-size: 10px; fill: #64748B; }
    .value { font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; fill: #0F172A; }
    .arrow { stroke: #94A3B8; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
  </style>
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#94A3B8"/>
    </marker>
  </defs>
  
  <rect x="200" y="20" width="200" height="60" rx="8" class="box"/>
  <text x="300" y="42" text-anchor="middle" class="label">Records Identified</text>
  <text x="300" y="65" text-anchor="middle" class="value">${identified}</text>
  
  <line x1="300" y1="80" x2="300" y2="110" class="arrow"/>
  
  <rect x="200" y="110" width="200" height="60" rx="8" class="box"/>
  <text x="300" y="132" text-anchor="middle" class="label">After Duplicates Removed</text>
  <text x="300" y="155" text-anchor="middle" class="value">${deduped}</text>
  
  <line x1="300" y1="170" x2="300" y2="200" class="arrow"/>
  
  <rect x="150" y="200" width="150" height="60" rx="8" class="box"/>
  <text x="225" y="222" text-anchor="middle" class="label">Screened</text>
  <text x="225" y="245" text-anchor="middle" class="value">${screened}</text>
  
  <rect x="320" y="200" width="150" height="60" rx="8" class="box"/>
  <text x="395" y="222" text-anchor="middle" class="label">Excluded</text>
  <text x="395" y="245" text-anchor="middle" class="value">${excludedScreen}</text>
  
  <line x1="300" y1="230" x2="320" y2="230" class="arrow"/>
  <line x1="225" y1="260" x2="225" y2="290" class="arrow"/>
  
  <rect x="150" y="290" width="150" height="60" rx="8" class="box"/>
  <text x="225" y="312" text-anchor="middle" class="label">Full-text Assessed</text>
  <text x="225" y="335" text-anchor="middle" class="value">${fulltext}</text>
  
  <rect x="320" y="290" width="150" height="60" rx="8" class="box"/>
  <text x="395" y="312" text-anchor="middle" class="label">Excluded</text>
  <text x="395" y="335" text-anchor="middle" class="value">${excludedFulltext}</text>
  
  <line x1="300" y1="320" x2="320" y2="320" class="arrow"/>
  <line x1="225" y1="350" x2="225" y2="380" class="arrow"/>
  
  <rect x="150" y="380" width="150" height="60" rx="8" class="box-highlight"/>
  <text x="225" y="402" text-anchor="middle" class="label">Studies Included</text>
  <text x="225" y="430" text-anchor="middle" class="value">${included}</text>
</svg>`;
    
    const blob = new Blob([svg], { type: 'image/svg+xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `prisma-flow-${new Date().toISOString().split('T')[0]}.svg`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('PRISMA SVG exported');
}

// ===== AUDIT PACK =====
function renderAuditPage() {
    const project = getProject();
    
    // Summary stats
    const templateCount = (project.templateLog || []).length;
    const taskCount = Object.values(project.completed || {}).filter(Boolean).length;
    const dodCount = Object.values(project.dodGates || {}).filter(Boolean).length;
    const deviationCount = (project.templateLog || []).filter(t => t.type === 'dev').length;
    
    document.getElementById('audit-templates').textContent = templateCount;
    document.getElementById('audit-tasks').textContent = taskCount;
    document.getElementById('audit-dod').textContent = `${dodCount}/5`;
    document.getElementById('audit-deviations').textContent = deviationCount;
    
    // Audit Grade Checklist
    let gradeScore = 0;
    let gradeHtml = '';
    AUDIT_GRADE_CRITERIA.forEach(criterion => {
        const passed = criterion.check();
        if (passed) gradeScore++;
        gradeHtml += `<div class="checklist-item ${passed ? 'checked' : ''}" style="cursor:default">
            <div class="check-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
            <div class="checklist-content"><div class="checklist-title">${escapeHtml(criterion.text)}</div></div>
        </div>`;
    });
    document.getElementById('auditGradeScore').textContent = gradeScore;
    document.getElementById('auditGradeChecklist').innerHTML = gradeHtml;
    
    // Template Log
    const logContainer = document.getElementById('templateLogContainer');
    if (templateCount === 0) {
        logContainer.innerHTML = '<p style="color:var(--text-muted);font-size:13px">No templates generated yet. Use the Templates tab to create documentation.</p>';
    } else {
        const typeLabels = {
            'consult': '📋 Consult Pack',
            'rt': '🔴 Red-Team Check',
            'a1': '🔍 Audit 1',
            'a2': '🔍 Audit 2',
            'dev': '📝 Deviation',
            'clin': '🏥 Clinical Summary',
            'grade': '⭐ Evidence Confidence (GRADE)',
            'condgo': '⚠️ Emergency Fix Mode (CondGO)',
            'fail': '🛑 Failure Log',
            'dod-A': '✅ DoD-A Sign-off',
            'dod-B': '✅ DoD-B Sign-off',
            'dod-C': '✅ DoD-C Sign-off',
            'dod-D': '✅ DoD-D Sign-off',
            'dod-E': '✅ DoD-E Sign-off'
        };
        
        let logHtml = '<div style="display:flex;flex-direction:column;gap:8px">';
        (project.templateLog || []).slice().reverse().forEach(entry => {
            const date = new Date(entry.timestamp).toLocaleDateString();
            const time = new Date(entry.timestamp).toLocaleTimeString();
            const label = typeLabels[entry.type] || entry.type;
            const safeDay = toSafeInt(entry.day, 0, 0, 40);
            logHtml += `<div style="background:var(--bg);padding:12px;border-radius:8px;border:1px solid var(--border)">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <strong>${escapeHtml(label)}</strong>
                    <span style="font-size:11px;color:var(--text-muted)">Day ${safeDay || '-'} · ${date} ${time}</span>
                </div>
                <div style="font-size:12px;font-family:'IBM Plex Mono',monospace;white-space:pre-wrap;max-height:80px;overflow-y:auto;color:var(--text-secondary)">${escapeHtml((entry.content || '').substring(0, 200))}${(entry.content || '').length > 200 ? '...' : ''}</div>
            </div>`;
        });
        logHtml += '</div>';
        logContainer.innerHTML = logHtml;
    }
}

function downloadAuditPack() {
    const project = getProject();
    const prisma = project.prisma || {};
    const screened = prisma.deduped ?? 0;
    const fulltext = Math.max(0, screened - (prisma.excludedScreen ?? 0));
    const included = Math.max(0, fulltext - (prisma.excludedFulltext ?? 0));
    
let content = `META-SPRINT AUDIT PACK
======================
Generated: ${new Date().toISOString()}
Project: ${project.name}
Current Day: ${project.day}
Role: ${ROLE_NAMES[project.role] || project.role}

================================================================================
STUDY PLAN REGISTRATION
================================================================================
URL: ${project.protocolUrl || 'Not entered'}
Published/Accessible: ${project.protocolPublished ? 'Yes ✓' : 'No'}

================================================================================
DEFINITION OF DONE (DoD) GATES
================================================================================
DoD-A (Study Plan):  ${project.dodGates?.A ? 'PASSED ✓' : 'Not passed'}
DoD-B (Search):      ${project.dodGates?.B ? 'PASSED ✓' : 'Not passed'}
DoD-C (Extraction):  ${project.dodGates?.C ? 'PASSED ✓' : 'Not passed'}
DoD-D (Analysis):    ${project.dodGates?.D ? 'PASSED ✓' : 'Not passed'}
DoD-E (Submission):  ${project.dodGates?.E ? 'PASSED ✓' : 'Not passed'}

================================================================================
STUDY-FLOW (PRISMA) COUNTS
================================================================================
Records identified:      ${prisma.identified ?? 0}
After deduplication:     ${prisma.deduped ?? 0}
Records screened:        ${screened}
Excluded (screening):    ${prisma.excludedScreen ?? 0}
Full-text assessed:      ${fulltext}
Excluded (full-text):    ${prisma.excludedFulltext ?? 0}
Studies included:        ${included}

Exclusion Reasons:
${prisma.exclusionReasons || 'Not specified'}

================================================================================
TRUSTWORTHINESS CHECK (AUDIT-GRADE INDEX)
================================================================================
`;
    
    let score = 0;
    AUDIT_GRADE_CRITERIA.forEach(c => {
        const passed = c.check();
        if (passed) score++;
        content += `[${passed ? '✓' : ' '}] ${c.text}\n`;
    });
    content += `\nScore: ${score}/9\n`;

    content += `
================================================================================
TEMPLATE LOG (${(project.templateLog || []).length} entries)
================================================================================
`;
    
    if ((project.templateLog || []).length === 0) {
        content += 'No templates generated.\n';
    } else {
        (project.templateLog || []).forEach((entry, i) => {
            content += `
--- Entry ${i + 1} ---
Type: ${entry.type}
Day: ${entry.day}
Timestamp: ${entry.timestamp}
Content:
${entry.content || '(no content)'}
`;
        });
    }
    
    content += `
================================================================================
TASK COMPLETION LOG
================================================================================
Total tasks completed: ${Object.values(project.completed || {}).filter(Boolean).length}
`;
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `audit-pack-${(project.name || 'project').replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Audit pack downloaded');
}

// ===== MORE TABS DROPDOWN =====
function toggleMoreTabs(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('moreTabsDropdown');
    const btn = dropdown.previousElementSibling;
    const isOpen = dropdown.classList.contains('visible');
    dropdown.classList.toggle('visible', !isOpen);
    btn.setAttribute('aria-expanded', !isOpen);
    if (!isOpen) {
        const firstItem = dropdown.querySelector('.tab-more-item');
        if (firstItem) firstItem.focus();
        document.addEventListener('click', closeMoreTabsOnOutsideClick);
        document.addEventListener('keydown', handleMoreTabsKeyboard);
    } else {
        document.removeEventListener('click', closeMoreTabsOnOutsideClick);
        document.removeEventListener('keydown', handleMoreTabsKeyboard);
    }
}

function closeMoreTabsOnOutsideClick(e) {
    const wrapper = document.querySelector('.tab-more-wrapper');
    if (!wrapper.contains(e.target)) closeMoreDropdown();
}

function handleMoreTabsKeyboard(e) {
    const dropdown = document.getElementById('moreTabsDropdown');
    if (!dropdown.classList.contains('visible')) return;
    const items = Array.from(dropdown.querySelectorAll('.tab-more-item'));
    const idx = items.indexOf(document.activeElement);
    if (e.key === 'Escape') { closeMoreDropdown(); dropdown.previousElementSibling.focus(); e.preventDefault(); }
    else if (e.key === 'ArrowDown') { e.preventDefault(); items[Math.min(idx + 1, items.length - 1)].focus(); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); items[Math.max(idx - 1, 0)].focus(); }
}

function closeMoreDropdown() {
    const dropdown = document.getElementById('moreTabsDropdown');
    if (dropdown) {
        dropdown.classList.remove('visible');
        dropdown.previousElementSibling.setAttribute('aria-expanded', 'false');
    }
    document.removeEventListener('click', closeMoreTabsOnOutsideClick);
    document.removeEventListener('keydown', handleMoreTabsKeyboard);
}

function showPageFromMore(pageId, clickedItem) {
    closeMoreDropdown();
    // Clear More active states
    document.querySelectorAll('.tab-more-item').forEach(i => i.classList.remove('active'));
    if (clickedItem) clickedItem.classList.add('active');
    // Mark More button as having active child
    const moreBtn = document.querySelector('.tab-more-btn');
    if (moreBtn) moreBtn.classList.add('has-active');
    showPage(pageId, null);
}

// ===== EXTRACTION TABLE =====
let extractionSortCol = 'authorYear';
let extractionSortAsc = true;

function getStudies() {
    const project = getProject();
    if (!project.studies) project.studies = [];
    return project.studies;
}

function addStudyRow() {
    const studies = getStudies();
    const id = 's' + Date.now() + Math.floor(Math.random() * 1000);
    studies.push({
        id, authorYear: '', nTotal: null, nIntervention: null, nControl: null,
        effectEstimate: null, lowerCI: null, upperCI: null, effectType: 'OR',
        weight: null, notes: ''
    });
    save();
    renderExtractionTable();
    syncRoBFromStudies();
}

function deleteStudyRow(id) {
    const project = getProject();
    project.studies = (project.studies || []).filter(s => s.id !== id);
    save();
    renderExtractionTable();
    syncRoBFromStudies();
    renderRoBSection();
}

function updateStudyField(id, field, value) {
    const study = getStudies().find(s => s.id === id);
    if (!study) return;
    const numericFields = ['nTotal','nIntervention','nControl','effectEstimate','lowerCI','upperCI','weight'];
    if (numericFields.includes(field)) {
        study[field] = toSafeFloat(value);
    } else if (field === 'authorYear') {
        study[field] = String(value || '').slice(0, 200);
    } else if (field === 'effectType') {
        study[field] = VALID_EFFECT_TYPES.includes(value) ? value : 'OR';
    } else if (field === 'notes') {
        study[field] = String(value || '').slice(0, 500);
    }
    save();
    renderExtractionSummary();
}

function validateStudyRow(study) {
    const issues = [];
    if (Number.isFinite(study.lowerCI) && Number.isFinite(study.upperCI) && study.lowerCI > study.upperCI) {
        issues.push('Lower CI > Upper CI');
    }
    return issues;
}

function renderExtractionTable() {
    const studies = getStudies();
    const tbody = document.getElementById('extractionTableBody');
    if (!tbody) return;

    // Sort
    const sorted = [...studies].sort((a, b) => {
        let va = a[extractionSortCol], vb = b[extractionSortCol];
        if (va === null || va === undefined) va = '';
        if (vb === null || vb === undefined) vb = '';
        if (typeof va === 'string') { va = va.toLowerCase(); vb = String(vb).toLowerCase(); }
        const cmp = va < vb ? -1 : va > vb ? 1 : 0;
        return extractionSortAsc ? cmp : -cmp;
    });

    // Update sort arrows
    document.querySelectorAll('.sort-arrow').forEach(el => { el.classList.remove('active'); el.textContent = '▲'; });
    const activeArrow = document.getElementById('sort-' + extractionSortCol);
    if (activeArrow) { activeArrow.classList.add('active'); activeArrow.textContent = extractionSortAsc ? '▲' : '▼'; }

    if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:24px;color:var(--text-muted)">No studies yet. Click "+ Add Study" to begin extraction.</td></tr>';
    } else {
        const rows = sorted.map(s => {
            const issues = validateStudyRow(s);
            const rowClass = issues.length ? ' style="background:var(--warning-light)"' : '';
            const fmtNum = (v) => Number.isFinite(v) ? v : '';
            return `<tr${rowClass}>
                <td><input class="extraction-input" value="${escapeHtml(s.authorYear)}" onchange="updateStudyField('${s.id}','authorYear',this.value)" placeholder="Author Year"></td>
                <td><input class="extraction-input narrow" value="${fmtNum(s.nTotal)}" onchange="updateStudyField('${s.id}','nTotal',this.value)" type="number"></td>
                <td><input class="extraction-input narrow" value="${fmtNum(s.nIntervention)}" onchange="updateStudyField('${s.id}','nIntervention',this.value)" type="number"></td>
                <td><input class="extraction-input narrow" value="${fmtNum(s.nControl)}" onchange="updateStudyField('${s.id}','nControl',this.value)" type="number"></td>
                <td><input class="extraction-input narrow" value="${fmtNum(s.effectEstimate)}" onchange="updateStudyField('${s.id}','effectEstimate',this.value)" type="number" step="any"></td>
                <td><input class="extraction-input narrow" value="${fmtNum(s.lowerCI)}" onchange="updateStudyField('${s.id}','lowerCI',this.value)" type="number" step="any"></td>
                <td><input class="extraction-input narrow" value="${fmtNum(s.upperCI)}" onchange="updateStudyField('${s.id}','upperCI',this.value)" type="number" step="any"></td>
                <td><select class="extraction-select" onchange="updateStudyField('${s.id}','effectType',this.value)">
                    ${VALID_EFFECT_TYPES.map(t => `<option value="${t}"${s.effectType === t ? ' selected' : ''}>${t}</option>`).join('')}
                </select></td>
                <td><input class="extraction-input narrow" value="${fmtNum(s.weight)}" onchange="updateStudyField('${s.id}','weight',this.value)" type="number" step="any"></td>
                <td><button class="extraction-delete" onclick="deleteStudyRow('${s.id}')" title="Delete study">✕</button></td>
            </tr>`;
        });
        tbody.innerHTML = rows.join('');
    }
    renderExtractionSummary();
}

function renderExtractionSummary() {
    const studies = getStudies();
    const el = document.getElementById('extractionSummary');
    if (!el) return;
    if (studies.length === 0) { el.style.display = 'none'; return; }
    el.style.display = 'flex';
    const k = studies.length;
    const totalN = studies.reduce((sum, s) => sum + (Number.isFinite(s.nTotal) ? s.nTotal : 0), 0);
    const effects = studies.map(s => s.effectEstimate).filter(Number.isFinite);
    const effectRange = effects.length ? `${Math.min(...effects).toFixed(2)} to ${Math.max(...effects).toFixed(2)}` : 'N/A';
    el.innerHTML = `
        <div class="extraction-summary-item">Studies: <span class="extraction-summary-value">${k}</span></div>
        <div class="extraction-summary-item">Total N: <span class="extraction-summary-value">${totalN.toLocaleString()}</span></div>
        <div class="extraction-summary-item">Effect range: <span class="extraction-summary-value">${escapeHtml(effectRange)}</span></div>
    `;
}

function sortStudies(column) {
    if (extractionSortCol === column) { extractionSortAsc = !extractionSortAsc; }
    else { extractionSortCol = column; extractionSortAsc = true; }
    renderExtractionTable();
}

function exportStudiesCSV() {
    const studies = getStudies();
    if (studies.length === 0) { showToast('No studies to export', 'error'); return; }
    const headers = ['Study ID','N Total','N Intervention','N Control','Effect','Lower CI','Upper CI','Type','Weight','Notes'];
    const rows = studies.map(s => [
        s.authorYear, s.nTotal ?? '', s.nIntervention ?? '', s.nControl ?? '',
        s.effectEstimate ?? '', s.lowerCI ?? '', s.upperCI ?? '',
        s.effectType, s.weight ?? '', s.notes
    ].map(v => '"' + String(v).replace(/"/g, '""') + '"').join(','));
    const csv = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'extraction-studies.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('CSV exported');
}

function handleCSVImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    event.target.value = '';
    const reader = new FileReader();
    reader.onload = function(e) {
        const lines = e.target.result.split(/\r?\n/).filter(l => l.trim());
        if (lines.length < 2) { showToast('CSV must have a header row and at least one data row', 'error'); return; }
        const studies = getStudies();
        for (let i = 1; i < lines.length && i < 501; i++) {
            const cols = parseCSVLine(lines[i]);
            if (cols.length < 1) continue;
            studies.push({
                id: 's' + Date.now() + i,
                authorYear: String(cols[0] || '').slice(0, 200),
                nTotal: toSafeFloat(cols[1]),
                nIntervention: toSafeFloat(cols[2]),
                nControl: toSafeFloat(cols[3]),
                effectEstimate: toSafeFloat(cols[4]),
                lowerCI: toSafeFloat(cols[5]),
                upperCI: toSafeFloat(cols[6]),
                effectType: VALID_EFFECT_TYPES.includes(cols[7]) ? cols[7] : 'OR',
                weight: toSafeFloat(cols[8]),
                notes: String(cols[9] || '').slice(0, 500)
            });
        }
        save();
        renderExtractionTable();
        syncRoBFromStudies();
        showToast(`Imported ${lines.length - 1} studies`);
    };
    reader.readAsText(file);
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (inQuotes) {
            if (ch === '"' && line[i + 1] === '"') { current += '"'; i++; }
            else if (ch === '"') { inQuotes = false; }
            else { current += ch; }
        } else {
            if (ch === '"') { inQuotes = true; }
            else if (ch === ',') { result.push(current.trim()); current = ''; }
            else { current += ch; }
        }
    }
    result.push(current.trim());
    return result;
}

// ===== ROB 2 ASSESSMENT =====
const ROB2_DOMAINS = [
    { key: 'd1', label: 'Randomization process', short: 'D1' },
    { key: 'd2', label: 'Deviations from intended interventions', short: 'D2' },
    { key: 'd3', label: 'Missing outcome data', short: 'D3' },
    { key: 'd4', label: 'Measurement of the outcome', short: 'D4' },
    { key: 'd5', label: 'Selection of the reported result', short: 'D5' },
    { key: 'overall', label: 'Overall', short: 'Overall' }
];

function getRoBAssessments() {
    const project = getProject();
    if (!project.robAssessments) project.robAssessments = [];
    return project.robAssessments;
}

function syncRoBFromStudies() {
    const studies = getStudies();
    const robs = getRoBAssessments();
    const studyIds = new Set(studies.map(s => s.id));
    // Add entries for new studies
    studies.forEach(s => {
        if (!robs.find(r => r.studyId === s.id)) {
            const entry = { studyId: s.id, authorYear: s.authorYear };
            ROB2_DOMAINS.forEach(d => { entry[d.key] = ''; entry[d.key + 'Support'] = ''; });
            robs.push(entry);
        } else {
            // Sync authorYear
            const rob = robs.find(r => r.studyId === s.id);
            if (rob) rob.authorYear = s.authorYear;
        }
    });
    // Remove orphans
    const project = getProject();
    project.robAssessments = robs.filter(r => studyIds.has(r.studyId));
    save();
}

function toggleRoBSection() {
    const body = document.getElementById('robBody');
    const arrow = document.getElementById('robArrow');
    const header = body.previousElementSibling;
    const isOpen = body.style.display !== 'none';
    body.style.display = isOpen ? 'none' : 'block';
    arrow.textContent = isOpen ? '▼' : '▲';
    header.setAttribute('aria-expanded', !isOpen);
    if (!isOpen) renderRoBSection();
}

function renderRoBSection() {
    syncRoBFromStudies();
    renderRoBSummaryTable();
    computeGRADERoBSuggestion();
}

function renderRoBSummaryTable() {
    const robs = getRoBAssessments();
    const container = document.getElementById('robSummaryTable');
    if (!container) return;
    if (robs.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-muted)">No studies extracted yet. Add studies in the table above first.</div>';
        return;
    }
    const domainHeaders = ROB2_DOMAINS.map(d => `<th>${escapeHtml(d.short)}</th>`).join('');
    const rows = robs.map(r => {
        const cells = ROB2_DOMAINS.map(d => {
            const j = r[d.key] || '';
            const cls = j ? j : 'empty';
            return `<td><span class="rob-dot ${cls}" title="${escapeHtml(j || 'Not assessed')}"></span></td>`;
        }).join('');
        const label = escapeHtml(r.authorYear || r.studyId);
        return `<tr><td style="text-align:left;cursor:pointer;font-weight:500" onclick="openRoBEntry('${escapeHtml(r.studyId)}')">${label} ✏️</td>${cells}</tr>`;
    }).join('');
    container.innerHTML = `<table class="rob-summary-table"><thead><tr><th class="rob-study-header">Study</th>${domainHeaders}</tr></thead><tbody>${rows}</tbody></table>`;
}

function openRoBEntry(studyId) {
    const robs = getRoBAssessments();
    const rob = robs.find(r => r.studyId === studyId);
    if (!rob) return;
    const panel = document.getElementById('robEntryPanel');
    const title = document.getElementById('robEntryTitle');
    const domainsDiv = document.getElementById('robEntryDomains');
    title.textContent = 'Assessing: ' + (rob.authorYear || rob.studyId);
    let html = '';
    ROB2_DOMAINS.forEach(d => {
        const current = rob[d.key] || '';
        const support = rob[d.key + 'Support'] || '';
        html += `<div class="rob-entry-domain">
            <div class="rob-domain-label">${escapeHtml(d.short)}: ${escapeHtml(d.label)}</div>
            <div class="rob-judgment-btns">
                <button class="rob-judgment-btn${current === 'low' ? ' selected-low' : ''}" onclick="setRoBJudgment('${escapeHtml(studyId)}','${d.key}','low',this)">Low</button>
                <button class="rob-judgment-btn${current === 'some' ? ' selected-some' : ''}" onclick="setRoBJudgment('${escapeHtml(studyId)}','${d.key}','some',this)">Some concerns</button>
                <button class="rob-judgment-btn${current === 'high' ? ' selected-high' : ''}" onclick="setRoBJudgment('${escapeHtml(studyId)}','${d.key}','high',this)">High</button>
            </div>
            <input class="rob-support-input" value="${escapeHtml(support)}" placeholder="Support for judgment..." onchange="setRoBSupport('${escapeHtml(studyId)}','${d.key}',this.value)">
        </div>`;
    });
    domainsDiv.innerHTML = html;
    panel.classList.add('visible');
}

function setRoBJudgment(studyId, domain, judgment, btn) {
    const rob = getRoBAssessments().find(r => r.studyId === studyId);
    if (!rob) return;
    // Toggle: if already selected, deselect
    if (rob[domain] === judgment) { rob[domain] = ''; }
    else { rob[domain] = judgment; }
    save();
    // Re-render entry form to reflect state
    openRoBEntry(studyId);
    renderRoBSummaryTable();
    computeGRADERoBSuggestion();
}

function setRoBSupport(studyId, domain, value) {
    const rob = getRoBAssessments().find(r => r.studyId === studyId);
    if (!rob) return;
    rob[domain + 'Support'] = String(value || '').slice(0, 500);
    save();
}

function closeRoBEntry() {
    document.getElementById('robEntryPanel').classList.remove('visible');
    renderRoBSummaryTable();
}

function computeGRADERoBSuggestion() {
    const robs = getRoBAssessments();
    const banner = document.getElementById('robGradeBanner');
    if (!banner || robs.length === 0) { if (banner) banner.style.display = 'none'; return; }
    const assessed = robs.filter(r => r.overall !== '');
    if (assessed.length === 0) { banner.style.display = 'none'; return; }
    const highCount = assessed.filter(r => r.overall === 'high').length;
    const someCount = assessed.filter(r => r.overall === 'some').length;
    const highPct = highCount / assessed.length;
    const somePct = someCount / assessed.length;
    let suggestion = 'No serious concern';
    if (highPct > 0.5) suggestion = 'Very serious (-2)';
    else if (highPct > 0.25 || somePct > 0.5) suggestion = 'Serious (-1)';
    banner.style.display = 'block';
    banner.innerHTML = `<strong>GRADE RoB suggestion:</strong> ${escapeHtml(suggestion)} (${highCount}/${assessed.length} high risk, ${someCount}/${assessed.length} some concerns)`;
    // Also update GRADE RoB hint
    const robHint = document.getElementById('grade-rob');
    if (robHint) {
        const hintEl = robHint.closest('.form-row')?.querySelector('.form-label');
        if (hintEl) {
            const existingHint = hintEl.querySelector('.rob-auto-hint');
            if (existingHint) existingHint.remove();
            const span = document.createElement('span');
            span.className = 'rob-auto-hint';
            span.style.cssText = 'font-weight:normal;font-size:11px;color:var(--accent);margin-left:8px';
            span.textContent = '[Auto: ' + suggestion + ']';
            hintEl.appendChild(span);
        }
    }
}

function exportRoBSVG() {
    const robs = getRoBAssessments();
    if (robs.length === 0) { showToast('No RoB data to export', 'error'); return; }
    const cellW = 40, cellH = 30, labelW = 160, headerH = 80;
    const w = labelW + ROB2_DOMAINS.length * cellW + 20;
    const h = headerH + robs.length * cellH + 20;
    const colors = { low: '#059669', some: '#D97706', high: '#DC2626', '': '#CBD5E1' };
    let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" font-family="sans-serif" font-size="11">`;
    svg += `<rect width="${w}" height="${h}" fill="white"/>`;
    ROB2_DOMAINS.forEach((d, i) => {
        const x = labelW + i * cellW + cellW / 2;
        svg += `<text x="${x}" y="${headerH - 10}" text-anchor="middle" font-weight="600" font-size="10">${d.short}</text>`;
    });
    robs.forEach((r, ri) => {
        const y = headerH + ri * cellH;
        svg += `<text x="5" y="${y + cellH / 2 + 4}" font-size="11">${escapeHtml(r.authorYear || r.studyId)}</text>`;
        ROB2_DOMAINS.forEach((d, di) => {
            const x = labelW + di * cellW;
            const j = r[d.key] || '';
            svg += `<rect x="${x + 5}" y="${y + 3}" width="${cellW - 10}" height="${cellH - 6}" rx="4" fill="${colors[j]}"/>`;
            if (j === 'low') svg += `<text x="${x + cellW/2}" y="${y + cellH/2 + 4}" text-anchor="middle" fill="white" font-size="10">+</text>`;
            else if (j === 'some') svg += `<text x="${x + cellW/2}" y="${y + cellH/2 + 4}" text-anchor="middle" fill="white" font-size="10">?</text>`;
            else if (j === 'high') svg += `<text x="${x + cellW/2}" y="${y + cellH/2 + 4}" text-anchor="middle" fill="white" font-size="10">-</text>`;
        });
    });
    svg += '</svg>';
    const blob = new Blob([svg], { type: 'image/svg+xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'rob2-traffic-light.svg';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('SVG exported');
}

function copyRoBSummary() {
    const robs = getRoBAssessments();
    if (robs.length === 0) { showToast('No RoB data', 'error'); return; }
    const lines = ['Risk of Bias 2 Summary', ''];
    robs.forEach(r => {
        const parts = ROB2_DOMAINS.map(d => `${d.short}: ${r[d.key] || 'N/A'}`).join(', ');
        lines.push(`${r.authorYear || r.studyId}: ${parts}`);
    });
    navigator.clipboard.writeText(lines.join('\n')).then(() => showToast('RoB summary copied')).catch(() => showToast('Copy failed', 'error'));
}

// ===== OIS CALCULATOR =====
function normalCDFInverse(p) {
    // Abramowitz & Stegun rational approximation (accurate to ~4.5e-4)
    if (p <= 0 || p >= 1) return 0;
    if (p < 0.5) return -normalCDFInverse(1 - p);
    const t = Math.sqrt(-2 * Math.log(1 - p));
    const c0 = 2.515517, c1 = 0.802853, c2 = 0.010328;
    const d1 = 1.432788, d2 = 0.189269, d3 = 0.001308;
    return t - (c0 + c1 * t + c2 * t * t) / (1 + d1 * t + d2 * t * t + d3 * t * t * t);
}

function computeDesignEffect(i2) {
    if (!Number.isFinite(i2) || i2 <= 0) return 1;
    const capped = Math.min(i2, 99);
    return 1 / (1 - capped / 100);
}

function toggleOISPanel() {
    const panel = document.getElementById('oisPanel');
    const arrow = document.getElementById('oisArrow');
    const isOpen = panel.classList.contains('visible');
    panel.classList.toggle('visible', !isOpen);
    arrow.textContent = isOpen ? '▼' : '▲';
}

function setOISType(type) {
    document.querySelectorAll('.ois-toggle-btn').forEach(b => b.classList.remove('active'));
    if (type === 'binary') {
        document.getElementById('oisBinaryInputs').style.display = '';
        document.getElementById('oisContinuousInputs').style.display = 'none';
        document.querySelectorAll('.ois-toggle-btn')[0].classList.add('active');
    } else {
        document.getElementById('oisBinaryInputs').style.display = 'none';
        document.getElementById('oisContinuousInputs').style.display = '';
        document.querySelectorAll('.ois-toggle-btn')[1].classList.add('active');
    }
    document.getElementById('oisResult').innerHTML = '';
}

function calculateOIS() {
    const isBinary = document.getElementById('oisBinaryInputs').style.display !== 'none';
    const alpha = toSafeFloat(document.getElementById('ois-alpha').value);
    const power = toSafeFloat(document.getElementById('ois-power').value);
    const i2 = toSafeFloat(document.getElementById('ois-i2').value);

    if (!Number.isFinite(alpha) || alpha <= 0 || alpha >= 1) { showToast('Alpha must be between 0 and 1', 'error'); return; }
    if (!Number.isFinite(power) || power <= 0 || power >= 1) { showToast('Power must be between 0 and 1', 'error'); return; }

    const Za = normalCDFInverse(1 - alpha / 2);
    const Zb = normalCDFInverse(power);
    const deff = computeDesignEffect(i2);
    let ois, formula;

    if (isBinary) {
        const p1 = toSafeFloat(document.getElementById('ois-p1').value);
        const p2 = toSafeFloat(document.getElementById('ois-p2').value);
        if (!Number.isFinite(p1) || p1 <= 0 || p1 >= 1) { showToast('p1 must be between 0 and 1', 'error'); return; }
        if (!Number.isFinite(p2) || p2 <= 0 || p2 >= 1) { showToast('p2 must be between 0 and 1', 'error'); return; }
        if (Math.abs(p1 - p2) < 1e-10) { showToast('p1 and p2 must differ', 'error'); return; }
        ois = Math.ceil((Za + Zb) ** 2 * (p1 * (1 - p1) + p2 * (1 - p2)) / (p1 - p2) ** 2 * deff);
        formula = `OIS = (Z_a + Z_b)^2 * [p1(1-p1) + p2(1-p2)] / (p1-p2)^2 * DEFF = (${Za.toFixed(3)} + ${Zb.toFixed(3)})^2 * [${p1}(1-${p1}) + ${p2}(1-${p2})] / (${p1}-${p2})^2 * ${deff.toFixed(2)} = ${ois}`;
    } else {
        const sd = toSafeFloat(document.getElementById('ois-sd').value);
        const delta = toSafeFloat(document.getElementById('ois-delta').value);
        if (!Number.isFinite(sd) || sd <= 0) { showToast('SD must be positive', 'error'); return; }
        if (!Number.isFinite(delta) || delta <= 0) { showToast('MID must be positive', 'error'); return; }
        ois = Math.ceil((Za + Zb) ** 2 * 2 * sd * sd / (delta * delta) * deff);
        formula = `OIS = (Z_a + Z_b)^2 * 2*SD^2 / delta^2 * DEFF = (${Za.toFixed(3)} + ${Zb.toFixed(3)})^2 * 2*${sd}^2 / ${delta}^2 * ${deff.toFixed(2)} = ${ois}`;
    }

    // Get total N from extraction table
    const studies = getStudies();
    const totalN = studies.reduce((sum, s) => sum + (Number.isFinite(s.nTotal) ? s.nTotal : 0), 0);
    renderOISResult(ois, totalN, deff, formula);
}

function renderOISResult(ois, totalN, deff, formula) {
    const el = document.getElementById('oisResult');
    if (!el) return;
    let cls, verdict, gradeHint;
    if (totalN > 0) {
        if (totalN >= ois) {
            cls = 'adequate'; verdict = 'Total N meets OIS.';
            gradeHint = 'No concern for imprecision (sample size adequate)';
        } else if (totalN >= ois / 2) {
            cls = 'borderline'; verdict = 'Total N is below OIS but above OIS/2.';
            gradeHint = 'Serious imprecision (-1)';
        } else {
            cls = 'inadequate'; verdict = 'Total N is well below OIS.';
            gradeHint = 'Very serious imprecision (-2)';
        }
    } else {
        cls = 'borderline'; verdict = 'No extraction data yet. Add studies to compare.';
        gradeHint = '';
    }
    el.innerHTML = `<div class="ois-result-box ${cls}">
        <div class="ois-value">OIS = ${ois.toLocaleString()}</div>
        ${totalN > 0 ? `<div class="ois-comparison">${escapeHtml(verdict)} (Total N = ${totalN.toLocaleString()} vs OIS = ${ois.toLocaleString()})${deff > 1 ? ` [DEFF = ${deff.toFixed(2)}]` : ''}</div>` : `<div class="ois-comparison">${escapeHtml(verdict)}</div>`}
        <div class="ois-formula">${escapeHtml(formula)}</div>
    </div>`;
    // Update GRADE imprecision suggestion
    const suggestionEl = document.getElementById('oisGradeSuggestion');
    if (suggestionEl && gradeHint) {
        suggestionEl.textContent = '[Auto: ' + gradeHint + ']';
    }
}

// ===== PICO SEARCH BUILDER =====
function getSearchElements() {
    const get = (id) => (document.getElementById(id)?.value || '').trim();
    const getLines = (id) => (document.getElementById(id)?.value || '').split('\n').map(s => s.trim()).filter(Boolean);
    return {
        P: { main: get('sb-p-main').slice(0, 200), synonyms: getLines('sb-p-syn').slice(0, 20), mesh: getLines('sb-p-mesh').slice(0, 10) },
        I: { main: get('sb-i-main').slice(0, 200), synonyms: getLines('sb-i-syn').slice(0, 20), mesh: getLines('sb-i-mesh').slice(0, 10) },
        C: { main: get('sb-c-main').slice(0, 200), synonyms: getLines('sb-c-syn').slice(0, 20), mesh: getLines('sb-c-mesh').slice(0, 10) },
        O: { main: get('sb-o-main').slice(0, 200), synonyms: getLines('sb-o-syn').slice(0, 20), mesh: getLines('sb-o-mesh').slice(0, 10) },
        includeC: document.getElementById('sb-includeC')?.checked ?? true,
        includeO: document.getElementById('sb-includeO')?.checked ?? true
    };
}

function buildSearchBlock(element, format) {
    const terms = [element.main, ...element.synonyms].filter(Boolean).map(t => t.slice(0, 200));
    const meshTerms = element.mesh.filter(Boolean).map(t => t.slice(0, 200));
    if (terms.length === 0 && meshTerms.length === 0) return '';

    let parts = [];
    if (format === 'pubmed') {
        parts = terms.map(t => `"${t}"[tiab]`);
        meshTerms.forEach(m => parts.push(`"${m}"[MeSH Terms]`));
    } else if (format === 'embase') {
        parts = terms.map(t => `'${t}':ti,ab`);
        meshTerms.forEach(m => parts.push(`'${m}'/exp`));
    } else if (format === 'cochrane') {
        parts = terms.map(t => `"${t}":ti,ab,kw`);
        meshTerms.forEach(m => parts.push(`[mh "${m}"]`));
    }
    return '(' + parts.join(' OR ') + ')';
}

function generateSearchString(format) {
    const els = getSearchElements();
    const blocks = [];
    const pBlock = buildSearchBlock(els.P, format);
    const iBlock = buildSearchBlock(els.I, format);
    const cBlock = buildSearchBlock(els.C, format);
    const oBlock = buildSearchBlock(els.O, format);
    if (pBlock) blocks.push(pBlock);
    if (iBlock) blocks.push(iBlock);
    if (els.includeC && cBlock) blocks.push(cBlock);
    if (els.includeO && oBlock) blocks.push(oBlock);
    return blocks.join(' AND ');
}

function updateSearchPreview() {
    ['pubmed', 'embase', 'cochrane'].forEach(fmt => {
        const el = document.getElementById('sb-output-' + fmt);
        if (!el) return;
        const str = generateSearchString(fmt);
        el.textContent = str || 'Enter PICO terms above to generate search string...';
    });
    saveSearchBuilderState();
}

function copySearchString(format) {
    const str = generateSearchString(format);
    if (!str) { showToast('No search string to copy', 'error'); return; }
    navigator.clipboard.writeText(str).then(() => showToast(format.charAt(0).toUpperCase() + format.slice(1) + ' search copied')).catch(() => showToast('Copy failed', 'error'));
}

function downloadAllSearchStrings() {
    const lines = [];
    ['pubmed', 'embase', 'cochrane'].forEach(fmt => {
        lines.push('=== ' + fmt.toUpperCase() + ' ===');
        lines.push(generateSearchString(fmt) || '(empty)');
        lines.push('');
    });
    const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'search-strings.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Search strings downloaded');
}

function saveSearchBuilderState() {
    const project = getProject();
    project.searchBuilder = getSearchElements();
    save();
}

function loadSearchBuilderState() {
    const project = getProject();
    const sb = project.searchBuilder;
    if (!sb) return;
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
    ['P','I','C','O'].forEach(el => {
        const data = sb[el];
        if (!data) return;
        set('sb-' + el.toLowerCase() + '-main', data.main);
        set('sb-' + el.toLowerCase() + '-syn', (data.synonyms || []).join('\n'));
        set('sb-' + el.toLowerCase() + '-mesh', (data.mesh || []).join('\n'));
    });
    const incC = document.getElementById('sb-includeC');
    const incO = document.getElementById('sb-includeO');
    if (incC) incC.checked = sb.includeC !== false;
    if (incO) incO.checked = sb.includeO !== false;
    updateSearchPreview();
}

function clearSearchBuilder() {
    ['p','i','c','o'].forEach(el => {
        const main = document.getElementById('sb-' + el + '-main');
        const syn = document.getElementById('sb-' + el + '-syn');
        const mesh = document.getElementById('sb-' + el + '-mesh');
        if (main) main.value = '';
        if (syn) syn.value = '';
        if (mesh) mesh.value = '';
    });
    const incC = document.getElementById('sb-includeC');
    const incO = document.getElementById('sb-includeO');
    if (incC) incC.checked = true;
    if (incO) incO.checked = true;
    updateSearchPreview();
    showToast('Search builder cleared');
}

// ===== PAGE SWITCHING =====
const MORE_TAB_PAGES = ['search', 'reference', 'help', 'glossary', 'casestudy'];

function showPage(pageId, clickedTab) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
    });

    const page = document.getElementById('page-' + pageId);
    if (page) page.classList.add('active');

    // Close More dropdown and clear its active states
    closeMoreDropdown();
    document.querySelectorAll('.tab-more-item').forEach(i => i.classList.remove('active'));
    const moreBtn = document.querySelector('.tab-more-btn');
    if (moreBtn) moreBtn.classList.remove('has-active');

    if (MORE_TAB_PAGES.includes(pageId)) {
        // Highlight item in More dropdown
        const item = document.querySelector(`.tab-more-item[data-page="${pageId}"]`);
        if (item) item.classList.add('active');
        if (moreBtn) moreBtn.classList.add('has-active');
    } else if (clickedTab && clickedTab.classList) {
        clickedTab.classList.add('active');
        clickedTab.setAttribute('aria-selected', 'true');
    } else {
        const tab = document.querySelector(`.tab[data-page="${pageId}"]`);
        if (tab) {
            tab.classList.add('active');
            tab.setAttribute('aria-selected', 'true');
        }
    }

    // Render page-specific content
    if (pageId === 'dod') renderDoDPage();
    if (pageId === 'prisma') loadPRISMA();
    if (pageId === 'audit') renderAuditPage();
    if (pageId === 'extraction') { renderExtractionTable(); renderRoBSection(); }
    if (pageId === 'search') loadSearchBuilderState();
}

// ===== GLOSSARY SEARCH =====
function filterGlossary() {
    const query = document.getElementById('glossarySearch').value.toLowerCase().trim();
    const items = document.querySelectorAll('#glossaryItems .glossary-item');
    const noResults = document.getElementById('glossaryNoResults');
    let visibleCount = 0;
    
    items.forEach(item => {
        const term = item.querySelector('.glossary-term')?.textContent?.toLowerCase() || '';
        const plain = item.querySelector('.glossary-plain')?.textContent?.toLowerCase() || '';
        const tech = item.querySelector('.glossary-technical')?.textContent?.toLowerCase() || '';
        
        const matches = !query || term.includes(query) || plain.includes(query) || tech.includes(query);
        item.classList.toggle('hidden', !matches);
        if (matches) visibleCount++;
    });
    
    if (noResults) {
        noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }
}
</script>
</body>
</html>
